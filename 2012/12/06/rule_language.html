<!doctype html>
<html class="no-js" lang="en">
	<head>
		<meta name="uyan_auth" content="05e9c08001" />
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<title>心内求法</title>
		<meta name="description" content="">
		<meta name="author" content="Holbrook">

		<link rel="stylesheet" href="http://holbrook.github.io/theme/css/foundation.css" />
		<link rel="stylesheet" href="http://holbrook.github.io/theme/css/pygment/friendly.css" />
		<link rel="stylesheet" href="http://holbrook.github.io/theme/css/custom.css" />


		<script src="http://holbrook.github.io/theme/js/modernizr.js"></script>

		<!-- Feeds -->
		<link href="http://holbrook.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="心内求法 Atom Feed" />


		<!-- mathjax config similar to math.stackexchange -->
		<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			jax: ["input/TeX", "output/HTML-CSS"],
			tex2jax: {
				inlineMath: [ ['$', '$'] ],
				displayMath: [ ['$$', '$$']],
				processEscapes: true,
				skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
			},
			messageStyle: "none",
			"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
		});
		</script>
		<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
		<!-- 百度统计 -->
		<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "https://hm.baidu.com/hm.js?16d951e9b49ded5f2e821a0e61d77797";
		  var s = document.getElementsByTagName("script")[0];
		  s.parentNode.insertBefore(hm, s);
		})();
		</script>
	</head>
	<body>
		<div class="off-canvas-wrap">
			<div class="inner-wrap">
				<!-- mobile top bar to activate nav -->
				<nav class="tab-bar show-for-small">
					<section class="left-small">
						<a class="left-off-canvas-toggle menu-icon" >
							<span class="fa-stack">
                    			<i class="fa fa-circle fa-stack-2x"></i>
                    			<i class="fa fa-bank fa-stack-1x fa-inverse" style="color: #eee"></i>
                			</span>
            			</a>
					</section>

					<section class="middle tab-bar-section">
						<h1 class="title">心内求法</h1>
					</section>
				</nav>

				<!-- mobile side bar nav -->
				<aside class="left-off-canvas-menu">
					<ul class="off-canvas-list">
						<li><a href="http://holbrook.github.io">Home</a></li>
						<li><label>Categories</label></li>
							<li ><a href="http://holbrook.github.io/category/bing-fa-xi-tong.html">并发系统</a></li>
							<li ><a href="http://holbrook.github.io/category/du-shu-bi-ji.html">读书笔记</a></li>
							<li ><a href="http://holbrook.github.io/category/ji-xian-xie-zuo.html">极限写作</a></li>
							<li ><a href="http://holbrook.github.io/category/liang-hua-jiao-yi.html">量化交易</a></li>
							<li class="active"><a href="http://holbrook.github.io/category/ruan-jian-kai-fa.html">软件开发</a></li>
							<li ><a href="http://holbrook.github.io/category/shu-ju-ke-xue.html">数据科学</a></li>
							<li ><a href="http://holbrook.github.io/category/tou-zi-fen-xi.html">投资分析</a></li>

						<li><label>Places</label></li>
							<li><a href="http://getpelican.com/">Pelican</a></li>
							<li><a href="http://python.org/">Python.org</a></li>
							<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
							<li><a href="#">You can modify those links in your config file</a></li>


						<li><label>Monthly Archives</label></li>
									<li><a href="/posts/2017/02/">二月 2017 (8)</a></li>
									<li><a href="/posts/2015/05/">五月 2015 (1)</a></li>
									<li><a href="/posts/2014/02/">二月 2014 (4)</a></li>
									<li><a href="/posts/2014/01/">一月 2014 (9)</a></li>
									<li><a href="/posts/2013/12/">十二月 2013 (10)</a></li>
									<li><a href="/posts/2013/09/">九月 2013 (1)</a></li>
									<li><a href="/posts/2013/08/">八月 2013 (2)</a></li>
									<li><a href="/posts/2013/07/">七月 2013 (7)</a></li>
									<li><a href="/posts/2013/06/">六月 2013 (4)</a></li>
									<li><a href="/posts/2013/05/">五月 2013 (6)</a></li>
									<li><a href="/posts/2013/01/">一月 2013 (2)</a></li>
									<li><a href="/posts/2012/12/">十二月 2012 (4)</a></li>
									<li><a href="/posts/2012/11/">十一月 2012 (3)</a></li>
									<li><a href="/posts/2012/10/">十月 2012 (2)</a></li>
									<li><a href="/posts/2012/04/">四月 2012 (1)</a></li>
									<li><a href="/posts/2012/03/">三月 2012 (1)</a></li>
									<li><a href="/posts/2012/02/">二月 2012 (2)</a></li>

						<li><label>Links</label></li>
							<li><a href="#">Another social link</a></li>
							<li><a href="#">You can add links in your config file</a></li>
					</ul>
				</aside>

				<!-- top bar nav -->
				<nav class="top-bar hide-for-small-only" data-topbar>
					<ul class="title-area">
						<li class="name">
							<h1><a href="http://holbrook.github.io/">心内求法</a></h1>
						</li>
					</ul>

					<section class="top-bar-section">
						<ul class="left">
								<li ><a href="http://holbrook.github.io/category/bing-fa-xi-tong.html">并发系统</a></li>
								<li ><a href="http://holbrook.github.io/category/du-shu-bi-ji.html">读书笔记</a></li>
								<li ><a href="http://holbrook.github.io/category/ji-xian-xie-zuo.html">极限写作</a></li>
								<li ><a href="http://holbrook.github.io/category/liang-hua-jiao-yi.html">量化交易</a></li>
								<li class="active"><a href="http://holbrook.github.io/category/ruan-jian-kai-fa.html">软件开发</a></li>
								<li ><a href="http://holbrook.github.io/category/shu-ju-ke-xue.html">数据科学</a></li>
								<li ><a href="http://holbrook.github.io/category/tou-zi-fen-xi.html">投资分析</a></li>
						</ul>
					</section>
				</nav>

				<!-- Main Page Content and Sidebar -->
				<section class="main-section">
					<div class="row">
						<!-- Main Content -->
						<div class="medium-9 small-12 columns" role="content">
<article>
	<h1 style="font-size: 2.75rem;">Drools规则描述语言快速手册</h1>
	<p><a href="/2012/03/20/rule_engine_1.html">在规则引擎中，通常会使用某种表述性的语言（而不是编程语言）来描述规则</a>。
所以规则描述语言也是规则引擎的一个重要组成部分。</p>
<p>目前在规则描述语言方面，并没有一个通用的标准获得规则引擎厂商的广泛支持，大部分规则描述语言都是厂商私有的。</p>
<p>大体来说，规则语言可以分为结构化的（Structured)和基于标记的（Markup，通常为xml）。</p>
<p>常见的规则描述语言包括：</p>
<ul>
<li>srl(Structured Rule Language) : Fair Isaac（以前是Blaze Software）定义的结构化规则描述语言</li>
<li>drl(Drools Rule Language) : Jboss（以前是drools.org)定义的结构化规则描述语言</li>
<li>RuleML(Rule Markup Language）: www.ruleml.org定义的xml规则描述语言</li>
<li>SRML(Simple Rule Markup Language): xml规则描述语言</li>
<li>BRML(Business Rules Markup Language):xml规则描述语言</li>
<li>SWRL（A Semantic Web Rule Language):www.daml.org定义的xml规则描述语言</li>
</ul>
<p>不管是哪种规则描述语言，都需要描述一组条件以及在此条件下执行的操作（即规则）。</p>
<h1>概览</h1>
<p>下面是一个drl的例子：</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">com</span><span class="o">.</span><span class="n">sample</span>

<span class="kn">import</span> <span class="nn">com.sample.DroolsTest.Message</span><span class="p">;</span>

<span class="n">rule</span> <span class="s2">&quot;Hello World&quot;</span>
    <span class="n">when</span>
        <span class="n">m</span> <span class="p">:</span> <span class="n">Message</span><span class="p">(</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Message</span><span class="o">.</span><span class="n">HELLO</span><span class="p">,</span> <span class="n">myMessage</span> <span class="p">:</span> <span class="n">message</span> <span class="p">)</span>
    <span class="n">then</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span> <span class="n">myMessage</span> <span class="p">);</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setMessage</span><span class="p">(</span> <span class="s2">&quot;Goodbye cruel world&quot;</span> <span class="p">);</span>
        <span class="n">m</span><span class="o">.</span><span class="n">setStatus</span><span class="p">(</span> <span class="n">Message</span><span class="o">.</span><span class="n">GOODBYE</span> <span class="p">);</span>
        <span class="n">update</span><span class="p">(</span> <span class="n">m</span> <span class="p">);</span>
<span class="n">end</span>

<span class="n">rule</span> <span class="s2">&quot;GoodBye&quot;</span>
    <span class="n">when</span>
        <span class="n">Message</span><span class="p">(</span> <span class="n">status</span> <span class="o">==</span> <span class="n">Message</span><span class="o">.</span><span class="n">GOODBYE</span><span class="p">,</span> <span class="n">myMessage</span> <span class="p">:</span> <span class="n">message</span> <span class="p">)</span>
    <span class="n">then</span>
        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span> <span class="n">myMessage</span> <span class="p">);</span>
<span class="n">end</span>
</pre></div>


<p>完整的drl文件会包含以下几个部分：</p>
<ul>
<li>package 声明</li>
<li>imports</li>
<li>declares</li>
<li>globals</li>
<li>functions</li>
<li>queries</li>
<li>rules</li>
</ul>
<h1>package和import声明</h1>
<p>与Java语言类似，drl的头部需要有package和import的声明。</p>
<p>规则文件当中必须要有一个 <strong>package</strong> 声明,同时 package 声明必须要放在规则文件的第一行。</p>
<h1>规则定义</h1>
<p>drl中，一个规则的标准结构如下：</p>
<div class="highlight"><pre><span></span>rule &quot;name&quot;
    attributes
    when
        LHS
    then
        RHS
end
</pre></div>


<p>一个规则通常包括三个部分:属性部分(attribute)、条件 部分(LHS)和结果部分(RHS)。</p>
<h2>条件部分(LHS)</h2>
<p>在 LHS 当中,可以包含多个条件,如果 LHS 部分没空的话,那么引擎会自动添加一 个 eval(true)的条件。</p>
<p>多个条件之间之间用可以使用 <strong>and</strong> 或 <strong>or</strong> 来进行连接。默认是 <strong>and</strong> 关系。</p>
<p>每个条件的语法为：</p>
<p>[绑定变量名:]Object([field 约束])</p>
<p>“绑定变量名”是可选的。绑定的变量可以在该LHS后续的条件中引用。</p>
<p>“field 约束”是指当前对象里相关字段的条件限制, 多个约束之间可以用“&amp;&amp;”(and)、“||”(or)和“,”(and)来连接。</p>
<p>举例如下：</p>
<div class="highlight"><pre><span></span><span class="x">when</span>
<span class="x">    </span><span class="p">$</span><span class="nv">customer</span><span class="x">:Customer()</span>
<span class="x">then</span>
<span class="x">    ……</span>


<span class="x">when</span>
<span class="x">    </span><span class="p">$</span><span class="nv">customer</span><span class="x">:Customer(age&gt;20,gender==􏰃male􏰃)</span>
<span class="x">    Order(customer==</span><span class="p">$</span><span class="nv">customer</span><span class="x">,price&gt;1000)</span>
<span class="x">then</span>
<span class="x">    ……</span>


<span class="x">when</span>
<span class="x">    Customer(age&gt;20 || (gender==&#39;male&#39; &amp;&amp; city==‘sh&#39;))</span>
<span class="x">then</span>
<span class="x">    ……</span>
</pre></div>


<p>约束中可以使用的比较操作符包括：</p>
<div class="highlight"><pre><span></span>&gt;、&gt;=、&lt;、&lt;=、= =、!=、contains、not contains、 memberof、not memberof、matches、not matches
</pre></div>


<p>举例如下：</p>
<div class="highlight"><pre><span></span><span class="nt">when</span>
    <span class="o">$</span><span class="nt">order</span><span class="nd">:Order</span><span class="o">();</span>
    <span class="o">$</span><span class="nt">customer</span><span class="nd">:Customer</span><span class="o">(</span><span class="nt">age</span> <span class="o">&gt;</span><span class="nt">20</span><span class="o">,</span> <span class="nt">orders</span> <span class="nt">contains</span> <span class="o">$</span><span class="nt">order</span><span class="o">);</span>
<span class="nt">then</span>
    <span class="err">……</span>


<span class="nt">when</span>
    <span class="o">$</span><span class="nt">order</span><span class="nd">:Order</span><span class="o">(</span><span class="nt">name</span> <span class="nt">memberOf</span> <span class="nt">orderNames</span><span class="o">);</span> <span class="err">#</span> <span class="nt">orderNames为数组或集合类型</span>
<span class="nt">then</span>
    <span class="err">……</span>

<span class="nt">when</span>
    <span class="o">$</span><span class="nt">customer</span><span class="nd">:Customer</span><span class="o">(</span><span class="nt">name</span> <span class="nt">matches</span> <span class="s2">&quot;李.*&quot;</span><span class="o">);</span> <span class="err">#</span> <span class="nt">正则表达式匹配</span>
<span class="nt">then</span>
    <span class="err">……</span>
</pre></div>


<h2>结果部分(RHS)</h2>
<p>RHS 部分定义了当LHS满足是要进行的操作。</p>
<p>RHS中可以编写代码，可以使用 LHS 部分当中定义的绑定变量名以及drl头部定义的全局变量。</p>
<p>在 RHS 当中虽然可以直接编写 Java 代码,但不建议在代码当中有条件判断,如果需要条件判断,那么请重新考虑将其放在 LHS 当中,否则就违背了使用规则的初衷。</p>
<h3>使用宏函数</h3>
<p>RHS中可以使用宏函数对工作空间(Working Memory)进行操作。当调用宏函数后，所有未设置“no-loop”属性的规则都会被重新匹配，符合条件的重新触发。</p>
<p>宏函数包括：</p>
<ul>
<li>insert：将一个 Fact 对象插入到当前的 Working Memory</li>
<li>update：对当前 Working Memory 中的 Fact 进行更新</li>
<li>retract ：从 Working Memory 中删除某个 Fact 对象</li>
</ul>
<p>这些宏函数都是StatefulSession中定义的方法。</p>
<p>举例如下：</p>
<div class="highlight"><pre><span></span><span class="nt">when</span>
    <span class="err">……</span>
<span class="nt">then</span>
    <span class="nt">Customer</span> <span class="nt">cus</span><span class="o">=</span><span class="nt">new</span> <span class="nt">Customer</span><span class="o">();</span>
    <span class="nt">cus</span><span class="nc">.setName</span><span class="o">(</span><span class="s2">&quot;张三&quot;</span><span class="o">);</span>
    <span class="nt">insert</span><span class="o">(</span><span class="nt">cus</span><span class="o">);</span>


<span class="nt">when</span>
    <span class="o">$</span><span class="nt">customer</span><span class="nd">:Customer</span><span class="o">(</span><span class="nt">name</span><span class="o">==</span><span class="s2">&quot;张三&quot;</span><span class="o">,</span><span class="nt">age</span><span class="o">&lt;</span><span class="nt">10</span><span class="o">);</span>
<span class="nt">then</span>
    <span class="o">$</span><span class="nt">customer</span><span class="nc">.setAge</span><span class="o">($</span><span class="nt">customer</span><span class="nc">.getAge</span><span class="o">()+</span><span class="nt">1</span><span class="o">);</span>
    <span class="nt">update</span><span class="o">($</span><span class="nt">customer</span><span class="o">);</span>


<span class="nt">when</span>
    <span class="o">$</span><span class="nt">customer</span><span class="nd">:Customer</span><span class="o">(</span><span class="nt">name</span><span class="o">==</span><span class="s2">&quot;张三&quot;</span><span class="o">,</span><span class="nt">age</span><span class="o">&lt;</span><span class="nt">10</span><span class="o">);</span>
<span class="nt">then</span>
    <span class="nt">Customer</span> <span class="nt">customer</span><span class="o">=</span><span class="nt">new</span> <span class="nt">Customer</span><span class="o">();</span>
    <span class="nt">customer</span><span class="nc">.setName</span><span class="o">(</span><span class="s2">&quot;张三&quot;</span><span class="o">);</span>
    <span class="nt">customer</span><span class="nc">.setAge</span><span class="o">($</span><span class="nt">customer</span><span class="nc">.getAge</span><span class="o">()+</span><span class="nt">1</span><span class="o">);</span>

    <span class="err">#</span> <span class="nt">用新对象替换Working</span> <span class="nt">Memory中的旧对象</span>
    <span class="nt">update</span><span class="o">(</span><span class="nt">drools</span><span class="nc">.getWorkingMemory</span><span class="o">()</span><span class="nc">.getFactHandleByIdentity</span><span class="o">($</span><span class="nt">customer</span><span class="o">),</span><span class="nt">customer</span><span class="o">);</span>


<span class="nt">when</span>
    <span class="o">$</span><span class="nt">customer</span><span class="nd">:Customer</span><span class="o">(</span><span class="nt">name</span><span class="o">==</span><span class="s2">&quot;张三&quot;</span><span class="o">);</span>
<span class="nt">then</span>
    <span class="nt">retract</span><span class="o">($</span><span class="nt">customer</span><span class="o">);</span>
</pre></div>


<h3>modify代码块</h3>
<p>modify代码块用于快速修改并更新(update)某个 Fact 对象的多个属性。语法及例子如下：</p>
<div class="highlight"><pre><span></span><span class="nt">modify</span><span class="o">(</span><span class="nt">fact-expression</span><span class="o">)</span><span class="p">{</span>
    <span class="o">&lt;</span><span class="err">修改</span> <span class="n">Fact</span> <span class="err">属性的表达式</span><span class="o">&gt;</span><span class="cp">[</span><span class="p">,</span><span class="o">&lt;</span><span class="nx">修改</span> <span class="nx">Fact</span> <span class="nx">属性的表达式</span><span class="o">&gt;*</span><span class="cp">]</span>
<span class="p">}</span>


<span class="nt">when</span>
    <span class="o">$</span><span class="nt">customer</span><span class="nd">:Customer</span><span class="o">(</span><span class="nt">name</span><span class="o">==</span><span class="s2">&quot;张三&quot;</span><span class="o">,</span><span class="nt">age</span><span class="o">==</span><span class="nt">20</span><span class="o">);</span>
<span class="nt">then</span>
    <span class="nt">modify</span><span class="o">($</span><span class="nt">customer</span><span class="o">)</span><span class="p">{</span>
        <span class="n">setId</span><span class="p">(</span><span class="s2">&quot;super man&quot;</span><span class="p">)</span><span class="o">,</span>
        <span class="n">setAge</span><span class="p">(</span><span class="m">30</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>


<h3>drools宏对象</h3>
<p>通过使用 drools 宏对象可以实现在规则文件里直接访问 Working Memory, 从而获取对当前的 Working Memory 的更多控制。</p>
<p>drools 宏对象的常用方法包括：</p>
<ul>
<li>drools.getWorkingMemory()：获取当前的 WorkingMemory 对象</li>
<li>drools.halt()：在当前规则执行完成后,不再执行 其它未执行的规则。</li>
<li>drools.getRule()：得到当前的规则对象</li>
<li>drools.insert(new Object)：向当前的 WorkingMemory 当中插入 指定的对象,功能与宏函数 insert 相同。</li>
<li>drools.update(new Object)：更新当前的 WorkingMemory 中指定 的对象,功能与宏函数 update 相同。</li>
<li>drools.update(FactHandle Object)：更新当前的 WorkingMemory 中指定 的对象,功能与宏函数 update 相同。</li>
<li>drools.retract(new Object)：从当前的 WorkingMemory 中删除指 定的对象,功能与宏函数 retract 相 同。</li>
</ul>
<p>例如：</p>
<div class="highlight"><pre><span></span>when
    eval(true);
then
    Customer cus=new Customer();
    cus.setName(&quot;张三&quot;);
    drools.insert(cus)
</pre></div>


<h3>kcontext宏对象</h3>
<p>kcontext 也是 Drools 提供的一个宏对象,它的作用主要是用来得到当前的 KnowledgeRuntime 对象,KnowledgeRuntime 对象可以实现与引擎的各种交互。</p>
<h2>规则属性</h2>
<p>主要的规则属性如下：</p>
<p>13 个:  auto-focus、、lock-on-active、no-loop、 ruleflow-group、、when。</p>
<ul>
<li>salience</li>
</ul>
<p>设置规则执行的优先级,数字越大越先执行，数字相同的使用随机顺序。默认值为0，可以设置为负数。</p>
<ul>
<li>no-loop</li>
</ul>
<p>默认为false。设置为true时，表示该规则只会被引擎检查一次。引擎内部对Fact更新时，忽略本规则的再次检查。</p>
<ul>
<li>date-effective</li>
</ul>
<p>设置规则的开始生效日期。默认接受“dd-MMM-yyyy”格式的字符串。可以用代码修改日期格式，如：</p>
<p><code>System.setProperty("drools.dateformat","yyyy-MM-dd")</code>。</p>
<ul>
<li>date-expires</li>
</ul>
<p>设置规则的过期日期。格式与<code>date-effective</code>相同。</p>
<ul>
<li>enabled</li>
</ul>
<p>默认为true。设置规则是否可用。</p>
<ul>
<li>dialect</li>
</ul>
<p>设置规则中使用的编程语言。默认为java，还可以设置为mvel。通过drools.getRule().getDialect()可以获取该属性的设置。</p>
<ul>
<li>duration</li>
</ul>
<p>延迟指定的时间后，在 <strong>另一个线程中</strong> 触发规则。单位为毫秒。</p>
<ul>
<li>activation-group</li>
</ul>
<p>为规则划指定一个活动组（组名为字符串）。同一个活动组中的规则只执行一个，根据优先级(salience)来决定执行哪一个规则。</p>
<ul>
<li>agenda-group 和 auto-focus</li>
</ul>
<p>为规则指定一个议程(agenda)组。指定了议程组的规则只有在该议程组得到焦点时才被触发。但如果规则同时指定了auto-focus属性为true，则该规则自动得到焦点。</p>
<p>指定议程组焦点可以通过回话(session)：</p>
<p><code>session.getAgenda().getAgendaGroup("GROUP_NAME").setFocus();
  session.fireAllRules();</code></p>
<p>也可以实现org.drools.runtime.rule.AgendaFilter 接口：</p>
<p>{% highlight java %}
    package test;
    import org.drools.runtime.rule.Activation;
    import org.drools.runtime.rule.AgendaFilter;</p>
<div class="highlight"><pre><span></span>public class TestAgendaFilter implements AgendaFilter {
    private String startName;
    public TestAgendaFilter(String startName){
        this.startName=startName;
    }
    public boolean accept(Activation activation) {
        String ruleName=activation.getRule().getName();
        if(ruleName.startsWith(this.startName)){
            return true;
        }else{
            return false;
        }
    }
}
</pre></div>


<p>{% endhighlight %}</p>
<ul>
<li>ruleflow-group</li>
</ul>
<p>指定规则流组。</p>
<ul>
<li>lock-on-active</li>
</ul>
<p>当在规则上使用 ruleflow-group 属性或 agenda-group 属性的时候,将 lock-on-action 属性 的值设置为 true,可能避免因某些 Fact 对象被修改而使已经执行过的规则再次被激活执行。lock-on-active 是 no-loop 的增强版属性，在规则流中很有用。</p>
<p>举例如下：</p>
<div class="highlight"><pre><span></span>rule &quot;rule1&quot;
    salience 1
    when
    ……
</pre></div>


<h1>注释</h1>
<p>Drools 当中注释的写法与编写 Java 类的注 释的写法完全相同,注释的写法分两种:单行注释与多行注释。</p>
<p>单行注释可以采用“#”或者“//”来进行标记， 多行注释以“/<em>”开始,以“</em>/”结束。</p>
<p>例如：</p>
<div class="highlight"><pre><span></span><span class="cm">/* 规则rule1的注释</span>
<span class="cm">这是一个测试用规则</span>
<span class="cm">*/</span><span class="w"></span>
rule<span class="w"> </span><span class="s">&quot;rule1&quot;</span><span class="w"></span>
<span class="w">    </span>when<span class="w"></span>
<span class="w">        </span>eval<span class="o">(</span>true<span class="o">)</span><span class="w"> </span><span class="err">#没有条件判断</span><span class="w"></span>
<span class="w">    </span><span class="kr">then</span><span class="w"></span>
<span class="w">        </span>System<span class="o">.</span>out<span class="o">.</span>println<span class="o">(</span><span class="s">&quot;rule1 execute&quot;</span><span class="o">)</span><span class="err">;</span><span class="w"> </span><span class="o">//</span><span class="err">仅仅是输出</span><span class="w"></span>
<span class="kr">end</span><span class="w"></span>
</pre></div>


<h1>类型声明</h1>
<p>可以在规则文件中定义Fact类型，而不需要编写Java类。比如：</p>
<div class="highlight"><pre><span></span>declare Address
    city : String
    addressName : String
end

declare Person
    name:String
    birthday:Date
    address:Address //使用declare声明的对象作为address属性类型
    order:Order //使用名为Order的JavaBean作为order属性类型
end
</pre></div>


<p>在KnowledgeBase中可以获取规则文件中定义的Fact类型，比如：</p>
<div class="highlight"><pre><span></span>//获取规则文件当中定义的Address对象并对其进行实例化
FactType addressType=knowledgeBase.getFactType(&quot;test&quot;,&quot;Address&quot;);
Object add=addressType.newInstance();
addressType.set(add, &quot;city&quot;,&quot;Beijing&quot;);
addressType.set(add, &quot;addressName&quot;,&quot;Capital&quot;);
</pre></div>


<p>在声明中还可以定义元数据。可以为 Fact 对象、Fact对象的属性或者是规则来定义元数据,元数据定义采用的是“@”符号开头。</p>
<p>比如：</p>
<div class="highlight"><pre><span></span>declare User
    @createTime(2009-10-25)
    username : String @maxLenth(30)
    userid : String @key
    birthday : java.util.Date
end
</pre></div>


<p>元数据的获取？(TODO)</p>
<h1>全局变量（TODO）</h1>
<h1>函数和import function</h1>
<h2>函数的定义和使用</h2>
<p>函数是定义在规则文件当中一代码块,作用是将在规则文件当中若干个规则都会用到的业务操作封装起来,实现业务代码的复用,减少规则编写的工作量。
函数的可见范围是函数所在的规则文件。</p>
<p>函数以function定义，可以是void，也可以有返回值。例如：</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">test</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="p">;</span>
<span class="o">/*</span>
<span class="err">一个测试函数</span>
<span class="err">用来向</span><span class="n">Customer对象当中添加指定数量的Order对象的函数</span>
<span class="o">*/</span>

<span class="n">function</span> <span class="n">void</span> <span class="n">setOrder</span><span class="p">(</span><span class="n">Customer</span> <span class="n">customer</span><span class="p">,</span><span class="nb">int</span> <span class="n">orderSize</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">List</span> <span class="n">ls</span><span class="o">=</span><span class="n">new</span> <span class="n">ArrayList</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span> <span class="n">orderSize</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">Order</span> <span class="n">order</span><span class="o">=</span><span class="n">new</span> <span class="n">Order</span><span class="p">();</span>
        <span class="n">ls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">order</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">customer</span><span class="o">.</span><span class="n">setOrders</span><span class="p">(</span><span class="n">ls</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">/*</span>
<span class="err">测试规则</span>
<span class="o">*/</span>
<span class="n">rule</span> <span class="s2">&quot;rule1&quot;</span> <span class="n">when</span>
    <span class="err">$</span><span class="n">customer</span> <span class="p">:</span><span class="n">Customer</span><span class="p">();</span>
<span class="n">then</span>
    <span class="n">setOrder</span><span class="p">(</span><span class="err">$</span><span class="n">customer</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;rule 1 customer has order size:&quot;</span><span class="o">+</span><span class="err">$</span><span class="n">customer</span><span class="o">.</span><span class="n">getOrders</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>
<span class="n">end</span>

<span class="o">/*</span>
<span class="err">测试规则</span>
<span class="o">*/</span>
<span class="n">rule</span> <span class="s2">&quot;rule2&quot;</span> <span class="n">when</span>
    <span class="err">$</span><span class="n">customer</span> <span class="p">:</span><span class="n">Customer</span><span class="p">();</span>
<span class="n">then</span>
    <span class="n">setOrder</span><span class="p">(</span><span class="err">$</span><span class="n">customer</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;rule 2 customer has order size:&quot;</span><span class="o">+</span><span class="err">$</span><span class="n">customer</span><span class="o">.</span><span class="n">getOrders</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>
<span class="n">end</span>
</pre></div>


<h2>引入静态方法</h2>
<p>实际应用当中,可以考虑使用在 Java 类当中定义静态方法的办法来替代在规则文件当 中定义函数。</p>
<p>Drools 提供了一个特殊的 import 语句:import function,通过该 import 语句,可以实现将一个 Java 类中静态方法引入到一个规则文件当中,使得该文件当中的规 则可以像使用普通的 Drools 函数一样来使用 Java 类中某个静态方法。</p>
<p>比如：</p>
<p _="%" endhighlight>{% highlight java %}
package test;
public class RuleTools {
    public static void printInfo(String name){
        System.out.println("your name is :"+name);
    }
}</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">test</span>
<span class="kn">import</span> <span class="nn">function</span> <span class="nn">test.RuleTools.printInfo</span><span class="p">;</span>
<span class="o">/*</span>
<span class="err">测试规则</span>
<span class="o">*/</span>
<span class="n">rule</span> <span class="s2">&quot;rule1&quot;</span>
    <span class="n">when</span>
        <span class="nb">eval</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
    <span class="n">then</span>
        <span class="n">printInfo</span><span class="p">(</span><span class="s2">&quot;test import function&quot;</span><span class="p">);</span>
<span class="n">end</span>
</pre></div>


<h1>查询定义</h1>
<p>查询用于根据条件在当前的 WorkingMemory 当中查找 Fact。Drools 当中查询可分为两种:一种是不需要外部传入参数;一种是需要外部传入参 数。</p>
<p>如：</p>
<div class="highlight"><pre><span></span><span class="x">query &quot;testQuery&quot;</span>
<span class="x">    customer:Customer(age&gt;30,orders.size &gt;10)</span>
<span class="x">end</span>

<span class="x">query &quot;testQuery2&quot;(int </span><span class="p">$</span><span class="nv">age</span><span class="x">,String </span><span class="p">$</span><span class="nv">gender</span><span class="x">)</span>
<span class="x">    customer:Customer(age&gt;</span><span class="p">$</span><span class="nv">age</span><span class="x">,gender==</span><span class="p">$</span><span class="nv">gender</span><span class="x">)</span>
<span class="x">end</span>
</pre></div>


<p>通过session可以在外部调用规则文件中的查询，比如：</p>
<p>{% highlight java %}
……
QueryResults queryResults=statefulSession.getQueryResults("testQuery");
for(QueryResultsRow qr:queryResults){
    Customer cus=(Customer)qr.get("customer"); //打印查询结果
    System.out.println("customer name :"+cus.getName());
}</p>
<p>QueryResults queryResults2=statefulSession.getQueryResults("testQuery2", new Object[]{new Integer(20),"F"});</p>
<p _="%" endhighlight>……</p>
	<h6>Written by <a href="http://holbrook.github.io/author/holbrook.html">Holbrook</a> on 2012-12-06.</h6>
</article>

<hr/>
<div class="row">

	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_weixin">微信</a>
		<a class="jiathis_button_email">邮件</a>
		<a class="jiathis_button_douban">豆瓣</a>
		<a class="jiathis_button_hi">百度空间</a>
		<a class="jiathis_button_xqw">雪球</a>
		<a class="jiathis_button_tsina">新浪微博</a>
		<a class="jiathis_button_ishare">一键分享</a>
		<a href="http://www.jiathis.com/share?uid=2124868" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
		<a class="jiathis_counter_style"></a>
	</div>
	<script type="text/javascript">
	var jiathis_config = {data_track_clickback:'true'};
	</script>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=2124868" charset="utf-8"></script>
	<!-- JiaThis Button END -->


	<div class="small-12 columns">
		<h3>Comments</h3>
		<!-- UY BEGIN -->
		<div id="uyan_frame"></div>
		<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2124868"></script>
		<!-- UY END -->
	</div>

	<!-- UJian Button BEGIN -->
	<div class="ujian-hook"></div>
	<script type="text/javascript">var ujian_config = {num:8,showType:3};</script>
	<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js"></script>
	<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
	<!-- UJian Button END -->

</div>
						</div>
						<!-- End Main Content -->
						<!-- Sidebar -->
						<aside class="medium-3 hide-for-small-only columns">
							<!-- <div class="panel">
								<h5>Places</h5>
								<ul class="side-nav">
									<li><a href="http://getpelican.com/">Pelican</a></li>
									<li><a href="http://python.org/">Python.org</a></li>
									<li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
									<li><a href="#">You can modify those links in your config file</a></li>
								</ul>
							</div> -->

							<div class="panel">
								<h5>Tags</h5>
								<ul class="tag-cloud">
									<li><a href="/tag/jiao-yi-xi-tong.html" class="tag-1">交易系统</a></li>
									<li><a href="/tag/duo-xian-cheng.html" class="tag-4">多线程</a></li>
									<li><a href="/tag/xiao-xi-zhong-jian-jian.html" class="tag-4">消息中间件</a></li>
									<li><a href="/tag/env.html" class="tag-2">env</a></li>
									<li><a href="/tag/python.html" class="tag-1">python</a></li>
									<li><a href="/tag/yun-wei.html" class="tag-1">运维</a></li>
									<li><a href="/tag/blog.html" class="tag-3">blog</a></li>
									<li><a href="/tag/ce-shi.html" class="tag-3">测试</a></li>
									<li><a href="/tag/graph.html" class="tag-3">graph</a></li>
									<li><a href="/tag/gui-ze-yin-qing.html" class="tag-1">规则引擎</a></li>
									<li><a href="/tag/cep.html" class="tag-2">CEP</a></li>
									<li><a href="/tag/web.html" class="tag-4">web</a></li>
									<li><a href="/tag/gui.html" class="tag-1">GUI</a></li>
									<li><a href="/tag/ling-yu-mo-xing.html" class="tag-4">领域模型</a></li>
									<li><a href="/tag/cli.html" class="tag-4">CLI</a></li>
									<li><a href="/tag/zhi-shi-guan-li.html" class="tag-4">知识管理</a></li>
									<li><a href="/tag/nosql.html" class="tag-4">NoSQL</a></li>
									<li><a href="/tag/tu-biao.html" class="tag-4">图表</a></li>
									<li><a href="/tag/cluster.html" class="tag-2">cluster</a></li>
									<li><a href="/tag/osgi.html" class="tag-1">OSGi</a></li>
									<li><a href="/tag/markdown.html" class="tag-4">markdown</a></li>
									<li><a href="/tag/java.html" class="tag-1">java</a></li>
									<li><a href="/tag/tong-ji-xue.html" class="tag-1">统计学</a></li>
									<li><a href="/tag/vim.html" class="tag-4">vim</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Monthly Archives</h5>
								<ul class="side-nav">
											<li><a href="/2017/02/">2017-02  (8)</a></li>
											<li><a href="/2015/05/">2015-05  (1)</a></li>
											<li><a href="/2014/02/">2014-02  (4)</a></li>
											<li><a href="/2014/01/">2014-01  (9)</a></li>
											<li><a href="/2013/12/">2013-12  (10)</a></li>
											<li><a href="/2013/09/">2013-09  (1)</a></li>
											<li><a href="/2013/08/">2013-08  (2)</a></li>
											<li><a href="/2013/07/">2013-07  (7)</a></li>
											<li><a href="/2013/06/">2013-06  (4)</a></li>
											<li><a href="/2013/05/">2013-05  (6)</a></li>
											<li><a href="/2013/01/">2013-01  (2)</a></li>
											<li><a href="/2012/12/">2012-12  (4)</a></li>
											<li><a href="/2012/11/">2012-11  (3)</a></li>
											<li><a href="/2012/10/">2012-10  (2)</a></li>
											<li><a href="/2012/04/">2012-04  (1)</a></li>
											<li><a href="/2012/03/">2012-03  (1)</a></li>
											<li><a href="/2012/02/">2012-02  (2)</a></li>
								</ul>
							</div>

							<div class="panel">
								<h5>Links</h5>
								<ul class="side-nav">
									<li><a href="#">Another social link</a></li>
									<li><a href="#">You can add links in your config file</a></li>
								</ul>
							</div>
						</aside>
						<!-- End Sidebar -->
					</div>

					<!-- Footer -->
					<footer class="row">
						<div class="medium-9 small-12">
							<p class="text-center">Powered by <a href="http://getpelican.com">Pelican</a> and <a href="http://foundation.zurb.com/">Zurb Foundation</a>. Theme by <a href="http://hamaluik.com">Kenton Hamaluik</a>.</p>
						</div>
					</footer>
					<!-- End Footer -->
				</section>
				<a class="exit-off-canvas"></a>
			</div><!--off-canvas inner-->
		</div><!--off-canvas wrap-->

		<script src="http://holbrook.github.io/theme/js/jquery.js"></script>
		<script src="http://holbrook.github.io/theme/js/foundation.min.js"></script>
		<script>
			$(document).foundation();
		</script>
	</body>
</html>