#+TITLE: 统一接入旁路日志方案
#+DATE: <2015-04-20 Mon>
#+AUTHOR: Holbrook

* 目的

以旁路方式获取T2的请求/响应消息并记录日志，以满足后续监控、分析的需要。

* 工作原理

T2节点的路由插件(router)可以配置旁路功能。当开启旁路功能后，经过路由插件的请求/响应消息会并发到旁路插件(bypass)。

旁路插件可以将消息通过T2协议转发到日志服务器，再通过日志插件记录下来，如下图：


[[./t2_bybass_plugin.png]]


* 监控点设置

上述的机制可以应用到每个T2节点，包括UFX、BAR、GATEWAY等。考虑到正常情况下所有的请求/响应都会经过BAR，
目前只监控BAR节点。如下图：

[[./t2_bybass_nodes.png]]

* 浏览估算

从目前的监控数据来看，BAR的网卡流量峰值为30Mbps。用一台日志服务器记录三个BAR的请求/响应消息，网卡和磁盘的I/O都可以满足要求。

* 日志处理方式

1. 现阶段可以使用恒生提供的日志插件(fsc_filter_log)，安装恒生定义的二进制格式在日志服务器落地到日志文件。

2. 针对该格式，编写文件监控和解析程序，将日志的变化写入日志分析库，以便后续进行日志分析。

3. 在日志服务器上还可以配置消息发布插件，将需要通知的消息发布给相关的应用系统（比如风控系统）。

4. 后续如果对日志处理的性能有进一步要求，可以编写插件直接将日志信息写入日志分析库，不在日志服务器落地为本地文件。
