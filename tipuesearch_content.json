{"pages":[{"title":"《机器学习》","text":"《机器学习》 , 作者: (美)Tom Mitchell ，译者: 曾华军 / 张银奎 / 等 读书笔记目录。 机器学习关注的问题是:计算机程序如何随着经验积累自动提高性能。 本书展现机器学习中核心的算法和理论。书中的一些算法的实现和数据可以在互联网上 1 找到。 学习笔记目录 第1章 引言 第2章 概念学习和一般到特殊序 第3章 决策树学习 第4章 人工神经网络 第5章 评估假设 第6章 贝叶斯学习 第7章 计算学习理论 第8章 基于实例的学习 第9章 遗传算法 第10章 学习规则集合 第11章 分析学习 第12章 归纳和分析学习的结合 第13章 增强学习 相关资料 本书的网址：http://www.cs.cmu.edu/~tom/mlbook.html ↩","tags":"机器学习","loc":"http://holbrook.github.io/2017/03/04/index.html"},{"title":"机器学习-1: 绪论","text":"Summary: 《机器学习》 , 作者: (美)Tom Mitchell ，译者: 曾华军 / 张银奎 / 等。 读书笔记 。 第 1 章：引言 《机器学习》 , 作者: (美)Tom Mitchell ，译者: 曾华军 / 张银奎 / 等。 读书笔记 。第 1 章：引言。 本书针对机器学习这个领域,描述了多种学习范型、算法、理论以及应用。 机器学习从是一个多学科的领域， 吸取了人工智能、概率统计、计算复杂性理论、控制论、信 息论、哲学、生理学、神经生物学等学科的成果。 这些学科中影响机器学习的关键思想如下： 一些学科和它们对机器学习的影响 人工智能 学习概念的符号表示。作为搜索问题的机器学习。作为提高问题求解能力途径的学习。使用先验的知识和训练数据一起引导学习。 贝叶斯方法 作为计算假设概率的基础的贝叶斯法则。朴素贝叶斯分类器。估计未观测到变量的值的算法。 计算复杂性理论 不同学习任务中固有的复杂性的理论边界,以计算量、训练样例数量、出错数量等衡量。 控制论 为了优化预定目标,学习对各种处理过程进行控制,学习预测被控制的过程的下一个状态。 信息论 熵和信息内容的度量。学习的最小描述长度方法。编码假设时,它的最佳编码和与最佳训练序列的关系。 哲学 \"奥坎姆的剃刀\"(Occam's razor)1:最简单的假设是最好的。从观察到的数据泛化的理由分析。 心理学和神经生物学 实践的幂定律(power law of practice),该定律指出对于很大范围内的学习问题,人们的反 应速度随着实践次数的幂级提高。激发人工神经网络的学习模式的神经生物学研究。 统计学 在估计有限数据样本上的假设精度时出现的误差(例如偏差和方差)的刻画。置信区间, 统计检验。 学习问题的标准描述 设计一个学习系统 机器学习的一些观点和问题 如何阅读本书 小结和补充读物","tags":"机器学习","loc":"http://holbrook.github.io/2017/03/04/machine-learning1.html"},{"title":"委托和成交","text":"demo ::uml:: format=\"png\" alt=\"Sample sequence diagram\" participant User User -> A: DoWork activate A #FFBBBB A -> A: Internal call activate A #DarkSalmon A -> B: << createRequest >> activate B B --> A: RequestCreated deactivate B deactivate A A -> User: Done deactivate A ::end-uml::","tags":"量化交易","loc":"http://holbrook.github.io/2017/03/02/order_and_match.html"},{"title":"利用Python进行数据分析(5.5)：多层次索引","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } In [1]: % pylab inline from pandas import Series , DataFrame import pandas as pd Populating the interactive namespace from numpy and matplotlib 《 利用Python进行数据分析 》 作者: Wes McKinney 译者: 唐学韬 层次化索引 层次化索引（hierarchical index）是pandas的重要功能， 通过在一个轴上拥有两个以上的索引级别， 使得 Pandas 可以用低维度形式处理高维度。 层次化索引在数据重塑和基于分组操作（如透视表生成）中扮演者重要的角色。 根据索引选择数据子集 In [2]: data = Series ( np . random . randn ( 10 ), index = [[ 'a' , 'a' , 'a' , 'b' , 'b' , 'b' , 'c' , 'c' , 'd' , 'd' ], [ 1 , 2 , 3 , 1 , 2 , 3 , 1 , 2 , 2 , 3 ]]) data Out[2]: a 1 -0.291810 2 -2.489879 3 -0.993844 b 1 0.791313 2 -1.233354 3 1.096154 c 1 1.627453 2 0.637391 d 2 -0.726163 3 -2.117156 dtype: float64 In [3]: data . index Out[3]: MultiIndex(levels=[['a', 'b', 'c', 'd'], [1, 2, 3]], labels=[[0, 0, 0, 1, 1, 1, 2, 2, 3, 3], [0, 1, 2, 0, 1, 2, 0, 1, 1, 2]]) In [10]: # 以外层索引的方式选择 data [ 'b' ] Out[10]: 1 0.791313 2 -1.233354 3 1.096154 dtype: float64 In [5]: data [ 'b' : 'c' ] Out[5]: b 1 0.791313 2 -1.233354 3 1.096154 c 1 1.627453 2 0.637391 dtype: float64 In [6]: data . ix [[ 'b' , 'd' ]] Out[6]: b 1 0.791313 2 -1.233354 3 1.096154 d 2 -0.726163 3 -2.117156 dtype: float64 In [11]: # 以内层索引的方式选择 data [:, 2 ] Out[11]: a -2.489879 b -1.233354 c 0.637391 d -0.726163 dtype: float64 stack() 和 unstack() In [13]: # 层次化索引数据可以转换为一个DataFrame data . unstack () Out[13]: 1 2 3 a -0.291810 -2.489879 -0.993844 b 0.791313 -1.233354 1.096154 c 1.627453 0.637391 NaN d NaN -0.726163 -2.117156 In [14]: # 反向 data . unstack () . stack () Out[14]: a 1 -0.291810 2 -2.489879 3 -0.993844 b 1 0.791313 2 -1.233354 3 1.096154 c 1 1.627453 2 0.637391 d 2 -0.726163 3 -2.117156 dtype: float64 DataFrame 的层次化索引 In [19]: # 对于DataFrame，横轴和竖轴都可以有层次化索引 frame = DataFrame ( np . arange ( 12 ) . reshape (( 4 , 3 )), index = [[ 'a' , 'a' , 'b' , 'b' ], [ 1 , 2 , 1 , 2 ]], columns = [[ 'Ohio' , 'Ohio' , 'Colorado' ], [ 'Green' , 'Red' , 'Green' ]]) frame Out[19]: Ohio Colorado Green Red Green a 1 0 1 2 2 3 4 5 b 1 6 7 8 2 9 10 11 In [20]: # 每层索引都可以命名 frame . index . names = [ 'key1' , 'key2' ] frame . columns . names = [ 'state' , 'color' ] frame Out[20]: state Ohio Colorado color Green Red Green key1 key2 a 1 0 1 2 2 3 4 5 b 1 6 7 8 2 9 10 11 In [18]: frame [ 'Ohio' ] Out[18]: color Green Red key1 key2 a 1 0 1 2 3 4 b 1 6 7 2 9 10 In [22]: # 可以单独创建MultiIndex然后复用 columns = pd . MultiIndex . from_arrays ([[ 'Ohio' , 'Ohio' , 'Colorado' ],[ 'Green' , 'Red' , 'Green' ]], names = [ 'state' , 'color' ]) frame1 = DataFrame ( np . arange ( 12 ) . reshape (( 4 , 3 )), columns = columns ) frame1 Out[22]: state Ohio Colorado color Green Red Green 0 0 1 2 1 3 4 5 2 6 7 8 3 9 10 11 重排分级顺序 In [26]: frame Out[26]: state Ohio Colorado color Green Red Green key1 key2 a 1 0 1 2 2 3 4 5 b 1 6 7 8 2 9 10 11 In [23]: frame . swaplevel ( 'key1' , 'key2' ) Out[23]: state Ohio Colorado color Green Red Green key2 key1 1 a 0 1 2 2 a 3 4 5 1 b 6 7 8 2 b 9 10 11 In [24]: frame . sortlevel ( 1 ) Out[24]: state Ohio Colorado color Green Red Green key1 key2 a 1 0 1 2 b 1 6 7 8 a 2 3 4 5 b 2 9 10 11 In [25]: frame . swaplevel ( 0 , 1 ) . sortlevel ( 0 ) Out[25]: state Ohio Colorado color Green Red Green key2 key1 1 a 0 1 2 b 6 7 8 2 a 3 4 5 b 9 10 11 根据级别汇总统计 In [27]: frame . sum ( level = 'key2' ) Out[27]: state Ohio Colorado color Green Red Green key2 1 6 8 10 2 12 14 16 In [28]: frame . sum ( level = 'color' , axis = 1 ) Out[28]: color Green Red key1 key2 a 1 2 1 2 8 4 b 1 14 7 2 20 10 使用 DataFrame 列 In [29]: frame = DataFrame ({ 'a' : range ( 7 ), 'b' : range ( 7 , 0 , - 1 ), 'c' : [ 'one' , 'one' , 'one' , 'two' , 'two' , 'two' , 'two' ], 'd' : [ 0 , 1 , 2 , 0 , 1 , 2 , 3 ]}) frame Out[29]: a b c d 0 0 7 one 0 1 1 6 one 1 2 2 5 one 2 3 3 4 two 0 4 4 3 two 1 5 5 2 two 2 6 6 1 two 3 In [31]: # set_index(): 将列转化为索引 frame2 = frame . set_index ([ 'c' , 'd' ]) frame2 Out[31]: a b c d one 0 0 7 1 1 6 2 2 5 two 0 3 4 1 4 3 2 5 2 3 6 1 In [33]: # 转化为索引，同时保留列 frame . set_index ([ 'c' , 'd' ], drop = False ) Out[33]: a b c d c d one 0 0 7 one 0 1 1 6 one 1 2 2 5 one 2 two 0 3 4 two 0 1 4 3 two 1 2 5 2 two 2 3 6 1 two 3 In [35]: # reset_index(): 将索引转化为列 frame2 . reset_index () Out[35]: c d a b 0 one 0 0 7 1 one 1 1 6 2 one 2 2 5 3 two 0 3 4 4 two 1 4 3 5 two 2 5 2 6 two 3 6 1 In [ ]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/03/01/python_data_analysis5-5.html"},{"title":"利用Python进行数据分析(5.6)：Pandas 其他","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } In [1]: % pylab inline from pandas import Series , DataFrame import pandas as pd Populating the interactive namespace from numpy and matplotlib 《 利用Python进行数据分析 》 作者: Wes McKinney 译者: 唐学韬 其他关于 Pandas的话题 整数索引 In [5]: ser = Series ( np . arange ( 3. )) ser Out[5]: 0 0.0 1 1.0 2 2.0 dtype: float64 In [6]: ser . iloc [ - 1 ] Out[6]: 2.0 In [7]: ser2 = Series ( np . arange ( 3. ), index = [ 'a' , 'b' , 'c' ]) ser2 [ - 1 ] Out[7]: 2.0 In [8]: #ix函数总是面向标签的 ser . ix [: 1 ] Out[8]: 0 0.0 1 1.0 dtype: float64 In [ ]: ser3 = Series ( range ( 3 ), index = [ - 5 , 1 , 3 ]) ser3 . iloc [ 2 ] In [9]: #如果需要可靠的、不考虑索引类型的、基于位置的索引，可以使用Series的iget_value方法，Dataframe的irow 和 icol方法 frame = DataFrame ( np . arange ( 6 ) . reshape (( 3 , 2 )), index = [ 2 , 0 , 1 ]) frame . iloc [ 0 ] Out[9]: 0 0 1 1 Name: 2, dtype: int64 面板数据 可以看做是三维的 DataFrame， 但是通常用多层索引的 DataFrame，而不是使用 Panel。 In [11]: #可以利用DataFrame对象组成的字典或者一个三维ndarray来创建Panel对象 from pandas_datareader import data , wb pdata = pd . Panel ( dict (( stk , data . get_data_yahoo ( stk )) for stk in [ 'AAPL' , 'GOOG' , 'MSFT' , 'DELL' ])) In [12]: pdata Out[12]: Dimensions: 4 (items) x 1821 (major_axis) x 6 (minor_axis) Items axis: AAPL to MSFT Major_axis axis: 2010-01-04 00:00:00 to 2017-02-28 00:00:00 Minor_axis axis: Open to Adj Close In [13]: pdata = pdata . swapaxes ( 'items' , 'minor' ) pdata [ 'Adj Close' ] Out[13]: AAPL DELL GOOG MSFT Date 2010-01-04 27.727039 14.06528 313.062468 25.555485 2010-01-05 27.774976 14.38450 311.683844 25.563741 2010-01-06 27.333178 14.10397 303.826685 25.406859 2010-01-07 27.282650 14.23940 296.753749 25.142634 2010-01-08 27.464034 14.36516 300.709808 25.316031 2010-01-11 27.221758 14.37483 300.255255 24.994007 2010-01-12 26.912110 14.56830 294.945572 24.828866 2010-01-13 27.291720 14.57797 293.252243 25.060064 2010-01-14 27.133657 14.22005 294.630868 25.563741 2010-01-15 26.680198 13.92985 289.710772 25.481172 2010-01-19 27.860485 14.32646 293.516976 25.679340 2010-01-20 27.431644 14.03626 289.915587 25.258232 2010-01-21 26.957455 13.92017 291.199286 24.779325 2010-01-22 25.620401 13.18982 274.730736 23.912336 2010-01-25 26.309658 13.43650 269.730740 24.209590 2010-01-26 26.681494 13.13662 270.939526 24.358216 2010-01-27 26.932840 13.08825 270.779695 24.498586 2010-01-28 25.819922 12.84641 266.878565 24.077477 2010-01-29 24.883208 12.47882 264.705742 23.268290 2010-02-01 25.229131 12.78837 266.244198 23.458201 2010-02-02 25.375533 12.86576 265.295156 23.499485 2010-02-03 25.812149 12.92380 270.140309 23.639855 2010-02-04 24.881912 12.58523 263.127321 22.987551 2010-02-05 25.323710 12.80772 265.380075 23.136177 2010-02-08 25.150100 12.95282 266.468996 22.888466 2010-02-09 25.418289 13.10760 267.952522 23.127920 2010-02-10 25.279660 13.30107 266.958496 23.111406 2010-02-11 25.739595 13.49454 267.932539 23.218748 2010-02-12 25.961142 13.38813 266.294170 23.061864 2010-02-16 26.352412 13.67834 270.380071 23.518124 ... ... ... ... ... 2017-01-17 119.481976 NaN 804.609985 62.153195 2017-01-18 119.472017 NaN 806.070007 62.123377 2017-01-19 119.262925 NaN 802.174988 61.924581 2017-01-20 119.481976 NaN 805.020020 62.361932 2017-01-23 119.561633 NaN 819.309998 62.580604 2017-01-24 119.452107 NaN 823.869995 63.137231 2017-01-25 121.353858 NaN 835.669983 63.296267 2017-01-26 121.413604 NaN 832.150024 63.882708 2017-01-27 121.423555 NaN 823.309998 65.383610 2017-01-30 121.104937 NaN 802.320007 64.737526 2017-01-31 120.826147 NaN 796.789978 64.260423 2017-02-01 128.194203 NaN 795.695007 63.196871 2017-02-02 127.975152 NaN 798.530029 62.789338 2017-02-03 128.522781 NaN 801.489990 63.296267 2017-02-06 129.727549 NaN 801.340027 63.256507 2017-02-07 130.962201 NaN 806.969971 63.047773 2017-02-08 131.469994 NaN 808.380005 62.958315 2017-02-09 132.419998 NaN 809.559998 63.673974 2017-02-10 132.119995 NaN 813.669983 63.614338 2017-02-13 133.289993 NaN 819.239990 64.330000 2017-02-14 135.020004 NaN 820.450012 64.570000 2017-02-15 135.509995 NaN 818.979980 64.529999 2017-02-16 135.350006 NaN 824.159973 64.519997 2017-02-17 135.720001 NaN 828.070007 64.620003 2017-02-21 136.699997 NaN 831.659973 64.489998 2017-02-22 137.110001 NaN 830.760010 64.360001 2017-02-23 136.529999 NaN 831.330017 64.620003 2017-02-24 136.660004 NaN 828.640015 64.620003 2017-02-27 136.929993 NaN 829.280029 64.230003 2017-02-28 136.990005 NaN 823.210022 63.980000 1821 rows × 4 columns In [14]: pdata . ix [:, '6/1/2012' , :] Out[14]: Open High Low Close Volume Adj Close AAPL 569.159996 572.650009 560.520012 560.989983 130246900.0 72.681610 DELL 12.150000 12.300000 12.045000 12.070000 19397600.0 11.675920 GOOG 571.790972 572.650996 568.350996 570.981000 6138700.0 285.205295 MSFT 28.760000 28.959999 28.440001 28.450001 56634300.0 24.942239 In [15]: pdata . ix [ 'Adj Close' , '5/22/2012' :, :] Out[15]: AAPL DELL GOOG MSFT Date 2012-05-22 72.160786 14.58765 300.100412 26.090721 2012-05-23 73.921494 12.08221 304.426106 25.520864 2012-05-24 73.242607 12.04351 301.528978 25.485795 2012-05-25 72.850038 12.05319 295.470050 25.477028 2012-05-28 NaN 12.05319 NaN NaN 2012-05-29 74.143041 12.24666 296.873645 25.915380 2012-05-30 75.037005 12.14992 293.821674 25.722505 2012-05-31 74.850442 11.92743 290.140354 25.591000 2012-06-01 72.681610 11.67592 285.205295 24.942239 2012-06-04 73.109156 11.60821 289.006480 25.029908 2012-06-05 72.920005 11.76298 284.920579 24.994841 2012-06-06 74.038104 11.81619 289.995487 25.731273 2012-06-07 74.071787 11.73396 288.826666 25.626067 2012-06-08 75.185997 11.72429 289.935570 25.994283 2012-06-11 74.000526 11.47278 283.966519 25.336755 2012-06-12 74.647030 11.57919 282.268201 25.678671 2012-06-13 74.128794 11.87423 280.265216 25.538397 2012-06-14 74.047168 11.93711 279.246220 25.722505 2012-06-15 74.384024 11.89841 281.973510 26.318665 2012-06-18 75.893391 12.01449 285.140358 26.160857 2012-06-19 76.104579 11.78233 290.475012 26.914824 2012-06-20 75.888208 11.89841 288.467038 27.116465 2012-06-21 74.842665 11.60821 282.323161 26.423868 2012-06-22 75.416614 11.80168 285.455033 26.914824 2012-06-25 73.948707 11.55500 280.070407 26.187159 2012-06-26 74.111953 11.53565 282.058429 26.318665 2012-06-27 74.431960 11.92743 284.366112 26.450170 2012-06-28 73.725860 11.55984 281.873596 26.222227 2012-06-29 75.662780 12.10155 289.745749 26.818386 2012-07-02 76.766625 11.98064 289.945546 26.792084 ... ... ... ... ... 2017-01-17 119.481976 NaN 804.609985 62.153195 2017-01-18 119.472017 NaN 806.070007 62.123377 2017-01-19 119.262925 NaN 802.174988 61.924581 2017-01-20 119.481976 NaN 805.020020 62.361932 2017-01-23 119.561633 NaN 819.309998 62.580604 2017-01-24 119.452107 NaN 823.869995 63.137231 2017-01-25 121.353858 NaN 835.669983 63.296267 2017-01-26 121.413604 NaN 832.150024 63.882708 2017-01-27 121.423555 NaN 823.309998 65.383610 2017-01-30 121.104937 NaN 802.320007 64.737526 2017-01-31 120.826147 NaN 796.789978 64.260423 2017-02-01 128.194203 NaN 795.695007 63.196871 2017-02-02 127.975152 NaN 798.530029 62.789338 2017-02-03 128.522781 NaN 801.489990 63.296267 2017-02-06 129.727549 NaN 801.340027 63.256507 2017-02-07 130.962201 NaN 806.969971 63.047773 2017-02-08 131.469994 NaN 808.380005 62.958315 2017-02-09 132.419998 NaN 809.559998 63.673974 2017-02-10 132.119995 NaN 813.669983 63.614338 2017-02-13 133.289993 NaN 819.239990 64.330000 2017-02-14 135.020004 NaN 820.450012 64.570000 2017-02-15 135.509995 NaN 818.979980 64.529999 2017-02-16 135.350006 NaN 824.159973 64.519997 2017-02-17 135.720001 NaN 828.070007 64.620003 2017-02-21 136.699997 NaN 831.659973 64.489998 2017-02-22 137.110001 NaN 830.760010 64.360001 2017-02-23 136.529999 NaN 831.330017 64.620003 2017-02-24 136.660004 NaN 828.640015 64.620003 2017-02-27 136.929993 NaN 829.280029 64.230003 2017-02-28 136.990005 NaN 823.210022 63.980000 1214 rows × 4 columns In [16]: stacked = pdata . ix [:, '5/30/2012' :, :] . to_frame () stacked Out[16]: Open High Low Close Volume Adj Close Date minor 2012-05-30 AAPL 569.199997 579.989990 566.559990 579.169998 132357400.0 75.037005 DELL 12.590000 12.700000 12.460000 12.560000 19787800.0 12.149920 GOOG 588.161028 591.901014 583.530999 588.230992 3827600.0 293.821674 MSFT 29.350000 29.480000 29.120001 29.340000 41585500.0 25.722505 2012-05-31 AAPL 580.740021 581.499985 571.460022 577.730019 122918600.0 74.850442 DELL 12.530000 12.540000 12.330000 12.330000 19955600.0 11.927430 GOOG 588.720982 590.001032 579.001013 580.860990 5958800.0 290.140354 MSFT 29.299999 29.420000 28.940001 29.190001 39134000.0 25.591000 2012-06-01 AAPL 569.159996 572.650009 560.520012 560.989983 130246900.0 72.681610 DELL 12.150000 12.300000 12.045000 12.070000 19397600.0 11.675920 GOOG 571.790972 572.650996 568.350996 570.981000 6138700.0 285.205295 MSFT 28.760000 28.959999 28.440001 28.450001 56634300.0 24.942239 2012-06-04 AAPL 561.500008 567.499985 548.499977 564.289978 139248900.0 73.109156 DELL 12.110000 12.112500 11.800000 12.000000 17015700.0 11.608210 GOOG 570.220958 580.491016 570.011006 578.590973 4883500.0 289.006480 MSFT 28.620001 28.780001 28.320000 28.549999 47926300.0 25.029908 2012-06-05 AAPL 561.269989 566.470001 558.330002 562.830025 97053600.0 72.920005 DELL 11.950000 12.240000 11.950000 12.160000 15620900.0 11.762980 GOOG 575.451008 578.131003 566.470986 570.410999 4697200.0 284.920579 MSFT 28.510000 28.750000 28.389999 28.510000 45715400.0 24.994841 2012-06-06 AAPL 567.770004 573.849983 565.499992 571.460022 100363900.0 74.038104 DELL 12.210000 12.280000 12.090000 12.215000 20779900.0 11.816190 GOOG 576.480979 581.970971 573.611004 580.570966 4207200.0 289.995487 MSFT 28.879999 29.370001 28.809999 29.350000 46860500.0 25.731273 2012-06-07 AAPL 577.290009 577.320023 570.500000 571.720001 94941700.0 74.071787 DELL 12.320000 12.410000 12.120000 12.130000 20074000.0 11.733960 GOOG 587.601014 587.891038 577.251006 578.230986 3530100.0 288.826666 MSFT 29.639999 29.700001 29.170000 29.230000 37792800.0 25.626067 2012-06-08 AAPL 571.599998 580.580017 568.999992 580.319984 86879100.0 75.185997 DELL 12.130000 12.225000 12.020000 12.120000 18155600.0 11.724290 ... ... ... ... ... ... ... ... 2017-02-14 AAPL 133.470001 135.089996 133.250000 135.020004 32815500.0 135.020004 GOOG 819.000000 823.000000 816.000000 820.450012 1053600.0 820.450012 MSFT 64.410004 64.720001 64.019997 64.570000 23065900.0 64.570000 2017-02-15 AAPL 135.520004 136.270004 134.619995 135.509995 35501600.0 135.509995 GOOG 819.359985 823.000000 818.469971 818.979980 1304000.0 818.979980 MSFT 64.500000 64.570000 64.160004 64.529999 16917000.0 64.529999 2017-02-16 AAPL 135.669998 135.899994 134.839996 135.350006 22118000.0 135.350006 GOOG 819.929993 824.400024 818.979980 824.159973 1281700.0 824.159973 MSFT 64.739998 65.239998 64.440002 64.519997 20524700.0 64.519997 2017-02-17 AAPL 135.100006 135.830002 135.100006 135.720001 22084500.0 135.720001 GOOG 823.020020 828.070007 821.655029 828.070007 1597800.0 828.070007 MSFT 64.470001 64.690002 64.300003 64.620003 21234600.0 64.620003 2017-02-21 AAPL 136.229996 136.750000 135.979996 136.699997 24265100.0 136.699997 GOOG 828.659973 833.450012 828.349976 831.659973 1247700.0 831.659973 MSFT 64.610001 64.949997 64.449997 64.489998 19384900.0 64.489998 2017-02-22 AAPL 136.429993 137.119995 136.110001 137.110001 20745300.0 137.110001 GOOG 828.659973 833.250000 828.640015 830.760010 982900.0 830.760010 MSFT 64.330002 64.389999 64.050003 64.360001 19259700.0 64.360001 2017-02-23 AAPL 137.380005 137.479996 136.300003 136.529999 20704100.0 136.529999 GOOG 830.119995 832.460022 822.880005 831.330017 1470100.0 831.330017 MSFT 64.419998 64.730003 64.190002 64.620003 20235200.0 64.620003 2017-02-24 AAPL 135.910004 136.660004 135.279999 136.660004 21690900.0 136.660004 GOOG 827.729980 829.000000 824.200012 828.640015 1386600.0 828.640015 MSFT 64.529999 64.800003 64.139999 64.620003 21705200.0 64.620003 2017-02-27 AAPL 137.139999 137.440002 136.279999 136.929993 20196400.0 136.929993 GOOG 824.549988 830.500000 824.000000 829.280029 1099500.0 829.280029 MSFT 64.540001 64.540001 64.050003 64.230003 15850400.0 64.230003 2017-02-28 AAPL 137.080002 137.440002 136.699997 136.990005 23403500.0 136.990005 GOOG 825.609985 828.539978 820.200012 823.210022 2252300.0 823.210022 MSFT 64.080002 64.199997 63.759998 63.980000 23043900.0 63.980000 3955 rows × 6 columns In [17]: stacked . to_panel () Out[17]: Dimensions: 6 (items) x 1208 (major_axis) x 4 (minor_axis) Items axis: Open to Adj Close Major_axis axis: 2012-05-30 00:00:00 to 2017-02-28 00:00:00 Minor_axis axis: AAPL to MSFT In [ ]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/03/01/python_data_analysis5-6.html"},{"title":"利用Python进行数据分析(5.4)：处理缺失数据","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } In [1]: % pylab inline from pandas import Series , DataFrame import pandas as pd Populating the interactive namespace from numpy and matplotlib 《 利用Python进行数据分析 》 作者: Wes McKinney 译者: 唐学韬 处理缺失数据 数据不完整在数据分析的过程中很常见。 pandas使用浮点值 NaN 表示浮点和非浮点数组里的缺失数据。 pandas使用 isnull() 和 notnull() 函数来判断缺失情况。 对于缺失数据一般处理方法为: 滤掉, 使用 dropna() 填充，使用 fillna ，比如 ffill(指定值）或 bfill（插值 In [2]: string_data = Series ([ 'aardvark' , 'artichoke' , np . nan , 'avocado' ]) string_data Out[2]: 0 aardvark 1 artichoke 2 NaN 3 avocado dtype: object In [3]: string_data . isnull () Out[3]: 0 False 1 False 2 True 3 False dtype: bool In [5]: # None 也被认为是缺失 string_data [ 0 ] = None string_data . isnull () Out[5]: 0 True 1 False 2 True 3 False dtype: bool 滤除缺失数据 In [7]: from numpy import nan as NA data = Series ([ 1 , NA , 3.5 , NA , 7 ]) data Out[7]: 0 1.0 1 NaN 2 3.5 3 NaN 4 7.0 dtype: float64 In [8]: # 使用 dropna()方法滤除 data . dropna () Out[8]: 0 1.0 2 3.5 4 7.0 dtype: float64 In [10]: # 等价方法 data [ data . notnull ()] Out[10]: 0 1.0 2 3.5 4 7.0 dtype: float64 In [14]: # 对于 DataFrame, 会 drop 掉所有有 NA 的行 data = DataFrame ([[ 1. , 6.5 , 3. ], [ 1. , NA , NA ], [ NA , NA , NA ], [ NA , 6.5 , 3. ]]) cleaned = data . dropna () data Out[14]: 0 1 2 0 1.0 6.5 3.0 1 1.0 NaN NaN 2 NaN NaN NaN 3 NaN 6.5 3.0 In [13]: cleaned Out[13]: 0 1 2 0 1.0 6.5 3.0 In [15]: # 只丢弃全为空的行 data . dropna ( how = 'all' ) Out[15]: 0 1 2 0 1.0 6.5 3.0 1 1.0 NaN NaN 3 NaN 6.5 3.0 In [16]: data [ 4 ] = NA data Out[16]: 0 1 2 4 0 1.0 6.5 3.0 NaN 1 1.0 NaN NaN NaN 2 NaN NaN NaN NaN 3 NaN 6.5 3.0 NaN In [17]: # 丢弃列 data . dropna ( axis = 1 , how = 'all' ) Out[17]: 0 1 2 0 1.0 6.5 3.0 1 1.0 NaN NaN 2 NaN NaN NaN 3 NaN 6.5 3.0 In [18]: df = DataFrame ( np . random . randn ( 7 , 3 )) df . ix [: 4 , 1 ] = NA ; df . ix [: 2 , 2 ] = NA df Out[18]: 0 1 2 0 -1.890923 NaN NaN 1 1.020294 NaN NaN 2 -3.132870 NaN NaN 3 0.541084 NaN -0.203774 4 2.200062 NaN 1.775465 5 -0.458244 0.208688 -0.027016 6 -1.291057 0.391487 -1.341282 In [21]: # thresh ：选取至少包含多少个非空值的行 df . dropna ( thresh = 2 ) Out[21]: 0 1 2 3 0.541084 NaN -0.203774 4 2.200062 NaN 1.775465 5 -0.458244 0.208688 -0.027016 6 -1.291057 0.391487 -1.341282 填充缺失数据 In [24]: # 用指定值填充 df . fillna ( 0 ) Out[24]: 0 1 2 0 -1.890923 0.000000 0.000000 1 1.020294 0.000000 0.000000 2 -3.132870 0.000000 0.000000 3 0.541084 0.000000 -0.203774 4 2.200062 0.000000 1.775465 5 -0.458244 0.208688 -0.027016 6 -1.291057 0.391487 -1.341282 In [26]: # 每列用不同的值填充 df . fillna ({ 1 : 0.5 , 3 : - 1 }) Out[26]: 0 1 2 0 -1.890923 0.500000 NaN 1 1.020294 0.500000 NaN 2 -3.132870 0.500000 NaN 3 0.541084 0.500000 -0.203774 4 2.200062 0.500000 1.775465 5 -0.458244 0.208688 -0.027016 6 -1.291057 0.391487 -1.341282 In [27]: # inplace: 不返回新对象，就地修改 _ = df . fillna ( 0 , inplace = True ) df Out[27]: 0 1 2 0 -1.890923 0.000000 0.000000 1 1.020294 0.000000 0.000000 2 -3.132870 0.000000 0.000000 3 0.541084 0.000000 -0.203774 4 2.200062 0.000000 1.775465 5 -0.458244 0.208688 -0.027016 6 -1.291057 0.391487 -1.341282 In [28]: df = DataFrame ( np . random . randn ( 6 , 3 )) df . ix [ 2 :, 1 ] = NA ; df . ix [ 4 :, 2 ] = NA df Out[28]: 0 1 2 0 -0.201570 -0.301825 -0.292899 1 0.407622 0.154548 0.337993 2 -1.390216 NaN 1.952913 3 -0.155158 NaN 0.732646 4 -1.391272 NaN NaN 5 -0.155741 NaN NaN In [30]: # 用前值填充 df . fillna ( method = 'ffill' ) Out[30]: 0 1 2 0 -0.201570 -0.301825 -0.292899 1 0.407622 0.154548 0.337993 2 -1.390216 0.154548 1.952913 3 -0.155158 0.154548 0.732646 4 -1.391272 0.154548 0.732646 5 -0.155741 0.154548 0.732646 In [32]: # 用前值，最多填充2次 df . fillna ( method = 'ffill' , limit = 2 ) Out[32]: 0 1 2 0 -0.201570 -0.301825 -0.292899 1 0.407622 0.154548 0.337993 2 -1.390216 0.154548 1.952913 3 -0.155158 0.154548 0.732646 4 -1.391272 NaN 0.732646 5 -0.155741 NaN 0.732646 In [34]: # 用平均值填充 data = Series ([ 1. , NA , 3.5 , NA , 7 ]) data . fillna ( data . mean ()) Out[34]: 0 1.000000 1 3.833333 2 3.500000 3 3.833333 4 7.000000 dtype: float64 fillna()参数汇总： value method, 插值方法，默认为 ffill axis, inplace limit In [ ]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/28/python_data_analysis5-4.html"},{"title":"利用Python进行数据分析(5.3)：Pandas 计算汇总和描述统计","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } In [1]: % pylab inline from pandas import Series , DataFrame import pandas as pd Populating the interactive namespace from numpy and matplotlib 《 利用Python进行数据分析 》 作者: Wes McKinney 译者: 唐学韬 汇总和描述性统计 Pandas 实现了一些简单简单的汇总和描述性统计功能，更复杂的统计计算可以使用 Scipy 的 stats 模块。 基本统计 包括： count: 计数 describe: 各列的汇总统计 min, max: 最小值和最大值 argmin, argmax: 最小值和最大值的索引位置 idxmin, idxmax: 最小值和最大值 的索引值 quantile: 样本的分位数(0--1) sum: 求和 mean: 平均数 median: 中位数（0.5分位数） mad: 平均绝对离差 var: 方差 std: 标准差 skew: 偏度（三阶矩） kurt: 峰度（四阶矩） cumsum: 累计和 cummin, cummax: 累计最小、最大值 cumprod: 累计积 diff: 一阶差分（用于时间序列） pct_change: 百分数变化 In [2]: df = DataFrame ([[ 1.4 , np . nan ], [ 7.1 , - 4.5 ], [ np . nan , np . nan ], [ 0.75 , - 1.3 ]], index = [ 'a' , 'b' , 'c' , 'd' ], columns = [ 'one' , 'two' ]) df Out[2]: one two a 1.40 NaN b 7.10 -4.5 c NaN NaN d 0.75 -1.3 In [3]: # 求和 df . sum () Out[3]: one 9.25 two -5.80 dtype: float64 In [5]: # 按行求和 df . sum ( axis = 1 ) Out[5]: a 1.40 b 2.60 c 0.00 d -0.55 dtype: float64 In [6]: # 不忽略 NA df . mean ( axis = 1 , skipna = False ) Out[6]: a NaN b 1.300 c NaN d -0.275 dtype: float64 In [9]: # 返回索引 df . idxmax () Out[9]: one b two d dtype: object In [10]: # 累加型 df . cumsum () Out[10]: one two a 1.40 NaN b 8.50 -4.5 c NaN NaN d 9.25 -5.8 In [11]: # 描述 df . describe () Out[11]: one two count 3.000000 2.000000 mean 3.083333 -2.900000 std 3.493685 2.262742 min 0.750000 -4.500000 25% 1.075000 -3.700000 50% 1.400000 -2.900000 75% 4.250000 -2.100000 max 7.100000 -1.300000 In [12]: # 非数值型的描述 obj = Series ([ 'a' , 'a' , 'b' , 'c' ] * 4 ) obj . describe () Out[12]: count 16 unique 3 top a freq 8 dtype: object 相关系数(Correlation)与协方差(covariance) In [26]: from pandas_datareader import data , wb all_data = {} for ticker in [ 'AAPL' , 'IBM' , 'MSFT' , 'GOOG' ]: all_data [ ticker ] = data . get_data_yahoo ( ticker ) price = DataFrame ({ tic : data [ 'Adj Close' ] for tic , data in all_data . items ()}) volume = DataFrame ({ tic : data [ 'Volume' ] for tic , data in all_data . items ()}) In [27]: price Out[27]: AAPL GOOG IBM MSFT Date 2010-01-04 27.727039 313.062468 111.405000 25.555485 2010-01-05 27.774976 311.683844 110.059232 25.563741 2010-01-06 27.333178 303.826685 109.344283 25.406859 2010-01-07 27.282650 296.753749 108.965786 25.142634 2010-01-08 27.464034 300.709808 110.059232 25.316031 2010-01-11 27.221758 300.255255 108.906903 24.994007 2010-01-12 26.912110 294.945572 109.773245 24.828866 2010-01-13 27.291720 293.252243 109.537735 25.060064 2010-01-14 27.133657 294.630868 111.287245 25.563741 2010-01-15 26.680198 289.710772 110.841458 25.481172 2010-01-19 27.860485 293.516976 112.826478 25.679340 2010-01-20 27.431644 289.915587 109.554561 25.258232 2010-01-21 26.957455 291.199286 108.503173 24.779325 2010-01-22 25.620401 274.730736 105.559289 23.912336 2010-01-25 26.309658 269.730740 106.080779 24.209590 2010-01-26 26.681494 270.939526 105.769566 24.358216 2010-01-27 26.932840 270.779695 106.257412 24.498586 2010-01-28 25.819922 266.878565 104.087347 24.077477 2010-01-29 24.883208 264.705742 102.943437 23.268290 2010-02-01 25.229131 266.244198 104.861166 23.458201 2010-02-02 25.375533 265.295156 105.584521 23.499485 2010-02-03 25.812149 270.140309 105.693870 23.639855 2010-02-04 24.881912 263.127321 103.456514 22.987551 2010-02-05 25.323710 265.380075 103.893889 23.136177 2010-02-08 25.150100 266.468996 102.972982 22.888466 2010-02-09 25.418289 267.952522 104.096663 23.127920 2010-02-10 25.279660 266.958496 103.758713 23.111406 2010-02-11 25.739595 267.932539 104.536000 23.218748 2010-02-12 25.961142 266.294170 104.764113 23.061864 2010-02-16 26.352412 270.380071 105.803308 23.518124 ... ... ... ... ... 2017-01-12 118.735214 806.359985 166.632452 62.232715 2017-01-13 118.526121 807.880005 166.027237 62.322172 2017-01-17 119.481976 804.609985 166.572925 62.153195 2017-01-18 119.472017 806.070007 165.491479 62.123377 2017-01-19 119.262925 802.174988 165.501396 61.924581 2017-01-20 119.481976 805.020020 169.212061 62.361932 2017-01-23 119.561633 819.309998 169.688291 62.580604 2017-01-24 119.452107 823.869995 174.520082 63.137231 2017-01-25 121.353858 835.669983 176.891332 63.296267 2017-01-26 121.413604 832.150024 177.258440 63.882708 2017-01-27 121.423555 823.309998 175.909108 65.383610 2017-01-30 121.104937 802.320007 174.420876 64.737526 2017-01-31 120.826147 796.789978 173.150918 64.260423 2017-02-01 128.194203 795.695007 172.922712 63.196871 2017-02-02 127.975152 798.530029 173.210445 62.789338 2017-02-03 128.522781 801.489990 174.440723 63.296267 2017-02-06 129.727549 801.340027 174.480403 63.256507 2017-02-07 130.962201 806.969971 177.060012 63.047773 2017-02-08 131.469994 808.380005 176.169998 62.958315 2017-02-09 132.419998 809.559998 177.210007 63.673974 2017-02-10 132.119995 813.669983 178.679993 63.614338 2017-02-13 133.289993 819.239990 179.360001 64.330000 2017-02-14 135.020004 820.450012 180.130005 64.570000 2017-02-15 135.509995 818.979980 181.679993 64.529999 2017-02-16 135.350006 824.159973 181.429993 64.519997 2017-02-17 135.720001 828.070007 180.669998 64.620003 2017-02-21 136.699997 831.659973 180.259995 64.489998 2017-02-22 137.110001 830.760010 181.149994 64.360001 2017-02-23 136.529999 831.330017 181.649994 64.620003 2017-02-24 136.660004 828.640015 181.350006 64.620003 1799 rows × 4 columns In [28]: returns = price . pct_change () returns . tail () Out[28]: AAPL GOOG IBM MSFT Date 2017-02-17 0.002734 0.004744 -0.004189 0.001550 2017-02-21 0.007221 0.004335 -0.002269 -0.002012 2017-02-22 0.002999 -0.001082 0.004937 -0.002016 2017-02-23 -0.004230 0.000686 0.002760 0.004040 2017-02-24 0.000952 -0.003236 -0.001651 0.000000 In [39]: # 相关系数 print ( returns . MSFT . corr ( returns . IBM )) # 协方差 print ( returns . MSFT . cov ( returns . IBM )) 0.495166900181 8.58872503835e-05 In [40]: # 相关系数矩阵 returns . corr () Out[40]: AAPL GOOG IBM MSFT AAPL 1.000000 0.409523 0.381495 0.388913 GOOG 0.409523 1.000000 0.402880 0.470810 IBM 0.381495 0.402880 1.000000 0.495167 MSFT 0.388913 0.470810 0.495167 1.000000 In [41]: # 协方差矩阵 returns . cov () Out[41]: AAPL GOOG IBM MSFT AAPL 0.000269 0.000105 0.000075 0.000092 GOOG 0.000105 0.000244 0.000075 0.000106 IBM 0.000075 0.000075 0.000144 0.000086 MSFT 0.000092 0.000106 0.000086 0.000209 In [44]: # 一组相关系数 returns . corrwith ( returns . IBM ) Out[44]: AAPL 0.381495 GOOG 0.402880 IBM 1.000000 MSFT 0.495167 dtype: float64 In [45]: # 一组相关系数( 回报百分比与成交量之间) returns . corrwith ( volume ) Out[45]: AAPL -0.074047 GOOG -0.009542 IBM -0.194405 MSFT -0.091078 dtype: float64 唯一值，值计数和成员资格 In [46]: obj = Series ([ 'c' , 'a' , 'd' , 'a' , 'a' , 'b' , 'b' , 'c' , 'c' ]) In [47]: uniques = obj . unique () uniques Out[47]: array(['c', 'a', 'd', 'b'], dtype=object) In [48]: obj . value_counts () Out[48]: a 3 c 3 b 2 d 1 dtype: int64 In [49]: pd . value_counts ( obj . values , sort = False ) Out[49]: b 2 d 1 c 3 a 3 dtype: int64 In [50]: mask = obj . isin ([ 'b' , 'c' ]) mask Out[50]: 0 True 1 False 2 False 3 False 4 False 5 True 6 True 7 True 8 True dtype: bool In [54]: # 通过 `isin()`的结果进行筛选 obj [ mask ] Out[54]: 0 c 5 b 6 b 7 c 8 c dtype: object In [52]: data = DataFrame ({ 'Qu1' : [ 1 , 3 , 4 , 3 , 4 ], 'Qu2' : [ 2 , 3 , 1 , 2 , 3 ], 'Qu3' : [ 1 , 5 , 2 , 4 , 4 ]}) data Out[52]: Qu1 Qu2 Qu3 0 1 2 1 1 3 3 5 2 4 1 2 3 3 2 4 4 4 3 4 In [55]: result = data . apply ( pd . value_counts ) . fillna ( 0 ) result Out[55]: Qu1 Qu2 Qu3 1 1.0 1.0 1.0 2 0.0 2.0 1.0 3 2.0 2.0 0.0 4 2.0 0.0 2.0 5 0.0 0.0 1.0 In [ ]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/27/python_data_analysis5-3.html"},{"title":"利用Python进行数据分析(5.1)：Pandas 中的数据结构","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } In [39]: % pylab inline from pandas import Series , DataFrame import pandas as pd Populating the interactive namespace from numpy and matplotlib 《 利用Python进行数据分析 》 作者: Wes McKinney 译者: 唐学韬 Pandas中两个主要的数据结构是 Series 和 DataFrame ，两个数据结构中都使用了索引( Index )对象。 Series Series是一组带索引的数组。包含一组数据（各种NumPy数据类型）和与之相关的一组数据标签（即索引）。 可以用index和values分别规定索引和值。如果不规定索引，会自动创建 0 到 N-1 索引。 最简单的 Series In [40]: # 只包含一组数据的 Series obj = Series ([ 4 , 7 , - 5 , 3 ]) obj Out[40]: 0 4 1 7 2 -5 3 3 dtype: int64 In [41]: obj . index Out[41]: RangeIndex(start=0, stop=4, step=1) In [42]: obj . values Out[42]: array([ 4, 7, -5, 3]) 指定索引 In [43]: obj2 = Series ([ 4 , 7 , - 5 , 3 ], index = [ 'd' , 'b' , 'a' , 'c' ]) obj2 Out[43]: d 4 b 7 a -5 c 3 dtype: int64 通过索引获取数据 In [44]: # 取单行数据 obj2 [ 'd' ] Out[44]: 4 In [45]: # 取多行数据 obj2 [[ 'c' , 'a' , 'd' ]] Out[45]: c 3 a -5 d 4 dtype: int64 按条件获取数据 In [46]: obj2 [ obj2 > 0 ] Out[46]: d 4 b 7 c 3 dtype: int64 数组运算 对数组进行计算，只改变值，不会改变索引 In [47]: obj2 * 2 Out[47]: d 8 b 14 a -10 c 6 dtype: int64 In [48]: np . exp ( obj2 ) Out[48]: d 54.598150 b 1096.633158 a 0.006738 c 20.085537 dtype: float64 改变索引 In [49]: obj2 Out[49]: d 4 b 7 a -5 c 3 dtype: int64 In [50]: obj2 . index = [ 'Bob' , 'Steve' , 'Jeff' , 'Ryan' ] obj2 Out[50]: Bob 4 Steve 7 Jeff -5 Ryan 3 dtype: int64 作为Dictionary 可以将 Series 看作一个定长有序字典。 In [51]: 'b' in obj2 Out[51]: False In [52]: # 通过 Dictionary 直接创建 Series sdata = { 'Ohio' : 35000 , 'Texas' : 71000 , 'Oregon' : 16000 , 'Utah' : 5000 } obj3 = Series ( sdata ) obj3 Out[52]: Ohio 35000 Oregon 16000 Texas 71000 Utah 5000 dtype: int64 In [53]: # 重建索引，并按索引筛选数据 # 注意，索引 `California` 对应的值为 NaN states = [ 'California' , 'Ohio' , 'Oregon' , 'Texas' ] obj4 = Series ( sdata , index = states ) obj4 Out[53]: California NaN Ohio 35000.0 Oregon 16000.0 Texas 71000.0 dtype: float64 In [ ]: 数据检查 In [54]: pd . isnull ( obj4 ) # 等价于 obj4.isnull() Out[54]: California True Ohio False Oregon False Texas False dtype: bool In [55]: pd . notnull ( obj4 ) # 等价于 obj4.notnull() Out[55]: California False Ohio True Oregon True Texas True dtype: bool 自动对齐索引 Series很重要的功能就是按照索引自动对齐。 In [56]: obj3 Out[56]: Ohio 35000 Oregon 16000 Texas 71000 Utah 5000 dtype: int64 In [57]: obj4 Out[57]: California NaN Ohio 35000.0 Oregon 16000.0 Texas 71000.0 dtype: float64 In [58]: obj3 + obj4 Out[58]: California NaN Ohio 70000.0 Oregon 32000.0 Texas 142000.0 Utah NaN dtype: float64 命名 Series 自身和索引都可以命名。这个设计对于 Pandas 其他模块很重要。 In [59]: obj4 . name = 'population' obj4 . index . name = 'state' obj4 Out[59]: state California NaN Ohio 35000.0 Oregon 16000.0 Texas 71000.0 Name: population, dtype: float64 In [60]: obj4 . index Out[60]: Index(['California', 'Ohio', 'Oregon', 'Texas'], dtype='object', name='state') DataFrame DataFrame 是一种表格型结构，含有一组有序的列，每一列可以是不同的数据类型。 DataFrame 可以看做是共用索引的、由Series组成的字典。其中，共用的索引是整个 DataFrame 的行索引，而各个 Series 的名字作为列索引。 DataFrame面向行和列的操作基本是平衡的。其实，DataFrame中的数据是以一个或者多个二维块存放的（不是列表、字典或者其他）。 创建 DataFrame In [92]: # 使用字典创建 data = { 'state' : [ 'Ohio' , 'Ohio' , 'Ohio' , 'Nevada' , 'Nevada' ], 'year' : [ 2000 , 2001 , 2002 , 2001 , 2002 ], 'pop' : [ 1.5 , 1.7 , 3.6 , 2.4 , 2.9 ]} frame = DataFrame ( data ) frame Out[92]: pop state year 0 1.5 Ohio 2000 1 1.7 Ohio 2001 2 3.6 Ohio 2002 3 2.4 Nevada 2001 4 2.9 Nevada 2002 In [66]: # 更改列顺序 DataFrame ( data , columns = [ 'year' , 'state' , 'pop' ]) Out[66]: year state pop 0 2000 Ohio 1.5 1 2001 Ohio 1.7 2 2002 Ohio 3.6 3 2001 Nevada 2.4 4 2002 Nevada 2.9 In [68]: # 与行索引的机制类似，找不到的列，会用 NaN 填充 frame2 = DataFrame ( data , columns = [ 'year' , 'state' , 'pop' , 'debt' ], index = [ 'one' , 'two' , 'three' , 'four' , 'five' ]) frame2 Out[68]: year state pop debt one 2000 Ohio 1.5 NaN two 2001 Ohio 1.7 NaN three 2002 Ohio 3.6 NaN four 2001 Nevada 2.4 NaN five 2002 Nevada 2.9 NaN 得到列 In [70]: # 列是关于 Series 的字典 frame2 . columns Out[70]: Index(['year', 'state', 'pop', 'debt'], dtype='object') In [72]: # 获取某一列 frame2 [ 'state' ] Out[72]: one Ohio two Ohio three Ohio four Nevada five Nevada Name: state, dtype: object In [74]: # 也可以用属性的方式获取 DataFrame 中的某一列 frame2 . year Out[74]: one 2000 two 2001 three 2002 four 2001 five 2002 Name: year, dtype: int64 In [78]: # 获取多个列，还是 DataFrame, 此时为\"切片\"操作 frame2 [[ 'state' , 'year' ]] Out[78]: state year one Ohio 2000 two Ohio 2001 three Ohio 2002 four Nevada 2001 five Nevada 2002 得到行 通过索引可以得到 DataFrame 的一行，行也是一个 Series. In [79]: frame2 . ix [ 'three' ] Out[79]: year 2002 state Ohio pop 3.6 debt NaN Name: three, dtype: object 按列赋值 In [81]: # 整列赋相同值 frame2 [ 'debt' ] = 16.5 frame2 Out[81]: year state pop debt one 2000 Ohio 1.5 16.5 two 2001 Ohio 1.7 16.5 three 2002 Ohio 3.6 16.5 four 2001 Nevada 2.4 16.5 five 2002 Nevada 2.9 16.5 In [84]: # 用一个 array 或 narray 对列赋值 frame2 [ 'debt' ] = np . arange ( 5. ) frame2 Out[84]: year state pop debt one 2000 Ohio 1.5 0.0 two 2001 Ohio 1.7 1.0 three 2002 Ohio 3.6 2.0 four 2001 Nevada 2.4 3.0 five 2002 Nevada 2.9 4.0 In [86]: # 使用 Series，可以根据索引对列精确赋值 # 注意其中的空值 val = Series ([ - 1.2 , - 1.5 , - 1.7 ], index = [ 'two' , 'four' , 'five' ]) frame2 [ 'debt' ] = val frame2 Out[86]: year state pop debt one 2000 Ohio 1.5 NaN two 2001 Ohio 1.7 -1.2 three 2002 Ohio 3.6 NaN four 2001 Nevada 2.4 -1.5 five 2002 Nevada 2.9 -1.7 增加和删除列 In [90]: # 对不存在的列赋值会增加列 frame2 [ 'eastern' ] = frame2 . state == 'Ohio' frame2 Out[90]: year state pop debt eastern one 2000 Ohio 1.5 NaN True two 2001 Ohio 1.7 -1.2 True three 2002 Ohio 3.6 NaN True four 2001 Nevada 2.4 -1.5 False five 2002 Nevada 2.9 -1.7 False In [91]: # 使用 `del` 删除列 del frame2 [ 'eastern' ] frame2 Out[91]: year state pop debt one 2000 Ohio 1.5 NaN two 2001 Ohio 1.7 -1.2 three 2002 Ohio 3.6 NaN four 2001 Nevada 2.4 -1.5 five 2002 Nevada 2.9 -1.7 转置 In [93]: frame2 . T Out[93]: one two three four five year 2000 2001 2002 2001 2002 state Ohio Ohio Ohio Nevada Nevada pop 1.5 1.7 3.6 2.4 2.9 debt NaN -1.2 NaN -1.5 -1.7 更多创建方法 In [95]: # 使用二维字典创建 pop = { 'Nevada' : { 2001 : 2.4 , 2002 : 2.9 }, 'Ohio' : { 2000 : 1.5 , 2001 : 1.7 , 2002 : 3.6 }} frame3 = DataFrame ( pop ) frame3 Out[95]: Nevada Ohio 2000 NaN 1.5 2001 2.4 1.7 2002 2.9 3.6 In [96]: DataFrame ( pop , index = [ 2001 , 2002 , 2003 ]) Out[96]: Nevada Ohio 2001 2.4 1.7 2002 2.9 3.6 2003 NaN NaN In [97]: pdata = { 'Ohio' : frame3 [ 'Ohio' ][: - 1 ], 'Nevada' : frame3 [ 'Nevada' ][: 2 ]} DataFrame ( pdata ) Out[97]: Nevada Ohio 2000 NaN 1.5 2001 2.4 1.7 为索引和列命名 In [98]: frame3 . index . name = 'year' ; frame3 . columns . name = 'state' frame3 Out[98]: state Nevada Ohio year 2000 NaN 1.5 2001 2.4 1.7 2002 2.9 3.6 DataFrame 的值 In [101]: # 返回 ndarray frame3 . values Out[101]: array([[ nan, 1.5], [ 2.4, 1.7], [ 2.9, 3.6]]) In [102]: # 类型不同时，自动转换为最抽象的类型 frame2 . values Out[102]: array([[2000, 'Ohio', 1.5, nan], [2001, 'Ohio', 1.7, -1.2], [2002, 'Ohio', 3.6, nan], [2001, 'Nevada', 2.4, -1.5], [2002, 'Nevada', 2.9, -1.7]], dtype=object) 索引对象 In [103]: obj = Series ( range ( 3 ), index = [ 'a' , 'b' , 'c' ]) index = obj . index index Out[103]: Index(['a', 'b', 'c'], dtype='object') In [104]: index [ 1 :] Out[104]: Index(['b', 'c'], dtype='object') In [109]: # Index 里面的数据不能更改 # index[1] = 'd' In [113]: index = pd . Index ( np . arange ( 3 )) obj2 = Series ([ 1.5 , - 2.5 , 0 ], index = index ) obj2 . index is index Out[113]: True In [114]: frame3 Out[114]: state Nevada Ohio year 2000 NaN 1.5 2001 2.4 1.7 2002 2.9 3.6 In [115]: 'Ohio' in frame3 . columns Out[115]: True In [116]: 2003 in frame3 . index Out[116]: False Index 不是数组，也不是 Series（看起来像）。Index 支持的一些方法如下： append 连接另一个 Index diff 计算差集 intersection 计算交集 union 计算并集 isin 是否全包含 delete 删除 i 初的元素，返回一个新的 Index drop 删除传入的值，返回一个新的 Index insert 插入到 i 处 is_monotonic 是否各元素都大于等于前一个元素（顺序排列） is_unique 是否没有重复值 unique 返回唯一值的数组 In [ ]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/24/python_data_analysis5-1.html"},{"title":"利用Python进行数据分析(5.2)：Pandas  基本功能","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } In [1]: % pylab inline from pandas import Series , DataFrame import pandas as pd Populating the interactive namespace from numpy and matplotlib 《 利用Python进行数据分析 》 作者: Wes McKinney 译者: 唐学韬 重建索引 Pandas 对象的重建索引（ reindex() )，会根据索引创建一个新的对象。 In [2]: obj = Series ([ 4.5 , 7.2 , - 5.3 , 3.6 ], index = [ 'd' , 'b' , 'a' , 'c' ]) obj Out[2]: d 4.5 b 7.2 a -5.3 c 3.6 dtype: float64 In [5]: # 如果传入的索引值在数据里不存在，则不会报错，而是添加缺失值的新行 obj2 = obj . reindex ([ 'a' , 'b' , 'c' , 'd' , 'e' ]) obj2 Out[5]: a -5.3 b 7.2 c 3.6 d 4.5 e NaN dtype: float64 In [6]: #如果不想用缺失值，可以用 fill_value 参数指定填充值 obj . reindex ([ 'a' , 'b' , 'c' , 'd' , 'e' ], fill_value = 0 ) Out[6]: a -5.3 b 7.2 c 3.6 d 4.5 e 0.0 dtype: float64 In [13]: obj3 = Series ([ 'blue' , 'purple' , 'yellow' ], index = [ 0 , 2 , 4 ]) # method 指定填充新值采用的差值方法 # ffill 或 pad 实现用前值填充(forward fill) obj3 . reindex ( range ( 6 ), method = 'ffill' ) Out[13]: 0 blue 1 blue 2 purple 3 purple 4 yellow 5 yellow dtype: object In [16]: # bfill 或 backfill 实现用后值填充 obj3 . reindex ( range ( 6 ), method = 'bfill' ) Out[16]: 0 blue 1 purple 2 purple 3 yellow 4 yellow 5 NaN dtype: object In [17]: # #DataFrame 的reindex可以修改行、列或者两个都改 frame = DataFrame ( np . arange ( 9 ) . reshape (( 3 , 3 )), index = [ 'a' , 'c' , 'd' ], columns = [ 'Ohio' , 'Texas' , 'California' ]) frame Out[17]: Ohio Texas California a 0 1 2 c 3 4 5 d 6 7 8 In [19]: # 默认更改行索引 frame2 = frame . reindex ([ 'a' , 'b' , 'c' , 'd' ]) frame2 Out[19]: Ohio Texas California a 0.0 1.0 2.0 b NaN NaN NaN c 3.0 4.0 5.0 d 6.0 7.0 8.0 In [20]: # 使用 columns 更改列索引 states = [ 'Texas' , 'Utah' , 'California' ] frame . reindex ( columns = states ) Out[20]: Texas Utah California a 1 NaN 2 c 4 NaN 5 d 7 NaN 8 In [21]: # 同时更改行和列索引 # 注意插值只能用在行上 frame . reindex ( index = [ 'a' , 'b' , 'c' , 'd' ], method = 'ffill' , columns = states ) Out[21]: Texas Utah California a 1 NaN 2 b 1 NaN 2 c 4 NaN 5 d 7 NaN 8 In [22]: # 使用ix的标签索引功能，重新索引变得比较简洁 # 等价于 frame.reindex(index=['a', 'b', 'c', 'd'], columns=states) frame . ix [[ 'a' , 'b' , 'c' , 'd' ], states ] Out[22]: Texas Utah California a 1.0 NaN 2.0 b NaN NaN NaN c 4.0 NaN 5.0 d 7.0 NaN 8.0 丢弃指定轴上的项 In [23]: # drop() 方法：通过索引数组或列表丢弃多个项，返回一个新的对象 obj = Series ( np . arange ( 5. ), index = [ 'a' , 'b' , 'c' , 'd' , 'e' ]) new_obj = obj . drop ( 'c' ) new_obj Out[23]: a 0.0 b 1.0 d 3.0 e 4.0 dtype: float64 In [24]: # 丢弃多项 obj . drop ([ 'd' , 'c' ]) Out[24]: a 0.0 b 1.0 e 4.0 dtype: float64 In [25]: # 对于 DataFrame data = DataFrame ( np . arange ( 16 ) . reshape (( 4 , 4 )), index = [ 'Ohio' , 'Colorado' , 'Utah' , 'New York' ], columns = [ 'one' , 'two' , 'three' , 'four' ]) data Out[25]: one two three four Ohio 0 1 2 3 Colorado 4 5 6 7 Utah 8 9 10 11 New York 12 13 14 15 In [27]: # 丢弃行 data . drop ([ 'Colorado' , 'Ohio' ]) Out[27]: one two three four Utah 8 9 10 11 New York 12 13 14 15 In [28]: # 丢弃一列 data . drop ( 'two' , axis = 1 ) Out[28]: one three four Ohio 0 2 3 Colorado 4 6 7 Utah 8 10 11 New York 12 14 15 In [29]: # 丢弃多列 data . drop ([ 'two' , 'four' ], axis = 1 ) Out[29]: one three Ohio 0 2 Colorado 4 6 Utah 8 10 New York 12 14 索引、选取和过滤 In [30]: obj = Series ( np . arange ( 4. ), index = [ 'a' , 'b' , 'c' , 'd' ]) obj Out[30]: a 0.0 b 1.0 c 2.0 d 3.0 dtype: float64 In [35]: # 通过索引选取, 以下两种方式等价 print ( obj [ 'b' ]) print ( obj [ 1 ]) 1.0 1.0 In [39]: # 连续切片 obj [ 2 : 4 ] Out[39]: c 2.0 d 3.0 dtype: float64 In [40]: # 通过索引选取 obj [[ 'b' , 'a' , 'd' ]] Out[40]: b 1.0 a 0.0 d 3.0 dtype: float64 In [41]: # 通过序号选取 obj [[ 1 , 3 ]] Out[41]: b 1.0 d 3.0 dtype: float64 In [42]: # 条件筛选 obj [ obj < 2 ] Out[42]: a 0.0 b 1.0 dtype: float64 In [46]: # 针对索引的条件筛选 obj [ 'b' : 'd' ] Out[46]: b 1.0 c 2.0 d 3.0 dtype: float64 In [49]: # 筛选并赋值 obj [ 'b' : 'd' ] = 5 obj Out[49]: a 0.0 b 5.0 c 5.0 d 5.0 dtype: float64 In [51]: # 对于 DataFrame data = DataFrame ( np . arange ( 16 ) . reshape (( 4 , 4 )), index = [ 'Ohio' , 'Colorado' , 'Utah' , 'New York' ], columns = [ 'one' , 'two' , 'three' , 'four' ]) data Out[51]: one two three four Ohio 0 1 2 3 Colorado 4 5 6 7 Utah 8 9 10 11 New York 12 13 14 15 In [52]: # 选取列 data [ 'two' ] Out[52]: Ohio 1 Colorado 5 Utah 9 New York 13 Name: two, dtype: int64 In [53]: # 选取多列 data [[ 'three' , 'one' ]] Out[53]: three one Ohio 2 0 Colorado 6 4 Utah 10 8 New York 14 12 In [55]: # data [: 2 ] Out[55]: one two three four Ohio 0 1 2 3 Colorado 4 5 6 7 In [56]: data [ data [ 'three' ] > 5 ] Out[56]: one two three four Colorado 4 5 6 7 Utah 8 9 10 11 New York 12 13 14 15 In [57]: data < 5 Out[57]: one two three four Ohio True True True True Colorado True False False False Utah False False False False New York False False False False In [59]: data [ data < 5 ] = 0 data Out[59]: one two three four Ohio 0 0 0 0 Colorado 0 5 6 7 Utah 8 9 10 11 New York 12 13 14 15 In [63]: # 选择一行中的一部分 data . ix [ 'Colorado' , [ 'two' , 'three' ]] Out[63]: two 5 three 6 Name: Colorado, dtype: int64 In [64]: # 选择多行中的一部分 data . ix [[ 'Colorado' , 'Utah' ], [ 3 , 0 , 1 ]] Out[64]: four one two Colorado 7 0 5 Utah 11 8 9 In [66]: # 一整行 data . ix [ 2 ] Out[66]: one 8 two 9 three 10 four 11 Name: Utah, dtype: int64 In [67]: data . ix [: 'Utah' , 'two' ] Out[67]: Ohio 0 Colorado 5 Utah 9 Name: two, dtype: int64 In [68]: data . ix [ data . three > 5 , : 3 ] Out[68]: one two three Colorado 0 5 6 Utah 8 9 10 New York 12 13 14 算术运算和数据对齐 Pandas 在对 Series 和 DataFrame 进行算术运算时，能够根据索引自动对齐,其中索引不重合的部分值为NaN。 +，-，*，/ 对应的函数分别为 add() , sub() , mul() , div() 。 In [69]: s1 = Series ([ 7.3 , - 2.5 , 3.4 , 1.5 ], index = [ 'a' , 'c' , 'd' , 'e' ]) s2 = Series ([ - 2.1 , 3.6 , - 1.5 , 4 , 3.1 ], index = [ 'a' , 'c' , 'e' , 'f' , 'g' ]) In [70]: s1 Out[70]: a 7.3 c -2.5 d 3.4 e 1.5 dtype: float64 In [71]: s2 Out[71]: a -2.1 c 3.6 e -1.5 f 4.0 g 3.1 dtype: float64 In [72]: s1 + s2 Out[72]: a 5.2 c 1.1 d NaN e 0.0 f NaN g NaN dtype: float64 In [73]: df1 = DataFrame ( np . arange ( 9. ) . reshape (( 3 , 3 )), columns = list ( 'bcd' ), index = [ 'Ohio' , 'Texas' , 'Colorado' ]) df2 = DataFrame ( np . arange ( 12. ) . reshape (( 4 , 3 )), columns = list ( 'bde' ), index = [ 'Utah' , 'Ohio' , 'Texas' , 'Oregon' ]) df1 Out[73]: b c d Ohio 0.0 1.0 2.0 Texas 3.0 4.0 5.0 Colorado 6.0 7.0 8.0 In [74]: df2 Out[74]: b d e Utah 0.0 1.0 2.0 Ohio 3.0 4.0 5.0 Texas 6.0 7.0 8.0 Oregon 9.0 10.0 11.0 In [75]: df1 + df2 Out[75]: b c d e Colorado NaN NaN NaN NaN Ohio 3.0 NaN 6.0 NaN Oregon NaN NaN NaN NaN Texas 9.0 NaN 12.0 NaN Utah NaN NaN NaN NaN 在算术方法中填充值 In [76]: df1 = DataFrame ( np . arange ( 12. ) . reshape (( 3 , 4 )), columns = list ( 'abcd' )) df2 = DataFrame ( np . arange ( 20. ) . reshape (( 4 , 5 )), columns = list ( 'abcde' )) df1 Out[76]: a b c d 0 0.0 1.0 2.0 3.0 1 4.0 5.0 6.0 7.0 2 8.0 9.0 10.0 11.0 In [77]: df2 Out[77]: a b c d e 0 0.0 1.0 2.0 3.0 4.0 1 5.0 6.0 7.0 8.0 9.0 2 10.0 11.0 12.0 13.0 14.0 3 15.0 16.0 17.0 18.0 19.0 In [78]: df1 + df2 Out[78]: a b c d e 0 0.0 2.0 4.0 6.0 NaN 1 9.0 11.0 13.0 15.0 NaN 2 18.0 20.0 22.0 24.0 NaN 3 NaN NaN NaN NaN NaN In [79]: df1 . add ( df2 , fill_value = 0 ) Out[79]: a b c d e 0 0.0 2.0 4.0 6.0 4.0 1 9.0 11.0 13.0 15.0 9.0 2 18.0 20.0 22.0 24.0 14.0 3 15.0 16.0 17.0 18.0 19.0 In [80]: df1 . reindex ( columns = df2 . columns , fill_value = 0 ) Out[80]: a b c d e 0 0.0 1.0 2.0 3.0 0 1 4.0 5.0 6.0 7.0 0 2 8.0 9.0 10.0 11.0 0 DataFrame 和 Series 之间的运算 In [81]: arr = np . arange ( 12. ) . reshape (( 3 , 4 )) arr Out[81]: array([[ 0., 1., 2., 3.], [ 4., 5., 6., 7.], [ 8., 9., 10., 11.]]) In [82]: arr [ 0 ] Out[82]: array([ 0., 1., 2., 3.]) In [83]: arr - arr [ 0 ] Out[83]: array([[ 0., 0., 0., 0.], [ 4., 4., 4., 4.], [ 8., 8., 8., 8.]]) In [84]: frame = DataFrame ( np . arange ( 12. ) . reshape (( 4 , 3 )), columns = list ( 'bde' ), index = [ 'Utah' , 'Ohio' , 'Texas' , 'Oregon' ]) series = frame . ix [ 0 ] frame Out[84]: b d e Utah 0.0 1.0 2.0 Ohio 3.0 4.0 5.0 Texas 6.0 7.0 8.0 Oregon 9.0 10.0 11.0 In [85]: series Out[85]: b 0.0 d 1.0 e 2.0 Name: Utah, dtype: float64 In [91]: # 将Series的索引匹配到DataFrame的列，然后进行计算，再沿着行一直向下广播 frame - series Out[91]: b d e Utah 0.0 0.0 0.0 Ohio 3.0 3.0 3.0 Texas 6.0 6.0 6.0 Oregon 9.0 9.0 9.0 In [92]: series2 = Series ( range ( 3 ), index = [ 'b' , 'e' , 'f' ]) series2 Out[92]: b 0 e 1 f 2 dtype: int64 In [95]: # 非共有的列，自动填充 frame + series2 Out[95]: b d e f Utah 0.0 NaN 3.0 NaN Ohio 3.0 NaN 6.0 NaN Texas 6.0 NaN 9.0 NaN Oregon 9.0 NaN 12.0 NaN In [88]: series3 = frame [ 'd' ] frame Out[88]: b d e Utah 0.0 1.0 2.0 Ohio 3.0 4.0 5.0 Texas 6.0 7.0 8.0 Oregon 9.0 10.0 11.0 In [89]: series3 Out[89]: Utah 1.0 Ohio 4.0 Texas 7.0 Oregon 10.0 Name: d, dtype: float64 In [96]: # 使用算术运算方法，可以指定轴，从而实现匹配行且在列上广播 frame . sub ( series3 , axis = 0 ) Out[96]: b d e Utah -1.0 0.0 1.0 Ohio -1.0 0.0 1.0 Texas -1.0 0.0 1.0 Oregon -1.0 0.0 1.0 函数应用和映射 In [97]: frame = DataFrame ( np . random . randn ( 4 , 3 ), columns = list ( 'bde' ), index = [ 'Utah' , 'Ohio' , 'Texas' , 'Oregon' ]) In [98]: frame Out[98]: b d e Utah 0.155111 -0.301627 0.034083 Ohio -0.003312 0.807804 -1.046114 Texas 1.983635 -0.667859 1.657091 Oregon 1.633512 -2.041568 0.820017 In [100]: # 求绝对值函数 np . abs ( frame ) Out[100]: b d e Utah 0.155111 0.301627 0.034083 Ohio 0.003312 0.807804 1.046114 Texas 1.983635 0.667859 1.657091 Oregon 1.633512 2.041568 0.820017 In [103]: #另一种常见的做法是：将一个函数应用到行或者列上,用apply方法 # 默认应用到行，广播到列 f = lambda x : x . max () - x . min () frame . apply ( f ) Out[103]: b 1.986947 d 2.849372 e 2.703205 dtype: float64 In [104]: # 通过指定 axis，可以应用到列，广播到行 frame . apply ( f , axis = 1 ) Out[104]: Utah 0.456738 Ohio 1.853918 Texas 2.651494 Oregon 3.675080 dtype: float64 In [105]: # 传递的函数还可以返回 Series def f ( x ): return Series ([ x . min (), x . max ()], index = [ 'min' , 'max' ]) frame . apply ( f ) Out[105]: b d e min -0.003312 -2.041568 -1.046114 max 1.983635 0.807804 1.657091 In [109]: # applymap: 应用到元素（而不是行和列） format = lambda x : ' %.2f ' % x frame . applymap ( format ) Out[109]: b d e Utah 0.16 -0.30 0.03 Ohio -0.00 0.81 -1.05 Texas 1.98 -0.67 1.66 Oregon 1.63 -2.04 0.82 In [111]: # 因为 frame 调用了 Series 的 map()函数 frame [ 'e' ] . map ( format ) Out[111]: Utah 0.03 Ohio -1.05 Texas 1.66 Oregon 0.82 Name: e, dtype: object 排序和排名 主要的函数包括： sort_index(): 按索引排序 sort_values(): 按值排序 rank(): 排名 In [113]: #用sort_index函数对行、列的索引进行排序 obj = Series ( range ( 4 ), index = [ 'd' , 'a' , 'b' , 'c' ]) obj . sort_index () Out[113]: a 1 b 2 c 3 d 0 dtype: int64 In [114]: frame = DataFrame ( np . arange ( 8 ) . reshape (( 2 , 4 )), index = [ 'three' , 'one' ], columns = [ 'd' , 'a' , 'b' , 'c' ]) frame . sort_index () Out[114]: d a b c one 4 5 6 7 three 0 1 2 3 In [115]: frame . sort_index ( axis = 1 ) Out[115]: a b c d three 1 2 3 0 one 5 6 7 4 In [116]: frame . sort_index ( axis = 1 , ascending = False ) Out[116]: d c b a three 0 3 2 1 one 4 7 6 5 In [118]: # 对值排序，使用 sort_values() obj = Series ([ 4 , 7 , - 3 , 2 ]) obj . sort_values () Out[118]: 2 -3 3 2 0 4 1 7 dtype: int64 In [119]: obj = Series ([ 4 , np . nan , 7 , np . nan , - 3 , 2 ]) obj . sort_values () Out[119]: 4 -3.0 5 2.0 0 4.0 2 7.0 1 NaN 3 NaN dtype: float64 In [120]: frame = DataFrame ({ 'b' : [ 4 , 7 , - 3 , 2 ], 'a' : [ 0 , 1 , 0 , 1 ]}) frame Out[120]: a b 0 0 4 1 1 7 2 0 -3 3 1 2 In [122]: frame . sort_values ( by = 'b' ) Out[122]: a b 2 0 -3 3 1 2 0 0 4 1 1 7 In [123]: frame . sort_values ( by = [ 'a' , 'b' ]) Out[123]: a b 2 0 -3 0 0 4 3 1 2 1 1 7 In [128]: #rank函数返回从小到大排序的下标，对于平级的数，rank是通过\"为各组分配一个平均排名\"的方式破坏平级关系 #下标从1开始 obj = Series ([ 7 , - 5 , 7 , 4 , 2 , 0 , 4 ]) obj . rank () Out[128]: 0 6.5 1 1.0 2 6.5 3 4.5 4 3.0 5 2.0 6 4.5 dtype: float64 In [125]: obj . rank ( method = 'first' ) Out[125]: 0 6.0 1 1.0 2 7.0 3 4.0 4 3.0 5 2.0 6 5.0 dtype: float64 In [129]: obj . rank ( ascending = False , method = 'max' ) Out[129]: 0 2.0 1 7.0 2 2.0 3 4.0 4 5.0 5 6.0 6 4.0 dtype: float64 In [130]: frame = DataFrame ({ 'b' : [ 4.3 , 7 , - 3 , 2 ], 'a' : [ 0 , 1 , 0 , 1 ], 'c' : [ - 2 , 5 , 8 , - 2.5 ]}) frame Out[130]: a b c 0 0 4.3 -2.0 1 1 7.0 5.0 2 0 -3.0 8.0 3 1 2.0 -2.5 In [131]: frame . rank ( axis = 1 ) Out[131]: a b c 0 2.0 3.0 1.0 1 1.0 3.0 2.0 2 2.0 1.0 3.0 3 2.0 3.0 1.0 带有重复值的轴索引 In [132]: obj = Series ( range ( 5 ), index = [ 'a' , 'a' , 'b' , 'b' , 'c' ]) obj Out[132]: a 0 a 1 b 2 b 3 c 4 dtype: int64 In [133]: #用is_unique看是否唯一 obj . index . is_unique Out[133]: False In [135]: # #对于重复值的索引，选取的话返回一个Series obj [ 'a' ] Out[135]: a 0 a 1 dtype: int64 In [137]: # 唯一的索引返回一个标量 obj [ 'c' ] Out[137]: 4 In [138]: df = DataFrame ( np . random . randn ( 4 , 3 ), index = [ 'a' , 'a' , 'b' , 'b' ]) df Out[138]: 0 1 2 a -0.146504 -0.442410 -1.044600 a -1.243650 0.281303 0.485324 b 1.040675 0.479036 -0.753287 b -1.571259 0.194030 0.517437 In [139]: df . ix [ 'b' ] Out[139]: 0 1 2 b 1.040675 0.479036 -0.753287 b -1.571259 0.194030 0.517437 In [ ]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/24/python_data_analysis5-2.html"},{"title":"利用Python进行数据分析(5)：Pandas 入门","text":"NumPy虽然提供了方便的数组处理功能，但是它还是缺少许多数据处理、分析所需的一些快速工具。 Pandas基于NumPy构建，提供众多更高级的数据处理功能，使得以 NumPy 为中心的数据处理工作更便捷。 pandas的作者在设计 Pandas 时，主要考虑以下几个方面： 按轴自动或显式数据对齐功能的数据结构 来自不同数据源的数据，由于各数据源的索引方式不同，经常会出现数据未对齐，而这会导致很多常见错误。 集成时间序列功能 既能处理时间序列数据也能处理非时间序列数据的数据结构 数学运算和简约（比如对某个轴求和）可以根据不同的元数据（轴编号）执行 灵活处理缺失数据 合并及其他出现在常见数据库（例如基于SQL的）中的关系型运算 引入 Pandas 的约定为： from pandas import Series , DataFrame import pandas as pd 本章内容较多，每节的内容拆分成一个 ipython notebook: 数据结构 基本功能 汇总和描述性统计 处理缺失数据 层次化索引 其他","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/23/python_data_analysis5.html"},{"title":"基于决策表实现交易策略","text":"所以决策表是进行实现复杂控制逻辑的一个有力工具。现在，考虑构建一个通用的决策表，用于定义交易策略。 决策表与规则引擎 决策表又称判断表，是一种呈表格状的图形工具，适用于描述处理判断条件较多，各条件又相互组合、有多种决策方案的情况。 精确而简洁描述复杂逻辑的方式，将多个条件与这些条件满足后要执行动作相对应。 但不同于传统程序语言中的控制语句，决策表能将多个独立的条件和多个动作直接的联系清晰的表示出来 1 。 决策表用表格的形式表示一组输入与一组输出的相关规则，可以作为规则引擎的输入。比如， Drools 就直接支持使用 Excel 定义的规则表作为规则。 决策表的构成 决策表通常包括以下组成部分： 条件 一组变量、关系或预测。条件可能的值的范围决定了决策表的类型。 最简单的形式为逻辑条件，取值为二元的 True/False。 也可以是用数组或字母代表的分类规则，可以取有限个离散值。 输入 每个条件可能的值。决策表要覆盖条件的所有可能组合。 但可以用\"不关心\"符号来化简决策表。 动作 一组要执行的过程或操作 输出 根据输入，决定是否以及按怎样的顺序执行动作。 这里 有一些决策表的例子。 使用决策表构建策略 与编程语言级别的逻辑控制( if-then-else ， switch ) 相比， 决策表能在一个平面中罗列出所有的可能情况，并清晰的指出相应的处理方式，不需要层层嵌套。 用户不需要考虑其中的逻辑关系就能一眼看出其中什么样的动作对应什么样的情况， 可读性大大提高，并且不容易因为疏忽产生不易察觉的错误。 所以决策表是进行实现复杂控制逻辑的一个有力工具。 现在，考虑构建一个通用的决策表，用于定义交易策略。 这篇文章提供了一个很好的起点 2 ，让我们在此基础上更近一步： 输入 为了简化条件的处理，可以要求所有的输入都是 bool 值。非 bool 值的条件，可以通过变形和多种条件的组合转换成 bool 条件。 为了简化决策表，需要支持\"不关心\"符号。 这样，输入就只有三种情况 ( True , False , True or False )，可以用符号( T , F , - )来表示。 输出 如果动作能够实现排列好顺序，则输出就是\"是否执行特定的动作\"的序列。可以用 X 表示执行，空白表示不执行。 输出只是是否执行某个特定的动作。可以用 `` 按照决策表原始的定义， 输出应该是某种\"动作\"。这很复杂， 很可能需要用到 Roslyn 这样的大象。 但对于交易策略来说，所有的输出无非是某种\"指令\"。如果把这个\"指令\"延后到后面的环境去执行， 则所有的输出就变成了一个\"表达式\"。 条件 用 C# 的 lambda 表达式可以很容易的创建条件(Condition)，但这还是通过编码的方式，不够通用。 我更希望能够通过外部文件来定义条件（比如 文本文件 或 Excel)，这就需要用到表达式引擎。 由于我已经定义了策略上下文(Context)来封装策略的运行时环境， 只需要把策略上下文中的变量注册到表达式引擎中，就可以很容易通过表达式解析的方式定义条件了。 动作 与\"条件\"类似，我已经定义过策略的输出为 Action ，在后续环节再生成交易指令。 为了避免在动作中涉及到复杂的运算，需要丰富 Action Factory 的功能，实现各种不同的创建 Action 的方式。 这样，就可以用表达式为工厂方法传递参数，避免复杂运算。 C# 表达式引擎: Expression Evaluator Expression Evaluator 是一个轻量级的 C#表达式引擎 3 。 Expression Evaluator仅仅依赖 Antlr (\"又一个语言识别工具\",一个开源的，支持多平台的语法解析器)， 并且自身还不到1M。 Expression Evaluator的主要特性包括 4 ： 支持算术运算符，支持关系运算符，以及逻辑运算符 支持表达式分组和括号，以及递增递减运算符 支持表达式属性访问以及动态类型，支持字符串的+运算 支持数值类型的后缀d/f/m/l/u/ul、 支持隐式表达式，以及成员访问操作符(.) 支持一些默认的类型，如double, float, char, string, DateTime, Convert, Math 支持foreach循环 实现要点 在我的架构中，策略要尽可能的简单，由 Context 封装策略的运行环境。？ 那么很自然的，表达式引擎应该在 Context 中引入并创建，策略中只是调用其结果。 在 Context 中： // 表达式变量 // 在构造函数中，定义引擎并注册变量 public StrategyContext() { var registry = new TypeRegistry(); registry.RegisterSymbol(\"当前委托\", CurrentOrder); registry.RegisterSymbol(\"做市商行情\", CurrentMMTick); } …… // 提供 参考资料 决策表_百度百科 ↩ Decision Table in C# ↩ Expression Evaluator：一个轻量级的C#编译器服务 ↩ Expression Evaluator表达式计算组件使用 ↩","tags":"量化交易","loc":"http://holbrook.github.io/2017/02/21/strategy_based_on_decision_table.html"},{"title":"利用Python进行数据分析(4)：NumPy","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } NumPy(Numerical Python)，python 数值计算包。是所有 python 数据分析包的基础。 NumPy提供了大量的数值编程工具，可以方便地处理向量、矩阵等运算，极大地便利了人们在科学计算方面的工作[&#94;1]。 NumPy 的主要功能包括： ndarray, 多维数组，支持快速的矢量运算和复杂广播能力（不同大小的数组之间的运算叫广播（broadcasting）) 随机数生成 标准数学函数，用于对这个数组的数据进行快速运算，无需自己编写循环 磁盘及内存 IO 工具 线性代数、傅里叶变换 提供通用数据接口和工具，便于集成其他语言( 如 C/C++ 等） 在数据分析时，很重要的功能包括： 用于数据整理和清理、子集构造和过滤、转换等快速的矢量化运算 常用的数组解法，如排序、唯一化、集合运算等 高效的描述统计和数据聚合/摘要运算 用于异构数据集的合并/连接运算的数据对齐和关系型数据运算 将条件逻辑表述为数组表达式（而不是带有if-elif-else分支的循环） 数据的分组运算（聚合、转换、函数应用等）。 这些功能 NumPy 都有提供，但是更基础。一般我们不直接使用 Numpy，而是通过 pandas 等包间接调用。 准备工作 In [2]: % pylab inline # import numpy as np import pandas as pd import json Populating the interactive namespace from numpy and matplotlib ndarray: 多维数组对象 ndarray 要求其中所有元素的类型必须相同。 In [3]: data = randn ( 2 , 3 ) In [4]: data data * 10 data + data Out[4]: array([[ 1.0827, -2.8554, 3.1286], [-0.7089, -3.0769, 2.1086]]) In [5]: data . shape data . dtype Out[5]: dtype('float64') 创建数组 np.array() 将 Python 数组转换为 ndarray 数组 np.asarray() ？ np.zeros() 元素全为0的数组 np.zeros_like() 创建一个与参数数组形状相同的全0数组 np.ones() 元素全为1的数组 np.ones_like() 创建一个与参数数组形状相同的全1数组 np.empty() 没有任何具体值的 ndarray 数组 np.empty_like() 创建一个与参数数组形状相同的全空数组 np.arange() 根据 Python 内置函数 range 创建数组 np.eye() 和 np.identity() 创建一个 NxN 的单位矩阵（对角线为1，其余全为0） In [6]: # 创建一维数组 data1 = [ 6 , 7.5 , 8 , 0 , 1 ] arr1 = np . array ( data1 ) arr1 Out[6]: array([ 6. , 7.5, 8. , 0. , 1. ]) In [7]: # 创建多维数组 data2 = [[ 1 , 2 , 3 , 4 ], [ 5 , 6 , 7 , 8 ]] arr2 = np . array ( data2 ) arr2 Out[7]: array([[1, 2, 3, 4], [5, 6, 7, 8]]) In [8]: # 特殊数组 print ( '一维 zero 数组' ) print ( np . zeros ( 10 )) print ( '二维空数组' ) print ( np . empty (( 2 , 3 ))) print ( '二维ones数组' ) print ( np . ones (( 3 , 2 ))) print ( '序列数组' ) print ( np . arange ( 15 )) print ( '[0, 1)区间的随机数数组' ) print ( np . random . rand ( 5 )) 一维 zero 数组 [ 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.] 二维空数组 [[ 0. 0. 0.] [ 0. 0. 0.]] 二维ones数组 [[ 1. 1.] [ 1. 1.] [ 1. 1.]] 序列数组 [ 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14] [0, 1)区间的随机数数组 [ 0.4772 0.2193 0.8478 0.3239 0.8526] In [9]: # 数组的属性 print ( arr1 . dtype ) print ( arr2 . dtype ) print ( arr2 . ndim ) print ( arr2 . shape ) float64 int64 2 (2, 4) 数组类型 dtype In [10]: arr1 = np . array ([ 1 , 2 , 3 ], dtype = np . float64 ) arr2 = np . array ([ 1 , 2 , 3 ], dtype = np . int32 ) print ( arr1 . dtype ) print ( arr2 . dtype ) float64 int32 In [11]: # 类型转换 # 调用astype总会创建一个新的数组（原始数组的一个拷贝），即使和原来的数据类型相同 float_arr = arr2 . astype ( np . float64 ) float_arr Out[11]: array([ 1., 2., 3.]) 数组运算 In [12]: arr = np . array ([[ 1. , 2. , 3. ], [ 4. , 5. , 6. ]]) arr Out[12]: array([[ 1., 2., 3.], [ 4., 5., 6.]]) In [13]: arr - arr Out[13]: array([[ 0., 0., 0.], [ 0., 0., 0.]]) In [14]: arr * arr Out[14]: array([[ 1., 4., 9.], [ 16., 25., 36.]]) In [15]: arr ** 0.5 Out[15]: array([[ 1. , 1.4142, 1.7321], [ 2. , 2.2361, 2.4495]]) In [16]: 1 / arr Out[16]: array([[ 1. , 0.5 , 0.3333], [ 0.25 , 0.2 , 0.1667]]) 索引(indexing) 和 切片(slicing) 索引即通过一个无符号整数值获取数组里的值。 切片即选择数组里某个片段。 In [17]: arr = np . arange ( 10 ) arr arr [ 5 ] arr [ 5 : 8 ] arr [ 5 : 8 ] = 12 # 对切片的操作会改变原始数组 arr Out[17]: array([ 0, 1, 2, 3, 4, 12, 12, 12, 8, 9]) In [18]: # 即使创建了新的变量也是如此。不会复制数据，只会改变源数据 arr_slice = arr [ 5 : 8 ] arr_slice [ 1 ] = 12345 arr arr_slice [:] = 64 arr Out[18]: array([ 0, 1, 2, 3, 4, 64, 64, 64, 8, 9]) In [19]: arr2d = np . array ([[ 1 , 2 , 3 ], [ 4 , 5 , 6 ], [ 7 , 8 , 9 ]]) arr2d [ 2 ] Out[19]: array([7, 8, 9]) In [20]: # 这两种方式等价 arr2d [ 0 ][ 2 ] arr2d [ 0 , 2 ] Out[20]: 3 In [21]: arr3d = np . array ([[[ 1 , 2 , 3 ], [ 4 , 5 , 6 ]], [[ 7 , 8 , 9 ], [ 10 , 11 , 12 ]]]) arr3d Out[21]: array([[[ 1, 2, 3], [ 4, 5, 6]], [[ 7, 8, 9], [10, 11, 12]]]) In [22]: arr3d [ 0 ] Out[22]: array([[1, 2, 3], [4, 5, 6]]) In [23]: # 如果一定要复制数据，使用 `copy()`方法 old_values = arr3d [ 0 ] . copy () arr3d [ 0 ] = 42 arr3d arr3d [ 0 ] = old_values arr3d Out[23]: array([[[ 1, 2, 3], [ 4, 5, 6]], [[ 7, 8, 9], [10, 11, 12]]]) In [24]: arr3d [ 1 , 0 ] Out[24]: array([7, 8, 9]) 切片索引(Indexing with slices) In [25]: arr [ 1 : 6 ] Out[25]: array([ 1, 2, 3, 4, 64]) In [26]: arr2d arr2d [: 2 ] Out[26]: array([[1, 2, 3], [4, 5, 6]]) In [27]: arr2d [: 2 , 1 :] Out[27]: array([[2, 3], [5, 6]]) In [28]: arr2d [ 1 , : 2 ] arr2d [ 2 , : 1 ] Out[28]: array([7]) In [29]: arr2d [:, : 1 ] Out[29]: array([[1], [4], [7]]) In [30]: arr2d [: 2 , 1 :] = 0 布尔索引 In [31]: names = np . array ([ 'Bob' , 'Joe' , 'Will' , 'Bob' , 'Will' , 'Joe' , 'Joe' ]) data = randn ( 7 , 4 ) names data Out[31]: array([[-0.843 , -1.2552, 1.6243, 0.1478], [ 0.7525, 0.4313, -0.4447, 0.296 ], [ 0.8521, -0.1377, 1.9734, 1.2485], [-0.349 , 1.5589, -0.0471, -0.1323], [-0.823 , -0.1922, 0.8819, -0.0861], [-0.5267, -1.9805, -0.7778, -1.5296], [-0.5977, 0.1968, 0.9831, -2.0394]]) In [32]: names == 'Bob' Out[32]: array([ True, False, False, True, False, False, False], dtype=bool) In [33]: data [ names == 'Bob' ] Out[33]: array([[-0.843 , -1.2552, 1.6243, 0.1478], [-0.349 , 1.5589, -0.0471, -0.1323]]) In [34]: data [ names == 'Bob' , 2 :] data [ names == 'Bob' , 3 ] Out[34]: array([ 0.1478, -0.1323]) In [35]: names != 'Bob' data [ ~ ( names == 'Bob' )] Out[35]: array([[ 0.7525, 0.4313, -0.4447, 0.296 ], [ 0.8521, -0.1377, 1.9734, 1.2485], [-0.823 , -0.1922, 0.8819, -0.0861], [-0.5267, -1.9805, -0.7778, -1.5296], [-0.5977, 0.1968, 0.9831, -2.0394]]) In [36]: mask = ( names == 'Bob' ) | ( names == 'Will' ) mask data [ mask ] Out[36]: array([[-0.843 , -1.2552, 1.6243, 0.1478], [ 0.8521, -0.1377, 1.9734, 1.2485], [-0.349 , 1.5589, -0.0471, -0.1323], [-0.823 , -0.1922, 0.8819, -0.0861]]) In [37]: data [ data < 0 ] = 0 data Out[37]: array([[ 0. , 0. , 1.6243, 0.1478], [ 0.7525, 0.4313, 0. , 0.296 ], [ 0.8521, 0. , 1.9734, 1.2485], [ 0. , 1.5589, 0. , 0. ], [ 0. , 0. , 0.8819, 0. ], [ 0. , 0. , 0. , 0. ], [ 0. , 0.1968, 0.9831, 0. ]]) In [38]: data [ names != 'Joe' ] = 7 data Out[38]: array([[ 7. , 7. , 7. , 7. ], [ 0.7525, 0.4313, 0. , 0.296 ], [ 7. , 7. , 7. , 7. ], [ 7. , 7. , 7. , 7. ], [ 7. , 7. , 7. , 7. ], [ 0. , 0. , 0. , 0. ], [ 0. , 0.1968, 0.9831, 0. ]]) 花式索引(Fancy indexing) 花式索引是指利用整数数组进行索引。 与切片索引不同， 花式索引总是将数据复制到新数组中 。 In [39]: arr = np . empty (( 8 , 4 )) for i in range ( 8 ): arr [ i ] = i arr Out[39]: array([[ 0., 0., 0., 0.], [ 1., 1., 1., 1.], [ 2., 2., 2., 2.], [ 3., 3., 3., 3.], [ 4., 4., 4., 4.], [ 5., 5., 5., 5.], [ 6., 6., 6., 6.], [ 7., 7., 7., 7.]]) In [40]: arr [[ 4 , 3 , 0 , 6 ]] Out[40]: array([[ 4., 4., 4., 4.], [ 3., 3., 3., 3.], [ 0., 0., 0., 0.], [ 6., 6., 6., 6.]]) In [41]: arr [[ - 3 , - 5 , - 7 ]] Out[41]: array([[ 5., 5., 5., 5.], [ 3., 3., 3., 3.], [ 1., 1., 1., 1.]]) In [42]: # more on reshape in Chapter 12 arr = np . arange ( 32 ) . reshape (( 8 , 4 )) arr arr [[ 1 , 5 , 7 , 2 ], [ 0 , 3 , 1 , 2 ]] Out[42]: array([ 4, 23, 29, 10]) In [43]: arr [[ 1 , 5 , 7 , 2 ]][:, [ 0 , 3 , 1 , 2 ]] Out[43]: array([[ 4, 7, 5, 6], [20, 23, 21, 22], [28, 31, 29, 30], [ 8, 11, 9, 10]]) In [44]: arr [ np . ix_ ([ 1 , 5 , 7 , 2 ], [ 0 , 3 , 1 , 2 ])] Out[44]: array([[ 4, 7, 5, 6], [20, 23, 21, 22], [28, 31, 29, 30], [ 8, 11, 9, 10]]) 数组转置和轴对换 转置(transpose)，是一种对源数据的视图，不会进行复制。 In [45]: arr = np . arange ( 15 ) . reshape (( 3 , 5 )) print ( arr ) print ( '-------' ) print ( arr . T ) [[ 0 1 2 3 4] [ 5 6 7 8 9] [10 11 12 13 14]] ------- [[ 0 5 10] [ 1 6 11] [ 2 7 12] [ 3 8 13] [ 4 9 14]] np.dot() : 矩阵乘积 In [46]: arr = np . arange ( 6 ) . reshape (( 2 , 3 )) print ( arr ) print ( '-------' ) print ( arr . T ) print ( '-------' ) print ( np . dot ( arr . T , arr )) [[0 1 2] [3 4 5]] ------- [[0 3] [1 4] [2 5]] ------- [[ 9 12 15] [12 17 22] [15 22 29]] In [47]: # 多维的情况比较复杂 arr = np . arange ( 16 ) . reshape (( 2 , 2 , 4 )) print ( arr ) print ( '--------' ) print ( arr . transpose (( 1 , 0 , 2 ))) [[[ 0 1 2 3] [ 4 5 6 7]] [[ 8 9 10 11] [12 13 14 15]]] -------- [[[ 0 1 2 3] [ 8 9 10 11]] [[ 4 5 6 7] [12 13 14 15]]] 交换坐标轴 In [48]: print ( arr ) print ( '--------' ) print ( arr . swapaxes ( 1 , 2 )) [[[ 0 1 2 3] [ 4 5 6 7]] [[ 8 9 10 11] [12 13 14 15]]] -------- [[[ 0 4] [ 1 5] [ 2 6] [ 3 7]] [[ 8 12] [ 9 13] [10 14] [11 15]]] 通用函数：快速的元素级数组函数 NumPy 中的通用函数(ufunc), 可以对ndarray中的数据逐个执行运算。 常见的 ufunc 包括： 一元 ufunc abs、fabs： 计算绝对值。对于非复数，fabs 更快 sqrt: 平方根 square: 平方 exp: e&#94;x log, log10, log2: 底数为 e,10,2的对数 log1p: log(1+x) sign: 符号。（返回1，0，-1) cell: ceiling 值，即>=x 的最小整数 floor: floor 值，即<=x 的最大整数 rint: 四舍五入的整数，保留 type modf: 将小数和整数部分返回两个独立数组 isnan: 返回是否为 非数字(NaN)的布尔数组 isfinite, isinf: 返回是否为有穷(非 inf,非 NaN) / 无穷 的布尔数组 cos, cosh, sin, sinh, tan, tanh: 三角函数 arcos, arccosh, arcsin, arcsinh, arctan, arctanh: 反三角函数 logical_not: 计算 非， 相当于 ~attr 二元 ufunc //TODO: In [49]: arr = np . arange ( 10 ) np . sqrt ( arr ) np . exp ( arr ) Out[49]: array([ 1. , 2.7183, 7.3891, 20.0855, 54.5982, 148.4132, 403.4288, 1096.6332, 2980.958 , 8103.0839]) In [50]: x = randn ( 8 ) y = randn ( 8 ) x y # 以两个数组为参数，并返回数组 np . maximum ( x , y ) # element-wise maximum Out[50]: array([ 0.3233, 0.6903, 1.6237, 0.8402, 1.1369, 0.7268, -1.1562, 1.1779]) In [51]: arr = randn ( 7 ) * 5 # 返回两个数组 np . modf ( arr ) Out[51]: (array([ 0.8414, 0.4926, 0.7819, -0.1564, 0.7183, 0.6111, -0.3078]), array([ 2., 4., 2., -4., 2., 2., -9.])) 利用数组进行数据处理 矢量化数组运算比纯pyhton方式快1-2个数量级（or more）, 因为broadcasting作用很强大。 In [52]: points = np . arange ( - 5 , 5 , 0.01 ) # 1000 equally spaced points xs , ys = np . meshgrid ( points , points ) ys Out[52]: array([[-5. , -5. , -5. , ..., -5. , -5. , -5. ], [-4.99, -4.99, -4.99, ..., -4.99, -4.99, -4.99], [-4.98, -4.98, -4.98, ..., -4.98, -4.98, -4.98], ..., [ 4.97, 4.97, 4.97, ..., 4.97, 4.97, 4.97], [ 4.98, 4.98, 4.98, ..., 4.98, 4.98, 4.98], [ 4.99, 4.99, 4.99, ..., 4.99, 4.99, 4.99]]) In [53]: from matplotlib.pyplot import imshow , title import matplotlib.pyplot as plt z = np . sqrt ( xs ** 2 + ys ** 2 ) z plt . imshow ( z , cmap = plt . cm . gray ); plt . colorbar () plt . title ( \"Image plot of $\\sqrt{x&#94;2 + y&#94;2}$ for a grid of values\" ) Out[53]: 将条件逻辑表述为数组运算 np.where() : x if condition else y 的矢量版 In [54]: xarr = np . array ([ 1.1 , 1.2 , 1.3 , 1.4 , 1.5 ]) yarr = np . array ([ 2.1 , 2.2 , 2.3 , 2.4 , 2.5 ]) cond = np . array ([ True , False , True , True , False ]) In [55]: result = [( x if c else y ) for x , y , c in zip ( xarr , yarr , cond )] result Out[55]: [1.1000000000000001, 2.2000000000000002, 1.3, 1.3999999999999999, 2.5] In [56]: result = np . where ( cond , xarr , yarr ) result Out[56]: array([ 1.1, 2.2, 1.3, 1.4, 2.5]) In [57]: arr = randn ( 4 , 4 ) arr np . where ( arr > 0 , 2 , - 2 ) np . where ( arr > 0 , 2 , arr ) # set only positive values to 2 Out[57]: array([[ 2. , 2. , -0.1632, -0.0998], [-0.1647, -0.4374, -0.8843, -0.5101], [-0.8537, 2. , -0.1251, -0.284 ], [ 2. , -1.8794, -1.1339, 2. ]]) In [58]: # 更复杂的用法 # result = 1 * cond1 + 2 * cond2 + 3 * -(cond1 | cond2) # np.where(cond1 & cond2, 0, # np.where(cond1, 1, # np.where(cond2, 2, 3))) 数学和统计方法 常用的统计计算 sum: 求和 mean: 算术平均数 min, max: 最小值、最大值 argmin, argmax: 最小元素、最大元素的索引 std,var: 标准差和方差 cumsum: 所有元素的累计和 cumprod: 所有元素的累计积 用于布尔数组时 sum: 用于 True 的加和 any: 是否存在 True all: 是否全为 True 常用集合运算 sort: 排序 unique: 唯一化，返回有序结果 intersect1d(x,y): 计算公共元素，返回有序结果 union1d(x,y): 计算并集，返回有序结果 in1d(x,y): 返回关于\"x数组中的元素是否在y中\" 的布尔数组 setdiff1d(x,y): 集合的差，返回元素在 x 中且不在 y 中的数组 setxor1d(x,y): 集合异或，返回元素在一个集合中但不同时在两个集合中的数组 这些运算可以使用参数axis表示对哪个维度计算 In [59]: arr = np . random . randn ( 5 , 4 ) # 正态分布数据 print ( arr . mean ()) #等价于 np.mean(arr) print ( arr . sum ()) -0.0787761160028 -1.57552232006 In [60]: print ( arr . mean ( axis = 1 )) # print ( arr . sum ( 0 )) [-0.5999 0.1865 -0.2813 0.3011 -0.0004] [-0.0753 1.6705 -2.3127 -0.858 ] In [61]: arr = np . array ([[ 0 , 1 , 2 ], [ 3 , 4 , 5 ], [ 6 , 7 , 8 ]]) print ( arr . cumsum ( 0 )) print ( '-------' ) print ( arr . cumprod ( 1 )) [[ 0 1 2] [ 3 5 7] [ 9 12 15]] ------- [[ 0 0 0] [ 3 12 60] [ 6 42 336]] Methods for boolean arrays In [62]: arr = randn ( 100 ) ( arr > 0 ) . sum () # Number of positive values Out[62]: 55 In [63]: bools = np . array ([ False , False , True , False ]) bools . any () bools . all () Out[63]: False Sorting In [64]: arr = randn ( 8 ) arr arr . sort () arr Out[64]: array([-0.7791, 0.2135, 0.3738, 0.3999, 0.4451, 0.8202, 1.0856, 1.5183]) In [65]: arr = randn ( 5 , 3 ) arr arr . sort ( 1 ) arr Out[65]: array([[-0.3418, -0.2091, 1.0341], [-0.277 , -0.0718, 0.3191], [-2.2649, -0.326 , 1.2374], [-0.7329, 0.3868, 0.6407], [-2.1872, -0.8663, -0.1269]]) In [66]: large_arr = randn ( 1000 ) large_arr . sort () large_arr [ int ( 0.05 * len ( large_arr ))] # 5% quantile Out[66]: -1.6426378066283904 Unique and other set logic In [67]: names = np . array ([ 'Bob' , 'Joe' , 'Will' , 'Bob' , 'Will' , 'Joe' , 'Joe' ]) print ( np . unique ( names )) ints = np . array ([ 3 , 3 , 3 , 2 , 2 , 1 , 1 , 4 , 4 ]) print ( np . unique ( ints )) ['Bob' 'Joe' 'Will'] [1 2 3 4] In [68]: sorted ( set ( names )) Out[68]: ['Bob', 'Joe', 'Will'] In [69]: values = np . array ([ 6 , 0 , 0 , 3 , 2 , 5 , 6 ]) np . in1d ( values , [ 2 , 3 , 6 ]) Out[69]: array([ True, False, False, True, True, False, True], dtype=bool) 保存和读取数组文件（二进制） In [70]: arr = np . arange ( 10 ) np . save ( 'some_array' , arr ) In [71]: np . load ( 'some_array.npy' ) Out[71]: array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]) In [72]: np . savez ( 'array_archive.npz' , a = arr , b = arr ) # 压缩保存 In [73]: arch = np . load ( 'array_archive.npz' ) # 解压读取 arch [ 'b' ] Out[73]: array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]) In [74]: ! rm some_array.npy ! rm array_archive.npz 保存和读取文本文件 In [77]: #!cat array_ex.txt #arr = np.loadtxt('array_ex.txt', delimiter=',') #arr 线性代数 (Linear algebra) NumPy 的linalg中有很多关于矩阵的函数，与MATLAB、R使用的是相同的行业标准级Fortran库。 常用的函数包括： diag 返回方阵的对角线/非对角线元素数组，或者将一位数组转换为方阵 dot 矩阵相乘 trace 计算对角线元素之和 det 计算矩阵行列式 eig 计算方阵的本征值和本征向量 inv 计算方阵的逆 pinv 计算矩阵的 Moore-Penrose 伪逆 qr 计算 QR 分解 svd 计算奇异值分解(SVD) solve 解线性方程组 Ax=b, 其中 A 为一个方阵 lstsq 计算 Ax=b 的最小二乘解 In [78]: x = np . array ([[ 1. , 2. , 3. ], [ 4. , 5. , 6. ]]) y = np . array ([[ 6. , 23. ], [ - 1 , 7 ], [ 8 , 9 ]]) x y x . dot ( y ) # equivalently np.dot(x, y) Out[78]: array([[ 28., 64.], [ 67., 181.]]) In [79]: np . dot ( x , np . ones ( 3 )) Out[79]: array([ 6., 15.]) In [80]: np . random . seed ( 12345 ) In [81]: from numpy.linalg import inv , qr X = randn ( 5 , 5 ) mat = X . T . dot ( X ) inv ( mat ) mat . dot ( inv ( mat )) q , r = qr ( mat ) r Out[81]: array([[ -6.9271, 7.389 , 6.1227, -7.1163, -4.9215], [ 0. , -3.9735, -0.8671, 2.9747, -5.7402], [ 0. , 0. , -10.2681, 1.8909, 1.6079], [ 0. , 0. , 0. , -1.2996, 3.3577], [ 0. , 0. , 0. , 0. , 0.5571]]) 生成随机数 NumPy.random模块对Python内置的random进行了补充，增加了一些用于高效生成多种概率分布的样本值的函数。 常用的函数包括： seed permutation shuffle rand randint randn binomial normal beta chisquare gamma uniform In [82]: samples = np . random . normal ( size = ( 4 , 4 )) samples Out[82]: array([[ 0.1241, 0.3026, 0.5238, 0.0009], [ 1.3438, -0.7135, -0.8312, -2.3702], [-1.8608, -0.8608, 0.5601, -1.2659], [ 0.1198, -1.0635, 0.3329, -2.3594]]) In [83]: from np.random import normalvariate N = 1000000 % timeit samples = [normalvariate(0, 1) for _ in xrange(N)] % timeit np.random.normal(size=N) --------------------------------------------------------------------------- ModuleNotFoundError Traceback (most recent call last) in () ----> 1 from np . random import normalvariate 2 N = 1000000 3 get_ipython ( ) . magic ( 'timeit samples = [normalvariate(0, 1) for _ in xrange(N)]' ) 4 get_ipython ( ) . magic ( 'timeit np.random.normal(size=N)' ) ModuleNotFoundError : No module named 'np' 示例：随机漫步 In [84]: nsteps = 1000 draws = np . random . randint ( 0 , 2 , size = nsteps ) steps = np . where ( draws > 0 , 1 , - 1 ) walk = steps . cumsum () plt . plot ( walk ) Out[84]: [ ] In [85]: print ( walk . min ()) print ( walk . max ()) print (( np . abs ( walk ) >= 10 ) . argmax ()) -13 21 169 一次模拟多个随机漫步 In [10]: nwalks = 500 nsteps = 100 draws = np . random . randint ( 0 , 2 , size = ( nwalks , nsteps )) # 0 or 1 steps = np . where ( draws > 0 , 1 , - 1 ) walks = steps . cumsum ( 1 ) # X = range(100) # plt.plot(X,walks.T) In [4]: print ( walks . max ()) print ( walks . min ()) hits30 = ( np . abs ( walks ) >= 30 ) . any ( 1 ) hits30 hits30 . sum () # Number that hit 30 or -30 35 -29 Out[4]: 3 In [5]: crossing_times = ( np . abs ( walks [ hits30 ]) >= 30 ) . argmax ( 1 ) crossing_times . mean () Out[5]: 93.666666666666671 In [6]: steps = np . random . normal ( loc = 0 , scale = 0.25 , size = ( nwalks , nsteps )) steps Out[6]: array([[-0.14399562, -0.32230426, 0.19550459, ..., 0.2911114 , -0.12301231, 0.37247767], [ 0.03271324, -0.16595483, -0.14435582, ..., 0.11651164, -0.41746024, 0.2331533 ], [ 0.37643298, -0.63381675, -0.34511255, ..., 0.31880143, 0.26840034, 0.40549077], ..., [-0.18773108, -0.0468002 , -0.24459798, ..., -0.04037555, 0.68543326, 0.08652403], [ 0.29482329, 0.55448322, 0.07250341, ..., -0.10875316, -0.10812287, 0.37397081], [ 0.39636087, 0.13759243, -0.4751035 , ..., 0.17986707, 0.04288109, 0.00116321]]) In [9]: Out[9]: array([[ -1, 1, -1, ..., 1, -1, 1], [ 0, 2, 0, ..., 2, -2, 2], [ -1, 3, -1, ..., 1, -1, 1], ..., [ -8, 2, -14, ..., 4, -6, 0], [ -7, 3, -15, ..., 5, -7, 1], [ -6, 4, -14, ..., 6, -8, 0]]) 参考资料 [&#94;1]: 一大波金融Library来袭之numpy篇 [&#94;2]: 司空格子Ored 的笔记 if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/17/python_data_analysis4.html"},{"title":"利用Python进行数据分析(2.3)：全美婴儿姓名分析","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } 《 利用Python进行数据分析 》读书笔记。 第2章 中的例子： 美国婴儿姓名统计。 所有用到的数据可以从 作者的 github 下载。 0. 准备工作 In [1]: % pylab inline import pandas as pd Populating the interactive namespace from numpy and matplotlib 1. 将数据加载到 DataFrame，并合并 In [2]: #pd.read_csv('data/ch02/names/yob1880.txt', names=['name', 'sex', 'births']) years = range ( 1880 , 2011 ) pieces = [] columns = [ 'name' , 'sex' , 'births' ] for year in years : path = 'data/ch02/names/yob %d .txt' % year frame = pd . read_csv ( path , names = columns ) frame [ 'year' ] = year pieces . append ( frame ) # 将多个 DataFrame 连接成一个 names = pd . concat ( pieces , ignore_index = True ) 2. 聚合 In [3]: # 按年度聚合，区分性别 total_births = names . pivot_table ( 'births' , index = 'year' , columns = 'sex' , aggfunc = sum ) total_births . head ( 10 ) Out[3]: sex F M year 1880 90993 110493 1881 91955 100748 1882 107851 113687 1883 112322 104632 1884 129021 114445 1885 133056 107802 1886 144538 110785 1887 145983 101412 1888 178631 120857 1889 178369 110590 In [4]: # 画张图看看 total_births . plot ( title = 'Total births by sex and year' ) Out[4]: 3.数据转换 In [6]: # 计算名字占所有出生婴儿的比重 def add_prop ( group ): # Integer division floors births = group . births . astype ( float ) group [ 'prop' ] = births / births . sum () return group names = names . groupby ([ 'year' , 'sex' ]) . apply ( add_prop ) names . head () Out[6]: name sex births year prop 0 Mary F 7065 1880 0.077643 1 Anna F 2604 1880 0.028618 2 Emma F 2003 1880 0.022013 3 Elizabeth F 1939 1880 0.021309 4 Minnie F 1746 1880 0.019188 In [9]: # 检查所有分组的 prop 之和是否近似=1 np . allclose ( names . groupby ([ 'year' , 'sex' ]) . prop . sum (), 1 ) Out[9]: True 4. 数据筛选 取 Top1000的名字 In [11]: def get_top1000 ( group ): return group . sort_values ( by = 'births' , ascending = False )[: 1000 ] grouped = names . groupby ([ 'year' , 'sex' ]) top1000 = grouped . apply ( get_top1000 ) top1000 . head () Out[11]: name sex births year prop year sex 1880 F 0 Mary F 7065 1880 0.077643 1 Anna F 2604 1880 0.028618 2 Emma F 2003 1880 0.022013 3 Elizabeth F 1939 1880 0.021309 4 Minnie F 1746 1880 0.019188 5. 结果展示 5.1 分析命名趋势 In [13]: boys = top1000 [ top1000 . sex == 'M' ] girls = top1000 [ top1000 . sex == 'F' ] # 按名字聚合，做透视表 total_births = top1000 . pivot_table ( 'births' , index = 'year' , columns = 'name' , aggfunc = sum ) # 分析5个名字的趋势 subset = total_births [[ 'John' , 'Harry' , 'Mary' , 'Marilyn' ]] subset . plot ( subplots = True , figsize = ( 12 , 10 ), grid = False , title = \"Number of births per year\" ) Out[13]: array([ , , , ], dtype=object) 5.2 评估名字的多样性 In [16]: # 最流行的1000个名字的占比 table = top1000 . pivot_table ( 'prop' , index = 'year' , columns = 'sex' , aggfunc = sum ) table . plot ( title = 'Sum of table1000.prop by year and sex' , yticks = np . linspace ( 0 , 1.2 , 13 ), xticks = range ( 1880 , 2020 , 10 )) Out[16]: In [18]: # 占总出生人数前50%的不同名字的数量 def get_quantile_count ( group , q = 0.5 ): group = group . sort_values ( by = 'prop' , ascending = False ) return group . prop . cumsum () . values . searchsorted ( q ) + 1 #numpy 的 searchsorted，查找 q 放在哪个索引合适 diversity = top1000 . groupby ([ 'year' , 'sex' ]) . apply ( get_quantile_count ) # 按 year 分组，每个分组都执行一次 diversity = diversity . unstack ( 'sex' ) diversity . head () Out[18]: sex F M year 1880 38 14 1881 38 14 1882 38 15 1883 39 15 1884 39 16 In [19]: diversity . plot ( title = \"Number of popular names in top 50%\" ) Out[19]: 5.3 最后一个字母的变革 In [24]: # 获取尾字母，并聚合 get_last_letter = lambda x : x [ - 1 ] last_letters = names . name . map ( get_last_letter ) last_letters . name = 'last_letter' table = names . pivot_table ( 'births' , index = last_letters , columns = [ 'sex' , 'year' ], aggfunc = sum ) # 选取有代表性的3个年份 subtable = table . reindex ( columns = [ 1910 , 1960 , 2010 ], level = 'year' ) subtable . head () Out[24]: sex F M year 1910 1960 2010 1910 1960 2010 last_letter a 108376.0 691247.0 670605.0 977.0 5204.0 28438.0 b NaN 694.0 450.0 411.0 3912.0 38859.0 c 5.0 49.0 946.0 482.0 15476.0 23125.0 d 6750.0 3729.0 2607.0 22111.0 262112.0 44398.0 e 133569.0 435013.0 313833.0 28655.0 178823.0 129012.0 In [28]: # 规范化处理，计算比例 letter_prop = subtable / subtable . sum () . astype ( float ) # 绘图 plt . subplots_adjust ( hspace = 0.25 ) fig , axes = plt . subplots ( 2 , 1 , figsize = ( 10 , 8 )) letter_prop [ 'M' ] . plot ( kind = 'bar' , rot = 0 , ax = axes [ 0 ], title = 'Male' ) letter_prop [ 'F' ] . plot ( kind = 'bar' , rot = 0 , ax = axes [ 1 ], title = 'Female' , legend = False ) Out[28]: In [30]: # 进一步分析男孩的 d, n, y 三个字母 letter_prop = table / table . sum () . astype ( float ) dny_ts = letter_prop . ix [[ 'd' , 'n' , 'y' ], 'M' ] . T plt . close ( 'all' ) dny_ts . plot () Out[30]: 5.4 男孩名变成女孩名 In [32]: # 合并重复的名字 all_names = top1000 . name . unique () # 找到 lesl 开头的名字 mask = np . array ([ 'lesl' in x . lower () for x in all_names ]) lesley_like = all_names [ mask ] lesley_like Out[32]: array(['Leslie', 'Lesley', 'Leslee', 'Lesli', 'Lesly'], dtype=object) In [33]: filtered = top1000 [ top1000 . name . isin ( lesley_like )] filtered . groupby ( 'name' ) . births . sum () Out[33]: name Leslee 1082 Lesley 35022 Lesli 929 Leslie 370429 Lesly 10067 Name: births, dtype: int64 In [34]: table = filtered . pivot_table ( 'births' , index = 'year' , columns = 'sex' , aggfunc = 'sum' ) table = table . div ( table . sum ( 1 ), axis = 0 ) table . tail () Out[34]: sex F M year 2006 1.0 NaN 2007 1.0 NaN 2008 1.0 NaN 2009 1.0 NaN 2010 1.0 NaN In [35]: plt . close ( 'all' ) table . plot ( style = { 'M' : 'k-' , 'F' : 'k--' }) Out[35]: In [ ]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/16/python_data_analysis2-3.html"},{"title":"利用Python进行数据分析(3)：IPython","text":"《 利用Python进行数据分析 》读书笔记。 第 3 章：IPython——一种交互式计算和开发环境。 介绍 IPython 及其使用。 IPython 的设计哲学是鼓励一种\"执行-探索\"(execute explore)的工作模式，而不是传统编程的\"编辑-编译-运行\"(edit-complie-run)模式。 由于大部分的数据分析工作都需要\"探索式操作\"(试误法和迭代法)，可以说 IPython 就是为了用 python 进行数据分析而生的。 可能 IPython 的设计灵感来自 R 等软件，但是在 python 的强大能力下，IPython 系已经形成了一整套的数据分析工具链， 已经有一些数据分析工作者转移到了 python 生态下。 IPython基础 类似于 python解释器，使用命令 ipython 可以打开一个交互式控制台。如果需要使用 Matplotlib 库，增加参数： ipython --pylab 。 更吸引人的使用方式是基于 web 的 ipython notebook。 可以使用命令： # ipython notebook jupyter notebook 该命令会自动打开浏览器并访问 notebook。 通常我们需要在页面中直接嵌入显示图片，此时使用命令： # ipython notebook --pylab inline jupyter notebook --pylab inline ipython notebook 还可以远程运行，可以参考资料1 1 。 使用技巧 用 Tab 建可以自动补全 内省：在变量的前面或后面加上 ? ，可以显示该对象的信息 用 %run 命令可以执行外部 py 脚本 用 %paste 可以按 python 缩进粘贴代码 IPython 提供了一些方便的快捷键，常用的包括： Ctrl+F 光标前移1个字符 Ctrl+B 光标后移1个字符 Ctrl+A 光标移至行首 Ctrl+E 光标移至行尾 Ctrl+U 删除此行光标之前的所有内容 Ctrl+K 删除此行光标之后的所有内容 Ctrl+L 清屏（Mac 下 Cmd+K 也可以） IPython 支持调试和跟踪 % 开头的命令称为\"魔术命令（Magic Command）\"，能够实现一些\"神奇\"的功能 GUI 方式 使用命令 ipython qtconsole --pylab=inline ，可以打开一个类似 R 的GUI 程序。 与操作系统交互 ipython 提供了很多魔术命令，用于与操作系统交互。 参考资料 IPython Notebook: 交互计算新时代 ↩","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/16/python_data_analysis3.html"},{"title":"利用Python进行数据分析(2.2)：电影评分数据分析","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } 《 利用Python进行数据分析 》读书笔记。 第2章 中的例子：电影评分数据分析。 所有用到的数据可以从 作者的 github 下载。 0. 准备工作 In [52]: % pylab inline import pandas as pd Populating the interactive namespace from numpy and matplotlib 1. 将数据加载到 DataFrame In [53]: # 定义列名 unames = [ 'user_id' , 'gender' , 'age' , 'occupation' , 'zip' ] rnames = [ 'user_id' , 'movie_id' , 'rating' , 'timestamp' ] mnames = [ 'movie_id' , 'title' , 'genres' ] # 读取数据 users = pd . read_table ( 'data/ch02/movielens/users.dat' , sep = '::' , header = None , names = unames , engine = 'python' ) ratings = pd . read_table ( 'data/ch02/movielens/ratings.dat' , sep = '::' , header = None , names = rnames , engine = 'python' ) movies = pd . read_table ( 'data/ch02/movielens/movies.dat' , sep = '::' , header = None , names = mnames , engine = 'python' ) In [54]: # 检验数据 users . head () ratings . head () movies . head () Out[54]: movie_id title genres 0 1 Toy Story (1995) Animation|Children's|Comedy 1 2 Jumanji (1995) Adventure|Children's|Fantasy 2 3 Grumpier Old Men (1995) Comedy|Romance 3 4 Waiting to Exhale (1995) Comedy|Drama 4 5 Father of the Bride Part II (1995) Comedy 2. 合并数据 In [55]: # 先合并 users 到ratings, 再合并movies # pandas 会根据列名进行连接 data = pd . merge ( pd . merge ( ratings , users ), movies ) data . head () Out[55]: user_id movie_id rating timestamp gender age occupation zip title genres 0 1 1193 5 978300760 F 1 10 48067 One Flew Over the Cuckoo's Nest (1975) Drama 1 2 1193 5 978298413 M 56 16 70072 One Flew Over the Cuckoo's Nest (1975) Drama 2 12 1193 4 978220179 M 25 12 32793 One Flew Over the Cuckoo's Nest (1975) Drama 3 15 1193 4 978199279 M 25 7 22903 One Flew Over the Cuckoo's Nest (1975) Drama 4 17 1193 5 978158471 M 50 1 95350 One Flew Over the Cuckoo's Nest (1975) Drama 3.数据转换 In [56]: # 按性别统计每部电影的得分 # pivot_table, 透视表, 是一个很常用的工具 mean_ratings = data . pivot_table ( 'rating' , index = 'title' , columns = [ 'gender' ], aggfunc = 'mean' ) # 另一种写法 #mean_ratings = pd.pivot_table(data,values=['rating'], index='title',columns=['gender'], aggfunc='mean') mean_ratings . head () Out[56]: gender F M title $1,000,000 Duck (1971) 3.375000 2.761905 'Night Mother (1986) 3.388889 3.352941 'Til There Was You (1997) 2.675676 2.733333 'burbs, The (1989) 2.793478 2.962085 ...And Justice for All (1979) 3.828571 3.689024 4. 数据筛选 In [57]: # 筛选评分数据>250 条的电影 ratings_by_title = data . groupby ( 'title' ) . size () # 按照title对data分组并计数 active_titles = ratings_by_title . index [ ratings_by_title >= 251 ] # index返回的下标 mean_ratings = mean_ratings . ix [ active_titles ] # 进行筛选。注意，这里原表和透视表的排序相同 mean_ratings . head () Out[57]: gender F M title 'burbs, The (1989) 2.793478 2.962085 10 Things I Hate About You (1999) 3.646552 3.311966 101 Dalmatians (1961) 3.791444 3.500000 101 Dalmatians (1996) 3.240000 2.911215 12 Angry Men (1957) 4.184397 4.328421 5. 结果展示 In [58]: # 女性观众最喜欢的 TOP10 电影 top_female_ratings = mean_ratings . sort_values ( by = 'F' , ascending = False )[: 10 ] top_female_ratings Out[58]: gender F M title Close Shave, A (1995) 4.644444 4.473795 Wrong Trousers, The (1993) 4.588235 4.478261 Sunset Blvd. (a.k.a. Sunset Boulevard) (1950) 4.572650 4.464589 Wallace & Gromit: The Best of Aardman Animation (1996) 4.563107 4.385075 Schindler's List (1993) 4.562602 4.491415 Shawshank Redemption, The (1994) 4.539075 4.560625 Grand Day Out, A (1992) 4.537879 4.293255 To Kill a Mockingbird (1962) 4.536667 4.372611 Creature Comforts (1990) 4.513889 4.272277 Usual Suspects, The (1995) 4.513317 4.518248 In [59]: # 分歧最大的电影 mean_ratings [ 'diff' ] = mean_ratings [ 'M' ] - mean_ratings [ 'F' ] # 分歧最大且女性更喜欢的电影 mean_ratings . sort_values ( by = 'diff' )[: 10 ] Out[59]: gender F M diff title Dirty Dancing (1987) 3.790378 2.959596 -0.830782 Jumpin' Jack Flash (1986) 3.254717 2.578358 -0.676359 Grease (1978) 3.975265 3.367041 -0.608224 Little Women (1994) 3.870588 3.321739 -0.548849 Steel Magnolias (1989) 3.901734 3.365957 -0.535777 Anastasia (1997) 3.800000 3.281609 -0.518391 Rocky Horror Picture Show, The (1975) 3.673016 3.160131 -0.512885 Color Purple, The (1985) 4.158192 3.659341 -0.498851 Age of Innocence, The (1993) 3.827068 3.339506 -0.487561 Free Willy (1993) 2.921348 2.438776 -0.482573 In [60]: # 分歧最大且男性更喜欢的电影 mean_ratings . sort_values ( by = 'diff' , ascending = False )[: 10 ] Out[60]: gender F M diff title Good, The Bad and The Ugly, The (1966) 3.494949 4.221300 0.726351 Kentucky Fried Movie, The (1977) 2.878788 3.555147 0.676359 Dumb & Dumber (1994) 2.697987 3.336595 0.638608 Longest Day, The (1962) 3.411765 4.031447 0.619682 Cable Guy, The (1996) 2.250000 2.863787 0.613787 Evil Dead II (Dead By Dawn) (1987) 3.297297 3.909283 0.611985 Hidden, The (1987) 3.137931 3.745098 0.607167 Rocky III (1982) 2.361702 2.943503 0.581801 Caddyshack (1980) 3.396135 3.969737 0.573602 For a Few Dollars More (1965) 3.409091 3.953795 0.544704 In [61]: # 分歧最大的电影 rating_std_by_title = data . groupby ( 'title' )[ 'rating' ] . std () rating_std_by_title . sort_values ( ascending = False )[: 10 ] Out[61]: title Foreign Student (1994) 2.828427 Criminal Lovers (Les Amants Criminels) (1999) 2.309401 Identification of a Woman (Identificazione di una donna) (1982) 2.121320 Sunset Park (1996) 2.121320 Eaten Alive (1976) 2.121320 Neon Bible, The (1995) 2.121320 Talk of Angels (1998) 2.121320 Tokyo Fist (1995) 2.121320 Paralyzing Fear: The Story of Polio in America, A (1998) 2.121320 Better Living (1998) 2.121320 Name: rating, dtype: float64 if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/15/python_data_analysis2-2.html"},{"title":"利用Python进行数据分析(1)：简单介绍","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } 《 利用Python进行数据分析 》 作者: Wes McKinney 译者: 唐学韬 补充说明 大部分问题在 这里 都有介绍。 两点补充： 书中推荐 Enthought公司 的 Canopy , 但我更喜欢非商业的 Anaconda 我已经把博客从 Jekyll 切换到了 Pelican ， 一切都回到了纯 python , 这个世界果然清净了许多。 更重要的是， 通过 Pelican 的插件 pelican-ipynb 可以在 bolg 中直接发布 ipython/jupyter notebook。 本文就是用 jupyter notebook 直接编辑并通过 Pelican 发布的。 绘制直线的例子 In [13]: % pylab inline # import pandas as pd # import numpy as np # import matplotlib.pyplot as plt plot ( arange ( 100 )) Populating the interactive namespace from numpy and matplotlib Out[13]: [ ] if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/14/python_data_analysis1.html"},{"title":"利用Python进行数据分析(2)：引言","text":"《 利用Python进行数据分析 》读书笔记。 第 2 章：引言 介绍数据分析的一般步骤，并用三个实例说明如何用 python 进行数据分析。 所有用到的数据可以从 作者的 github 下载。 数据分析的一般步骤 数据加载 从各种格式的数据文件和数据库加载数据 数据准备 对数据进行清理、修整、整合、规范化、重塑、切片切块、变形等处理，以便于进行分析 数据转换 对数据集进行数学和统计运算，产生新的数据集。比如，根据分组变量对一个大表进行聚合 建模和计算 通过统计模型、机器学习算法和其他计算工具，对数据进行分析计算 结果展示 通过静态或交互式的方式，展示结果 用 python 进行数据分析的例子 分析网站的用户访问数据 电影评分数据分析 全美婴儿姓名分析","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/14/python_data_analysis2.html"},{"title":"利用Python进行数据分析(2.1)：分析网站的用户访问数据","text":"/*! * * IPython notebook * */ /* CSS font colors for translated ANSI colors. */ .ansibold { font-weight: bold; } /* use dark versions for foreground, to improve visibility */ .ansiblack { color: black; } .ansired { color: darkred; } .ansigreen { color: darkgreen; } .ansiyellow { color: #c4a000; } .ansiblue { color: darkblue; } .ansipurple { color: darkviolet; } .ansicyan { color: steelblue; } .ansigray { color: gray; } /* and light for background, for the same reason */ .ansibgblack { background-color: black; } .ansibgred { background-color: red; } .ansibggreen { background-color: green; } .ansibgyellow { background-color: yellow; } .ansibgblue { background-color: blue; } .ansibgpurple { background-color: magenta; } .ansibgcyan { background-color: cyan; } .ansibggray { background-color: gray; } div.cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; border-radius: 2px; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; border-width: 1px; border-style: solid; border-color: transparent; width: 100%; padding: 5px; /* This acts as a spacer between cells, that is outside the border */ margin: 0px; outline: none; border-left-width: 1px; padding-left: 5px; background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%); } div.cell.jupyter-soft-selected { border-left-color: #90CAF9; border-left-color: #E3F2FD; border-left-width: 1px; padding-left: 5px; border-right-color: #E3F2FD; border-right-width: 1px; background: #E3F2FD; } @media print { div.cell.jupyter-soft-selected { border-color: transparent; } } div.cell.selected { border-color: #ababab; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%); } @media print { div.cell.selected { border-color: transparent; } } div.cell.selected.jupyter-soft-selected { border-left-width: 0; padding-left: 6px; background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%); } .edit_mode div.cell.selected { border-color: #66BB6A; border-left-width: 0px; padding-left: 6px; background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%); } @media print { .edit_mode div.cell.selected { border-color: transparent; } } .prompt { /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */ min-width: 14ex; /* This padding is tuned to match the padding on the CodeMirror editor. */ padding: 0.4em; margin: 0px; font-family: monospace; text-align: right; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; /* Don't highlight prompt number selection */ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; /* Use default cursor */ cursor: default; } @media (max-width: 540px) { .prompt { text-align: left; } } div.inner_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; } @-moz-document url-prefix() { div.inner_cell { overflow-x: hidden; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_area { border: 1px solid #cfcfcf; border-radius: 2px; background: #f7f7f7; line-height: 1.21429em; } /* This is needed so that empty prompt areas can collapse to zero height when there is no content in the output_subarea and the prompt. The main purpose of this is to make sure that empty JavaScript output_subareas have no height. */ div.prompt:empty { padding-top: 0; padding-bottom: 0; } div.unrecognized_cell { padding: 5px 5px 5px 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.unrecognized_cell .inner_cell { border-radius: 2px; padding: 5px; font-weight: bold; color: red; border: 1px solid #cfcfcf; background: #eaeaea; } div.unrecognized_cell .inner_cell a { color: inherit; text-decoration: none; } div.unrecognized_cell .inner_cell a:hover { color: inherit; text-decoration: none; } @media (max-width: 540px) { div.unrecognized_cell > div.prompt { display: none; } } div.code_cell { /* avoid page breaking on code cells when printing */ } @media print { div.code_cell { page-break-inside: avoid; } } /* any special styling for code cells that are currently running goes here */ div.input { page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.input { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } /* input_area and input_prompt must match in top border and margin for alignment */ div.input_prompt { color: #303F9F; border-top: 1px solid transparent; } div.input_area > div.highlight { margin: 0.4em; border: none; padding: 0px; background-color: transparent; } div.input_area > div.highlight > pre { margin: 0px; border: none; padding: 0px; background-color: transparent; } /* The following gets added to the <head> if it is detected that the user has a * monospace font with inconsistent normal/bold/italic height. See * notebookmain.js. Such fonts will have keywords vertically offset with * respect to the rest of the text. The user should select a better font. * See: https://github.com/ipython/ipython/issues/1503 * * .CodeMirror span { * vertical-align: bottom; * } */ .CodeMirror { line-height: 1.21429em; /* Changed from 1em to our global default */ font-size: 14px; height: auto; /* Changed to auto to autogrow */ background: none; /* Changed from white to allow our bg to show through */ } .CodeMirror-scroll { /* The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/ /* We have found that if it is visible, vertical scrollbars appear with font size changes.*/ overflow-y: hidden; overflow-x: auto; } .CodeMirror-lines { /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */ /* we have set a different line-height and want this to scale with that. */ padding: 0.4em; } .CodeMirror-linenumber { padding: 0 8px 0 4px; } .CodeMirror-gutters { border-bottom-left-radius: 2px; border-top-left-radius: 2px; } .CodeMirror pre { /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */ /* .CodeMirror-lines */ padding: 0; border: 0; border-radius: 0; } /* Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org> Adapted from GitHub theme */ .highlight-base { color: #000; } .highlight-variable { color: #000; } .highlight-variable-2 { color: #1a1a1a; } .highlight-variable-3 { color: #333333; } .highlight-string { color: #BA2121; } .highlight-comment { color: #408080; font-style: italic; } .highlight-number { color: #080; } .highlight-atom { color: #88F; } .highlight-keyword { color: #008000; font-weight: bold; } .highlight-builtin { color: #008000; } .highlight-error { color: #f00; } .highlight-operator { color: #AA22FF; font-weight: bold; } .highlight-meta { color: #AA22FF; } /* previously not defined, copying from default codemirror */ .highlight-def { color: #00f; } .highlight-string-2 { color: #f50; } .highlight-qualifier { color: #555; } .highlight-bracket { color: #997; } .highlight-tag { color: #170; } .highlight-attribute { color: #00c; } .highlight-header { color: blue; } .highlight-quote { color: #090; } .highlight-link { color: #00c; } /* apply the same style to codemirror */ .cm-s-ipython span.cm-keyword { color: #008000; font-weight: bold; } .cm-s-ipython span.cm-atom { color: #88F; } .cm-s-ipython span.cm-number { color: #080; } .cm-s-ipython span.cm-def { color: #00f; } .cm-s-ipython span.cm-variable { color: #000; } .cm-s-ipython span.cm-operator { color: #AA22FF; font-weight: bold; } .cm-s-ipython span.cm-variable-2 { color: #1a1a1a; } .cm-s-ipython span.cm-variable-3 { color: #333333; } .cm-s-ipython span.cm-comment { color: #408080; font-style: italic; } .cm-s-ipython span.cm-string { color: #BA2121; } .cm-s-ipython span.cm-string-2 { color: #f50; } .cm-s-ipython span.cm-meta { color: #AA22FF; } .cm-s-ipython span.cm-qualifier { color: #555; } .cm-s-ipython span.cm-builtin { color: #008000; } .cm-s-ipython span.cm-bracket { color: #997; } .cm-s-ipython span.cm-tag { color: #170; } .cm-s-ipython span.cm-attribute { color: #00c; } .cm-s-ipython span.cm-header { color: blue; } .cm-s-ipython span.cm-quote { color: #090; } .cm-s-ipython span.cm-link { color: #00c; } .cm-s-ipython span.cm-error { color: #f00; } .cm-s-ipython span.cm-tab { background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=); background-position: right; background-repeat: no-repeat; } div.output_wrapper { /* this position must be relative to enable descendents to be absolute within it */ position: relative; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; z-index: 1; } /* class for the output area when it should be height-limited */ div.output_scroll { /* ideally, this would be max-height, but FF barfs all over that */ height: 24em; /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */ width: 100%; overflow: auto; border-radius: 2px; -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8); display: block; } /* output div while it is collapsed */ div.output_collapsed { margin: 0px; padding: 0px; /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } div.out_prompt_overlay { height: 100%; padding: 0px 0.4em; position: absolute; border-radius: 2px; } div.out_prompt_overlay:hover { /* use inner shadow to get border that is computed the same on WebKit/FF */ -webkit-box-shadow: inset 0 0 1px #000; box-shadow: inset 0 0 1px #000; background: rgba(240, 240, 240, 0.5); } div.output_prompt { color: #D84315; } /* This class is the outer container of all output sections. */ div.output_area { padding: 0px; page-break-inside: avoid; /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } div.output_area .MathJax_Display { text-align: left !important; } div.output_area div.output_area div.output_area img, div.output_area svg { max-width: 100%; height: auto; } div.output_area img.unconfined, div.output_area svg.unconfined { max-width: none; } /* This is needed to protect the pre formating from global settings such as that of bootstrap */ .output { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } @media (max-width: 540px) { div.output_area { /* Old browsers */ display: -webkit-box; -webkit-box-orient: vertical; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: vertical; -moz-box-align: stretch; display: box; box-orient: vertical; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: column; align-items: stretch; } } div.output_area pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; color: black; background-color: transparent; border-radius: 0; } /* This class is for the output subarea inside the output_area and after the prompt div. */ div.output_subarea { overflow-x: auto; padding: 0.4em; /* Old browsers */ -webkit-box-flex: 1; -moz-box-flex: 1; box-flex: 1; /* Modern browsers */ flex: 1; max-width: calc(100% - 14ex); } div.output_scroll div.output_subarea { overflow-x: visible; } /* The rest of the output_* classes are for special styling of the different output types */ /* all text output has this class: */ div.output_text { text-align: left; color: #000; /* This has to match that of the the CodeMirror class line-height below */ line-height: 1.21429em; } /* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */ div.output_stderr { background: #fdd; /* very light red background for stderr */ } div.output_latex { text-align: left; } /* Empty output_javascript divs should have no height */ div.output_javascript:empty { padding: 0; } .js-error { color: darkred; } /* raw_input styles */ div.raw_input_container { line-height: 1.21429em; padding-top: 5px; } pre.raw_input_prompt { /* nothing needed here. */ } input.raw_input { font-family: monospace; font-size: inherit; color: inherit; width: auto; /* make sure input baseline aligns with prompt */ vertical-align: baseline; /* padding + margin = 0.5em between prompt and cursor */ padding: 0em 0.25em; margin: 0em 0.25em; } input.raw_input:focus { box-shadow: none; } p.p-space { margin-bottom: 10px; } div.output_unrecognized { padding: 5px; font-weight: bold; color: red; } div.output_unrecognized a { color: inherit; text-decoration: none; } div.output_unrecognized a:hover { color: inherit; text-decoration: none; } .rendered_html { color: #000; /* any extras will just be numbers: */ } .rendered_html :link { text-decoration: underline; } .rendered_html :visited { text-decoration: underline; } .rendered_html h1:first-child { margin-top: 0.538em; } .rendered_html h2:first-child { margin-top: 0.636em; } .rendered_html h3:first-child { margin-top: 0.777em; } .rendered_html h4:first-child { margin-top: 1em; } .rendered_html h5:first-child { margin-top: 1em; } .rendered_html h6:first-child { margin-top: 1em; } .rendered_html * + ul { margin-top: 1em; } .rendered_html * + ol { margin-top: 1em; } .rendered_html pre, .rendered_html tr, .rendered_html th, .rendered_html td, .rendered_html * + table { margin-top: 1em; } .rendered_html * + p { margin-top: 1em; } .rendered_html * + img { margin-top: 1em; } .rendered_html img, .rendered_html img.unconfined, div.text_cell { /* Old browsers */ display: -webkit-box; -webkit-box-orient: horizontal; -webkit-box-align: stretch; display: -moz-box; -moz-box-orient: horizontal; -moz-box-align: stretch; display: box; box-orient: horizontal; box-align: stretch; /* Modern browsers */ display: flex; flex-direction: row; align-items: stretch; } @media (max-width: 540px) { div.text_cell > div.prompt { display: none; } } div.text_cell_render { /*font-family: \"Helvetica Neue\", Arial, Helvetica, Geneva, sans-serif;*/ outline: none; resize: none; width: inherit; border-style: none; padding: 0.5em 0.5em 0.5em 0.4em; color: #000; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; } a.anchor-link:link { text-decoration: none; padding: 0px 20px; visibility: hidden; } h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link, h4:hover .anchor-link, h5:hover .anchor-link, h6:hover .anchor-link { visibility: visible; } .text_cell.rendered .input_area { display: none; } .text_cell.rendered .text_cell.unrendered .text_cell_render { display: none; } .cm-header-1, .cm-header-2, .cm-header-3, .cm-header-4, .cm-header-5, .cm-header-6 { font-weight: bold; font-family: \"Helvetica Neue\", Helvetica, Arial, sans-serif; } .cm-header-1 { font-size: 185.7%; } .cm-header-2 { font-size: 157.1%; } .cm-header-3 { font-size: 128.6%; } .cm-header-4 { font-size: 110%; } .cm-header-5 { font-size: 100%; font-style: italic; } .cm-header-6 { font-size: 100%; font-style: italic; } .highlight .hll { background-color: #ffffcc } .highlight { background: #f8f8f8; } .highlight .c { color: #408080; font-style: italic } /* Comment */ .highlight .err { border: 1px solid #FF0000 } /* Error */ .highlight .k { color: #008000; font-weight: bold } /* Keyword */ .highlight .o { color: #666666 } /* Operator */ .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */ .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */ .highlight .cp { color: #BC7A00 } /* Comment.Preproc */ .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */ .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */ .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */ .highlight .gd { color: #A00000 } /* Generic.Deleted */ .highlight .ge { font-style: italic } /* Generic.Emph */ .highlight .gr { color: #FF0000 } /* Generic.Error */ .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */ .highlight .gi { color: #00A000 } /* Generic.Inserted */ .highlight .go { color: #888888 } /* Generic.Output */ .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */ .highlight .gs { font-weight: bold } /* Generic.Strong */ .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */ .highlight .gt { color: #0044DD } /* Generic.Traceback */ .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */ .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */ .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */ .highlight .kp { color: #008000 } /* Keyword.Pseudo */ .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */ .highlight .kt { color: #B00040 } /* Keyword.Type */ .highlight .m { color: #666666 } /* Literal.Number */ .highlight .s { color: #BA2121 } /* Literal.String */ .highlight .na { color: #7D9029 } /* Name.Attribute */ .highlight .nb { color: #008000 } /* Name.Builtin */ .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */ .highlight .no { color: #880000 } /* Name.Constant */ .highlight .nd { color: #AA22FF } /* Name.Decorator */ .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */ .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */ .highlight .nf { color: #0000FF } /* Name.Function */ .highlight .nl { color: #A0A000 } /* Name.Label */ .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */ .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */ .highlight .nv { color: #19177C } /* Name.Variable */ .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */ .highlight .w { color: #bbbbbb } /* Text.Whitespace */ .highlight .mb { color: #666666 } /* Literal.Number.Bin */ .highlight .mf { color: #666666 } /* Literal.Number.Float */ .highlight .mh { color: #666666 } /* Literal.Number.Hex */ .highlight .mi { color: #666666 } /* Literal.Number.Integer */ .highlight .mo { color: #666666 } /* Literal.Number.Oct */ .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */ .highlight .sc { color: #BA2121 } /* Literal.String.Char */ .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */ .highlight .s2 { color: #BA2121 } /* Literal.String.Double */ .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */ .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */ .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */ .highlight .sx { color: #008000 } /* Literal.String.Other */ .highlight .sr { color: #BB6688 } /* Literal.String.Regex */ .highlight .s1 { color: #BA2121 } /* Literal.String.Single */ .highlight .ss { color: #19177C } /* Literal.String.Symbol */ .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */ .highlight .vc { color: #19177C } /* Name.Variable.Class */ .highlight .vg { color: #19177C } /* Name.Variable.Global */ .highlight .vi { color: #19177C } /* Name.Variable.Instance */ .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */ /* Temporary definitions which will become obsolete with Notebook release 5.0 */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-bold { font-weight: bold; } 《 利用Python进行数据分析 》读书笔记。 第2章 中的例子：分析网站的用户访问数据 所有用到的数据可以从 作者的 github 下载。 0. 准备工作 In [3]: % pylab inline import pandas as pd import json Populating the interactive namespace from numpy and matplotlib 1. 将数据加载到 DataFrame In [4]: records = [ json . loads ( line ) for line in open ( 'data/ch02/usagov_bitly_data2012-03-16-1331923249.txt' )] frame = pd . DataFrame ( records ) # 从列表创建 DataFrame 2. 数据准备 In [5]: # 规整时区数据 frame [ 'tz' ] . fillna ( 'Missing' ) # 填充 缺失值 NA frame [ frame [ 'tz' ] == '' ] = 'Unknown' # 填充空值 3.数据转换 In [6]: # 按值统计个数 tz_counts = frame [ 'tz' ] . value_counts () # 从USER_AGENT 数据中获取客户浏览器类型数据 results = pd . Series ([ x . split ()[ 0 ] for x in frame . a . dropna ()]) # 从USER_AGENT 数据中获取客户操作系统数据 cframe = frame [ frame . a . notnull ()] operating_system = np . where ( cframe [ 'a' ] . str . contains ( 'Windows' ), 'Windows' , 'Not Windows' ) # 将时区按照操作系统分组 by_tz_os = cframe . groupby ([ 'tz' , operating_system ]) # 按分组计数，然后用 unstack重塑 数据 agg_counts = by_tz_os . size () . unstack () . fillna ( 0 ) # 以按行加和并排序的数据作为索引 indexer = agg_counts . sum ( 1 ) . argsort () #用 take 函数, 通过索引取出时区最多的值 count_subset = agg_counts . take ( indexer )[ - 10 :] 4.建模和计算 暂无 5. 结果展示 In [7]: # TOP10 时区 tz_counts [: 10 ] . plot ( kind = 'barh' ) Out[7]: In [8]: # TOP10 时区的操作系统数量（表） count_subset Out[8]: Not Windows Windows tz America/Sao_Paulo 13.0 20.0 Europe/Madrid 16.0 19.0 Pacific/Honolulu 0.0 36.0 Asia/Tokyo 2.0 35.0 Europe/London 43.0 31.0 America/Denver 132.0 59.0 America/Los_Angeles 130.0 252.0 America/Chicago 115.0 285.0 Unknown 521.0 0.0 America/New_York 339.0 912.0 In [9]: # TOP10 时区的操作系统数量（图） count_subset . plot ( kind = 'barh' , stacked = True ) Out[9]: In [10]: # TOP10 时区的操作系统比例（图） normed_subset = count_subset . div ( count_subset . sum ( 1 ), axis = 0 ) normed_subset . plot ( kind = 'barh' , stacked = True ) Out[10]: if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) { var mathjaxscript = document.createElement('script'); mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#'; mathjaxscript.type = 'text/javascript'; mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'; mathjaxscript[(window.opera ? \"innerHTML\" : \"text\")] = \"MathJax.Hub.Config({\" + \" config: ['MMLorHTML.js'],\" + \" TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },\" + \" jax: ['input/TeX','input/MathML','output/HTML-CSS'],\" + \" extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],\" + \" displayAlign: 'center',\" + \" displayIndent: '0em',\" + \" showMathMenu: true,\" + \" tex2jax: { \" + \" inlineMath: [ ['$','$'] ], \" + \" displayMath: [ ['$$','$$'] ],\" + \" processEscapes: true,\" + \" preview: 'TeX',\" + \" }, \" + \" 'HTML-CSS': { \" + \" styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }\" + \" } \" + \"}); \"; (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript); }","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/14/python_data_analysis2-1.html"},{"title":"基于Python的数据科学环境","text":"在 《数据科学的知识体系》 中， 列出了进行数据科学研究所需的知识。但Swami Chandrasekaran明显更喜欢 R 。 我个人更倾向于 python。至于为什么不是 R 或 Matlib，可以参考 《R vs Python vs matlab: the quant language war》 和 《R和Python的相遇》 。 其实，R 和 python 的边界也不是那么的无法逾越， 可以使用 rpy2 在 python 中调用 R， 也可以使用 rPython 在 R 中调用 python。 运行环境 Anaconda 尽管 Linux 和 Mac OS 自带了 python 环境，但还是推荐安装 Anaconda 。 Anaconda是python的一个科学计算发行版，包含了众多流行的科学、数学、工程、数据分析的Python包 1 。 从官方网站下载有点慢。如果用安装包进行安装， 可以从 清华大学开源软件镜像站(TUNA) 下载。 但还是建议 使用包管理器 进行安装，安装后再配置TNUA 上Anaconda 仓库的镜像作为源： conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ conda config --set show_channel_urls yes 安装和配置完 Anaconda 后，可以使用其自带的 python 包管理器安装 python 模块，也可以使用常用的 pip 。 但要注意环境的配置。比如： conda --version # 查看版本 conda install seaborn # ipython, jupyter 和 spyder python 本身提供了类似shell的交互式解释器，但是并不好用， IPython 对其进行了极大加强。 IPython是一个增强的 Python Shell，目的是提高编写、测试、调试 Python 代码的速度。 主要用于交互式数据处理和利用matplotlib 对数据进行可视化处理。 不仅如此，IPython 还提供了 web 方式的 IPython notebook(现在叫做 jupyter )， 已经成为Python科学计算界的标准配置。 如果你喜欢像 R 一样的 GUI 程序，可以使用命令 jupyter qtconsole 打开一个图形界面。 如果喜欢 RStudio，可以使用 spyder . （附：可能是 IPython notebook 太好用了， RStudio 现在也实现了一个类似的 web 交互工具 shiny )。 Cython 编译Python程序，提高性能。 底层库 NumPy python 中本来提供了 列表(list) 和 数组(array), 可以用来构建矩阵。 但是这些都是通用数据结构，对于纯数值运算来说效率不高。而且没有矩阵运算的函数。 NumPy 弥补了这些不足，为线性代数的计算提供了极大帮助。 NumPy 定义了ndarray(N维数组对象，N-dimensional array object)和 ufunc(通用函数对象, universal function object)， 分别用于多维数组的存储和处理。 其中，ufunc 是一种能对数组的每个元素进行操作的函数。 Numpy 还支持线性代数运算和随机数生成。 Numpy是下面很多模块的基础模块。 SciPy SciPy 在NumPy的基础上增加了众多的数学、科学以及工程计算中常用的模块。 通过不同的子模块，SciPy 提供了线性代数、拟合与优化、差值、数值积分、图像处理、系数矩阵处理等函数。 Numpy 已经提供了线性代数函数库，但是SciPy的线性代数库比NumPy更加全面。 SciPy 的主要子模块包括： scipy.integrate: 数值积分例程和微分方程求解器 scipy.linalg: 扩展了由 numpy.linalg 提供的线性代数例程和矩阵分解功能 scipy.optimize: 函数优化器以及根查找算法 scipy.signal: 信号处理工具 scipy.sparse: 稀疏矩阵和稀疏线性系统求解器 scipy.special: SPECFUN（这是一个实现了许多常用数学函数的 Fortran 库）的包装器 scipy.stats: 标准连续和离散概率分布、各种统计检验方法和更好的描述统计法 scipy.weave: 利用内联 C++ 代码加速数组计算的工具 matplotlib Matplotlib 为 python 提供了一整套和MATLAB类似的绘图函数集。 Matplotlib 很强大，但是比较底层。高级的python 数据处理模块会调用 Matplotlib 实现更简单的绘图函数， 比如后面要提到的 Pandas, Seaborn等。 但是要对图表进行精细的、个性化的调整时，还是需要掌握 Matplotlib 的函数。 数据分析和处理 Pandas Pandas , Python Data Analysis Library, 是 python 数据分析领域里程碑式的一个重要工具。 Pandas 基于 NumPy, 实现了 Series(序列) 和类似 R的 DataFrame 对象， 提供了大量能使我们快速便捷地处理数据的函数和方法。 Pandas 很好的解决了数据分析的大部分任务，是所有中等规模数据分析的最有效的工具。 Statsmodels Statsmodels 是 Python 中一个强大的统计分析包，包含了描述统计、回归分析、时间序列分析、假设检验等等的功能。 一些主要的功能包括： Linear regression models Generalized linear models Discrete choice models Robust linear models Many models and functions for time series analysis Nonparametric estimators A collection of datasets for examples A wide range of statistical tests Input-output tools for producing tables in a number of formats (Text, LaTex, HTML) and for reading Stata files -into NumPy and Pandas. Plotting functions Extensive unit tests to ensure correctness of results Many more models and extensions in development SymPy SymPy 是Python的数学符号计算库，目标是成为一个全功能的代数系统。 SymPy支持符号计算、高精度计算、模式匹配、绘图、解方程、微积分、组合数学、离散数学、几何学、概率与统计、物理学等方面的功能。 可视化 Seaborn Seaborn 是基于 Matplotlib 的高级统计绘图工具（类似 Pandas 与 NumPy 的关系），其功能类似 R 中的 lattice。 Matplotlib很强大，但是也很复杂。因此推荐一开始使用Seaborn。 Bokeh Bokeh(Bokeh.js) 是一个 Python 交互式可视化库，支持现代化 Web 浏览器，提供非常完美的展示功能。 Bokeh 的目标是使用 D3.js 样式提供优雅，简洁新颖的图形化风格，同时提供大型数据集的高性能交互功能。 Boken 可以快速的创建交互式的绘图，仪表盘和数据应用。 TVTK 数据的三维可视化 VPython 制作3D演示动画 OpenCV 图像处理和计算机视觉 机器学习 scikit-learn For machine learning and artificial intelligence algorithms PyTorch 深度学习 Enthought Tool Suite Enthought Tool Suite 是 Enthought公司 开发的开源科学计算一套应用程序开发包。 包含了大量的工具。主要的工具包括： Traits Explicit type declarations; validation; initialization; delegation; notification; visualization. TraitsUI A UI layer that supports the visualization features of Traits. Implementations using wxWidgets and Qt are provided by the TraitsBackendWX and TraitsBackendQt projects. Chaco 交互式 2D 图表 Mayavi 交互式 3D 图表 其他 Enaml Library for creating professional quality user interfaces combining a domain specific declarative language with a constraints based layout. Envisage Python-based framework for building extensible (plugin-based) applications. Pyface toolkit-independent GUI abstraction layer, which is used to support the \"visualization\" features of the Traits package. BlockCanvas Visual environment for creating simulation experiments, where function and data are separated using CodeTools. GraphCanvas library for interacting with visualizations of complex graphs. Enable Object drawing library and PDF vector drawing engine. SciMath Convenience libraries for math, interpolation, and units Casuarius supports constraints based layout in Enaml by wrapping Cassowary. AppTools General tools for ETS application development: scripting, logging, preferences, ... EnCore Core tools for application development (only depends on the Standard library). and more... 参考资料 Python科学计算发行版—Anaconda ↩ 用Python做科学计算 ↩ 用Python做科学计算(第二版) ↩ Comprehensive learning path – Data Science in Python ↩ Python for statistical computing ↩","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/11/dataology_python_env.html"},{"title":"windows下面的包管理器：Chocolatey","text":"系统级别的包管理器 开发人员一般都喜欢命令行操作，因为效率更高。在管理系统上的软件时，更喜欢用包管理器( package manager )。 Linux 下面我们已经熟悉了 yum , apt 等，在 Mac OS 下面， Homebrew 最终战胜了 MacPort 。 但是有时候我们不得不使用 windows，比如 万德。 Windows 的软件管理，以前是一些第三方的\"软件仓库\"，比如 百度软件管理等，但是难保上面没有地雷。 Windows 10 自己提供了\"软件商店\"，安全性应该大有改观，但是使用仍很受限制，尤其是开发用的软件很不全。 我们需要一个 Windows 下面的包管理器。所幸，现在有了 Chocolatey 。 使用包管理的好处不仅仅是提高效率，更重要的是使得 Windows 的自动运维成为可能。 比如，原来 SaltStack 的很多脚本在 Windows 下很难实现，但有了 Chocolatey ， 用 SaltStack 管理Windows 服务器的难度大大降低。 原理 Chocolatey 使用 Nuget 协议，将软件的官方链接封装到描述文件中。 可以查看 软件包列表 。 安装 Chocolatey 需要的环境为： Windows 7+ / Windows Server 2003+ PowerShell v2+ .NET Framework 4+ 管理员权限 以管理员的权限安装。可以使用 PowerShell ，但先要修改 PowerShell的执行策略： Set-ExecutionPolicy unrestricted iwr https://chocolatey.org/install.ps1 -UseBasicParsing | iex 也可以使用 Cmd 、 CygWin 、。。。 等命令行工具： @powershell -NoProfile -ExecutionPolicy Bypass -Command \"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\" && SET \"PATH=%PATH%;%ALLUSERSPROFILE%\\chocolatey\\bin\" 使用 安装好 Chocolatey 后，可以通过如下命令查看使用帮助： choco help Chocolatey 的命令一般提供两种格式，比如安装软件可以使用长格式 choco install , 或者短格式 cinst 。 可以根据需要选择。但我个人更喜欢长格式，因为跟其他包管理器的命令更接近。 Chocolatey 的常用命令包括： 搜索: choco search ，用 -all 参数会显示所有可用的版本 安装: choco install , 用 -version 参数可以安装指定版本 查找更新: choco version 升级: choco upgrade 卸载: choco uninstall 小结 使用 Chocolatey 可以管理很多软件包，比如 Linux 下面常用的 ~curl~, 一些小工具如 ~7zip~， 各种开发环境和工具如 ~git~, ~nodejs~, 甚至一些大型 GUI程序如 ~SublimeText3~, ~virtualbox~, ~VisualStudio2013Ultimate~. 通过命令行的方式，可以将按照操作纳入到 SaltStack 的管理中。 相信通过深入挖掘，Chocolatey 能够发挥很大的作用。","tags":"软件开发","loc":"http://holbrook.github.io/2017/02/11/windows_pkg_manager_chocolatey.html"},{"title":"数据科学的知识体系","text":"数据科学是利用计算机的运算能力对数据进行处理，从数据中提取信息，进而形成\"知识\"。 然而要实现这一点并不容易。Swami Chandrasekaran在他的 《Becoming a Data Scientist》 中，规划了\"数据科学家\"之路，让我们共勉。 先上图： 1.基本原理(Fundamentals) 矩阵和线性代数(Matrices & Linear Algebra) 数据存储和处理 哈希函数，二叉树，时间复杂度(Hash Functions,Binary Tree,O(n)) 关系代数和数据库基础(Relational Algebra,DB Basic) 内连接、外连接、交叉连接、θ连接(Inner、Outer、Cross、Theta Join) CAP定理（CAP Theorem） 列表数据(tabular data) 数据框和序列(DataFrames & Series) 分片(Sharding) 联机分析处理（OLAP, Online Analytical Processing） 多维数据模型(Multidimensional Data Model) ETL 报表，商业智能与分析(Reporting vs BI vs Analytics) JSON & XML NoSQL 正则表达式（Regex, Regular Expression） 业务背景知识(Vendor Landscape) 安装环境(Env Setup) 2.统计学(Statistics) 获取数据(Pick a Dataset) UCI Repo: UCI数据库。是加州大学欧文分校(University of CaliforniaIrvine) 提出的用于机器学习的数据库，有大量的数据集。 描述性统计Descriptive Statistics 均值，中位数，极差，标准差，方差(（mean, median, range, SD, Var） 探索性数据分析(Exploratory Data Analysis) 直方图(Histograms) 百分位数和极值(Percentiles & Outliers) 概率论(Probability Theory) 贝叶斯定理(Bayes Theorem) 随机变量(Random Variables) 累计分布函数（CDF, Cumulative Distribution Function) 连续分布(Continuos Distributions) 正态分布、泊松分布、高斯分布(Normal, Poisson, Gaussian) 偏度(Skewness) 方差分析(ANOVA) 概率密度函数(PDF,Prob Den Fn) 中心极限定理(Central Limit THeorem) 蒙特卡罗方法(Monte Carlo Method) 假设检验(Hypothesis Testing) P值(p-Value) 卡方检验(Chi2 Test) 估计(Estimation) 置信区间(CI,Confid Int) 极大似然估计(MLE) 核密度估计(Kernel Density Estimate) 回归(Regression) 协方差(Convariance) 相关性(Correlation) 皮尔逊相关系数(Pearson Coeff) 因果性(Causation) 最小二乘法(Least2 fit) 欧氏距离(Eculidean Distance) 3.编程(Programming) python基础(Python Basics) R Excel 数据结构 Swami Chandrasekaran 给出的是 R 中的数据结构，但可以映射到python中。 变量(Varibles) 向量(Vectors) 矩阵(Matrices) 数组(Arrays) 因子(Factors) 列表(Lists) 数据框(Data Frames) 4.机器学习(Machine Learning) 机器学习与数据挖掘的区别(What is ML?) 数值变量(Numerical Var) 分类变量(Categorical Var) 监督学习(Supervised Learning) 无监督学习(Unsupervied Learning) 概念、输入和特征(Concepts, Inputs & Attributes) 训练集和测试集(Traning & Test Data) 分类器(Classifier) 预测(Prediction) Lift曲线 过拟合(Overfitting) 偏差和方差(Bias & Variance) 树分类(Trees & Classification) 分类问题(Classification) 分类正确率(Classification Rate) 决策树(Decision Trees) 提升方法(Boosting) 朴素贝叶斯分类(Naive Bayes Classifiers) K近邻分类(K-Nearest Neighbour) 回归问题(Regression) 逻辑回归(Logistic Regression) 排序(Ranking) 线性回归(Linear Regression) 感知机(Perceptron) 聚类问题(Clustering) 层次聚类(Hierarchical Clustering) K聚类(K-means Clusterning) 神经网络(Neural Networks) 情感分析(Sentiment Analysis) 协同过滤(Collaborative Fitering) 标签(Tagging) 5.文本挖掘/自然语言处理(Text Mining / NLP) 语料库(Corpus) 命名实体识别(Named Entity Recognition) 文本分析(Text Analysis) UIMA 词-文档矩阵(Term Document Matrix) 词频和权重(Term Frequency & Weight) 支持向量机(Support Vector Machines) 关联规则(Association Rules) 购物篮分析(Market Basket Analysis) 特征提取(Feature Extraction) 工具箱 Mahout Weka NLTK 文本分类(Classify Text) 词汇映射(Vocabulary Mapping) 6.数据可视化 单变量、双变量和多变量可视化(Uni, Bi & Multivariate Viz) ggplot2(R中的一个可视化包，python中使用pyplotlib) 直方图和饼图（单变量）(Histogram & Pie(Uni)) 树图和矩形树图(Tree & Tree Map) 散点图（双变量）(Scatter Plot (Bi)) 折线图（双变量）(Line Charts (Bi)) 空间图(Spatial Charts) Survey Plot 时间轴(Timeline) 决策树(Decision Tree) D3.js(知名的数据可视化前端框架) IBM ManyEyes(IBM的一款在线可视化处理工具) Tableau(国外知名的商用BI) 7.大数据(Big Data) MapReduce框架(Map Reduce Fundamentals) Hadoop组件(Hadoop Components) HDFS(Hadoop分布式文件系统,Hadoop Distributed FilesSystem） 数据复制原理(Data Replication Principles) 名称和数据节点(Name & Data Nodes) 任务跟踪(Job & Task Tracker) Map/Reduce编程(M/R Programming) Sqoop工具: Loading Data in HDFS Flue, Scribe: 处理非结构化数据 利用Pig语言进行SQL操作(SQL with Pig) 利用Hive来实现数据仓库(DWH with Hive) Scribe, Chukwa For Weblog(日志收集器和数据收集器) 使用Mahout Zookeeper 和 Avro Storm: Hadoop Realtime Rhadoop, RHipe, SparkR ： 将R和hadoop结合起来的架构 rmr: RHadoop的一个包，和hadoop的MapReduce相关 NoSql数据库 Classandra MongoDB Neo4j 8.数据摄取(ingestion) 数据格式概要(Summary of Data Formats) 数据发现(Data Discovery) 数据来源与采集(Data Sources & Acquisition) 数据集成(Data Integration) 数据融合(Data Fusion) 转换和浓缩(Transformation & Enrichament) 数据调查(Data Survey) Google OpenRefine: Google发布的开源的数据处理软件 数据量级(How much Data) ETL 9.数据清洗(munging) 维度与数值归约(Dimensionality & Numerosity Reduction) 数据规范化(Normalization) 数据清洗(Data Scrubbing) 缺失值处理(Handling Missing Values) 无偏估计量(Unbiased Estimators) 分箱稀疏值(Binning Sparse Values) 特征提取／特征工程(Feature Extraction) 去噪(Denoising) 抽样(Sampling) 分层抽样(Stratified Sampling) 主成分分析(PCA,Principal Component Analysis) 10.工具集 微软的Excel及其自带的分析工具库(MS Excel / Analysis ToolPak) Java, Python R, R-Studio, Rattle（Rattle是基于R的数据挖掘工具，提供了GUI） Weka(基于JAVA环境下开源的机器学习以及数据挖掘软件) Knime(基于Eclipse环境的开源商业智能工具) RapidMiner(开源的数据挖掘软件,提供一些可扩展的数据分析挖掘算法的实现。) Hadoop发行版选择(Hadoop Dist of Choice) Spark, Storm: Hadoop相关的实时处理框架，是对Hadoop的补充和完善 Flume: 海量日志采集、聚合和传输的系统 Scribe: Facebook开源的日志收集系统，在Facebook内部已经得到的应用 Chukwa: 开源的用于监控大型分布式系统的数据收集系统 Nutch: 一个开源的Java搜索引擎 Talend： 一家专业的开源集成软件公司，提供各类数据工具 ScraperWiKi： 致力于数据科学领域维基百科网站，帮助个人和企业获得最专业的可视化数据，并支持对数据进行分析和管理 Webscraper： 网页爬虫 Flume: 海量日志采集、聚合和传输的系统 Sqoop: Haddop套件 tm: R语言的文本挖掘包 RWeka: R的weka算法包 NLTK: 自然语言工具包 RHIPE: R与Hadoop相关的开发环境 D3.js ggplot2 Shiny: 在线网页交互可视化工具, 可以将R语言作为半个BI用。 IBM Languageware: IBM的自然语言处理 Cassandra, MongoDB: 2种NoSql数据库 参考资料 知乎上面秦路的回答 Vamei对数据科学的理解","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/05/index.html"},{"title":"搭建一个\"现代化\"的web开发环境","text":"目标 将要开展的一个项目，使用Angularjs 和 Flask开发一个web界面， 作为saltstack和其他自行开发的python小工具的前端界面， 实现自己的\"运维操作平台\"。 为了统一框架、工具和开发方式，在本文中描述了项目的一些约定。 这些约定具有通用性，应该是目前基于python的web开发技术中， 比较\"主流\"和\"先进\"的方式，所以也可以作为开发其他应用的参考。 工具和框架 工具 版本管理 基于 gogs 的私有git 问题管理、版本发布、资料共享 redmine 项目管理 redmine的scrum插件 nodejs包管理器 npm (node package manager)。 本文中，npm仅作为安装yoeman, bower，grunt等的基础工具。 js依赖管理: bower npm可以安装js包，但是没有解决依赖的问题。而bower解决了js包的依赖管理。类似maven中的依赖管理功能。 前端构建工具: grunt js开发中的项目构建工具，类似maven/ant/makefile， 通过配置文件执行压缩,编译, 单元测试, 代码检查以及打包发布的任务。 前端脚手架工具 yoeman 。类似maven的archetypes。 python开发环境管理 virtualenv 框架和插件 样式库 Bootstrap chartjs 前端框架： AngularJS 后端框架： Flask Flask-SQLAlchemy Flask-RESTful 环境准备 本文中仅给出MacOS下的安装方法，其他系统可以阅读官方文档或参考资料。 #安装npm brew install npm #全局安装工具 npm install -g yo grunt-cli grunt bower generator-angular #安装virtualenv sudo easy_install pip sudo pip install virtualenv 搭建工程 创建工程目录 mkdir -p PROJ \\_ ROOT/web \\# 前端工程目录 mkdir -p PROJ \\_ ROOT/app/APP \\_ NAME \\# 后端工程目录 \\# +END 创建前端工程 cd PROJ \\_ ROOT/web yo angular \\# 一些交互，按照自己的需要选择即可。 \\# ... 配置前端工程 修改IP地址 将connect -> hostname, 由'localhost' 改为 '0.0.0.0' 修改dist目录 将appConfig -> dist 有 'dist' 改为 '../app/APP_NAME/static' virtualenv cd PROJ \\_ ROOT virtualenv venv source venv/bin/activate pip install flask pip install sqlalchemy pip install flask-sqlalchemy ... pip freeze > app/requirements.txt 构建Flask工程 mkdir -p PROJ \\_ ROOT/app/APP \\_ NAME/common mkdir -p PROJ \\_ ROOT/app/APP \\_ NAME/models mkdir -p PROJ \\_ ROOT/app/APP \\_ NAME/static mkdir -p PROJ \\_ ROOT/app/APP \\_ NAME/templates mkdir -p PROJ \\_ ROOT/app/APP \\_ NAME/views touch PROJ \\_ ROOT/app/APP \\_ NAME/common/__init__.py touch PROJ \\_ ROOT/app/APP \\_ NAME/models/__init__.py touch PROJ \\_ ROOT/app/APP \\_ NAME/views/__init__.py 配置git cd PROJ \\_ ROOT mv web/.gitattributes . rm -f web/.gitignore cat > .gitignore << EOF web/node_modules web/.tmp web/.sass-cache web/bower_components dist venv EOF 使用 以上是工程框架搭建的过程，对于开发人员，不需要要这么麻烦，只要从版本库中获取源代码后进行初始化即可： git clone xxxx cd PROJ_ROOT virtualenv venv source venv/bin/activate pip install -r app/requirements.txt cd web npm install bower install 启动前端 cd PROJ_ROOT/web grunt serve 然后通过http://0.0.0.0:9000可以访问前端界面。 启动后端 cd PROJ \\_ ROOT/app python run.py 然后通过http://127.0.0.1:5000/ 访问后端应用。 知识准备 在开始开发之前，开发人员最好熟悉以下内容： - Bootstrap入门: http://v3.bootcss.com/getting-started/ - Angularjs入门教程: http://www.ituring.com.cn/article/13471 - Flask系列教程 :http://www.oschina.net/translate/the-flask-mega-tutorial-part-i-hello-world - SQLAlchemy教程: 参考资料 NPM小结 chyingp http://www.cnblogs.com/chyingp/p/npm.html bower解决js的依赖管理 | 粉丝日志 http://blog.fens.me/nodejs-bower-intro/ getting started with Yeoman http://yeoman.io/learning/index.html Yeoman自动构建js项目 | 粉丝日志 http://blog.fens.me/nodejs-yeoman-intro/ grunt让Nodejs规范起来 | 粉丝日志 http://blog.fens.me/nodejs-grunt-intro/ Bootstrap入门 http://v3.bootcss.com/getting-started/ AngularJS入门教程 http://www.ituring.com.cn/article/13471 Flask系列教程 http://www.oschina.net/translate/the-flask-mega-tutorial-part-i-hello-world 使用 Flask 和 AngularJS 构建博客 - 1 http://segmentfault.com/a/1190000000654088 使用 Flask 和 AngularJS 构建博客 - 2 http://segmentfault.com/a/1190000000665636 references: - id: fenner2012a title: One-click science marketing author: - family: Fenner given: Martin container-title: Nature Materials volume: 11 URL: 'http://dx.doi.org/10.1038/nmat3283' DOI: 10.1038/nmat3283 issue: 4 publisher: Nature Publishing Group page: 261-263 type: article-journal issued: year: 2012 month: 3","tags":"软件开发","loc":"http://holbrook.github.io/2015/05/04/modern_web_dev_env.html"},{"title":"持续集成(CI)工具的作用","text":"个人时代的软件开发 众所周知，软件开发一般需要编码、构建、测试、打包、发布等步骤，如下图： {% graphviz dot { digraph G{ rankdir=LR Code -> Build -> Test -> Package -> Deploy } } %} 在\"个人英雄\"时代，一个人完成所有的事情，一切都不是问题。 团队开发 很快，软件的规模就上升到了个人无法完成的程度。这就需要团队开发。在团队开发模式中，一定要解决代码共享的问题: {% graphviz dot { digraph G{ rankdir=LR subgraph cluster_process { label=\"开发过程\" graph [rankdir=LR] Code -> Build -> Test -> Package -> Deploy } repo1 [shape=\"folder\" label=\"代码库\"] repo2 [shape=\"folder\" label=\"配置库\" style=\"dashed\"] Code -> repo1 Build -> repo2 } %} 图中的\"代码库\"，通常由版本管理软件负责，比如git,svn。 对于软件的配置信息，开发团队通常不会很十分在意——要么随源代码一起放入版本库，要么由\"实施人员\"临时配置。 开发和运维 企业应用的环境中，通常开发团队和运维团队是分开的。这就形成了一堵墙: 当软件系统从墙的一端(Dev)传递到另一端(Ops)时，会发生各种各样不可预知的情况发生。这些\"异常\"通常是由于交付了不正确的东西： 开发人员不清楚生成环境，而运维人员又搞不定即没有规范又没有文档的配置 开发过程中的不成熟版本进入了生成环境 …… 在开发团队和运维团队之间，也应该有一个信息交换和缓冲带，主要是： {% graphviz dot { digraph G{ rankdir=LR subgraph cluster_process { label=\"开发过程\" graph [rankdir=LR] Code -> Build -> Test -> Package -> Deploy } repo1 [shape=\"folder\" label=\"代码库\"] repo2 [shape=\"folder\" label=\"配置库\"] repo3 [shape=\"folder\" label=\"交付库\"] Code -> repo1 Build -> repo2 Package -> repo3 -> Deploy } } %} 配置库 有严格的环境(开发、测试、生产环境)区分，有版本管理的配置库，开发人员和运维人员各自维护自己需要的配置信息。 交付库 经过测试，符合要求的软件版本，经过规范的打包后，才允许进入交付库。交付库的软件包是部署生成环境的唯一来源。 自动化工具 有了代码库、配置库和交付库，加上繁杂的管理规范、流程指南，额外配上检查员、管理员，大概就可以完成上述的过程。 但是，我们需要自动化！持续集成(CI)工具就是时上述过程自动化的有力工具——以至于随时可以以很小的代价将上述过程跑一遍。 持续集成工具的主要功能如下图： {% graphviz dot { digraph G{ graph [layout=\"dot\"] repo1 -> {Code m1} Code -> Build -> Test -> Package -> Deploy // Code -> repo1 -> m1 m2 -> Build m4 -> {Build Test Package Deploy} Package -> m3 m5 -> servers repo1 [shape=\"folder\" label=\"代码库\"] {rank=same; repo1; Code ; Build ; Test ; Package ; Deploy; servers} subgraph cluster_ci { label=\"持续集成\" {rank=same; m1; m2; m3; m4; m5} m1 [label=\"工程管理\" shape=\"rect\"] m2 [label=\"配置库\" shape=\"folder\"] m3 [label=\"交付库\" shape=\"folder\"] m4 [label=\"自动执行\" shape=\"rect\"] m5 [label=\"发布管理\" shape=\"rect\"] } servers [label=\"服务器\" shape=\"box3d\"] } } %} CI工具实现了与代码库关联的软件工程管理，能够自动执行构建、测试、打包、发布等操作。 CI工具通常内置了配置库和交付库，在自动构建时可以从配置库获取配置信息，在自动发布时从交付库取得指定的软件版本并部署到服务器。 此外，CI工具还会提供事件通知、生成报告等功能。 常见的CI工具 Hudson 这个大概是最流行的CI工具了，使用Java开发。 BuildBot 使用Python语言开发。好用，但是有点小众。 Jenkins 也是使用Java开发。","tags":"软件开发","loc":"http://holbrook.github.io/2014/03/04/ci_tools.html"},{"title":"Apache Karaf：OSGi中间件","text":"为什么需要\"OSGi中间件\" 尽管在OSGi Runtime(Felix, Equinox等)的基础上，OSGi组织又规定了 Blueprint规范以实现OSGi环境下的依赖注入 ， 但这还不够——没有提供类似Web开发框架那样的一些\"平台级\"的功能。比如日志，控制台，配置文件等。 很难想象没有Tomcat这样的Web中间件，开发Java Web应用的工作量有多大。同样的，OSGi应用也需要一种\"中间件\"，来实现各应用共性的一些功能，并管理应用的部署。 Apache Karaf 就是这样的一个\"OSGi中间件\"。最早，Karaf只是 Apache ServiceMix 的Kernel子项目，后来独立出来成为Apache的顶级项目。 目前，Apache Karaf已经用于Apache Geronimo, Apache ServiceMix, Fuse ESB等项目。 Apache Karaf的主要竞争对手是 Eclipse Virgo 。 Apache Karaf的功能 Apache Karaf提供了如下\"开箱即用\"的功能： 热部署 尽管OSGi支持热部署，但并不是自动热部署，需要调用一些API去执行插拔的动作。Karaf在运行时可以自动处理 [home]/deploy 文件夹中的OSGi bundle，能够自动加载并在满足依赖关系时自动启动。 动态配置 Karaf在 $KARAF_HOME/etc 文件夹中存储配置文件。这些配置内容可以在Karaf运行时动态修改。 日志处理 基于Log4J的日志系统，同时支持多种日志API，如JDK 1.4, JCL, SLF4J, Avalon, Tomcat, OSGi等。 系统服务 Karaf可以作为系统服务运行。 控制台 可以在控制台进行服务管理、安装bundle等操作。还可以扩展自己的控制台命令。 可以通过SSH远程访问其他服务器上的Karaf控制台。 多实例管理 一个服务器上可以运行多个Karaf实例。对实例的管理可以在Karaf控制台中进行。 Bundle仓库 Karaf中内置了 Pax URL 的MVN协议，可以从Maven中央仓库安装bundle。 Bundle集合(Feature) 类似于Eclipse的Feature，Karaf中也支持Feature，即bundle的集合。使用Feature可以简化OSGi应用的部署。 Karaf初体验 安装好Java环境，加压缩Karaf，执行 $KARAF_HOME/bin/karaf ，可以看到Karaf的启动界面： 如图的提示，使用 <tab> 可以列出所有可用的命令，所有的命令支持 --help 参数。 如果执行 list 命令，可以列出所有的bundles: 还有很多其他的命令，比如 bundle:install 安装bundle feature:repo-add 安装feature库 feature:install 安装feature 等等。详情可以参考官方的 Quick Start 。 如果查看Karaf的目录，可以看到如下的目录结构： /bin : 启动、停止、登录karaf控制台的脚本 /etc : 配置文件 /data : 存放运行时的工作文件，清空这个目录可以使Karaf回到初始状态 /cache : OSGi framework的bundle缓存 /generated-bundles : 开发用的临时目录 /log : 日志 /deploy : 用于bundle的热部署 /instances : 存放karaf的各个实例用到的数据 /lib : 启动Karaf时需要的一些库 /lib/ext : Karaf需要的扩展库 /lib/endorsed : Karaf对其他API的再封装(背书)的一些jar包 /system : OSGi bundles库，使用Maven 2仓库的结构 Karaf启动模式和实例 常规模式(regular mode) 使用命令 bin/karaf ，可以在前端启动Karaf并进入控制台 服务模式(server mode) 使用命令 bin/karaf server ，可以在前端启动Karaf，但不进入控制台 后台模式(background mode) 使用命令 bin/start ，可以在后台启动Karaf。 如果安装了service-wrapper(可以在Karaf中执行 feature:install service-wrapper )，还可以将 Karaf安装为系统服务。 一个Karaf节点可以运行多个\"Karaf实例\"。实际上，默认情况下Karaf会启动一个名为 root 的实例。 实例是包含单独的配置文件、数据文件等信息的一个Karaf副本，每个实例可以单独启动或部署bundle。 Karaf控制台中提供了一些管理实例的命令： instance:create 创建实例 instance:clone 从现有的实例克隆一个新的实例 instance:start 启动实例 instance:status 查看实例状态 instance:connect 连接(切换)到某个实例 instance:stop 停止实例 instance:destroy 删除实例 ssh、客户端和Web控制台 Karaf内置了一个SSHd server，可以通过ssh远程访问Karaf控制台。 要启动远程控制台服务，需要在控制台中启动bundle: bundle:restart -f org.apache.karaf.shell.ssh 。此时，远端可以使用ssh远程访问控制台，比如: ssh -p 8101 karaf@localhost 。默认karaf用户的密码也是karaf。ssh的用户、密码、端口等都可以在 etc/org.apache.karaf.shell.cfg 中配置。 Karaf的客户端'bin/client'即可以连接本地控制台，也可以通过ssh连接远程控制台，甚至可以执行单个的命令。比如： bin/client -u karaf -p karaf -a 8101 hostname osgi:shutdown Karaf还可以安装Web控制台( feature:install webconsole )。通过Web控制台能够管理 Karaf的bundle、feature、实例、配置以及查看日志。启动web控制台后，默认可以通过 http://localhost:8181/system/console 访问web控制台，默认的用户名/密码为 karaf/karaf 。Web控制台的配置文件位于 etc/org.ops4j.pax.web.cfg 。 bundle URL和bundle仓库 Karaf在安装bundle时，可以使用多种URL来定位bundle，比如： http http://repo1.maven.org/maven2/org/apache/servicemix/nmr/org.apache.servicemix.nmr.api/1.0.0-m2/org.apache.servicemix.nmr.api-1.0.0-m2.jar file file:base/bundles/org.apache.servicemix.nmr.api-1.0.0-m2.jar maven库 mvn:org.apache.servicemix.nmr/org.apache.servicemix.nmr.api/1.0.0-m2 其中，maven库方式是使用maven库作为bundle仓库，从其中检索需要的bundle。与maven类似，可以自动解决bundle之间的依赖问题。 Karaf提供了OBR (OSGi Bundle Repository)，能够管理bundle仓库。在控制台使用命令 feature:install obr 安装OBR之后，就可以： 增加新的bundle仓库 obr:url-add file:///user/.m2/repository/repository.xml 查看已安装的bundle仓库 obr:url-list 刷新仓库 obr:url-refresh 删除仓库 obr:url-remove 列出所有可用的bundle obr:list 查找bundle obr:find OSGi应用，Karaf Feature和KAR OSGi运行的基本单元是bundle，bundle之间有依赖关系。一组满足依赖关系的bundle集合，加上相关的配置信息，称为一个\"OSGi应用\"。 将OSGi应用部署到Karaf的行为称为\"provisioning\"。 为了简化OSGi应用的部署，Karaf定义了feature，用于描述OSGi应用的部署信息，包括： 名称 版本号 描述信息 bundle集合 配置文件信息 依赖的其他feature 可以看出，Karaf中的feature与Eclipse Feature非常类似。 Karaf控制台中提供了一系列的feature和feature库的管理命令，包括： - feature:info - feature:install - feature:list - feature:repo-add - feature:repo-list - feature:repo-refresh - feature:repo-remove - feature:uninstall - feature:version-list 由于feature中可能使用远端的bundle，Karaf提出了 KAR 格式，可以把一个bundle相关的所有资源打包在一起。 这类似于使用maven定义的web工程，和最终打包的war文件之间的关系。 Karaf控制台中，可以打包( kar:create )、安装( kar:install )、卸载( kar:uninstall )或列出( kar:list )KAR文件。 企业级特性 Karaf提供了一系列的功能，以支持企业级应用的开发，包括： 日志 Karaf提供了 灵活的日志系统 ，支持 OSGi Log Service Log4j Commons Logging Logback SLF4J java Util Logging 等日志框架。不管应用中使用了上述哪种日志框架，Karaf中都可以进行统一的管理，如log level, appender等。 安全 Karaf提供了基于JAAS(Java Authentication and Authorization Service)的 安全框架 ，可以控制对OSGi service、控制台命令、JMX、Web控制台等资源的访问。并且在应用中也可以使用Karaf的安全框架。 Web Karaf可以 作为Web容器 使用，完全支持JSP/Servlet规范。 Karaf的Web容器同时支持WAR和WAB的部署。 JNDI Karaf 支持OSGi中的JNDI服务 。 JDBC、JPA和JTA Karaf中即可以 使用JDBC 直接连接数据库， 也可以 使用JPA 作为持久层框架。Karaf可以通过Blueprint管理JPA的persist Unit。 Karaf支持 JTA ，以实现容器管理的事务。 其他 Karaf还支持 EJB 、 CDI 、 JMX 、 JMS 等企业级特性。 Karaf内置支持主备方式的部署，以保证高可用。使用 Apache Karaf Cellar 可以实现Karaf的集群部署。","tags":"软件开发","loc":"http://holbrook.github.io/2014/02/20/apache_karaf.html"},{"title":"在markdown中嵌入graphviz","text":"在markdown中嵌入graphviz gravizo.com ![txt](http://g.gravizo.com/g? digraph G { aize =\"4,4\"; main [shape=box]; main -> parse [weight=8]; parse -> execute; main -> init [style=dotted]; main -> cleanup; execute -> { make_string; printf} init -> make_string; edge [color=red]; main -> printf [style=bold,label=\"100 times\"]; make_string [label=\"make a string\"]; node [shape=box,style=filled,color=\".7 .3 1.0\"]; execute -> compare; } ) abc","tags":"极限写作","loc":"http://holbrook.github.io/2014/02/17/graphviz_in_markdown.html"},{"title":"Graphviz概述","text":"Graphviz是什么 Graphviz 是基于dot语言的绘图工具，可以画有向图、无向图、关系图、目录图、流程图等各种你知道的或不知道的图形。可以欣赏Graphviz的 Gallery ，以及Yifan Hu的 gallery of large graphs 。 Graphviz使用 DOT语言 描述图形，并提供一组工具： dot 将生成的图形转换成多种输出格式，如PostScript，PDF，SVG，PNG，含注解的文本等等。 neato 用于sprint model的生成（在Mac OS版本中称为energy minimized）。 twopi 用于放射状图形的生成 circo 用于圆形图形的生成。 fdp 另一个用于生成无向图的工具。 dotty 一个用于可视化与修改图形的图形用户界面程序。 lefty 一个可编程的控件，它可以显示DOT图形，并允许用户用鼠标在图上执行操作。Lefty可以作为MVC模型的使用图形的GUI程序中的视图部分。 Graphviz使用 DOT语言 描述图形，而不是依赖于鼠标绘图，这就提供了无限的可能，主要体现在两个方面： 自动生成图形描述文件，从而自动生成图形 更加Geek的写作方式，比如在Org-mode中嵌入图形代码，在导出时自动生成图形文件 有一些强大的工具依赖或支持Graphviz，比如 OmniGraffle 和 PlantUML 。 DOT语言简介 DOT语言使用离散数学中的Graph描述图形，包括三个基本元素：grahp,node,edge。下面是一个例子： example.dot digraph G { main -> parse -> execute[label=\"edge label2\"]; main -> init[label=\"edge label1\"]; main -> cleanup; execute -> make_string; execute -> printf; init -> make_string; main -> printf; execute -> compare; } 执行命令 dot -Tpng example.dot -o example.png ，就可以生成如下的图形： DOT通过属性可以设置node和edge的样式，比如： graph graphname { // label属性可以改变节点的显示名称 a [label=\"Foo\"]; // 节点形状被改变了 b [shape=box]; // a-b边和b-c边有相同的属性 a -- b -- c [color=blue]; b -- d [style=dotted, label=\"无向图\"]; } 生成的图形如下： 更多的属性设置可以参考 官方文档 。 应用场景 Graphviz可以有很多玩法，常见的比如： 直接使用Graphviz绘图 ，以代替Visio等绘图工具 其他工具生成数据，Graphviz进行图表展示 利用脚本 动态生成图 嵌入轻量级标记语言，如org-mode和markdown中","tags":"极限写作","loc":"http://holbrook.github.io/2014/02/17/graphviz_intro.html"},{"title":"Apache Camel的核心概念","text":"Apache Camel的整体架构 Apache Camel 是一个消息处理引擎，实现了EIP(Enterprise Integration Patterns,企业整合模式)。 Camel能够用来处理来自于不同源的事件和信息，定义规则进行消息的传递和转换等处理，以实现基于消息的应用整合。其整体架构如下图所示： Message 和 Exchange org.apache.camel.Message 接口是对\"消息\"的抽象。消息由head、body、attachment等部分组成。 Camel中提供了一个默认的实现： org.apache.camel.impl.DefaultMessage ，可以适应大部分的应用场景。 不管是请求、响应，或者异常，都可以作为消息在上下文(CamelContext)的消息处理器(Processor)之间进行交换(Exchange)。 org.apache.camel.Exchange 接口就是对\"消息交换\"的抽象。 其中： Exchange ID : 区分每次消息交换的标识 MEP: （message exchange pattern，消息交换模式），分为单向(InOnly)和请求-应答(InOut)两种 Exception: 用于记录消息交换时发生的异常 In message: 上一个节点传入的消息 Out message: 当MEP 是InOut时，需要传出的消息 Camel提供了默认的 org.apache.camel.impl.DefaultExchange 实现。 Camel处理消息时，每个节点都在处理 Exchange 。 Endpoint 和 Component Endpoint(端点)，接收或发送消息的通道。通过 URI 连接消息源或目标。 为了适应各种不同的URI协议，如http,ftp,JMS,smtp等，Camel中提供了多种Endpoint，也支持扩展自己的Endpoint。 Component(不应该叫做组件，而应该是连接器connector)。 org.apache.camel.Component 接口只定义了两个方法： createConfiguration(String) createEndpoint(String) 通常，客户代码不会直接调用 createEndoint() 方法，而是由 CamelContext 对象进行调用。 Camel中提供了大量的Component的实现： Processor 不管是消息路由(Message Routing)、消息转换(Message Transformation)还是消息过滤(Message Filter)，都是对消息的某种处理(Process)。 Camel中，抽象出 org.apache.camel.Processor 接口，表示对消息的处理。该接口只定义了一个方法： void process(Exchange exchange) throws Exception; 从接口定义可以看出，Camel中认为可以处理消息交换(Exchange)的类都是消息处理器(Processor)。 基于Camle的应用可以开发自己的Processor实现，同时Camel提供了大量的内置Processor，以支持 EIP(Enterprise Integration Patterns) 。 CamelContext CamelContext是对Camel运行时的抽象，提供了API用于管理Component、Endpoint、Processor等节点： 一般来说，使用Camel的步骤如下： 创建一个CamelContext对象。 向CamelContext对象中添加Endpoints或者是Components 向CamelContext对象中添加路由(routes)规则 调用CamelContext的start()方法启动Camel引擎 通过Endpoint发送或接收消息 调用CamelContext的stop()方法时 定义路由(Route) 每个消息处理流程是由一系列的 Processor 连接而成的图(Graph)，每个图称为一个路由(Route)。 在开始使用Camel之前，需要在CamelContext中定义一个或多个路由。Camel支持使用DSL或者Spring XML进行配置。比如： RouteBuilder builder = new RouteBuilder () { public void configure () { from ( \"queue:a\" ) . filter ( header ( \"foo\" ) . isEqualTo ( \"bar\" )) . to ( \"queue:b\" ); from ( \"queue:c\" ) . choice () . when ( header ( \"foo\" ) . isEqualTo ( \"bar\" )) . to ( \"queue:d\" ) . when ( header ( \"foo\" ) . isEqualTo ( \"cheese\" )) . to ( \"queue:e\" ) . otherwise () . to ( \"queue:f\" ); } } ; CamelContext myCamelContext = new DefaultCamelContext (); myCamelContext .addRoutes ( builder ); 或者： <beans xmlns= \"http://www.springframework.org/schema/beans\" xmlns:xsi= \"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation= \" http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd \" > <!-- this is an included XML file where we only the the routeContext --> <routeContext id= \"myCoolRoutes\" xmlns= \"http://camel.apache.org/schema/spring\" > <!-- we can have a route --> <route id= \"cool\" > <from uri= \"direct:start\" /> <to uri= \"mock:result\" /> </route> <!-- and another route, you can have as many your like --> <route id= \"bar\" > <from uri= \"direct:bar\" /> <to uri= \"mock:bar\" /> </route> </routeContext> </beans> FUSE Mediation Router: 企业级Camel FuseSource提供Camel的经测试、认证并提供支持的企业级版本，称作 FUSE Mediation Router 。","tags":"并发系统","loc":"http://holbrook.github.io/2014/02/10/apache_camel.html"},{"title":"命令行界面设计","text":"命令行界面是否过时 答案是：不会的！ 1965年 OS/360 的发布标志着与硬件分离的\"通用\"操作系统的出现。 尽管8年后的1973年出现了 图形界面程序 ， 16年后的1981年出现了 图形界面的操作系统 ， 但是在此之后，至今三十几年过去了，图形界面(GUI)仍无法取代命令行界面(CLI)。 有什么理由可以说，图形界面终将取代命令行界面呢？ 不管是传统的linux\"神器\"，如find, grep, curl, netcat, xargs, rsync, screen，awk, vi, emacs， 还是让人惊叹的新作，如maven, git, salt，都有着强大的命令行界面。甚至你会有一种感觉： 为这些软件设计图形界面根本就是画蛇添足。 命令行界面的优势在于： 效率高 鼠标操作是最简单，同时也是最笨拙的操作 更专注 鼠标操作容易分心 速度快 CLI程序需要的资源少，启动和执行速度更快 易远程 ssh、telnet的连接比vnc、remote desktop等更容易 自动化 CLI不仅可以给人使用，也适用于自动化脚本 zhuangbility &#94;o&#94; 命令行界面的类型 按照复杂程度，命令行界面可以分为： 非交互式 一次性输入所有的参数，程序执行期间不需要用户的干预。这是最常见的命令行界面形式。 基于行的交互 在执行过程中，需要用户输入一些内容，比如确认信息、路径参数等。 由于用户交互会使程序难以用于自动化脚本，所以这种命令行界面并不多见，常用于基于命令行的安装程序。 文本用户界面(TUI) 类似于图形用户界面，没有明确的执行流程，完全由用户控制程序的执行步骤。比如vi和emacs。 CLI世界的潜规则 为了使你的CLI程序不会显得格格不入，在设计CLI程序时要遵守一些潜规则。 良好命名 容易理解 名字要短 容易记忆 必备选项 所有的命令行工具都应该提供=-v/--version=和=-h/--help=选项。 保持安静 程序的输出要\"恰到好处\"，让用户/其他程序明确知道必要的信息，又不过分\"啰嗦\"。过多的输出即会浪费系统资源和带宽，也会让用户感觉不舒服，更重要的是会使得其他程序的处理逻辑变得复杂。以下的原则有利于保持安静： 不要输出无关的信息，比如版本号、作者名------除非用户要求 对于很明确的结果，不需要再提醒用户。只应提示例外(exception)情况 不需要告诉用户输出的是什么东西------用户会知道的 如有必要，可以提供=-v/--verbose=和=-q/--quiet=选项，供用户选择 明确要求 在基于行的交互式CLI中，需要用户输入时要给出明确的提示，比如： =Do you really want to do this (y/n)?= =Enter a date (YYYY-MM-DD):= 支持管道 程序应该支持从管道或文件重定向中读取数据： 如果文件名作为参数传递给程序，就读取文件的内容作为输入 如果没有提供这样的参数，就从标准输入中读取，一直到 CTRL+D 功能单一 UNIX哲学中重要的一条原则就是：每个程序只做一件事情，并把它做好。 复杂的功能通过程序间的配合完成，而为了与其他的程序配合，要尽量支持管道和重定向。 既然\"只做一件事\"，就要\"做好一件事\"。 遵循惯例 UNIX中命令行参数会有一些惯例，比如=-=后面的单字母选项可以连用（如=ls -Al=), =--=后面使用多字母选项等；此外，遵循已经被广泛使用的命令的参数，也会容易被接受。 CLI支持库 CLI是如此重要，以至于很多语言/平台都提供了开发CLI的支持库，比如： python的optparse和argparse argparse更先进，旨在替代optparse，但是从python2.7开始才支持。如果希望在比较旧的linux上运行(通常支持python2.4)，最好还是使用optparse。 java的Apache Commons CLI Apache karaf的karaf-command-archetype python的TUI支持库 Urwid","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/30/cli_design.html"},{"title":"Blueprint: OSGi的依赖注入(DI)容器","text":"曾几何时，你在Spring和OSGi之间摇摆不定；曾几何时，你对SpringDM感到迷惑不解。 你是否向往OSGi的动态特性，又为遗留代码（尤其是基于Spring的代码）感到不舍？ 现在，这些都不再是问题！ 在 OSGi Service Platform Release 4 V4.2中， 提到了很多的 企业级规范(Enterprise Specification) ， 其中包括了规范121：Blueprint容器规范(Container Specification)。 Buleprint容器规范规定了一个OSGi容器(不是OSGi rumtime)的方方面面： Buleprint(或者说，OSGi Enterprise)目前有两个主要的实现： Eclipse Gemini 和 Apache Aries 。 其中Gemini的代码最初来自Spring DM，其实Blueprint规范的最早版本也来自Spring；而Aries已经用在Apache的众多企业级产品中。 在本文中，使用Aries Blueprint。 依赖注入 Blueprint Container 规范为 OSGi 定义了一个 依赖性注入（DI,Dependency Injection）框架，可以处理OSGi 的动态特性。 与 OSGi服务 或 OSGi Declarative Service ，不同，Blueprint依赖注入可以处理POJO对象的装配，使得POJO能够在OSGi中跨bundle访问。 这与 JSR330:Java依赖注入规范 很像，是该规范在OSGi环境下的扩展。 这也就是Spring DM(Spring Dynamic Modules)干的事情。实际上，Buleprint容器规范最初就来自于Spring， 而其Gemini实现更是来自SpringDM的捐赠。 无奈，如今 Spring已经宣布放弃OSGi 正所谓造化弄人，让人唏嘘不已。 Blueprint XML Blueprint使用XML文件描述装配关系，下面是一个例子： <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"no\"?> <blueprint xmlns= \"http://www.osgi.org/xmlns/blueprint/v1.0.0\" > <!-- Bean Manager Examples --> <bean id= \"accountOne\" class= \"org.apache.aries.samples.Account\" > <argument value= \"1\" /> <property name= \"description\" value= \"#1 account\" /> </bean> <bean id= \"accountTwo\" class= \"org.apache.aries.samples.StaticAccountFactory\" factory-method= \"createAccount\" > <argument value= \"2\" /> <property name= \"description\" value= \"#2 account\" /> </bean> <bean id= \"accountFactory\" class= \"org.apache.aries.samples.AccountFactory\" > <argument value= \"account factory\" /> </bean> <bean id= \"accountThree\" factory-ref= \"accountFactory\" factory-method= \"createAccount\" > <argument value= \"3\" /> <property name= \"description\" value= \"#3 account\" /> </bean> <bean id= \"prototypeAccount\" class= \"org.apache.aries.samples.Account\" scope= \"prototype\" > <argument value= \"4\" /> </bean> <bean id= \"singletonAccount\" class= \"org.apache.aries.samples.Account\" scope= \"singleton\" > <argument value= \"5\" /> </bean> <bean id= \"accountFour\" class= \"org.apache.aries.samples.Account\" init-method= \"init\" destroy-method= \"destroy\" > <argument value= \"6\" /> <property name= \"description\" value= \"#6 account\" /> </bean> <!-- Service Manager Examples --> <bean id= \"myAccount\" class= \"org.apache.aries.samples.MyAccount\" > <argument value= \"7\" /> <property name= \"description\" value= \"MyAccount\" /> </bean> <service id= \"serviceOne\" ref= \"myAccount\" interface= \"java.io.Serializable\" /> <service id= \"serviceTwo\" ref= \"myAccount\" > <interfaces> <value> java.io.Serializable </value> </interfaces> </service> <service id= \"serviceThree\" ref= \"myAccount\" auto-export= \"all-classes\" /> <service id= \"serviceFour\" ref= \"myAccount\" auto-export= \"all-classes\" > <service-properties> <entry key= \"mode\" value= \"shared\" /> <entry key= \"active\" > <value type= \"java.lang.Boolean\" > true </value> </entry> </service-properties> </service> <service id= \"serviceFive\" ref= \"myAccount\" auto-export= \"all-classes\" ranking= \"3\" /> <service id= \"serviceSix\" ref= \"myAccount\" auto-export= \"all-classes\" > <registration-listener registration-method= \"register\" unregistration-method= \"unregister\" > <bean class= \"org.apache.aries.samples.RegistrationListener\" /> </registration-listener> </service> <!-- Service Reference Manager Examples --> <reference-list id= \"serviceReferenceListTwo\" interface= \"java.io.Serializable\" availability= \"optional\" > <reference-listener bind-method= \"bind\" unbind-method= \"unbind\" > <bean class= \"org.apache.aries.samples.ReferenceListener\" /> </reference-listener> </reference-list> <!-- Environmental Manager Example --> <bean id= \"accountManagerOne\" class= \"org.apache.aries.samples.AccountManager\" > <property name= \"managerBundle\" ref= \"blueprintBundle\" /> </bean> <!-- Object Values Examples --> <bean id= \"accountManagerTwo\" class= \"org.apache.aries.samples.AccountManager\" > <property name= \"managedAccount\" > <ref component-id= \"accountOne\" /> </property> </bean> <bean id= \"accountManagerThree\" class= \"org.apache.aries.samples.AccountManager\" > <property name= \"managedAccount\" > <bean class= \"org.apache.aries.samples.Account\" > <argument value= \"10\" /> <property name= \"description\" value= \"Inlined Account\" /> </bean> </property> </bean> <bean id= \"accountManagerFour\" class= \"org.apache.aries.samples.AccountManager\" > <property name= \"accountNumbers\" > <list> <value> 123 </value> <value> 456 </value> <value> 789 </value> </list> </property> </bean> </blueprint> 可以看出，这个文件与Spring的配置文件非常类似。 Blueprint XML中可以标记 bean ， service 、 reference-list 等元素，用于bean管理、service管理和service引用管理。 Bean管理 通过 <bean> 标签定义Bean，容器可以创建bean、设置属性。bean的创建可以基于构造函数、静态工厂或工厂方法；属性可以是基本类型，也可以引用其他的bean。可以设置bean的scope为singleton或prototype。 Service管理 bean只能在当前bundle中使用。要跨bundle引用，必须定义服务。服务可以依赖bean或其他服务。 服务管理用于在OSGi服务注册表中注册服务。容器会根据服务的依赖关系是否满足，自动注册或注销服务。 Service引用管理 通过 <reference> 和 <reference-list> 标签可以引用其他bundle中发布的服务。两个标签分布用于引用单个服务和引用服务列表。 一个bundle可以有一个或多个xml配置，通常位于 OSGI-INF/blueprint/ 目录下，也可以在 META-INF/MANIFEST.MF 文件中通过 Bundle-Blueprint 属性进行指定。 更多关于Blueprint XML配置的内容和例子，可以参考 Apache Aries官方的例子 ，以及 developerWorks上的这篇文章 工作原理 Blueprint Container 使用扩展器（extender）模式，监视OSGi框架中的bundle的状态。当新的bundle被激活时， Blueprint根据该bundle是否有Blueprint XML配置文件判断是否需要容器进行处理。 处理的过程是为该bundle创建一个容器，通过容器解析XML文件，并将组件装配到一起。如果bundle中的服务依赖得到满足，容器还会调用 OSGi DS 发布服务。 在停止bundle时，也会进行相反的销毁过程。 在Eclipse中运行和调试 可以在前面 通过maven手工创建Felix运行环境 的基础上， 增加Blueprint需要的bundle: <!-- for aries blueprint --> <artifactItem> <groupId> org.apache.aries.blueprint </groupId> <artifactId> org.apache.aries.blueprint </artifactId> <version> 1.1.0 </version> </artifactItem> <artifactItem> <groupId> org.apache.aries.proxy </groupId> <artifactId> org.apache.aries.proxy </artifactId> <version> 1.0.1 </version> </artifactItem> <artifactItem> <groupId> org.apache.aries </groupId> <artifactId> org.apache.aries.util </artifactId> <version> 1.1.0 </version> </artifactItem> <artifactItem> <groupId> org.apache.felix </groupId> <artifactId> org.apache.felix.configadmin </artifactId> <version> 1.2.4 </version> </artifactItem> <artifactItem> <groupId> org.ops4j.pax.logging </groupId> <artifactId> pax-logging-api </artifactId> <version> 1.4 </version> </artifactItem> <artifactItem> <groupId> org.ops4j.pax.logging </groupId> <artifactId> pax-logging-service </artifactId> <version> 1.4 </version> </artifactItem> 使用Apache Felix Karaf 自己搭建的Felix+Blueprint环境功能很有限，比如缺失了很多必要的基础组件和管理功能。更好的选择是使用 Apache Felix Karaf 。 Karaf在Felix和Blueprint的基础上，还增加了一些插件，以提供认证和登录、热部署、动态配置、控制台以及一些管理功能。 更贴心的是，Karaf还提供了Eclipse插件： Eclipse Integration for Karaf (EIK) ，从而可以： Custom Eclipse perspective for Apache Karaf development: places valuable Karaf runtime information in one location Apache Karaf installation management in your workspace: Karaf installations are managed as workspace projects giving the developer visibility in to the runtime each Karaf installation is automatically synchronized with your workspace, including additional bundles, configuration files Run and debug Karaf installations with a single Eclipse Launcher: the launch configuration allows developers to fine tune how Karaf will launch Automatic deployment of workspace plugin projects: create plugin-projects and have them deployed automatically Advanced instrumentation of the running Karaf instance: watch bundles deploy in real time and examine the OSGi service registry from within the Eclipse IDE Access Eclipse platform IDE plugins from within a running Karaf instance: all Eclipse plugins are presented as an OBR","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/22/osgi_blueprint_container.html"},{"title":"OSGi构建工具：Tycho还是Maven-Bundle-Plugin？","text":"Tycho与Maven-Bundle-Plugin的对比 Maven与OSGi天生就是冤家：Maven通过 pom.xml 描述一个产物的全部，而OSGi将这项工作交给了 MANIFEST.MF 。 如果仅仅是一些定义信息还好说，但是Maven和OSGi都希望能够描述产物的依赖关系，在使用Maven开发OSGi bundle的时候，就导致了一个问题： 依赖关系到底是在 pom.xml 中描述，还是在 MANIFEST.MF 中描述？ 前面提到的Tycho 的思路是由 MANIFEST.MF 自行管理bundle的依赖关系， pom.xml 只记录使用maven进行构建时需要的信息，比如maven工程的父子关系、打包时需要的bundle仓库及要发布的目标平台等。 Tycho的这种机制对Eclipse IDE比较友好，在开发期间完全使用IDE的机制进行开发和调试，只有在打包部署时才依赖maven。 Apache Felix Maven-Bundle-Plugin 则使用另一套机制：使用Maven-Bundle-Plugin，在开发时可以没有 MANIFEST.MF 文件！Maven-Bundle-Plugin在 pom.xml 中复制了一套 MANIFEST.MF 的元数据，完全可以通过 pom.xml 文件中的定义生成出完整的 MANIFEST.MF 文件。 Maven-Bundle-Plugin的这种机制使得工程完全的\"maven化\"，更适合传统非OSGi开发人员的使用习惯。但是无法很好的利用IDE的开发和调试功能，比如，你可能需要自己搭建一个运行环境从IDE中调用。 两种方式可谓各有千秋。但是Tycho明显基于Equniox和Eclipse，比如，Tycho可以配置Eclipse p2站点作为bundle库。如果要使用Tycho开发和调试Felix，需要搭建一个Eclipse风格的p2站点，将Felix runtime和需要的各种bundle都放到该站点中并发布，然后 在Tycho中引用该站点 。更详细的说明可以参考 这里 。 而Felix Maven-Bundle-Plugin对于各种OSGi runtime的支持是相同的，由于完全基于maven，使用任何IDE开发bundle的效果都差不多。通常，Felix系的平台，如Karaf、Geronimo、Camel、ServiceMix、Fuse等，其例子都是使用Maven-Bundle-Plugin构建的。 由于 前文已经说明了如何用Tycho开发OSGi ，下面只给出使用Maven-Bundle-Plugin的例子。 Maven-Bundle-Plugin的pom例子 <project xmlns= \"http://maven.apache.org/POM/4.0.0\" xmlns:xsi= \"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation= \"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\" > <modelVersion> 4.0.0 </modelVersion> <groupId> thinkinside.demo.osgi </groupId> <artifactId> simple-bundle </artifactId> <version> 0.0.1-SNAPSHOT </version> <build> <plugins> <plugin> <groupId> org.apache.felix </groupId> <artifactId> maven-bundle-plugin </artifactId> <executions> <execution> <id> generate-resources </id> <goals> <goal> manifest </goal> </goals> <configuration> <instructions> <Bundle -Name > ${ project . name } </Bundle-Name> <Bundle -SymbolicName > ${ project . artifactId } </Bundle-SymbolicName> <Bundle -Activator > test.bundle.internal.Activator </Bundle-Activator> <Export -Package > *** </Export-Package> <Import -Package > *** </Import-Package> <Private -Package > *** </Private-Package> </instructions> </configuration> </execution> </executions> </plugin> <plugin> <groupId> org.apache.maven.plugins </groupId> <artifactId> maven-jar-plugin </artifactId> <version> 2.3.1 </version> <configuration> <archive> <manifestFile> ${ project . build . outputDirectory } /META-INF/MANIFEST.MF </manifestFile> </archive> </configuration> </plugin> </plugins> </build> <dependencies> <dependency> <groupId> org.apache.felix </groupId> <artifactId> org.osgi.core </artifactId> <version> 1.4.0 </version> </dependency> </dependencies> </project> 使用Maven-Bundle-Plugin构建bundle，就是构建一个简单的jar。不同之处在于：要通过pom.xml中的信息生成符合OSGi要求的 MANIFEST.MF 文件并打包到jar中。这通过两个插件来完成： org.apache.felix:maven-bundle-plugin 在项目生命周期的\"generate-resources\"阶段，根据 <instructions> 标签内定义的信息生成 MANIFEST.MF 文件。这里可以配置OSGi所需要的全部元数据。 org.apache.maven.plugins:maven-jar-plugin 配置其在打包是使用前面生成的 MANIFEST.MF 文件 由于OSGi bundle通常会使用OSGi API，这里添加了org.apache.felix:org.osgi.core的依赖。当然也可以换成其他的OSGi运行时，比如Equinox。 此时，使用 mvn package 生成的jar包中， MANIFEST.MF 文件内已经添加了配置好的bundle信息。 当然，使用 maven-bundle-plugin的目标(Goals) 可以进行更细致的控制。 在Eclipse中运行和调试 本来，传说中的 Pax Cursor 可以在Eclipse中基于各种OSGi runtime运行和调试bundle，但是天朝的网络中似乎不存在 ops4j.org 这个域名。 好在我们可用一个Java Project的方式建立起Felix的环境，通过Eclipse对bundle进行运行和调试。 由于 这里 有非常详细的说明，故不再赘述。 其实，我们还可以基于maven构建，而不是使用Java Project的方式。使用maven的好处是这种方法可以用于任何支持maven的IDE。 Felix runtime的主要内容包括： 其中： bin/felix.jar 启动的jar, MainClass是 org.apache.felix.main.Main bundle/ 存放可用的bundle，Felix runtime中内置了4个必需的bundle conf/conf.properties 启动配置。类似于Eclipse的 configuration/config.ini 。Felix配置项可以参考 官方网站中的内容 知道了Felix runtime的构成，就可以用maven构建出相同的结构，并插入到项目周期的适当位置。pom如下： <project xmlns= \"http://maven.apache.org/POM/4.0.0\" xmlns:xsi= \"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation= \"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\" > <modelVersion> 4.0.0 </modelVersion> <groupId> thinkinside.demo.fuse </groupId> <artifactId> felix-launcher </artifactId> <version> 0.0.1-SNAPSHOT </version> <name> Felix Launcher </name> <properties> <felix.bundlerepository.version> 1.6.4 </felix.bundlerepository.version> <felix.gogo.version> 0.10.0 </felix.gogo.version> <felix.framework.version> 4.2.1 </felix.framework.version> </properties> <build> <plugins> <plugin> <artifactId> maven-clean-plugin </artifactId> <version> 2.4.1 </version> <configuration> <filesets> <fileset> <directory> bundle </directory> </fileset> </filesets> </configuration> </plugin> <plugin> <groupId> org.apache.maven.plugins </groupId> <artifactId> maven-dependency-plugin </artifactId> <version> 2.2 </version> <executions> <execution> <id> copy </id> <phase> generate-resources </phase> <goals> <goal> copy </goal> </goals> <configuration> <artifactItems> <artifactItem> <groupId> org.apache.felix </groupId> <artifactId> org.apache.felix.gogo.command </artifactId> <version> ${ felix . gogo . version } </version> </artifactItem> <artifactItem> <groupId> org.apache.felix </groupId> <artifactId> org.apache.felix.gogo.runtime </artifactId> <version> ${ felix . gogo . version } </version> </artifactItem> <artifactItem> <groupId> org.apache.felix </groupId> <artifactId> org.apache.felix.gogo.shell </artifactId> <version> ${ felix . gogo . version } </version> </artifactItem> <artifactItem> <groupId> org.osgi </groupId> <artifactId> org.osgi.compendium </artifactId> <version> 4.2.0 </version> </artifactItem> </artifactItems> <outputDirectory> bundle </outputDirectory> </configuration> </execution> </executions> </plugin> </plugins> </build> <dependencies> <dependency> <groupId> org.apache.felix </groupId> <artifactId> org.apache.felix.main </artifactId> <version> ${ felix . framework . version } </version> </dependency> <dependency> <groupId> org.ops4j.pax.url </groupId> <artifactId> pax-url-assembly </artifactId> <version> 1.6.0 </version> </dependency> </dependencies> </project> 该pom在标准的生命周期中增加了两项工作： 在 generate-resources 阶段，创建bundle文件夹，复制必需的4个bundle 在 clean 阶段，清除bundle文件夹 最后，还需要一个配置文件。在工程目录建立 /conf/config.properties 文件，并进行基本配置： felix.auto.deploy.action=install,start felix.log.level=1 org.osgi.framework.storage.clean=onFirstInit 配置完成了，先执行 mvn compile 生成需要的资源。此时使用命令 mvn exec:java -Dexec.mainClass=\"org.apache.felix.main.Main\" 即可以启动Felix runtime： 在Eclipse中，将这个工程作为 Java Application 运行，选择 org.apache.felix.main.Main 作为Main Class，就可以进行运行和调试。","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/21/tycho_vs_maven_bundle_plugin.html"},{"title":"在SWT中用JFreeChart实现K线图","text":"目标 在 R学习笔记 中，展示了这样一张图表： 现在需要在Eclipse e4应用中实现这样的图表。 SWT图表组件的选择 在RCP/JFace/SWT中，可以选择的图表组件包括： Eclipse BIRT Eclipse BIRT 是Eclipse平台下的报表框架。其中的图表组件可以单独使用。 由于BIRT依赖于GEF、EMF等Eclipse插件，所以非常重，不适合简单轻量的应用。 SWT Chart 从名字就可以看出， SWT Chart 是专为SWT环境开发的报表组件。设计很清晰，使用起来也方便。但是目前支持的图表类型比较少。 JFreeChart JFreeChart 是Java世界的老牌图表组件，其强大无以言表。JFreeChart支持AWT、Swing等 GUI环境，也可以生成图片在Web环境中使用。后来又增加了对SWT环境的支持，从此不再需要SWT_AWT的桥接方式。 综上所述，这里选择JFreeChart作为绘图组件。 获取股票数据 由于需要的数据量比较大，不能再使用 前面 的模拟数据方法了。这里使用 雅虎财经 的数据。 雅虎财经提供了查询股票历史数据的接口： http://table.finance.yahoo.com/table.csv?ignore=.csv&.... 参数包括： s: 股票代码/名称。对于国内的股票，使用类似 000001.ss 的编码 a、b、c: 开始时间的月、日、年 d、e、f: 结束时间的月、日、年 g：时间周期，分别为 d :日， w :周， m ：月， v :dividends only 其中，月份是从0开始。比如，9月数据写为08。 本文中使用2013年上证综合指数的日线数据： http://table.finance.yahoo.com/table.csv?ignore=.csv&s=000001.ss&a=00&b=01&c=2013&d=11&e=31&f=2013&g=d 获取到的CSV文件包含的数据列为 Date,Open,High,Low,Close,Volume,Adj Close ，其中Date的格式为 yyyy-MM-dd 。数据按照日期倒序排列。 处理代码如下： OHLCSeries ohlcSeries = new OHLCSeries ( \"\" ); TimeSeries volumeSeries = new TimeSeries ( \"\" ); try { URL url = new URL ( \"http://table.finance.yahoo.com/table.csv?ignore=.csv&s=000001.ss&a=00&b=01&c=2013&d=11&e=31&f=2013&g=d\" ); InputStream is = url . openStream (); InputStreamReader reader = new InputStreamReader ( is , \"UTF-8\" ); BufferedReader buffer = new BufferedReader ( reader ); String newLine = buffer . readLine (); // 标题行 while (( newLine = buffer . readLine ()) != null ) { String item [] = newLine . trim () . split ( \",\" ); Date date = df . parse ( item [ 0 ] ); float open = Float . valueOf ( item [ 1 ] ); float high = Float . valueOf ( item [ 2 ] ); float low = Float . valueOf ( item [ 3 ] ); float close = Float . valueOf ( item [ 4 ] ); float volume = Float . valueOf ( item [ 5 ] ); float adj_close = Float . valueOf ( item [ 6 ] ); ohlcSeries . add ( new Day ( date ) , open , high , low , close ); volumeSeries . add ( new Day ( date ) , volume ); } } catch ( Exception e ) { e . printStackTrace (); } 联合图表 目标中的图表是一种联合图表(Combined Chart)：多个图表共用横坐标或纵坐标。JFreeChart中提供了 CombinedDomainXYPlot 和 CombinedRangeXYPlot ，分别用于联合横坐标和联合纵坐标的图表。 由于各种图表类型都有可能组成联合图表，JFreeChart没有在 ChartFactory 中提供工厂方法进行创建， 只能按照 JFreeChart中的图表模型 进行手工创建。下面是例子： //创建横坐标轴，作为联合坐标 DateAxis timeAxis = new DateAxis(); //创建两个纵坐标，用于上下两个Plot NumberAxis ohlcAxis = new NumberAxis(); NumberAxis volumeAxis = new NumberAxis(); //创建两个Plot对应的Renderer CandlestickRenderer ohlcRenderer = new CandlestickRenderer(); XYBarRenderer volumeRenderer = new XYBarRenderer(); //创建K线图的Plot，使用\"数据\"一节中的ohlcSeries ////其中横坐标设为\"null\"，以使用联合横坐标 OHLCSeriesCollection ohlcDataset = new OHLCSeriesCollection(); ohlcDataset.addSeries(ohlcSeries); XYPlot ohlcPlot = new XYPlot(ohlcDataset,timeAxis,ohlcAxis,ohlcRenderer); //创建成交量柱状图的Plot，使用\"数据\"一节中的volumeSeries //其中横坐标设为\"null\"，以使用联合横坐标 TimeSeriesCollection volumeDataset = new TimeSeriesCollection(); volumeDataset.addSeries(timeSeries); XYPlot volumePlot=new XYPlot(volumeDataset,null,volumeAxis,volumeRenderer; //创建联合图表 CombinedDomainXYPlot combineddomainxyplot = new CombinedDomainXYPlot(timeAxis()); //上下两个图表占据的高度比例为2:1，间隔为10 combineddomainxyplot.add(ohlcPlot, 2); combineddomainxyplot.add(volumePlot, 1); combineddomainxyplot.setGap(10); JFreeChart chart = new JFreeChart(\"xx股票\", JFreeChart.DEFAULT_TITLE_FONT, combineddomainxyplot, false); 创建的图表如下所示： 设置样式 上面的图表默认样式与国内的习惯不大一样。不过JFreeChart提供了丰富的API进行样式的设置。下面对样式进行简单调整(目前对SWT的支持不够完全。比如，颜色值仍需要使用AWT的 Color 类)： //图表 chart.setBackgroundPaint(Color.BLACK); chart.getTitle().setPaint(Color.WHITE); chart.setBorderVisible(false); //Plot combineddomainxyplot.setBackgroundPaint(Color.BLACK); ohlcPlot.setBackgroundPaint(Color.BLACK); volumePlot.setBackgroundPaint(Color.BLACK); //渲染 ohlcRenderer.setUpPaint(Color.RED); ohlcRenderer.setDownPaint(Color.GREEN); volumeRenderer.setShadowVisible(false); //坐标轴 timeAxis.setTickLabelPaint(Color.GRAY); ohlcAxis.setTickLabelPaint(Color.GRAY); volumeAxis.setTickLabelPaint(Color.GRAY); 调整后的图表如下所示： 去除非交易时段 前面的例子中，K线是不连续的，因为会有非交易日的存在。如果是小时、分钟级别的K线图，该问题会更加明显。 要去除非交易时段，使得K线连续，大体有两个思路： 实现一个自定义的 DateAxis ，根据数据的序号产生坐标，根据实际时间产生标签 实现一个 Timeline ，并设置给 DateAxis 更改Renderer 看起来方法1更容易，但由于没有相关的文档，需要自己分析 DateAxis 的代码，类似一种\"Hack\"的模式，很难保证向后兼容； 方法2是官方指定的方法，可行性更高，但是要同时支持日线、小时线、分钟/5分钟线，实现起来有点难度。 此外， Timeline的接口说明 读起来有些费解；方法3需要改变数据源(Dataset)，使用序号作为数据，设置Renderer的 ItemLabelGenerator ，根据序号产生时间格式的坐标标签。 这里采用方法3，实例代码如下： //TODO 修正高度和宽度(TODO) 固定每根K线的宽度，根据图表宽度决定显示多少根K线 使用\"时间窗口\"作为数据 横向滚动和实时曲线(TODO)","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/18/swt_jfreechart_candlestick.html"},{"title":"Eclipse e4：从OSGi-DS到依赖注入","text":"MANIFEST.MF 为了管理一组Java类和资源，通常我们会将其打包为JAR(Java Archive File，java存档文件)，该文件以ZIP格式进行打包。 在JAR文件中，会包含一个 META-INF/MANIFEST.MF 文件，作为该JAR包的清单文件，设置执行入口类和支持库的路径等信息。 主要内容包括： Manifest-Version Class-Path Created-By Main-Class OSGi bundle OSGi的目标是实现Java应用的模块化，其目标是： 将程序封装成一个个的模块(在OSGi中叫做bundle) 模块向外只暴露特定的接口，内部实现对外不可见 OSGi容器管理模块的接口，包括服务发布、寻找和版本管理等 OSGi容器管理模块的生命周期，比如启动、停止、热插拔等 OSGi将每个模块打包为一个JAR文件。为了实现上述目标， OSGi规范利用了 MANIFEST.MF 文件，在其中增加了一些bundle的描述信息，比如： Bundle-ManifestVersion Bundle-Name Bundle-SymbolicName Bundle-Version Bundle-ClassPath Bundle-Vendor Bundle-Localization Bundle-RequiredExecutionEnvironment Export-Package Require-Bundle Bundle-Activator Bundle-ActivationPolicy Import-Package OSGi服务的注册和寻找 OSGi模块中，只有 Export-Package 中声明的包才可以被其他模块访问。为了避免一个模块对其他模块的直接引用， 通常会实现一个\"接口定义\"模块和多个\"接口实现\"模块。通过服务注册和发现的方式进行服务的使用。 OSGi还可以为模块指定一个\"激活类( Bundle-Activator )\"， 这个类会在模块启动时被执行，通常在这里进行本模块的接口实现(服务)的发布，以及向本模块内的类注入其他模块实现的接口(服务). 比如： public class MyActivator implements org.osgi.framework.BundleActivator{ @Override public void start(BundleContext context) throws Exception { context.registerService(MyService.class.getName(), new MyServiceImpl(), null); System.out.println(MyService.class.getName() + \" has been registred as a service\"); } …… } 这样，其他使用该服务的模块可以寻找服务。通常，也是在\"激活类( Bundle-Activator )\"中进行： public class ClientActivator implements BundleActivator{ public static MyService helloService; @Override public void start(BundleContext context) throws Exception { ServiceReference ref = context.getServiceReference(MyService.class.getName()); MyService service = (MyService) context.getService(ref); MyClient.setService(service); } …… } Declarative Service 上面通过代码的方式进行服务的注册和寻找，实现起来比较繁琐。为了简化编码，从OSGi4.0版本开始，提出了\"Declarative Service\"标准， 使用xml文件进行服务发布和引用的描述。 首先，在 MANIFEST.MF 文件中增加一个新的属性 Service-Component ，用来指定服务声明文件的路径，比如： Service-Component: OSGI-INF/component.xml 然后编写服务声明配置： <?xml version=\"1.0\" encoding=\"UTF-8\"?> <scr:component xmlns:scr= \"http://www.osgi.org/xmlns/scr/v1.1.0\" name= \"myservice\" > <implementation class= \"MyServiceImpl\" /> <service> <provide interface= \"MyService\" /> </service> </component> 该文件中也可以配置服务引用： <reference bind=\"setMyService\" cardinality=\"1..1\" interface=\"MyService\" name=\"myservice\" policy=\"static\" unbind=\"unsetMyService\"/> 可以用如下的代码使用所引用的服务： // Method will be used by DS to set the service public synchronized void setMyService(MyService service) { System.out.println(\"Service was set. Thank you DS!\"); this.service = service; } // Method will be used by DS to unset the service public synchronized void unsetMyService(MyService service) { System.out.println(\"Service was unset.\"); if (this.service == service) { this.service = null; } e4中的依赖注入 Declarative Service的方式与Spring的服务组装很类似。但是Spring中已经开始 使用注解代替繁琐的XML配置 。 从Eclipse e4开始，已经支持使用 JSR330:依赖注入规范 实现服务的注入。 在e4增加的服务编程模型中，引入了上下文（context），所有的依赖对象都被上下文管理并通过上下文获取： 在Eclipse e4中，将全局的上下文分成了多个层次： 下层的context可以获取上层context中定义的对象，比如： e4中，可以使用 JSR330中基本的 @Inject 、 @Named 等注解 ,用于构造器、方法和属性。同时,e4在 org.eclipse.e4.core.di.annotations 包中也定义了一些扩展的注解，包括： @Optional ：声明一个注入( @Inject )为可选 @GroupUpdates ：声明一个注入的对象是批量更新的，使用这个注解对于RCP应用的性能有很大好处 @Execute @CanExecute @Creatable 下面是e4中依赖注入的一些例子： // Tracks the active part @Inject @Optional public void receiveActivePart(@Named(IServiceConstants.ACTIVE_PART) MPart activePart) { if (activePart != null) { System.out.println(\"Active part changed \" + activePart.getLabel()); } } // tracks the active shell @Inject @Optional public void receiveActiveShell(@Named(IServiceConstants.ACTIVE_SHELL) Shell shell) { if (shell != null) { System.out.println(\"Active shell (Window) changed\"); } } 在 org.eclipse.e4.core.contexts 包中定义的 @Active 注解可以获取活动(actived)组件。比如： public class MyOwnClass { @Inject void setChildValue(@Optional @Named(\"key_of_child_value\") @Active String value) { this.childValue = value; } } 创建自己的可注入对象 @Creatable","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/12/dependency_injection_in_e4.html"},{"title":"Eclipse e4中的平台服务","text":"概述 前面 提到，e4中可以通过依赖注入进行服务的发布和获取。并且，\"在Eclipse e4中，将全局的上下文分成了多个层次\"： e4提供了很多平台级的服务，注册于OSGi context之上的其他各个context层。这些服务提供了开发应用的很多通用的功能。一些常用的服务包括： 展现层MVC的视图、模型、控制器相关的服务，以及逻辑层服务。 视图相关服务 EPartService 访问和修改Part，使用Part模板，切换perspectives，支持Edit方法 ESelectionService 处理GUI界面中的\"选中\" EMenuService Registers a popup menu (MPopupMenu) for an SWT control. org.eclipse.jface.window.IShellProvider 在SWT环境中访问Shell IThemeEngine Allows to switch the styling of the application at runtime. 模型相关服务 EModelService 在运行时访问或更改e4的 应用模型 控制器相关服务 MDirtyable 用于标记Part中的内容是否被修改过 ECommandService 访问、创建和更改应用模型中的command对象 EHandlerService 访问、更改或触发(trigger)应用模型中的handler对象 逻辑层相关服务 IEventBroker 提供基于发布、订阅机制的事件处理功能 StatusReporter Allows you to report Status objects. EContextService Activate and deactivate key bindings defined as BindingContext in the application model. The content referred to in this service is the BindingContext and not the IEclipseContext. Logger org.eclipse.e4.core.services 插件中的 Logger 提供了日志功能 Adapter An adapter can adapt an object to the specified type, allowing clients to request domain-specific behavior for an object. It integrates IAdaptable and IAdapterManager 视图相关服务 EPartService 在应用模型中，可以定义PartDescriptors。PartDescriptors可以作为创建Part的模板。 通过EPartService可以访问这些模板，比如： @Inject private EPartService partService; // Showing and hiding parts detailsTodoPart = partService.findPart(\"com.example.todo.rcp.parts.tododetails\"); partService.hidePart(detailsTodoPart); …… detailsTodoPart.setVisible(true); partService.showPart(detailsTodoPart, PartState.VISIBLE); //Switching perspectives @Execute public void execute(MApplication app, EPartService partService, EModelService modelService) { MPerspective element = (MPerspective) modelService.find(\"secondperspective\", app); // now switch perspective partService.switchPerspective(element); } // creating parts dynamically @Execute public void execute(EPartService partService) { // create a new Part based on a PartDescriptor // in the application model // assume the ID is used for the PartDescriptor MPart part = partService .createPart(\"com.example.e4.rcp.todo.partdescriptor.fileeditor\"); part.setLabel(\"New Dynamic Part\"); // If multiple parts of this type are now allowed // in the application model, // then the provided part will be shown // and returned partService.showPart(part, PartState.ACTIVATE); } //switch perspective @Execute public void execute(MApplication app, EPartService partService, EModelService modelService) { MPerspective element = (MPerspective) modelService.find(\"secondperspective\", app); partService.switchPerspective(element); } ESelectionService e4的应用模型中，MWindow对象可以保持选中的Part。e4在IEclipseContext中注册了 ESelectionService ，可以设置或获取选中的组件。 使用 setSelection() 方法可以设置选中状态： // use field injection for the service @Inject ESelectionService selectionService; // viewer is a JFace Viewer viewer.addSelectionChangedListener(new ISelectionChangedListener() { @Override public void selectionChanged(SelectionChangedEvent event) { IStructuredSelection selection = (IStructuredSelection) viewer.getSelection(); selectionService.setSelection(selection.getFirstElement()); } }); 使用 getSelection(partId) 方法可以获取选中的组件，更常用的做法是使用 IServiceConstants.ACTIVE_SELECTION 作为 @Named 注解的参数，自动注入选中的组件： @Inject public void setTodo(@Optional @Named(IServiceConstants.ACTIVE_SELECTION) Todo todo) { if (todo != null) { // do something with the value } } 模型相关服务EModelService 使用 EModelService 可以在运行时访问或更改e4的 应用模型 ，比如增加或删除模型元素。EModelService中一些常用的方法包括： cloneElement() 和 cloneSnippet() ：克隆元素或模型片段 findElements() ：通过ID、类型、或标签(tags)搜索元素 使用举例： //search by type private void findParts(MApplication application, EModelService service) { List<MPart> parts = service.findElements(application, null, MPart.class, null); System.out.println(\"Found parts(s) : \" + parts.size()); } //Dynamically create a new window MWindow window = modelService.createModelElement(MWindow.class); window.setWidth(200); window.setHeight(300); // add new Window to the application application.getChildren().add(window); 控制器相关服务 MDirtyable和@Persist注解 e4中不再区分ViewPart和EditPart，而是统一使用Part。通过MDirtyable可以标记Part中的内容是否被修改过；使用 @Persist 注解可以标记持久化Part内容的方法。比如： public class MyEditPart { @Inject MDirtyable dirty; @PostConstruct public void createControls(Composite parent) { Button button = new Button(parent, SWT.PUSH); button.addSelectionListener(new SelectionAdapter() { @Override public void widgetSelected(SelectionEvent e) { dirty.setDirty(true); } }); } @Persist public void save(MDirtyable dirty, ITodoService todoService) { // save changes via ITodoService for example todoService.saveTodo(todo); // save was successful dirty.setDirty(false); } } 在上面的例子中，看起来 @Persist 注解没有多大用处。其实，该注解主要用于EPartService的 saveAll() 方法： public class SaveHandler { @Execute void execute(EPartService partService) { partService.saveAll(false); } } ECommandService和EHandlerService 举例如下： Command command = commandService.getCommand(\"com.example.mycommand\"); // check if the command is defined System.out.println(command.isDefined()); // activate Handler, assume AboutHandler() class exists already handlerService.activateHandler(\"com.example.mycommand\", new AboutHandler()); ParameterizedCommand cmd = commandService.createCommand(\"com.example.mycommand\", null); // check if the command can get executed System.out.println(handlerService.canExecute(cmd)); // execute the command handlerService.executeHandler(cmd); 逻辑层相关服务 IEventBroker Eclipse 3.x中，事件处理使用Observer模式：事件接收者实现事件发布者指定的Listener接口，并注册到事件发布者。 这带来两个问题： 一个Listener接口要写很多个实现，这些实现中的代码有重复 事件发布者和接收者的生命周期紧耦合 Eclipse e4中，将OSGi的 EventAdmin API封装为事件服务，提供了基于发布、订阅机制的事件处理功能： EventBroker 作为事件总线，通过 EventBroker 可以发布和订阅事件。 要使用e4事件服务，需要增加依赖插件： * org.eclipse.e4.core.services * org.eclipse.osgi.services 获取EventBroker e4中定义了 org.eclipse.e4.core.services.events.IEventBroker 接口，可以通过依赖注入、e4上下文等方式获取： @Inject IEventBroker eventBroker; @Inject private IEclipseContext eclipseContext; …… IEventBroker eventBroker = eclipseContext.get(IEventBroker.class); - 发布事件 可以用`IEventBroker`的`post()`或`send()`方法，进行同步(synchronous)或异步(asynchronous)事件的发布： boolean IEventBroker.post(String topic, Object data) // synchronous delivery boolean IEventBroker.send(String topic, Object data) // asynchronous delivery 返回值为是否发生成功。 - 订阅事件 可以通过依赖注入或者`IEventBroker`的`subscribe()`方法订阅事件： @Inject @Optional private void closeHandler(@UIEventTopic(''TOPIC_STRING'') foo.Bar payload) { //do something with payload } @Inject IEventBroker eventBroker; org.osgi.service.event.EventHandler closeHandler = new EventHandler() { public void handleEvent(Event event) { foo.Bar payload = (foo.Bar) event.getProperty(IEventBroker.DATA); } } eventBroker.subscribe(TOPIC_STRING, closeHandler); …… eventBroker.unsubscribe(closeHandler); 消息对象(payload)作为附件存储在`IEventBroker.DATA`属性中。对于`Dictionary`或`Map`等集合类型的消息，会将其中所有的值按照KEY添加为属性。 ## Logger Eclipse 3.x中，Log的接口和实现类分别为`org.eclipse.core.runtime.ILog`和`org.osgi.service.log.LogService`，可以使用`ServiceTracker`获取： LogService getLog() { fLogServiceTracker = new ServiceTracker(fBundleContext, LogService.class.getName(), null); return (LogService) fLogServiceTracker.getService(); } 为了方便，在`Plugin`的基类中实现了`getLog()`方法，所有的`Plugin`子类可以直接使用。 在`org.eclipse.e4.core.services`插件中提供了`org.eclipse.e4.core.services.Logger`类，可以通过`@Inject`注解或使用`IEclipseContext`接口获取： @Inject private Logger logger; //or use code: Logger log = (Logger) context.get(Logger.class.getName()); ``` 实现自己的服务 Usually services have two parts: the interface definition and the implementation. How these two are linked is defined by a context function , an OSGi service or plain context value setting (IEclipseContext). Please note that there can be more than one service implementation for an interface.","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/12/e4_platform_services.html"},{"title":"Tycho：用Maven构建Eclipse Plugin项目","text":"Tycho 是一个Maven插件，目标是使用Maven构建Eclipse插件，OSGI Bundle等工程。 如果说 Maven 的出现是一群Java程序员受不了繁琐的插件依赖管理，受不了冗长的ant build.xml文件而创造出来的， 那Tycho则是一群Eclipse、OSGi插件开发人员受不了重复地配置类似的Maven pom.xml而创造出来的。 Tycho以一组maven插件的形式，支持Eclipse的plug-ins, features, update sites (based on p2) 、products等类型的工程， 表现为不同的maven打包类型(packaging): eclipse-plugin eclipse-feature eclipse-test-plugin eclipse-repository eclipse-target-definition 父工程 基于OSGi的工程通常会划分很多模块，对于Maven来说，一般通过一个父工程（parent）来管理所有模块的构建。父工程的 packaging 类型为 pom . 为了使用Tycho，需要在父工程的pom文件中增加一些配置。 增加Tycho插件 父工程中定义的插件可以在所有子工程中使用： <properties> <tycho -version > 0.16.0 </tycho-version> </properties> <build> <plugins> <plugin> <groupId> org.eclipse.tycho </groupId> <artifactId> tycho-maven-plugin </artifactId> <version> ${ tycho - version } </version> <extensions> true </extensions> </plugin> </plugins> </build> 定义bundle仓库 比如，基于Eclipse 4.3(Kepler)的RCP应用，使用了Texo、GeminiJPA等插件，需要如下的仓库定义： <repositories> <repository> <id> Kepler </id> <url> http://download.eclipse.org/releases/kepler </url> <layout> p2 </layout> </repository> <repository> <id> Texo </id> <url> http://download.eclipse.org/modeling/emft/texo/updates/interim </url> <layout> p2 </layout> </repository> <repository> <id> GeminiJPA </id> <url> http://download.eclipse.org/gemini/jpa/updates </url> <layout> p2 </layout> </repository> <repository> <id> EclipseLink </id> <url> http://download.eclipse.org/rt/eclipselink/updates/ </url> <layout> p2 </layout> </repository> </repositories> 定义目标 定义不同的目标平台： <plugin> <groupId> org.eclipse.tycho </groupId> <artifactId> target-platform-configuration </artifactId> <configuration> <environments> <environment> <os> linux </os> <ws> gtk </ws> <arch> x86 </arch> </environment> <environment> <os> macosx </os> <ws> cocoa </ws> <arch> x86_64 </arch> </environment> </environments> </configuration> </plugin> 如果要发布比较复杂的目标，比如Eclipse Product的发布，需要单独构建 eclipse-target-definition 类型的子工程。 为现有工程生成pom Tycho提供了一个工具，可以为现有的Eclipse Plugin、Feature等工程生成pom文件，从而将其整合到Tycho的管理之下。 该工具也是基于maven的，只需要在工程文件夹执行命令： mvn org.eclipse.tycho:tycho-pomgenerator-plugin:generate-poms -DgroupId=thinkinside.tangle 生成的pom文件举例如下： <?xml version=\"1.0\" encoding=\"UTF-8\"?> <project xsi:schemaLocation= \"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\" xmlns= \" http://maven.apache.org/POM/4.0.0\" xmlns:xsi= \"http://www.w3.org/2001/XMLSchema-instance\" > <modelVersion> 4.0.0 </modelVersion> <groupId> thinkinside.tangle </groupId> <artifactId> tangle-app </artifactId> <version> 1.0.0-SNAPSHOT </version> <packaging> eclipse-plugin </packaging> </project> 由于种种原因，Eclipse Plugin工程的配置内容分散在多个文件中，包括： OSGi的配置文件：MANIFEST.MF 插件工程构建文件：build.properties 插件定义文件：plugin.xml 产品描述文件：.product 这些文件中的配置项有重复，开发人员要保证各文件中的相关配置的一致性。 Tycho在生成pom文件时，会检查这些配置文件，将其中的配置项写入pom文件中。 Tycho的逻辑是以上述标准的配置文件优先。比如，在pom文件中没有定义依赖关系，而是以 MANIFEST.MF 中定义的依赖为准。 如果现有工程已经有了pom文件，还可以使用Tycho进行更新： mvn org.eclipse.tycho:tycho-versions-plugin:update-pom -Dtycho.mode=maven \"目标定义\"子工程 前面提到，如果要发布比较复杂的目标，比如Eclipse Product的发布，需要单独构建 eclipse-target-definition 类型的子工程。 在\"目标定义\"子工程中创建 .product 文件，然后在pom文件中添加： <build> <plugins> <plugin> <groupId> org.eclipse.tycho </groupId> <artifactId> tycho-p2-director-plugin </artifactId> <version> ${ tycho - version } </version> <executions> <execution> <!-- install the product for all configured os/ws/arch environments using p2 director --> <id> materialize-products </id> <goals> <goal> materialize-products </goal> </goals> </execution> <!-- (optional) create product zips (one per os/ws/arch) --> <execution> <id> archive-products </id> <goals> <goal> archive-products </goal> </goals> </execution> </executions> </plugin> </plugins> </build> \"目标定义\"子工程中还可以使用\"目标定义文件（Target Definition, *.target）\"进行复杂的配置。 可以参考 这里 的说明，也可以查看 GitHub上的例子 的例子。 Test工程 与专门的测试工具 Pax Exam 相比，Tycho test使用起来会更简单。当然前提是测试由Tycho构建的OSGi应用。 Tycho将一个\"Fragment\"工程包装成Maven工程，可以在其中编写测试代码，然后使用\"JUnit Plug-in Test\"执行测试。 对比Maven-Bundle-Plugin Maven-Bundle-Plugin提供了与Tycho不同风格的另一种构建OSGi的maven插件。关于二者的对比，可以参考 这里","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html"},{"title":"Eclipse e4 概览","text":"基于EMF的应用模型(Application Model)；依赖注入；基于CSS定义外观 尽管至今为止， Eclipse e4 仍然处于孵化器阶段(Incubation Phase)，但是e4代表了Eclipse的未来。 e4是位于底层的Equinox、EMF、SWT/JFace和上层的Eclipse应用(Plugin、RCP、RAP等)之间的一个应用开发平台。 从RCP的角度来说，e4的一个主要目标就是更轻松地编写和重用组件。 为了实现这个目标，与之前的Eclipse平台相比，e4带来的新特性主要包括： 基于EMF的应用模型(Application Model) 依赖注入 基于CSS定义外观 快速开始 需要的环境和工具包括： Java >= 1.7 Eclipse >= 4.3 Enide - Eclipse bootstrap e4 WindowBuilder 安装了Eclipse bootstrap e4插件之后，可以创建Eclipse 4 --> Eclipse 4 Application Project。 生成的目录结构如下： 其中， *.product 文件是Eclipse插件项目的产品配置文件，可以以\"E4Application\"的方式运行： 在 *.product 文件上右键-->Run As-->Eclipse Application，就可以启动一个e4应用： 整个工程可以导出(Export)为\"Eclipse Product\"，称为一个可以脱离Eclipse独立运行的、跨平台的RCP应用。 应用模型 好吧，到目前为止，e4所表现出来的功能与Eclipse 3.x相比没什么区别。但是请关注一下上面生成的 Application.e4xmi 文件。 该文件是e4中的应用模型文件。 在 Eclipse 平台 UI 的早期版本中，workbench 被显式地硬编码来布局 workbench 窗口、workbench 页面、编辑器区域或视图堆栈。e4 引入了额外的一层，可将UI元素提取和抽象成一个模型。应用程序可以重新配置或扩展这个模型来制作不同的外观。这个模型也可被动态操纵；模型的改变可以立即反映出 UI 的变化。 e4的模型的特性为： 基于抽象描述 可以在运行时(runtime)更改 支持扩展 抽象描述 e4的应用模型基于抽象描述——应用模型只定义了需要哪些组件，而不关注这些组件是如何实现的。e4应用模型实现了应用模型和实际视图(Views)的分离。 由于应用模型没有绑定的具体实现，这意味着一种可能：同一个应用模型可以用各种界面技术（如SWT/JFace, Swing甚至web，Flash）来实现。 模型中即描述了可视的组件，如 windows, parts (views 和 editors), menus, toolbars等，也可以描述非可视化组件如handlers, commands , key bindings等。所有能够在模型中描述的组件（包括可视化组件和非可视化组件），都实现了MApplicationElement接口，如下图： 用Eclipse 4 model editor打开 Application.e4xmi ，可以看到如下的视图： Application.e4xmi 是基于EMF定义的。其定义文件(.ecore）位于 org.eclipse.e4.ui.model.workbench 插件的model文件夹中。 常用的可视化组件 e4中的可视化组件描述类都来自 MUIElement ，该接口当然也继承了 MApplicationElement 接口。 常用的可视化组件包括： Window 窗口。一个Eclipse 应用可以包含一个或多个窗口。 Parts e4中不区分Views和editors，而是统一定义为Parts。Part能够放置在用户界面的任何位置，每个Part可以有自己的菜单、工具条，可以出来自己的模型数据。 Perspective Perspective是Parts的容器，可以管理内部Part的布局。一个应用可以有多个不同的Perspective(不能同时出现)，以适应不同的应用场景。 比如，Eclipse IDE提供了Java、Java EE、Debug等Perspective。 在应用模型中，为了管理方便，还可以将Perspective放置到Perspective Stack中。 PartStack 和 PartSashContainer Part可以直接用于Window或Perspective中，也可以将其分组。使用PartStack 和 PartSashContainer可以实现Part的分组和布局管理。 PartStack可以容纳多个Part，每次只能显示其中一个Part，以页签(tab)的形式进行切换，而PartSashContainer以水平或竖直布局的方式同时显示多个Part。如下图： 通过PartStack和PartSashContainer的组合，能够创建出非常复杂的布局： PartStack 和 PartSashContainer中的子组件，可以设置\"容器数据(Container Data)\"，作为决定自己在容器中布局的参数。 需要注意的是，容器中的所有元素要么都设置容器数据，要么都不设置，否则会出现异常。 依赖注入 基于上一节的内容，我们可以脱离UI组件的实现，直接定义出应用模型。 同样的，当我们实现一个UI组件的时候，也完全无需考虑应用模型的存在。在e4中，View甚至无需实现任何接口，而是通过依赖注入的方式获取UI组件的上下文环境。可以使用 JSR330 中定义的 @Inject 注解，也可以使用e4的 org.eclipse.e4.ui.di 包中定义的 @Focus 、 @Persist 等注解。比如： public class SamplePart { private Text txtInput; private TableViewer tableViewer; @Inject private MDirtyable dirty; @PostConstruct public void createComposite(Composite parent) { parent.setLayout(new GridLayout(1, false)); txtInput = new Text(parent, SWT.BORDER); txtInput.setMessage(\"Enter text to mark part as dirty\"); txtInput.addModifyListener(new ModifyListener() { @Override public void modifyText(ModifyEvent e) { dirty.setDirty(true); } }); txtInput.setLayoutData(new GridData(GridData.FILL_HORIZONTAL)); tableViewer = new TableViewer(parent); tableViewer.add(\"Sample item 1\"); tableViewer.add(\"Sample item 2\"); tableViewer.add(\"Sample item 3\"); tableViewer.add(\"Sample item 4\"); tableViewer.add(\"Sample item 5\"); tableViewer.getTable().setLayoutData(new GridData(GridData.FILL_BOTH)); } @Focus public void setFocus() { tableViewer.getTable().setFocus(); } @Persist public void save() { dirty.setDirty(false); } } 由于UI组件与应用模型完全解耦，可以对UI组件单独进行测试： public static void main(String[] args) { Display display = new Display(); Shell shell = new Shell(display); shell.setLayout(new FillLayout()); SamplePart part = new SamplePart(); part.createComposite(shell); shell.open(); while( !shell.isDisposed() ) { if( ! display.readAndDispatch() ) { display.sleep(); } } } 向模型注入资源 前面两节分别介绍了创建应用模型和UI组件，接下来就是将二者结合起来。 在应用模型中，使用URI注入外部资源。比如，一个Part的Icon、Class都是通过URI注入的。这些资源是延迟加载(lazy loaded)的——只有显示某个可视化组件时，才加载其需要的资源。 模型使用的资源即可以在运行时注入或更改，也可以在Eclipse 4 model editor中指定初始的资源： 任何形式的URI都可以作为资源使用。比如： http://thinkinside.tk/assets/ico/favicon.png 。 对于Eclipse的插件环境，可以使用应用模型所在的插件(bundle)或来自其他插件的资源，分别使用 bundleclass://Bundle-SymbolicName/ package.classname 和 platform:/plugin/Bundle-SymbolicName/ path/filename.extension 的形式。 比如： bundleclass://tangle-app/parts.SamplePart platform:/plugin/test/icons/save_edit.gif 定义行为 e4的应用模型中，通过 Handler 定义行为。可视化组件和 Handler 之间通过 Command 关联。 与GUI组件一样，Handler的定义和实现也是分离的。在应用模型中定义的 Handler 通过Class URI关联到具体的实现类。我们可以单独编写一个 Handler ，无需实现任何接口： public class MyHandler { @Execute public void execute(Shell shell) { MessageDialog.openInformation(shell, \"\", \"Hello World!\"); } @CanExecute public boolean canExecute() { return true; } } 其中， canExecute() 方法是可选的。该方法定义了 execute() 方法是否可以被执行的一个开关。 由于 Handler 与应用模型完全解耦，可以单独对 Handler 进行测试： public static void main(String[] args) { Display display = new Display(); Shell shell = new Shell(display); shell.open(); MyHandler.execute(shell); while( !shell.isDisposed() ) { if( ! display.readAndDispatch() ) { display.sleep(); } } } 最简单的事件处理是菜单/工具条的处理。使用模型编辑器，可以在图形界面中很容易的将 Handler 和菜单项都关联到同一个 Commnad ， 即实现了行为的定义。这里不做截图，定义好的 Application.e4xmi 中相关内容可能是： <!--定义一个Command--> <commands xmi:id= \"_4mWoMHcyEeOYmvSF-9z33Q\" elementId= \"holbrook.tangle.demo.myCommand\" commandName= \"测试Cmd\" /> <!--定义一个Handler，并关联到Command--> <handlers xmi:id= \"_J-fYsHczEeOYmvSF-9z33Q\" elementId= \"holbrook.tangle.demo.myHandler\" contributionURI= \"bundleclass://tangle-app/handlers.MyHandler\" command= \"_4mWoMHcyEeOYmvSF-9z33Q\" /> <!--定义一个菜单项，也关联到Command--> <mainMenu xmi:id= \"_FfY8UHbUEeOYmvSF-9z33Q\" elementId= \"tangle-app.menu.0\" > <children xsi:type= \"menu:Menu\" xmi:id= \"_OwboQHc0EeOYmvSF-9z33Q\" elementId= \"tangle-app.menu.1\" label= \"测试菜单\" > <children xsi:type= \"menu:HandledMenuItem\" xmi:id= \"_TwOjEHc0EeOYmvSF-9z33Q\" elementId= \"tangle-app.handledmenuitem.0\" label= \"测试Cmd\" command= \"_4mWoMHcyEeOYmvSF-9z33Q\" /> </children> </mainMenu> CSS样式 e4将桌面应用和Web应用的一些特性融合在了一起，比如，可以通过CSS定义桌面应用的外观。 使用Eclipse bootstrap e4创建的Eclipse 4 Application Project，会包含一个 css/default.css 的空文件。 编辑这个文件就可以修改应用的外观。 在e4中，CSS选择器使用 type#id.class 的格式。其中： type：对应SWT组件类（如Button、Composite等） id：对应应用模型中的 elementId 一些映射关系可以参考 这里 下面是一个CSS的例子： Text { font : Verdana 15px ; color : red ; background-color : green ; } 默认情况下，该CSS就会生效。因为在 plugin.xml 中，已经指定了CSS的扩展点： 更灵活的使用CSS是通过主题管理器。","tags":"软件开发","loc":"http://holbrook.github.io/2014/01/07/eclipse_e4_RCP_quickstart.html"},{"title":"交易策略的基本检验","text":"前提和假设 信号发生时机 通常，交易系统无法实时获取分笔数据，而是获取某一个时间段的 成交数据 。每个时间段（比如5分钟，1天）作为一个成交周期。 由于交易策略都是对成交数据进行事后分析，所以信号通常会滞后一个交易周期产生。 成交价格 基本检验暂时不考虑\"无法成交\"（比如涨跌停）的情况，但是为了检验的严格性，需要采取\"最不利\"的价格作为成交价格。即如果是买入信号，取交易周期内的最高价作为成交价格；如果是卖出信号取交易周期内的最低价作为成交价格。 样本量 为了减小随机误差的影响，每个样本至少要包含30对买入/卖出的交易，即至少要涵盖30个交易周期。 机会的度量 交易策略最根本的指标就是获利的机会。统计学中，用 概率和分布 来度量机会。相应的，对交易策略的获利机会的度量需要确定以下几个指标： 总量 比率 分布 金额类 净利，最大资本金损失程度 平均盈利额/平均亏损额 最大盈利/亏损额 次数类 交易周期 盈利（次数）比率 盈利次数分布，最大连续盈利/亏损次数 净利 净利 = 获利额 - 亏损额 - 交易成本（在基本分析中交易成本=0） 净利考察一个交易策略是否为盈利的策略。净利为负的策略一定不可用。但净利的大小不是最重要的指标。 平均盈利额/平均亏损额 平均盈利额应大于平均亏损额，否则说明该策略不可用。 盈利（次数）比率 盈利比率=盈利次数/交易周期数 盈利比率也叫\"信号成功率\"，反映了策略所对应的投资理念：是依赖于偶然的巨额获利，还是依赖于多次小额获利。 盈利次数分布 可以考察二项式分布、泊松(Poisson)分布或正态分布。 盈利标准差 标准差越小，说明策略的稳定性越高，越不依赖于偶然的巨额获利。 最大盈利/亏损额 如果最大盈利与平均盈利差距过大，则应视为偶然现象，去除该盈利后重新分析。 如果最大亏损与平均亏损差距过大，则要慎重制定风险控制策略，避免突发事件风险（分析时 不 去除！） 如果最大盈利/亏损所占比重过大，则应怀疑策略的盈利能力和稳定性 最大连续盈利/亏损次数 连续盈利/亏损会经常出现，这是因为策略是稳定的，但是市场会发生周期性的变化。 最大连续盈利/亏损次数可以与市场的周期性进行比对。 结合 当前 盈利/亏损次数 和 最大 盈利/亏损次数，可以决策某次交易的额度。 最大资本金损失程度 是指资本波峰、波谷间的差额。决定了需要准备的资本金。 交易周期 交易周期决定了交易的频繁程度。交易越频繁则交易成本越高。 样本的质量 对一个交易策略用不同的时间、不同的交易对象反复多次验证，并根据抽样分布（即各样本的统计量，如均值、中位数、标准差等的分布）的特征，剔除一些不合格的样本，重新对交易策略进行综合评价。 波长稳定性 理论上来说，在各波长下（日线，5分钟线等），信号成功率应该保持稳定。","tags":"量化交易","loc":"http://holbrook.github.io/2014/01/05/verificating_a_trade_system.html"},{"title":"Java依赖注入规范：JSR330","text":"依赖关系 在面向对象编程中，我们常常处理依赖。比如ClassA依赖ClassB，通常需要： ClassA a = new ClassA(); ClassB b = new ClassB(); a.setB(b); a.xxx(); …… 大量这样的依赖处理会导致高耦合度，并且由于通过硬编码组织对象和资源，代码不具有灵活性。 DI和IoC 一种更好的处理方式是 依赖注入 。比如上面的例子中： 通过某种方式声明\"ClassA 依赖 ClassB\" 使用ClassA时，有某种机制自动创建ClassB并将其 注入 到ClassA 这里面，\"某种机制\"需要一个容器来实现。这个容器叫做\"IoC(Inversion of Control)容器\"。 之所以叫做\"控制反转\"，是说不在对象中直接控制，而是由容器控制创建对象、为对象注入其他对象和资源等行为。 IoC是一种思想，实际上我们遇到的大多数\"容器\"都有对其内容的控制功能。 对于前一节的例子，IoC容器可能会有这样一个处理过程： 创建ClassA 分析ClassA的依赖项，得出其依赖ClassB 创建ClassB 将ClassB注入到ClassA 之后，我们可以直接从容器中获取创建并组装好的ClassA对象，无需任何处理即可使用。 关于DI和IoC，可以参考Martin Fowler的经典文章： 《Inversion of Control Containers and the Dependency Injection pattern》 依赖的描述 在DI和IoC的历史上， Spring 功不可没。可以说，Spring使得DI和IoC称为Java应用开发的主流方式。 2004年3月， Spring 1.0 使用外部配置文件(xml)描述对象之间的依赖关系。 2004年10月，JDK1.5开始支持注解(Annotations)语法。 2007年3月， Google Guice 1.0发布，使用annotations作为依赖描述的方式。 2007年11月， Spring 2.5 也开始支持annotation。 JSR330 随着各种IoC容器的出现，依赖的描述方式也五花八门。为了规范和统一，JCP(Java Community Process)于2009年10月发布了 JSR330 。 JSR330在javax.inject中规定了依赖注入的标准注解(Annotations)。包括： @Inject : 标记为\"可注入\"。可用于构造器(constructors), 方法(methods)或字段(fields) @Qualifier : 限定器 @Scope : 标记作用域 @Named : 基于 String 的限定器 @Singleton : 标记为单例 JSR330只规定了依赖注入的描述，对于容器实现未作要求。目前 Spring 、Guice 、Eclipse e4等常用框架已经开始兼容该规范。 JSR-299（Contexts and Dependency Injection for Java EE platform，参考实现 Weld ）在依赖注入上也使用该规范。 比如，定义两个接口： interface MessageRenderer { public void render(); public void setMessageProvider(MessageProvider provider); public MessageProvider getMessageProvider(); } interface MessageProvider { public String getMessage(); } 很明显，一个MessageRenderer依赖一个MessageProvider。 在实现类中，可以使用依赖注入： class StandardOutMessageRenderer implements MessageRenderer { @Inject @Named ( \"messageProvider\" ) private MessageProvider messageProvider = null ; public void render () { if ( messageProvider == null ) { throw new RuntimeException ( \"You must set the property messageProvider of class:\" + StandardOutMessageRenderer . class . getName ()); } System . out . println ( messageProvider . getMessage ()); } public void setMessageProvider ( MessageProvider provider ) { this . messageProvider = provider ; } public MessageProvider getMessageProvider () { return this . messageProvider ; } } class ConfigurableMessageProvider implements MessageProvider { private String message = \"Default message\" ; public ConfigurableMessageProvider () { } @Inject @Named ( \"message\" ) public ConfigurableMessageProvider ( String message ) { this . message = message ; } public void setMessage ( String message ) { this . message = message ; } public String getMessage () { return message ; } } 其中，ConfigurableMessageProvider的构造函数中依赖一个 String 类型的参数。 spring实现 Spring 3.0开始支持JSR330。下面的例子中，使用spring的classpath scanning功能 ( 从spring2.5开始支持 )， 会自动组装bean。 <?xml version=\"1.0\" encoding=\"UTF-8\"?> <beans xmlns= \"http://www.springframework.org/schema/beans\" xmlns:xsi= \"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context= \"http://www.springframework.org/schema/context\" xsi:schemaLocation= \"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.1.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.1.xsd\" > <context:component-scan base-package= \"demo\" /> <bean id= \"message\" class= \"java.lang.String\" > <constructor-arg value= \"You are running JSR330!\" /> </bean> </beans> public static void main ( String [] args ) { GenericXmlApplicationContext ctx = new GenericXmlApplicationContext (); ctx . load ( \"classpath:jsr330.xml\" ); ctx . refresh (); MessageRenderer renderer = ctx . getBean ( \"messageRenderer\" , MessageRenderer . class ); renderer . render (); ctx . close (); }","tags":"软件开发","loc":"http://holbrook.github.io/2013/12/31/jsr330.html"},{"title":"从规则引擎到复杂事件处理(CEP)","text":"Drools Fusion既是规则引擎，又可以作为CEP。除了 事件定义 和 时间推理 之外，对于引擎本身也会有一些不同的使用。 主要体现在会话时钟、流模式、滑动窗口和对事件的内存管理。 会话时钟 由于事件的时间性，处理事件时需要一个参考时钟。 这个参考时钟在会话配置(KnowledgeSessionConfiguration)中指定，所以称为会话时钟(Session Clock)。 有很多种场景需要对时钟进行控制，比如： 规则测试 测试总是需要一个可控的环境,并且当测试包含了带有时间约束的 规则时,不仅需要控制输入规则和事实,而且也需要时间流。 定期(regular)执行 通常,在运行生产规则时,应用程序需要一个实时时 钟,允许引擎对时间的行进立即作出反应。 特殊环境 特殊环境可以对时间的控制有特殊的要求。群集环境可能需要在心 跳中的时钟同步,或 JEE 环境可能需要使用一个应用服务器提供的时钟,等 等。 - 规则重演或模拟 要重演场景或模拟场景也需要应用程序控制时间流。 Drools中默认使用基于系统时钟的实时时钟(realtime)，也可以使用能被应用程序控制的伪时钟(pseudo)。设置伪时钟的方法如下： {% highlight java %} KnowledgeSessionConfiguration conf = KnowledgeBaseFactory.newKnowledgeSessionConfiguration(); conf.setOption( ClockTypeOption.get( \"pseudo\" ) ); StatefulKnowledgeSession session =kbase.newStatefulKnowledgeSession( conf, null ); SessionPseudoClock clock = session.getSessionClock(); // then, while inserting facts, advance the clock as necessary: FactHandle handle1 = session.insert( tick1 ); clock.advanceTime( 10, TimeUnit.SECONDS ); FactHandle handle2 = session.insert( tick2 ); clock.advanceTime( 30, TimeUnit.SECONDS ); FactHandle handle3 = session.insert( tick3 ); {% endhighlight %} 流模式 Drools默认运行在云(Cloud)模式下。云模式下没有时间流的概念，引擎知道所有的事实(Fact)和事件(Event)。此时引擎将所有的事实/事件看做是一个无序的云。 由于云模式下引擎没有\"现在\"的概念，尽管事件具有时间戳、期限等元数据，这些数据也仅仅作为事件的属性， 不代表事件发生的顺序，也不能进行 时间推理 。 如果需要处理实时/准实时事件(Event)，需要 时间推理 ，Drools必须工作在流(Stream)模式下。 此时要求每个流中的事件必须按照时间顺序插入。 启用流模式 Drools默认运行在云模式下，可以通过以下方式启用流模式： {% highlight java %} KnowledgeBaseConfiguration config = KnowledgeBaseFactory.newKnowledgeBaseConfiguration(); config.setOption( EventProcessingOption.STREAM ); 也可以使用属性文件定义： drools.eventProcessingMode = stream 。 入口点 Drools定义了工作空间的多个入口点(WorkingMemoryEntryPoint)，每个入口点可以看做是一个事件流，可以将事件通过不同的入口点插入到工作空间中。 来自同一个入口点的事件通过时间戳被排序。每个流既可以包含单一类型的事件，也可以包含多种类型的事件。 声明入口点 入口点不需要显式声明，在规则中引用的入口点都会在规则编译期间被自动识别和创建。比如： rule \"authorize withdraw\" when WithdrawRequest( $ai : accountId, $am : amount ) from entry-point \"ATM Stream\" CheckingAccount( accountId == $ai, balance > $am ) then // authorize withdraw end 规则编译器会识别\"ATM Stream\"入口点，并在规则库中创建该入口点。 使用入口点 举例如下： {% highlight java %} // create your rulebase and your session as usual StatefulKnowledgeSession session = ... // get a reference to the entry point WorkingMemoryEntryPoint atmStream = session.getWorkingMemoryEntryPoint( \"ATM Stream\" ); // and start inserting your facts into the entry point atmStream.insert( aWithdrawRequest ); {% endhighlight %} 除了这种手工插入事实的方式之外，Drools还提供了一系列的管道API和适配器，可以将其他流(如JMS、IO流、Socket等)之间接入到入口点上。 滑动窗口 在流模式中，规则的 LHS部分 可以使用滑动窗口限定只关注一定范围内的事件。这个范围可以是时间或事件的个数，分别成为滑动时间窗口和滑动长度窗口。 比如： StockTick() over window:time( 2m ) Number( doubleValue > $ max ) from accumulate( SensorReading( $ temp : temperature ) over window:time( 10m ), average( $ temp ) ) StockTick( company == \"IBM\" ) over window:length( 10 ) Number( doubleValue > $ max ) from accumulate( SensorReading( $ temp : temperature ) over window:length( 100 ), average( $ temp ) ) 内存管理 在流模式下，引擎自动执行事件的内存管理。对于不可能再被匹配的事件自动释放。 引擎会关注事件的@expires中指定的到期时间，并分析规则中隐含的到期时间，进行自动释放。","tags":"并发系统","loc":"http://holbrook.github.io/2013/12/22/from_rule_to_cep.html"},{"title":"CEP中的时间推理(Temporal)","text":"CEP 中的 事件(Event) 具有两个与时间相关的属性。一个是timestamp，标记事件发生的时间；另一个是duration，标记事件持续的时间间隔。 由这两个时间属性，还可以计算出事件结束的事件。 时间推理(Temporal)是CEP中特有的条件判断( LHS ，其判断的要素正是基于事件的上述时间属性。 Allen在《An Interval-based Representation of Temporal Knowledge》中描述了13种时间推理的运算符。 下面用DRL语言介绍这13种运算符。其中，运算符的参数格式均为 [#d][#h][#m][#s][#[ms]] 。比如 3m30s 、 4m 等。 After 和 Before(之前和之后) ``` // x∈[a,b]时，满足以下条件 //A发生在B之前 $eventA : EventA( this before[a,b] $eventB ) //B发生在A之后 $eventB : EventB( this after[a,b] $eventA ) ``` 如果没有给出参数，则a=1ms, b=+∞ 如果只给出一个参数a,则b=+∞ Coincides（同时发生） ``` // x∈[0,a]，且y∈[0,b]时，满足以下条件 $eventA : EventA( this coincides[a,b] $eventB ) $eventB : EventB( this coincides[a,b] $eventA ) ``` 如果只给出一个参数a,则b=a 如果不给出参数，则a=0,b=0 During 和 Includes（包含） ``` // x∈[a,b]，且y∈[c,d]时，满足以下条件 //A在B期间发生 $eventA : EventA( this during[a,b,c,d] $eventB ) //B包含A $eventB : EventB( this includes[a,b,c,d] $eventA ) ``` 如果只给出二个参数a,b,则c=a,d=b 如果只给出一个参数b,则a=0,c=0,d=b 如果不给出参数，则a=0,b=+∞, c=0,d=+∞ Finishes 和 Finished by（同时结束） ``` // x∈[0,a]时，满足以下条件 //A在B之后开始，和B同时结束 $eventA : EventA( this finishes[a] $eventB ) //B在A之前开始，和B同时结束 $eventB : EventB( this finishedby[a] $eventA ) ``` 如果不给出参数，则a=0 Meets 和 Met by（相邻） ``` // x∈[0,a]时，满足以下条件 //A结束时B开始 $eventA : EventA( this meets[a] $eventB ) //A结束时B开始 $eventB : EventB( this metby[a] $eventA ) ``` 如果没有给出参数，则a=0 Overlaps 和 Overlappd by（相交） ``` // x∈[a,b]时，满足以下条件 //A在B之前开始，在B之后结束 $eventA : EventA( this overlaps[a,b] $eventB ) //B在A之后开始，在A之前结束 $eventB : EventB( this overlappedby[a,b] $eventA ) ``` 如果只给出一个参数b,则a=0 如果不给出参数，则a=0,b=0 Starts 和 Started by（同时开始） ``` // x∈[0,a]时，满足以下条件 //A和B同时开始，A先结束 $eventA : EventA( this starts[a] $eventB ) //B和A同时开始，B后结束 $eventB : EventB( this startedby[a] $eventA ) ``` 如果不给出参数，则a=+∞","tags":"并发系统","loc":"http://holbrook.github.io/2013/12/21/Temporal_of_CEP.html"},{"title":"CEP中的事件(Event)","text":"CEP 处理复杂事件。宽泛的事件，是指在应用程序域中的状态的一个有意义改变的一条记录。 而复杂事件处理关注 事件之间的相关性 ,以及原子事件组合成的复杂(复合)事件。 CEP与规则引擎有类似之处，但CEP中的事件(Event)是一种特殊类型的事实(Fact)。其特殊性在于： 不可改变 事件记录了已经发生的事情，而\"过去\"是不可改变的。 强时间约束 事件有发生的时点，事件之间通常基于事件发生的时点进行关联。 被管理的生命周期 有效时间窗口之外的事件不再有意义，可以被引擎自动回收。 可以通过时间聚合 因为所有的事件都有与它们关联的时间戳,所以,对它们可以 定义和使用滑动窗口,允许在一个时间段上根据值的聚合创建规则, 例如, 整个 60 分钟的一个事件的值的平均值。 复杂事件处理(CEP),本质上是一个事件处理概念,涉及处理多个事件的任务与在事件云内部识别有意义事件的目标。 或者说，CEP从事件云/事件流中检测和选择感兴趣的事件, 找出它们之间的关系,根据它们和它们之间的关系推断新的数据。 由于CEP与规则引擎类似之处，CEP通常基于规则引擎。比如，Drools Fusion即是规则引擎，也可以作为CEP。 事件声明 DRL中的 declare 可以用于声明事件，只需要在declare中增加一条 @role(event) 的元数据。实际上，declare默认隐含了 @role(fact) 的元数据，表面声明的是事实(Fact)。 比如： import some.package.StockTick declare StockTick @role ( event ) end // 或者使用内嵌的事件声明 declare StockTick @role ( event ) datetime : java . util . Date symbol : String price : double end 事件元数据 除了 @role 之外，事件还有一些Fact不具备的元数据。可以在declare中指定。 @timestamp 事件默认的时间戳是在insert到工作空间时，由引擎从Session Clock 获取并分配给事件。如果要指定使用事件的某一个属性作为时间戳， 可以用 @timestamp 元数据指定。比如： declare StockTick @role( event ) @timestamp( datetime ) datetime : java.util.Date symbol : String price : double end @duration 默认事件的期限为0，称为point-in-time 事件。有些事件具有期限性，称为interval-based 事件。 要声明事件的期限，通过 @duration 指定事件的一个属性，该属性以 毫秒数 记录了事件的期限。 @expires 当引擎运行在流(STREAM)模式时，指定一个过期时间可以用于内存管理。其格式为 [#d][#h][#m][#s][#[ms]] ，比如： @expires( 1h35m )","tags":"并发系统","loc":"http://holbrook.github.io/2013/12/21/event_in_CEP.html"},{"title":"Drools规则引擎API概述","text":"如前所述 ， 规则引擎中，将知识表达为规则（rules），要分析的情况定义为事实（facts）。二者在内存中的存储分别称为Production Memory和Working Memory。在外围，还会有一个执行引擎（Execution Engine）。 与此对应，规则引擎API也分成三个部分。在Drools中，分别叫做Knowledge API，Fact API和Execution API。 Knowledge API Drools将知识库(KnowledgeBase)作为 JSR94 中的规则执行集(RuleExecutionSet)。知识库中的知识以包(KnowledgePackage)为单位组合而成。每个包中聚合多个规则(Rule)。 通常，一个包中的内容会在一个或多个资源(Resource)中保存。资源的类型可以有很多种,如.drl 文件、.dslr 文件或 xls 文件等。 规则包还可以从规则流(rule flow) 文件中获取。 与此对应，Drools定义了一组Knowledge API来操作知识库。 构建知识库的一般过程为： 通过ResourceFactory获取资源。可以从Classpath、URL、File、ByteArray、Reader等输入源中获取 构建KnowledgeBuilder，将资源添加到KnowledgeBuilder中。KnowledgeBuilder通常由KnowledgeBuilderFactory创建 从KnowledgeBuilder中获取规则包 创建KnowledgeBase，可以通过KnowledgeBaseConfiguration定义KnowledgeBase的一些属性，默认的配置位于drools-core-VERSION.jar 包下 META-INF/drools.default.rulebase.conf 文件中 将规则包添加到KnowledgeBase 为KnowledgeBase添加KnowledgeBaseEventListener，可以监控KnowledgeBase中的事件 代码示例： {% highlight java %} KnowledgeBase buildKBase () { Resource res = ResourceFactory . newClassPathResource ( \"hello.drl\" , Demo . class ); KnowledgeBuilder kbuilder = KnowledgeBuilderFactory . newKnowledgeBuilder (); kbuilder . add ( res , ResourceType . DRL ); // validate if ( kbuilder . hasErrors ()) { System . out . println ( \"规则中存在错误,错误消息如下:\" ); KnowledgeBuilderErrors kbuidlerErrors = kbuilder . getErrors (); for ( Iterator iter = kbuidlerErrors . iterator (); iter . hasNext ();) { System . out . println ( iter . next ()); } } Collection < KnowledgePackage > kpackages = kbuilder .getKnowledgePackages (); KnowledgeBaseConfiguration kbConf = KnowledgeBaseFactory .newKnowledgeBaseConfiguration (); kbConf .setProperty ( \"org.drools.sequential\" , \"true\" ); // KnowledgeBase kbase = KnowledgeBaseFactory .newKnowledgeBase (); KnowledgeBase kbase = KnowledgeBaseFactory .newKnowledgeBase ( kbConf ); kbase .addKnowledgePackages ( kpackages ); return kbase ; } {% endhighlight %} Fact API 要操作Working Memory，首先要建立规则引擎的一个会话。Drools中的有状态会话和无状态会话分别为StatefulKnowledgeSession和StatelessKnowledgeSession，都可以由KnowledgeBase建立。 通过会话可以进行操作Fact对象，执行规则等交互，例如： {% highlight java %} KnowledgeBase kbase = buildKBase(); StatefulKnowledgeSession statefulKSession=kbase.newStatefulKnowledgeSession(); statefulKSession.setGlobal(\"globalTest\", new Object()); statefulKSession.insert(new Object()); statefulKSession.fireAllRules(); statefulKSession.dispose(); {% endhighlight %} StatefulKnowledgeSession中，insert()方法、fireAllRules()方法和 dispose()方法是分开执行的，这个过程中可以进行一定的控制， 而StatelessKnowledgeSession不同，在无状态会话中，上述三个方法被合并为execute()方法，不能分开调用。如果要插入多个Fact对象，只能使用集合，比如： {% highlight java %} StatelessKnowledgeSession statelessKSession=kbase.newStatelessKnowledgeSession(); ArrayList list=new ArrayList(); list.add(new Object()); list.add(new Object()); statelessKSession.execute(list); {% endhighlight %} 这样的特点决定了，无状态会话适合推演和分析，需要事先知道所有的事实(Fact)；而有状态会话可以随时增加事实并进行批评，适合实际应用。 无状态会话中还可以使用execute(Command cmd)方法。比如，如果要在无状态会话中插入一个List，可以用CommandFactory生成一个关于List的Command: {% highlight java %} statelessKSession.execute(CommandFactory.newInsert(list)); 同样，无状态会话中如果要设置global，也需要使用Command: {% highlight java %} ArrayList list=new ArrayList (); list.add(CommandFactory.newInsert(new Object())); list.add(CommandFactory.newInsert(new Object())); list.add(CommandFactory.newSetGlobal(\"key1\", new Object())); list.add(CommandFactory.newSetGlobal(\"key2\", new Object())); statelessKSession.execute(CommandFactory.newBatchExecution(list)) ; Execution API 插入到WorkingMemory中的对象，并不是克隆，而是对原对象的引用。这就意味着引擎中可以改变外部的对象，这是引擎与外部数据交互的一个通道。 此外，insert()方法还会返回一个FactHandler，作为引擎中该Fact对象的一个句柄。 最后，session上可以注册AgendaEventListener、ProcessEventListener和WorkingMemoryEventListener，这也是常用的交互方式。 比如WorkingMemoryEventListener可以监听Fact对象变化的事件： {% highlight java %} public interface WorkingMemoryEventListener extends EventListener { void objectInserted(ObjectInsertedEvent event); void objectUpdated(ObjectUpdatedEvent event); void objectRetracted(ObjectRetractedEvent event); } {% endhighlight %}","tags":"软件开发","loc":"http://holbrook.github.io/2013/12/20/drools_API.html"},{"title":"使用Oracle Berkeley DB持久化股票行情数据","text":"关系数据库，数据文件 还是 NoSQL 股票行情数据具有如下特点： 数据量大 对于分析来说，至少需要5分钟数据。如果每天交易时间为4小时，每年250个交易日，则一支股票一年的行情数据量为60/5 4 250= 12k。20年则为240k。如果是1分钟数据，则20年的数据量为240k*5 = 1.2M。 所以，如果用于分析，行情数据将是百万量级。如果记录3000只股票/指数的数据，数据量会非常大。 数据很少变化 由于都是历史数据，行情数据很少需要修改。主要的操作是查询和增加。 数据结构简单 主要考虑 成交数据 ，是一种简单的一维结构。价格数据只在发生交易信号时有一定的参考意义，不需要保留所有的历史记录。 由于行情数据的这些特点，通常不适合使用关系数据库。传统上一般采用数据文件进行存储。 但是用数据文件需要自己处理写入锁，随机读写，序列化等问题，比较麻烦。于是 NoSQL 成了比较好的一种选择。 对于单机的分析软件， NoSQL选型要素 为： key/value儲存 支持持久化 支持嵌入式 接口方便 Oracle Berkeley DB Berkeley DB 是满足上述4点要求的比较好的一款产品。Berkeley DB分为BDB、BDB Java版和BDB XML版。其总体架构如下图： BDB的三个版本的功能不完全相同。 我选择BDB Java版，不支持SQL API和XQuery API，可以使用底层的键/值API、Java 直接持久层 (DPL) API和Java 集合 API。三种API的应用场景如下： 当 Java 类是用来代表应用中的域对象(domain objects),也就是说,该模式是相对 稳定的,建议用直接持久层。 当在Berkeley DB和Berkeley DB Java 版之间移植应用程序时,或当实现自己的 动态模式(举例来说,一个 LDAP 服务器),那么建议用基础 API。您也可能喜欢使用这 个基础API如果您有极少数域类(domain class)。 集合API有利于和外部组件交互,因为它遵从Java集合框架标准。继而,和基础API 以及直接持久层结合后会很有用。您可能会喜欢这个 API,因为它提供了熟悉的 Java 集 合接口。 在行情数据的持久化中，可以选用直接持久层（DPL）。直接持久层API 可以持久化以及还原相互关联的 Java 对象，但是比ORM更加简单高效。 实现过程 获取开发包 可以从 这里 下载需要的jar包，也可以使用maven： {% highlight xml %} com.sleepycat je 5.0.73 {% endhighlight %} 如果要使用最新版（目前的最新版是5.0.97），需要引入oracle的maven库： {% highlight xml %} oracleReleases Oracle Released Java Packages http://download.oracle.com/maven default 定义持久化模型 实体和值对象 Berkeley DB支持DDD(领域驱动设计)中的实体和值对象的持久化。 实体：拥有长期不变的标识符,可以被跟踪的对象。 值对象：没有标识符，主要关注其属性的对象。 在BDB中，分别使用 @Entity 和 @Persistent 来声明实体和值对象。 声明了 @Persistent 的对象可以直接作为 @Entity 对象中的属性使用。 任何Java类一旦增加了持久化声明，其所有字段（任何作用域）都会被持久化。需要持久化的类需要缺省的无参数构造函数。 比如： {% highlight java %} @Entity public class Transaction { …… public OHLC ohlc; …… } @Persistent public class OHLC { public float open,high,low,close; } {% endhighlight %} 主键和\"次键\"声明 每个实体类(@Entity)可以定义一个主键(PrimaryKey)和多个次键(SecondaryKey)，从而可以按照主键或次键进行索引。例如： {% highlight java %} @Entity public class Security implements Instrument{ @PrimaryKey private String code; @SecondaryKey(relate=Relationship.ONE_TO_ONE) private String name; …… } 关联关系 关联关系也是通过次键(SecondaryKey)声明的。需要同时指定多重性（relate）和关联到的实体（relatedEntity）。 relate可以是ONE_TO_ONE,ONE_TO_MANY,MANY_TO_ONE或MANY_TO_MANY(在com.sleepycat.persist.model.Relationship中定义)。 需要注意的是，次键的属性类型需要是relatedEntity指定的对端实体的主键类型，而不能直接使用对端实体。 如果relate是ONE_TO_MANY或MANY_TO_MANY，可以使用集合类型。比如（不属于股票行情数据模型，而是BDB官方例子）： {% highlight java %} @Entity class Employer { @PrimaryKey(sequence=\"ID\") long id; @SecondaryKey(relate=ONE_TO_ONE) String name; …… } @Entity class Person { @PrimaryKey String ssn; @SecondaryKey(relate=MANY_TO_ONE, relatedEntity=Person.class) String parentSsn; @SecondaryKey(relate=ONE_TO_MANY) Set<String> emailAddresses = new HashSet<String>(); @SecondaryKey(relate=MANY_TO_MANY, relatedEntity=Employer.class, onRelatedEntityDelete=NULLIFY) Set<Long> employerIds = new HashSet<Long>(); …… } {% endhighlight %} 使用DPL API 设计Accessor(TODO) 类似于DAO，BDB中通常将对实体的访问封装到Accessor中。例如： EntityStore 获取索引 CRUD 访问关联对象 通过索引可以得到关联的对象，无论是单个关联对象还是集合。 关联到单个对象 关联到集合 {% highlight java %} EntityCursor employees = dao.personByEmployerIds.subIndex(gizmoInc.id).entities(); try { for (Person employee : employees) { System.out.println(employee.ssn + ' ' + employee.name); } } finally { employees.close(); } 等值连接 通过 EntityJoin 类可以进行等值连 接(equality join)操作。 比如，以下代码查询所有Bob的孩子中为gizmo公司工作的 员工: {% highlight java %} EntityJoin join = new EntityJoin(dao.personBySsn); join.addCondition(dao.personByParentSsn, \"111-11-1111\"); join.addCondition(dao.personByEmployerIds, gizmoInc.id); ForwardCursor results = join.entities(); try { for (Person person : results) { System.out.println(person.ssn + ' ' + person.name); } } finally { results.close(); } 建立连接 事务支持 {% highlight java %} Transaction txn = env.beginTransaction(null, null); dao.employerById.put(txn, gizmoInc); dao.employerById.put(txn, gadgetInc); txn.commit(); 模型变化 对于增加实体或值对象的属性，改变属性类型等变化，一般不需要对BDB进行额外的处理，而是会自动适应。 对于一些特殊的、无法自动适应的变化，比如重命名字段或优化单个的类(如:使用通用类型,模块复用等改变),可以使用Mutations。 Mutations 操作是延迟的:只在存取数据时自动改变,故避免了软件升级时大型数据库转换导致的长时间停机。 复杂的类优化可能涉及到多个类,使用 ConversionStore 进行。因而,无论持久化类作出何种 改变,直接持久层都始终提供可靠数据存取。 性能选项 Berkeley DB在API的很多地方提供了性能调优的选项。常见的包括： DatabaseConfig参数 通过DatabaseConfig参数可以用来调整Berkeley DB引擎的性能。 比如,可指定内部B树节点的大小来调整性能,通过如下方式来指定: {% highlight java %} DatabaseConfig config = store.getPrimaryConfig(Employer.class); config.setNodeMaxEntries(64); store.setPrimaryConfig(config); CRUD操作参数 例如, \"脏读\"可通过LockMode参数实现: Employer employer = employerByName.get(null, \"Gizmo Inc\", LockMode.READ_UNCOMMITTED);","tags":"量化交易","loc":"http://holbrook.github.io/2013/12/19/Berkeley_DB.html"},{"title":"交易策略与规则引擎","text":"交易策略的要点 前面 提到，交易策略是系统化交易的核心。但是要注意的是，风险管理比交易策略要重要10倍。 交易策略的一些要点整理如下： 交易策略是一套完整的交易规则体系 这些规则对投资决策的各个环节做出明确规定 这些规则必须客观、唯一 所谓完整，至少要包括入场和出场两个规则——完成一个完整的交易周期，入场和出场信号必须确定会发生 出场策略比入场策略要重要10倍 越简单的策略越可靠 要有错误处理机制 交易策略的种类 所谓 规则，规定了一组确定的条件和此条件所产生的结果 。根据条件的类别不同，可以把交易策略分成以下几种： 基于技术指标 例1 规则定义 入场规则：短期均线上穿长期均线 出场规则：短期均线下穿长期均线 评价 简单但完整的交易策略 例2 规则定义 入场规则：RSI<10 出场规则：RSI>90 评价 有严重的设计缺陷。因为RSI可能长期不能趋近于某一极值，从而得不到对应的操作信号，长期无法完成完整的买卖周期。 基于统计分析 此类策略要研究市场数据的统计分布特征，需要较强的数学功底 例1 规则定义 入场规则：跳空高开若干 出场规则：利润达到x值或收盘价，或者损失达到y止损 评价 其思想是捕捉跳空开盘对后市的影响 例2 规则定义 入场规则：突破跳空 出场规则：衰竭跳空 评价 两个问题：1）跳空不一定会出现，从而导致交易周期不完整；2）过于主观随意 例3 规则定义 入场规则：迪马克波动系数终点 出场规则：反向迪马克波动系数终点 评价 交易周期不完整 基于图形分析 这类是最传统、最常见的交易策略 例1 规则定义 入场规则：维克多突破 出场规则：反向维克多突破 评价 简单但完整 例2 规则定义 入场规则：罗斯钩式突破 出场规则：反向罗斯钩式突破 评价 完整 例3 规则定义 入场规则：卡尔汉数突破 出场规则：反向卡尔汉数突破 评价 例4 规则定义 入场规则：W型反转 出场规则：M型反转 评价 不一定会发生，交易周期不完整 例5 规则定义 入场规则：晨星式 出场规则：昏星式 评价 不一定会发生，交易周期不完整 基于数学理论 需要较强的金融投资理论背景 例1：飞镖系统 规则定义 入场规则：飞镖击中的股票 出场规则：持有至规定期限 评价 其收益战胜了华尔街股票分析家，验证了投资学术界的随机行走理论 例2：以满月为买入信号，以新月为卖出信号。 这是一个以金融占星术理论为基础的交易系统。该方法以月球引力场的变化来解释地球生态系统的周期性变比。 例3：硬币法——以随机选择过程为基础 （略） 基于基本分析 P/E小于某一值时买入，P/E大于某一值时卖出 收益增长率大于某一值时买入，收益增长率小于某一值时卖出 每年某月买入白糖合约，若干月后平仓（季节波动） 新建住房开工率持续上升若干月买入铜合约，若干月后平仓（因果关系） 基于心理分析 例： 传言开始是进场，传言证实后出场 其他 基于人工智能、神经网络、混沌理论（Chaos)等 用规则引擎驱动交易策略 尽管要求交易策略要尽可能简单，但是交易信号产生的条件可能五花八门。为了使交易系统具备更好的适应性，还是应该使用 规则引擎 来驱动。这就需要将交易策略规则化。 一般来说，交易策略的规则化需要经过确定规则（定性）、确定参数（定量）以及用规则语言描述（实现）三个步骤。 策略定性 将交易策略表示为条件与交易信号。对于最简单的交易策略，可能只有入场信号和出场信号。但也会有一些稍复杂的情况需要处理： 对于期货交易，入场信号可以区分为\"做多\"和\"做空\"，出场信号均为\"平仓\" 有些交易策略的入场、出场信号可能会划分出不同的风险级别——风险越高的信号，产生的时间越早，可能的获利越大，但判断失误的风险也更大 完善的交易系统，对于(正确入场,正确出场)、(正确入场,错误出场)、(错误入场,正确出场)、(错误入场,错误出场) 等情况都要考虑到，针对这些情况都要及时给出交易信号 确定参数 将策略中可变的部分定义为参数。这些参数可以在引擎中进行设置，以调整策略的具体行为。 参数可能要经过实际检验，才能得出最优的参数。 定义事件 交易信号都是由某些数据触发， 如前 所述，这些数据可能是行情、指标、基本面等。 不管是哪种数据，从规则引擎的角度，都需要定义为 事件(Event) 。 定义操作 规则匹配的结果就是产生某种 操作 。 考虑到交易策略要与后续的 资金管理 等策略结合，这里将操作也定义为事件，作为资金管理策略的输入。 描述规则 使用前面定义好的参数、事件和操作，用 规则描述语言 将定性的策略描述为定量的规则。 实例 以\"简单算术平均线\"策略为例，其实现过程如下： 规则定性 规则1：当短期平均线向上穿越长期平均线时，买入 规则2：当短期平均线向下穿越长期平均线时，卖出 确定参数 这个策略中，可以作为参数的变量包括： 选用哪种价格，比如开盘价、收盘价、最高价、最低价等 短期和长期均线的长度 为简单起见，这里只把均线的长度作为参数。 可以在DRL的global部分用全局变量定义规则的参数。这些参数将用于事件属性或规则条件中，用于调整策略的具体行为。如下： global java.lang.Integer SHORT_LENGTH; global java.lang.Integer LONG_LENGTH; global参数可以使用在规则引擎会话中，使用 KnowledgeSession 的 setGlobal() 方法进行设置。 事件定义 定义一个\"均线事件\"(MAEvent): ``` public class MAEvent { public Date datetime; public long duration; public int length; public double average; public double price; public String toString(){ return \"\"+this.getDatetime().toLocaleString()+\":MA\"+this.length+\"=\"+average+\"\\t(\"+price+\")\"; } } ``` 并在规则文件中进行声明： import my.package.MAEvent …… declare MAEvent @role(event) @timestamp( datetime ) @duration( duration ) end 定义操作 这里使用一个\"操作信号事件\"(SingalEvent)作为操作，符合条件时将该事件 insert 到规则引擎： ``` public class SignalEvent extends AbstractEvent{ public enum SignalType{LONG,SHORT} public Date datetime; public long duration; public SignalType type; public String strategyName; } ``` 在规则文件中声明： declare SignalEvent @role(event) @timestamp(datetime) @duration(duration) end 描述规则 ``` rule \"LONG SIGNAL\" when $MA5_1:MAEvent(length==SHORT_LENGTH); $MA5_0:MAEvent(length==SHORT_LENGTH,this meets[1d] $MA5_1); $MA20_1:MAEvent(length==LONG_LENGTH,this coincides $MA5_1,average>=$MA5_1.average); $MA20_0:MAEvent(length==LONG_LENGTH,this meets[1d] $MA20_1,this coincides $MA5_0, average<=$MA5_0.average ); then SignalEvent e = new SignalEvent(); e.datetime = $ MA5_1 . datetime ; e.strategyName = \"简单移动平均线策略\"; e.type = SignalEvent.SignalType.LONG; e.price = $ MA5_1 . price ; insert(e); System.out.println(e); end rule \"SHORT SIGNAL\" when $MA5_1:MAEvent(length==SHORT_LENGTH); $MA5_0:MAEvent(length==SHORT_LENGTH,this meets[1d] $MA5_1); $MA20_1:MAEvent(length==LONG_LENGTH,this coincides $MA5_1,average<=$MA5_1.average); $MA20_0:MAEvent(length==LONG_LENGTH,this meets[1d] $MA20_1, this coincides $MA5_0, average>=$MA5_0.average ); then SignalEvent e = new SignalEvent(); e.datetime = $ MA5_1 . datetime ; e.strategyName = \"简单移动平均线策略\"; e.type = SignalEvent.SignalType.SHORT; e.price = $ MA5_1 . price ; insert(e); System.out.println(e); end ```","tags":"量化交易","loc":"http://holbrook.github.io/2013/12/19/trading_strategy.html"},{"title":"证券行情数据模型","text":"行情数据举例 交易系统离不开行情数据。比如，如果访问新浪的股票数据接口： http://hq.sinajs.cn/list=sh600133,sh601005 可能会得到如下的数据： var hq_str_sh600133 = \"东湖高新,6.01,6.01,5.91,6.07,5.80,5.92,5.93,8947052,52872049,2000,5.92,57704,5.91,191500,5.90,75000,5.89,142800,5.88,19700,5.93,43750,5.94,51600,5.95,17299,5.96,11445,5.97,2013-12-18,13:56:49,00\" ; var hq_str_sh601005 = \"重庆钢铁,2.50,2.50,2.49,2.51,2.48,2.49,2.50,1505600,3764816,448800,2.49,110600,2.48,132500,2.47,206500,2.46,150300,2.45,95501,2.50,447100,2.51,110600,2.52,110800,2.53,136400,2.54,2013-12-18,13:56:49,00\" ; 每只股票返回一组数据。以第一组数据为例，各数据项的含义如下： 东湖高新 股票名称 6.01 今日开盘价（元） 6.01 昨日收盘价（元） 5.91 当前价格（元） 6.07 今日最高价（元） 5.80 今日最低价（元） 5.92 买一（元） 5.93 卖一（元） 8947052 成交量（股） 52872049 成交金额（元） 2000 买一申报量（股） 5.92 买一出价（元） 57704 买二申报量（股） 5.91 买二出价（元） 191500 买三申报量（股） 5.90 买三出价（元） 75000 买四申报量（股） 5.89 买四出价（元） 142800 买五申报量（股） 5.88 买五出价（元） 19700 卖一申报量（股） 5.93 卖一报价（元） 43750 卖二申报量（股） 5.94 卖二报价（元） 51600 卖三申报量（股） 5.95 卖三报价（元） 17299 卖四申报量（股） 5.96 卖四报价（元） 11445 卖五申报量（股） 5.97 卖五报价（元） 2013-12-18 日期 13:56:49,00 时间 价格和成交 上述的查询结果包含了两种不同的数据：价格(Price)和成交（Transaction)。 价格是实时数据，记录了某一时点的当前价格（price）和一系列（上面的例子中是五组）的报价(Quote)数据；其中报价又包含了买方的出价（bid)和卖方的要价（offer），通常可能表示为\"0.6712/5\"、\"0.2345/\"，\"/0.4352\"等。 成交是阶段数据，记录了某一个时段（上面的例子中是一天）内的开盘价(open)，收盘价（close）,最高价（high），最低价（low）； 以及该段时间内总的成交量（volume）和成交价格（amount）。由于(开盘价,收盘价,最高价,最低价）是很常用的一种结构，比如画蜡烛图时就会使用这种结构，所以将其封装为一个 值对象 ： OHLC 。 不管是价格信息还是成交信息，都关联到某一证券（Security）。 场景 在上面的模型中，价格和成交直接关联到时点。 实际应用中，经常会需要将一些价格或成交聚合在一起。比如，某个市场、某个板块的所有股票的价格。而这种聚合通常要指定到某个时间点才有意义。 可以把这种聚合叫做场景（Scenario），场景关联到某一时间点（TimePoint)。一个场景可以有多个场景元素（ScenarioElement），场景元素作为证券和其他因素之间的关联，聚合到与时点相关的场景中。 场景提供了一个把所有因素综合在一起的基础，从而可以很方便的在不同的情况之间进行比较。这就有较高的实用性。 比如，在跨市场套利中，可以针对不同的市场定义不同的场景，并将场景关联到指定的市场，从而在不同市场之间进行比较。 在比如在交易系统的风险管理中，可以在多种可能的情况之间进行对比分析。 有了场景和场景元素的定义，则价格和成交都是场景元素的一种实现： 多数据源 实际应用中，可能需要从多个数据源获取数据。 价格指标 通过其他场景元素计算获取","tags":"量化交易","loc":"http://holbrook.github.io/2013/12/18/quotation_model.html"},{"title":"系统交易和交易系统","text":"证券价格的随机性 很多人都从股票投机中赚过钱，但是绝少人能够长期赚钱。甚至这些长期赚钱的人中，绝大部分人的成功次数少于50%。这意味着，证券价格的波动具有随机性。 投资理论界认为，价格的波动具备高度随机性；而投资实务界认为只是部分随机性。 如果价格的波动具备完全随机性，则意味着数据没有任何记忆性，完全无法通过过去的数据预测未来。就好像抛硬币，即使之前抛出了一千次正面，第一千零一次抛出正、反面的概率依然是各占50%。 不可否认，证券价格的变化比抛硬币游戏要复杂得多，目前无法证明其具备完全随机性，但是也无法准确发现其变化规律。 从实践来看，总有人能够从证券投资中稳定获利。尤其近几年一些量化投资方法的成功，又让人看到了通过数学模型获取稳定收益的希望。 赌博还是投资？ 尽管人的天性中都厌恶风险（不确定性），但是又都或多或少喜欢赌博。 对于证券投机，可以说本质上也是一种赌博。区别在于大多数人仅仅是赌博，而少数人以数学家的方式参与赌博。 赌博之所以吸引人，在于其概率性。数学家经过思考和技术能够赢得赌博游戏，是因为其对概率和统计学的把握。 要进行科学的投资/投机，而不是以赌博的心态去进行交易，一定要明确以下几点： 投资的目标是持续稳定获利 不要期望每次交易都是正确的，甚至不要期望成功交易的次数要大于失败的次数。据说，华尔街的顶尖交易员在十年中的平均正确率仅仅是35%左右 成功的交易，其收益率不一定高，不要追求单次交易的高回报率——这种事情发生的概率太小 失败的交易，一定要将其损失控制在合理的范围。失败是常态，但是一定不要把一次失败演变成灾难 符合上述行为的投资，就可以称为科学投资，而不是赌博。 科学投资的精髓就是捕捉高度随机变化中的非随机性。 系统化交易 要实现科学投资，需要将一段时间内的所有交易看做一系列整体性、系统化的行为，而不是一次次的\"率性而为\"。这就要求： 首先要有一个交易策略，这个交易策略经过一系列的统计验证，期望值为正。并且明确知道其成功率、最高收益率、最大损失率等一系列关键性的指标 根据该交易策略的关键指标，结合自身资金情况，制定一个资金管理策略。资金管理策略保证你有足够的筹码将这个游戏玩下去，而不是中途出局 严格基于交易策略和资金管理策略，进行一系列的选股、择时、执行等操作 对于每一笔交易，分析其成功或失败的原因是由于概率、心理因素还是模型的缺陷。在一定的时间后根据最新的统计结果修正模型参数。 能够做到这些，就可以称之为\"系统化交易\"。 选股：筛选交易对象 择时：对行情进行判断，选择合适的操作时机 战术：生成正向或反向交易指令 执行：记录交易结果 反馈：核算、评估 心理因素 系统化交易中，最难克服的是心理障碍。请将手放在心口，听我说： 你能否承认交易策略和资金管理策略是指引你交易行为的唯一准则，爱他、安慰他、尊重他、保护他，像你爱自己一样，无论每次交易是成功、是失败，也无论你听到了市场上多么动听的传言，亦或你的交易遭到了何种的嘲讽？ 先不要急着回答。人性是如此脆弱，以至于你很快就会释放心中的魔鬼，从而将上面的誓言抛之脑后。请问： 两个选择：1）有75%的机会得到1000美元，但有25%的机会什么都得不到。2）确定可以得到700美元。 你会如何选择？ 还是两个选择：1）75%的机会付出1000美元，但有25%的机会什么也不用付出。2）确定付出700美元。 你会如何选择？ 可能多数人会在第1个问题中选择2），第二个问题中选择1）。实际上，如果计算了期望值，这两个选择都是错的。这就是你心中的魔鬼。 传言巴菲特有一次打高尔夫的时候球友们跟他打赌：在三天内如果巴菲特打出一次一杆进洞，就给他20000美元，否则巴菲特要付出10美元。但是巴菲特拒绝了。 关住内心的魔鬼，从概率的角度进行思考，绝不要心存侥幸。这才是科学交易的精神。 无论成败，恪守交易策略，才能从大量单个交易的偶然中获取总体期望值的必然；无原则，或者有原则而不遵守，就只能停留在一个个的偶然，并且总体结果也是偶然。 交易系统的作用 除了心理控制的难关，系统化交易过程中需要进行信息收集、信息处理、交易决策、交易计划、交易执行等大量琐碎耗时的事情，这些事情很可能影响你的心态，甚至由于信息的干扰影响决策的正确性。 此外，系统化交易需要不断对交易策略和资金管理策略不断进行统计分析、优化和参数调整，对于大多数人来说这也是一个难以胜任的工作。 上述种种，需要某种工具来辅助，姑且称之为\"交易系统\"。 如上图，交易的\"铁三角\"是交易者、交易资本和交易对象，而交易系统的主要作用是： 管理交易策略的生命周期，按照交易策略实施交易 根据风险控制策略进行资金管理 辅助交易者进行心理控制 交易系统的主要功能 交易策略的生命周期管理 交易系统最重要的功能应该是对交易策略的整个生命周期进行管理。 一个交易策略提出后，要经过一系列的阶段，直到最终被废弃。交易策略的生命周期如下图所示： 公式化 交易策略中的所有规则，既包括买卖点的生成规则，也包括交易对象筛选的规则等，必须能够用公式/程序语言客观、准确的表示。 并提取出所有的变量/事件和参数。变量/事件用于客观事实的输入，参数用于优化。 当然，对于一些共性的规则，如检查交易对象的流动性和价格波动程度等规则，可以提取出公共的规则，在交易策略中进行引用。 统计检验 使用历史数据对交易策略进行检验，得出交易策略的统计学参数和关键指标 外推检验 使用真实的外部数据，进行模拟盘的操作，检验效果，验证参数和指标的变化 实战检验 使用真实的外部数据，进行实盘操作，检验效果，验证交易策略与交易者之间是否契合 监控与维护 经过上述步骤的交易策略，可以用于实战。在实战过程中要不断监控策略的统计学参数和指标是否已经偏离 优化 在任一环节，如果发现交易策略不能满足要求，可以对参数进行优化 辅助决策 经过验证的交易策略只是给出合适的交易信号：买入信号或卖出信号。根据交易信号、资金状况、策略的统计指标等因素来决定是否要交易、交易量是多少等等这些交易要素，是一个决策的过程。 交易系统应该能够为交易决策提供辅助。 支持功能 前面提到的交易过程中的其他环节，如信息收集、信息处理、交易日志、结果分析、指标计算等，也需要交易系统进行支持。 交易策略与交易者 同一套交易策略，在不同的交易员手中，效果截然不同。这里面没有对错，而是一个是否适合的问题。 交易策略仅仅规定了交易信号产生的规则，但是不同的交易员具有不同的交易周期长短、风险承受水平、投资理念等偏好，所以会适合不同的交易策略。 所谓最适合的就是最好的，对交易员来说，最重要的时期不是妄图找到\"最好\"的交易策略，而是应该找到最适合自己投资理念的交易策略。 在符合自己投资理念的前提下，交易过程中要尽量排除不必要的主观性。对于每对交易，不要关注是成功还是失败，而要关注是对的还是错的： 符合策略的成功交易是对的；更重要的是符合策略的失败交易也是对的 偏离策略的失败交易是错的；更重要的是偏离策略的成功交易也是错的 最后的迷思 尽管我们希望在有限的条件下建立一个科学的模型，从而获得一个正的\"预期收益率\"（该死的银行理财产品？），但是，我们还是将命运交给了未知：那冥冥中的概率。 尽管根据 大数定律 ，随着交易次数的增多，总体结果会越来越接近事先计算出的期望值，但是 中心极限定理 指出，大量独立随机变量的平均数近似正态分布。 就我们有限而短暂的生命来说，我们不可能让交易次数达到无穷，去逼近那个理论中的\"期望值\"，而只能进行有限次数的交易。如果说一套交易策略，由不同的交易者去实践，则每个交易者的最终结果可以看做中心极限定理中的一个样本。 很遗憾，中心极限定理告诉我们，最终结果是近似正态分布的，也就是说：有限次的策略交易，最终的统计结果仍然是一个概率分布——正所谓谋事在人，成事在天。","tags":"量化交易","loc":"http://holbrook.github.io/2013/12/16/trade_system.html"},{"title":"《统计学》读书笔记(9/17:方差分析)","text":"问题的提出 对于一个模型，需要调整其各个因子(factor)，以使模型达到最好的效果。 每个因子的取值是离散的，称为该因子的水平(level) 需要对各个因子的不同水平进行组合实验，才能得出一组最佳的因子水平 如何设置因子的不同水平，以及如何进行组合实验，属于实验设计的范畴，实验设计模型可以说是回归模型的一种。 这里探讨的不是如何设计实验，而是如何对实验的结果进行分析 方差分析概述 方差分析（analysis of variance, ANOVA），分析各个自变量对因变量的影响的一种方法。 自变量包括： 因子——定性变量 协变量（convariate）——定量变量 分析的结果是一个方差分析表 原理： 因变量的值随着自变量的变化而变化 将因变量的变化按照自变量进行分解，每个自变量对因变量的变化有一份贡献 无法用已知因素解释的因变量的变化，看做随机误差的贡献 然后用每一个自变量的贡献与随机误差的贡献进行比较(F检验) 判断出自变量的不同水平/值是否对因变量的变化有显著贡献 最终结果：F检验的一些p-值 只考虑主效应的方差分析 对因变量的影响包括各个因素的主效应(main effect)、交互效应(interaction)和协变量 对于两个自变量（水平分别为3个和4个）的一个模型，如果只考虑主效应，其线性模型为： 其中： i,j分别为两个自变量的各个水平 k为每个(i,j)组合的多个观测值的编号 最后一项为误差项，方差分析中假定误差项是独立的，并且符合正态分布 考虑主效应和交互效应 此时的线性模型增加了交叉项： 考虑协变量 此时的模型变成： 加上了一个自变量x，及其相关系数。","tags":"数据科学","loc":"http://holbrook.github.io/2013/12/11/statistics_intro_9.html"},{"title":"《统计学》读书笔记(8/17:列连表，x&#94;2检验和对数线性模型)","text":"列连表数据 列连表研究2个或以上的变量，每个变量的取值是离散的，取值的总数量称为该变量的\"水平\"。 列连表记录这些变量的各种取值组合出现的次数，以研究这些变量之间的相关性。 比如： 上图记录了一个3x2x2的列连表，三个变量分别为收入（高、中、低）、观点（同意、反对）、性别（男，女）。 软件处理时通常将列连表处理成二维表格，比如： 二维列连表的检验 比如以下的二维列连表： 设定零假设和备选假设： H0:观点和收入不相关<=>H1:相关 检验逻辑: 检验统计量在零假设下有（大样本时）近似的x 2 分布。 当该统计量很大时或p-值很小时，就可以拒绝零假设，认为两个变量相关。 x 2 检验量还可以使用Pearson x&#94;2统计量和似然比（likelihood ratio) x 2 统计量 (公式：略） 高维列联表和(多项分布)对数线性模型 高维列联表的检验和两维类似 但高维列联表可以构造一个(多项分布)对数线性模型(loglinear model)来进行分析。 好处：不仅可以直接进行预测，而且可以增加定量变量作为模型自变量的一部分。 对数线性模型 ln(m ij )= a i + b j + e ij 其中： a i ： 行变量的第i个水平对ln(m ij )的影响 b j ：列变量的第j个水平对ln(m ij )的影响 e ij : 随机误差。 （多项分布）对数线性模型 ln(m ij )= a i + b j + (ab) ij + e ij 增加了交叉效应(ab) ij ，代表第一个变量的第i个水平和第二个变量的第j个水平对ln(m ij )的共同影响 Poisson对数线性模型 很多事件符合Poisson分布，需要使用 Poisson对数线性模型进行分析。 ln(l) = u + a i + b j + gx 其中： u: 常数项 ……","tags":"数据科学","loc":"http://holbrook.github.io/2013/09/05/statistics_intro_8.html"},{"title":"《统计学》读书笔记(7/17:相关和回归分析)","text":"7.1 问题的提出 统计实践的最终目的：发现变量之间的统计关系并帮助决策 变量关系的模型：Y=f(x) 则： Y: 因变量 x: 自变量 建立f的过程成为回归(regression) 回归模型的作用： 对相关性进行定量 根据自变量预测因变量 注意：自变量和因变量不一定有因果关系 7.2 定量变量的相关 确定两个定量变量是否有关系：最简单的办法是散点图 对于相关程度的度量： Pearson相关系数r, 取值区间为 [-1,1]。适合描述线性相关程度 Kendall 相关系数 Spearman秩相关系数 7.3 定量变量的线性回归分析（略） 7.4 自变量中有定性变量的回归 将相关模型表示为分段函数 7.5 Logistic回归 适合因变量为定性变量的相关性分析 7.6 小结","tags":"数据科学","loc":"http://holbrook.github.io/2013/08/05/statistics_intro_7.html"},{"title":"《统计学》读书笔记(6/17:简单统计推断：总体参数的假设检验)","text":"假设检验 证明一件事情比较难，证伪一件事情比较容易 科学研究的一个基本方法就是假设检验： 提出一个可以被推翻的假设； 如果还没有发现不符合该假设的实例，则该假设成为猜想； 如果该猜想能够从理论上推导证明，则该猜想也成为定理/定律 统计学中的假设检验方法也是一样，只不过关注点是统计量之间关系的假设 注意：假设不能被推翻，也仅仅是假设。因为无法证明其能覆盖所有的情况。对于统计学领域尤其如此 6.1 假设检验的过程和逻辑 比如检查商品的份量是否充足：进行抽样后检验。单个商品的称量结果有多有少， 如何判断总体的份量是否足够？仅用样本的平价重量进行评价是不科学的！ 提出假设 首先提出假设，比如总体的平价质量充足（u>=u0），称为零假设（null hypothesis)，记为 H0 同时提出备选假设(alternative hypothesis)，总体的平价质量不充足（u<u0)，记为 H1 命题： H0:u>=u0 <=> H1:u<u0 。其中 <=> 相当于\"versus\" 通常，选择更接近实际情况的假设作为备选假设，相反的作为零假设。检验的目地就是判断H1是否显著。所以假设检验也成为\"显著性检验（significant test）\" 判断逻辑 被检验的统计量成为\"检验统计量（test statistic）\" 根据 H0(注意，不是H1) 得到检验统计量的分布 看看该统计量的数据实现值（realization)是否为小概率事件 如果是小概率事件，则拒绝零假设（检验显著） 该逻辑中，H0和H1的地位不对称：按照H0推导分布，只要不符合就可以推翻H0 判断结果 上面的逻辑并不严谨： 小概率事件也有可能真实发生！ 所以统计结论也有可能犯错误。两种错误情况： 第一类错误（type I error)： 按照H0假设，样本数据为小概率事件，于是拒绝H0。但总体的真实情况是符合H0 第二类错误（type II error）：按照H0假设，样本数据的概率很大，于是接受H0。但总体的真实情况是不符合H0 势(power）和临界值（critical value) （TODO) 6.2 对于正态总体均值的检验 单个总体单个样本：单边检验 两个总体两个样本：双边检验 一个总体一对样本（如事件发生前后的对照）：单边、双边相结合 6.3 对于比例的检验 (略） 6.4 从一个例子说明\"接受零假设\"的说法不妥 结论：不能说\"接受零假设\"，更严谨的说法是\"不拒绝零假设\" 6.5 小结","tags":"数据科学","loc":"http://holbrook.github.io/2013/08/02/statistics_intro_6.html"},{"title":"用Ganglia监控集群的性能","text":"Ganglia简介 对基础设施的监控主要包括三个方面：状态，性能和可用性。通俗的讲就是：是否在干活，干了多少活，还能干多少。 有很多开源的强大工具可以用于监控，比如 Cacti ， Nagios 以及比较新的 Shinken 和 Zabbix 。 这些工具的主要功能是状态监控和报警——就像一个合格的监工，随时掌握基础设施是否在干活，发现谁没干活马上报告。 如果是传统的运维工作，有这些工具就足够强大了。但是对于分布式系统的开发+运维人员（DevOps?），更关心的是掌握分布式系统的性能和可用性，根据数据做出性能调整、升级、扩容等的决策，从而保证基础设施服务能够满足不断增长的业务需求。 Ganglia 就是这样一种工具。Ganglia 是 UC Berkeley 发起的一个开源监视项目，设计用于测量数以千计的节点。Ganglia主要监控集群的性能指标，如cpu 、mem、硬盘利用率， I/O负载、网络流量情况等， 也可以监控自定义的性能指标。通过Ganglia绘制的曲线很容易见到每个节点的工作状态，对合理调整、分配系统资源，提高系统整体性能起到重要作用。 gmond 带来的系统负载非常少，这使得它成为在集群中各台计算机上运行的一段代码，而不会影响用户性能。 Ganglia架构 Ganglia的整体架构如下图所示： 每个被检测的节点或集群运行一个gmond进程，进行监控数据的收集、汇总和发送。gmond即可以作为发送者（收集本机数据），也可以作为接收者（汇总多个节点的数据）。 通常在整个监控体系中只有一个gmetad进程。该进程定期检查所有的gmonds，主动收集数据，并存储在RRD存储引擎中。 ganglia-web是使用php编写的web界面，以图表的方式展现存储在RRD中的数据。通常与gmetad进程运行在一起。 其中， RRDtool (Round Robin Database tool,环状数据库工具)是一组操作RRD数据的API，支持数据图形化。RRD是一种环状数据库技术，只存储固定数量的数据，新的数据会覆盖最旧的数据。 更多信息可以参考 RRDtool简体中文教程 v1.01 。 Ganglia规划 在动手部署Ganglia之前，首先要对监控体系进行初步的规划。主要考虑两方面的问题： 单集群 or 多集群 如果节点较少，使用单集群配置起来更容易； 如果节点很多，使用多集群可以避免广播风暴。但是需要为每个集群配置不同的组播通道（通过端口区分），同时要配置gmetad同时监听这多个通道。 组播模式 or 单播模式 组播模式是ganglia的默认模式，同一集群的多个gmond之间互相交换数据，gmetad中可以指定集群中的任意一个或多个节点作为\"data_source\"； 组播模式可能会带来网络的 \"抖动（Jitter）\"。据说设置节点的时钟同步可以避免抖动的问题； 但如果网络环境不支持组播（比如Amazon's AWS EC2），就需要使用单播模式。单播模式时，将大部分节点的gmond.conf中,global的deaf设置改为\"yes\"，则这些节点只发生数据，不接收其他节点的数据，同样也不能作为gmetad中的\"data_source\"。 单播模式中还需要设置\"send_metadata_interval\"，比如30秒。以强制发送元数据。 ganglia将一个gmetad覆盖的所有集群/节点称为一个grid。可以在/etc/ganglia/gmetad.conf中通过 gridname 指定其名称。多个grid的数据也可以聚合到一个上级gmetad中。 安装和配置 安装 在RHEL/CentOS上如果配置了EPEL源，则安装变得非常简单。用yum可以查到如下软件包： ganglia.i686 : Ganglia Distributed Monitoring System ganglia.x86_64 : Ganglia Distributed Monitoring System ganglia-devel.i686 : Ganglia Library ganglia-devel.x86_64 : Ganglia Library ganglia-gmetad.x86_64 : Ganglia Metadata collection daemon ganglia-gmond.x86_64 : Ganglia Monitoring daemon ganglia-gmond-python.x86_64 : Ganglia Monitor daemon python DSO and metric modules ganglia-web.x86_64 : Ganglia Web Frontend 在不同的节点选择对应的软件包安装即可。 配置防火墙规则 gmond和gmetad之间默认使用UDP的8649端口进行通信，如果配置多个集群，还会有其他端口。要保证这些端口畅通。 配置被监控节点(/etc/ganglia/gmond.conf) 最重要的配置是集群名称(cluster.name)。 如果要配置多个集群，每个集群要使用不同的端口。共三个地方： udp_send_channel.port udp_recv_channel.port tcp_accept_channel.port 配置中心节点(/etc/ganglia/gmetad.conf) 最重要的是配置数据源。比如： data_source \"NginX\" a.a.a.101:8661 a.a.a.102:8661 data_source \"LVS\" b.b.b.101 b.b.b.102 配置web 默认启动httpd服务后，就可以通过 http://IP/ganglia 访问。如果提示权限问题，需要检查： selinux设置 防火墙设置 /etc/httpd/conf.d/ganglia.conf中的 Deny from all 限制 扩展监控功能 Ganglia默认只监控一些通用的性能指标，如果要监控自定义的指标，就需要对Ganglia进行扩展。 插件机制 从Ganglia 3.1开始，可以使用python开发的插件对Ganglia进行扩展。 /etc/ganglia/gmond.conf 配置中通常会包含： include ('/etc/ganglia/conf.d/*.conf') 如果安装了 ganglia-gmond-python 软件包，会创建一个 /etc/ganglia/conf.d/modpython.conf 文件： {% highlight nginx %} modules { module { name = \"python_module\" path = \"modpython.so\" params = \"/usr/lib64/ganglia/python_modules\" } } include ('/etc/ganglia/conf.d/*.pyconf') 这样，就可以用python编写自定义的插件。 Ganglia 在 GitHub 上已经收集了一些 常用的python插件 。 部署NginX插件 在 常用的python插件 中包含了 nginx_status插件 ， 该插件利用 NginX的状态监控功能 获取数据。 在确保nginx_status可以访问的前提下，只需要做如下配置： 将python_modules/目录下的文件复制到gmond节点的 /usr/lib64/ganglia/python_modules 目录。这是执行数据采集的脚本 将conf.d/目录下的文件复制到gmond节点的 /etc/ganglia/conf.d/ 目录。这些文件定义了collection_group以及metric 重启gmond 将graph.d/目录下的文件复制到gmetad节点的 /usr/share/ganglia/graph.d 目录。这些文件定义了如何绘制metric的图形 重启gmetad，在对应的nginx节点详细信息中可以看到nginx metric对应的7个图表。 理解了NginX插件，基本上能够自己开发Ganglia插件了。 TODO：与Nagios结合使用 Nagios提供了很好的报警机制，将Ganglia与Nagios结合使用是常见的方式。","tags":"软件开发","loc":"http://holbrook.github.io/2013/07/30/ganglia.html"},{"title":"keepalived实现双机互备","text":"目标：高可用 \"高可用性\"（High Availability）通常来描述一个系统经过专门的设计，从而减少停工时间，而保持其服务的高度可用性。 通过高可用性设计，可以提高系统的平均无故障时间(MTTF)， 对于重要的系统或系统中重要的节点，必须有高可用性的设计来保证系统的平均无故障时间达到预期的要求。 前面的 NginX负载均衡方案 中就使用了keepalived实现NginX节点的高可用，但那只是高可用性设计中的一种工作方式。 通常来说，高可用设计中多个冗余设备可以采用以下三种工作方式： 主从方式 （非对称方式） 主机工作，备机处于监控准备状况；当主机宕机时，备机接管主机的一切工作，待主机恢复正常后，按使用者的设定以自动或手动方式将服务切换到主机上运行，数据的一致性通过共享存储系统解决。 双机双工方式（互备互援） 两台主机同时运行各自的服务工作且相互监测情况，当任一台主机宕机时，另一台主机立即接管它的一切工作，保证工作实时，应用服务系统的关键数据存放在共享存储系统中。 集群工作方式（多服务器互备方式） 多台主机一起工作，各自运行一个或几个服务，各为服务定义一个或多个备用主机，当某个主机故障时，运行在其上的服务就可以被其它主机接管。 显然，主从方式最简单但存在资源浪费的情况；双工方式可以充分利用资源，但配置较复杂，两个节点之间要进行心跳监测；集群工作方式与双工方式并没有本质的区别，但复杂度急剧增加，除了健康状态要多播外，还需要考虑脑裂、仲裁、法定人数等问题。 本文只讨论双机互备的工作方式。 keepalived简介 keepalived 是 LVS 的扩展项目，最初是为了解决LVS负载调度器的单点故障问题，但由于其适用性较强，配置简洁，也被用在许多其他场合，比如NginX负载均衡的高可用设计。 keepalived的设计如下图： WatchDog：监控checkers和vrrp 进程 Checkers：服务器健康状态检查(healthchecking)。可以编写自定义的健康检查脚本。 VRRP STACK：当健康检查失败（服务不可用）时，在节点见进行切换。使用 VRRP(Virtual Router Redundancy Protocol, 虚拟路由器冗余协议） 的组播实现。 IPVS wrappers：生成ipvs规则。专门为LVS所用。 Netlink Reflector：设定vrpp的vip地址。 keepalived可以在每个节点配置相同的VRRP实例(vrrp_instance)，并指定状态为MASTER或BACKUP。 当Checkers监测到本节点的服务不可用时，使本机的VRRP实例停止工作，并通知另外节点的VRRP STACK接管VRRP实例，从而对外保证服务继续可用。 双机互备方式的实现 keepalived实现主备工作的资料到处都有，我这里也有一个 NginX主备机制的例子 ，这里就不再重复了。 其实，只要稍微动点脑筋，在主备的基础上就可以实现双机互备甚至集群的工作方式。因为有两个前提： keepalived并没有限定节点的个数只能是2个 keepalived没有限定每个节点只能有一个VRRP实例 那么，双机互备的实现原理就是： 在每个节点配置两个VRRP实例 两个实例分别以一个节点为主(MASTER)，另一个节点为备(BACKUP) 通过外部的其他机制，如DNS轮询，使得两个VRRP实例同时对外提供服务 配置实例 keepalived的配置文件（ /etc/keepalived/keepalived.conf )中包含3部分内容： global_defs： 全局配置 vrrp_instance：vrrp实例，用来定义虚拟路由组 virtual_server：定义LVS虚拟服务器 这里面只例举一下vrrp实例的配置。 节点1 {% highlight nginx %} vrrp_instance VI_1 { state MASTER interface eth0 virtual_router_id 51 priority 100 advert_int 1 authentication { auth_type PASS auth_pass password } virtual_ipaddress { 192.168.1.8 } } vrrp_instance VI_2 { state BACKUP interface eth0 virtual_router_id 52 priority 99 advert_int 1 authentication { auth_type PASS auth_pass password } virtual_ipaddress { 192.168.1.9 } } {% endhighlight %} 节点2 {% highlight nginx %} vrrp_instance VI_1 { state BACKUP interface eth0 virtual_router_id 51 priority 99 advert_int 1 authentication { auth_type PASS auth_pass password } virtual_ipaddress { 192.168.1.8 } } vrrp_instance VI_2 { state MASTER interface eth0 virtual_router_id 52 priority 100 advert_int 1 authentication { auth_type PASS auth_pass password } virtual_ipaddress { 192.168.1.9 } } {% endhighlight nginx %}","tags":"软件开发","loc":"http://holbrook.github.io/2013/07/16/ha_keepalived.html"},{"title":"《统计学》读书笔记(5/17:简单统计推断：总体参数的估计)","text":"统计推断(statistical inference)：从数据得到关于现实世界的结论的过程。 由于统计学的研究对象是不可能穷举的大量个体，通常需要通过抽样方法得到样本，再用样本去推断总体的情况， 所以统计推断得出的不是一个精确的结论，而是近似结果。 统计推断的两个重要的方法是： 估计(estimation) 假设检验(hypothesis testing) 本章介绍估计，下一章介绍假设检验 5.1 用估计量估计总体参数 假定分布族 在通过样本信息推断总体情况之前，先假设总体的属性复合某种分布特征（分布族）。比如： 假设身高符合正态分布族 假设对某个观点的认同与否符合二项分布族 这些假设一半是通过经验获得，无法明确的证明。 确定具体分布 一个分布族下面的各种分布只是参数不同，通过研究样本确定这些参数，也就确定了具体分布。 常见的分布参数： 总体均值 总体标准差 成功概率 正态分布由总体均值和标准差两个参数决定； Bernoulli分布由概率一个参数决定 确定参数的过程是一个估计的过程，来源于样本数据。 通过样本计算的各种统计量中，用于估计的统计量称为估计量（estimator)。 估计量随样本的不同具有随机分布；对于给定的样本有一个给定的值，称为估计值(estimate)。 两种估计： 点估计(point estimation)：用一个估计值来近似总体参数 区间估计(interval estimation)：用一个包括估计值在内的区间表示总体参数很可能处于的范围 5.2 点估计 任何统计量都可以作为估计量。 估计量的命名可以来自： 衡量一个估计量的好坏的某个标准 估计量的计算方式 常见的估计量： 样本均值：用于估计总体均值 样本标准差(s)：用于估计总体标准差 成功比例(x/n)：用于估计成功概率p 无偏估计量(unblased estimator)：多个样本产生的估计量的期望等于要估计的总体参数，这样的估计量称为无偏估计量。 上述三种估计量都是无偏估计量。 5.3 区间估计 为了更准确的表达估算量，通常采用点估计和区间估计结合的说法。比如： 估计值+置信区间+置信度 其中： 估计值是对总体量的点估计 置信区间(confidence interval)是以估计值为中心的区间估计，包括上限(upper bound)和下限(lower bound) 置信度（confidence level）是抽取大量样本时，该区间会覆盖样本估计值的比例 5.4 关于置信区间的注意点 置信度描述的是统计量覆盖总体参数的概率，而不是置信区间覆盖总体参数的概率 置信度越低，则置信区间越窄 5.5 小结（略）","tags":"数据科学","loc":"http://holbrook.github.io/2013/07/09/statistics_intro_5.html"},{"title":"Pillar：定义Salt配置管理的数据","text":"为什么需要Pillar 看了 这篇文档 ，你可能已经被Salt State的强大所折服。 是的，Salt State能够解决很多配置管理的问题，但是如下两个场景，如果只用state进行配置就会比较麻烦： 让 apache 配置项适应不同的OS 这个例子 中的apache配置中通过pkg模块验证 apache 软件包是否安装。但是在RedHat系统的yum包管理器和Debian系统的apt包管理器中，apache的包名字分别为 httpd 和 apache2 。如何避免为apache配置项针对不同的包管理器定义不同的state？ 同一个应用在不同环境中的数据库连接 假如你开发了一个Django应用，数据库连接信息在应用的settings.py中定义： {% highlight python %} DATABASES = { 'default': { 'ENGINE': 'django.db.backends.mysql', 'NAME': 'test', 'USER': 'root', 'PASSWORD': 'password', 'HOST': 'localhost', 'PORT': '3306', } } {% endhighlight %} 显然，数据库连接信息在开发环境、测试环境、生成环境中各不相同。如果把该应用作为一个state，如何实现在不同环境中的自动部署？ Salt Pillar就是为了解决类似上述的问题而提供的组件。 Pillar是什么？ 如 这篇文章 所述，Salt Sate定义了配置项以及minion和配置项直接的映射关系；与此类似，Pillar定义了数据以及minion和数据的映射关系。Pillar中定义的数据可以在Salt的其他组件中引用，当然最常见的情况是在State中引用Pillar数据。 比如，在上一节的第一个问题中，我们可以这样定义State: {% highlight yaml %} apache: pkg.installed: - name: {{ pillar['apache'] }} {% endhighlight %} 其中， salt.states.pkg.installed 函数的 name 参数就是引用了Pillar中定义的变量 apache 。 而该变量在Pillar中的定义如下： {% highlight yaml %} { % if grains['os_family'] == 'RedHat' % } apache: httpd { % elif grains['os_family'] == 'Debian' % } apache: apache2 {% endhighlight %} Pillar的配置结构 Pillar与State就像是配置管理的左右手，所以Pillar的配置结构与 State的配置结构 几乎完全一样。 Pillar Tree和Environment 与 State Tree 一样，Salt中可以定义一棵Pillar Tree，并且将Pillar按照环境进行分组管理。 Pillar Tree定义在salt master的配置文件 /etc/salt/master 的 pillar_roots 变量中： {% highlight yaml %} pillar_roots: base: - /srv/pillar ext_pillar: - hiera: /etc/hiera.yaml - cmd_yaml: cat /etc/salt/yaml {% endhighlight %} Pillar定义 Pillar是一组key-value，使用yaml的语法格式。 简单的定义比如： foo : bar 可以使用 { { pillar['foo'] } } 的形式进行引用； 复杂的定义比如： {% highlight yaml %} users: thatch: 1000 shouse: 1001 utahdave: 1002 redbeard: 1003 {% endhighlight %} 可以使用包含jinja语法的yaml进行引用： {% highlight yaml %} { % for user, uid in pillar.get('users', {}).items() % } { {user} }: user.present: - uid: { {uid} } {% endhighlight %} 定义好的pillar数据保存在Pillar Tree下面的某个 sls 文件中。为了能够在State中引用Pillar数据， Pillar的目录结构和文件名需要与State能够对应。 Pillar可以用于任何数据的定义，比如ssh key、证书、密码口令等敏感数据，minion的模块、状态、信息反馈，以及要传递给minion的任何变量的值等等。 这些数据都会以加密通道安全的分发到minion上面。 Pillar的数据不仅仅可以来自SLS文件，还可以从其他数据源获取数据。相关内容可以自行查阅 官方文档 。 minion与Pillar之间的映射 与 minion与state之间的映射 一样， 在Pillar的base目录中也存在一个名为 top.sls 的入口文件，定义minion与Pillar的映射关系，例如： {% highlight yaml %} base: '*': - packages 'alpha': - database {% endhighlight %} 上边的例子定义了packages对所有的minion有效，database只对名字为'alpha'的minion有效. Pillar数据的查询和使用 查询pillar数据 {% highlight yaml %} salt 'client2' pillar.data salt ' ' pillar.data salt ' ' pillar.raw key='roles' 更多的函数可以参考 pillar模块的文档 。 刷新pillar数据 在master上修改Pilla文件后，需要用以下命令刷新minion上的数据（同步到minion）： salt '*' saltutil.refresh_pillar 在其他sls文件中引用数据 Pillar解析后是dict对象，直接使用Python语法，可以用索引（ pillar['pkgs']['apache'] ）或get方法（ pillar.get('users', {}) ）获取到需要的数据。 在Targetting中使用Pillar Targetting中可以用 -I 选项指定用Pillar数据选择minion。 参考资料 《Pillar Walkthrough》 《Pillar of Salt》","tags":"软件开发","loc":"http://holbrook.github.io/2013/07/07/salt_pillar.html"},{"title":"ZeroMQ简介","text":"zeroMQ不是TCP，不是socket，也不是消息队列，而是这些的综合体。 ZeroMQ是什么 ZeroMQ 以嵌入式网络编程库的形式实现了一个并行开发框架（concurrency framework）， 能够提供进程内(inproc)、进程间(IPC)、网络(TCP)和广播方式的消息信道， 并支持扇出(fan-out)、发布-订阅(pub-sub)、任务分发（task distribution）、请求/响应（request-reply）等通信模式。 ZeroMQ的性能足以用来构建集群产品， 其异步I/O模型能够为多核消息系统提供足够的扩展性。 ZeroMQ支持30多种语言的API，可以用于绝大多数操作系统。 在提供这些优秀特性的同时，ZeroMQ是开源的，遵循LGPLv3许可。 ZeroMQ的明确目标是\"成为标准网络协议栈的一部分，之后进入Linux内核\"。 Zero 之禅（The Zen of Zero） ZeroMQ是一个很有个性的项目，其名称也暗合禅意： Ø 是一种权衡：让一些丹麦人恼火，但是\"Ø\"本身也降低了google搜索的命中率以及twitter上的关注度 Ø 暗合\"零代理(broker)\"、\"零延迟\" Ø 的目标是\"零管理、零消耗、零浪费\" Ø 符合简约主义：力量的源泉是降低复杂度，而不是增加新功能 ZeroMQ对socket API的封装 与libevent, ACE等项目不同，使用ZeroMQ时可以不关注网络细节。 ZeroMQ的API提供了对于传统socket API的封装，对于套接字类型、连接处理、帧、甚至路由的底层细节都进行了抽象， 使得一套API可以用于进程内通讯、IPC、TCP和广播等多种消息信道。 ZeroMQ自己定位为\"智能传输层\"（The Intelligent Transport Layer），位于网络层和应用层之间。 ZeroMQ使得构建大型并发应用时，可以将基本单元随意的\"组装\"，由ZeroMQ解决通信的弹性伸缩， ZeroMQ的这种设计大大简化了应用程序消息通信的实现，使得在多种场景下重用相同的交互模式成为可能。 使用ZeroMQ可以让编写高性能网络应用程序极为简单和有趣。 与socket相比，ZeroMQ API的特征如下： 在后台线程中异步地处理IO。后台线程使用无需锁的数据结构与应用线程通信，所以ZeroMQ应用程序不需要锁、信号量，或者其他等待状态。 组件可以动态地加入和退出，ZeroMQ会自动重新连接。这意味着可以以任何次序启动组件。可以创建\"面向服务架构（service-oriented architectures)\"，其中的服务可以在任何时候加入或者退出网络。 在需要的时候自动对消息排队。这种处理是智能的，在排队前会尽量让消息靠近接收者。 有处理队列溢出的方法（\"高水位标记\"）。队列满的时候，ZeroMQ会自动阻塞发送者，或者丢弃消息，取决于你正在使用的消息传递类型（模式）。 ZeroMQ让应用程序可以使用传输端点相互交流：TCP、多播、进程内、进程间。使用不同的传输端点时不用修改代码。 根据消息传递模式的不同，使用不同的策略来安全地处理慢速/阻塞的接收者。 使用请求-应答、发布-订阅等多种模式来路由消息。这些模式定义了如何创建网络拓扑结构。 需要降低互联的各部分间的复杂性的时候，可以在网络中放置模式扩展的\"设备\"（小的代理）。 通过在线路中使用简单的帧，可以精确地传递整个消息。发送10K的消息，则会收到10K的消息。 不对消息格式做任何假定。消息是从零到数G字节的块。需要在高层使用其他产品来表示数据，如Google的Protocol Buffers、XDR等等。 智能地处理网络错误。有时候重试，有时候告诉你操作失败。 降低能耗。使用较少的CPU时间来做更多事情意味着使用更少的能源，而且较老的机器可以使用更长的时间。 ZeroMQ的通信协议 ZeroMQ定义了 ZMTP（ZeroMQ Message Transport Protocol, ZeroMQ消息传输协议） ，在TCP协议之上定义了向后兼容性的规则，可扩展的安全机制，命令和消息分帧，连接元数据，以及其他传输层功能。 相对于其他的消息传输协议/通信协议，ZeroMQ有明显的优势： TCP：ZeroMQ基于消息，使用消息模式而不是字节流。 XMPP：ZeroMQ更简单、快速、更底层。Jabber可建在ØMQ之上。 AMQP：完成相同的工作，ZeroMQ要快100倍，而且不需要代理（规范更简洁——比AMQP的规范文档少278页） IPC：ZeroMQ可以跨主机通信 CORBA：ZeroMQ不会将复杂到恐怖的消息格式强加于你。 RPC：ZeroMQ完全是异步的，你可以随时增加/删除参与者。 RFC 1149 ：ZeroMQ比它快多了！ 29west LBM：ZeroMQ是自由软件！ IBM Low-latency：ZeroMQ是自由软件！ Tibco：ZeroMQ仍然是自由软件！ ZeroMQ不是消息队列 在摩尔定律的魔咒下，\"分布式处理\"逐渐成为主流，随之而来的是关于消息通讯、消息中间件的项目层出不穷。 其中最有名的应该是ZeroMQ和RabbitMQ，Thrift。 RabbitMQ 是符合 AMQP(Advanced Message Queuing Protocol, 高级消息队列协议) 的消息中间件， 而 Thrift 是出自于Facebook的跨语言服务访问的框架。 2011年， 欧洲核子研究组织（CERN） 调查了统一用于操作CERN加速器的中间件解决方案的方式，欧洲核子研究组织的研究比较了 CORBA 、 Ice ， Thrift ， ZeroMQ, YAMI4， RTI 和 Qpid/AMQP ， ZeroMQ得到了最高的分数。 但ZeroMQ最大的特点不在性能，而是机制。尽管名字中包含了\"MQ\"，但ZeroMQ并不是\"消息队列/消息中间件\"。ZeroMQ是一个传输层API库， 更关注消息的传输。与消息队列相比，ZeroMQ有以下一些特点： 1 点对点无中间节点 传统的消息队列都需要一个消息服务器来存储转发消息。而ZeroMQ则放弃了这个模式，把侧重点放在了点对点的消息传输上，并且（试图）做到极致。以为消息服务器最终还是转化为服务器对其他节点的点对点消息传输上。ZeroMQ能缓存消息，但是是在发送端缓存。ZeroMQ里有水位设置的相关接口来控制缓存量。当然，ZeroMQ也支持传统的消息队列（通过zmq_device来实现）。 2 强调消息收发模式 在点对点的消息传输上ZeroMQ将通信的模式做了归纳，比如常见的订阅模式（一个消息发多个客户），分发模式（N个消息平均分给X个客户）等等。下面是目前支持的消息模式配对，任何一方都可以做为服务端。 - PUB and SUB - REQ and REP - REQ and XREP - XREQ and REP - XREQ and XREP - XREQ and XREQ - XREP and XREP - PUSH and PULL - PAIR and PAIR 3 以统一接口支持多种底层通信方式 不管是线程间通信，进程间通信还是跨主机通信，ZeroMQ都使用同一套API进行调用，只需要更改通信协议名称（如，从\"ipc:///xxx\"改为\"tcp:// . . . :****\"）即可。 4 异步，强调性能 ZeroMQ设计之初就是为了高性能的消息发送而服务的，所以其设计追求简洁高效。它发送消息是异步模式，通过单独出一个IO线程来实现，所以消息发送调用之后不要立刻释放相关资源哦，会出错的（以为还没发送完），要把资源释放函数交给ZeroMQ让ZeroMQ发完消息自己释放。 ZeroMQ的应用案例 ZeroMQ如何拯救世界 由于ZeroMQ的强大，我们可以用ZeroMQ搭建出非常强悍的应用。比如： Salt 的底层就使用了ZeroMQ作为通信机制 Mongrel2 是使用ZeroMQ开发的一个Web服务器 Mongrel2是应用ZeroMQ的一个有趣的案例：所有入站消息通过\"Push\"套接字路由到Mongrel2，套接字可以自动实现负载均衡，将消息分发到连接处理器。反过来，连接处理器处理入站消息（通过Pull套接字），然后将处理结果发布到一个\"Pub\"套接字，Mongrel2服务器本身已订阅了该套接字，并且通过主题（topic）过滤器监听该套接字的进程号。如下图： ZeroMQ带来了一种新的分布式应用架构的思考方式。善用ZeroMQ，可以为应用带来非常强大的特性。 参考资料 官方指南 ，这篇巨长的文档不仅介绍了ZeroMQ的主要方面，网络编程，还融入了ZeroMQ作者对于编程的理念，很值得精读 An Introduction to ØMQ (ZeroMQ) ,InfoQ上面对于ZeroMQ的一篇介绍性文章 ZeroMQ社区 ， ZeroMQ：云计算时代最好的通讯库 ZeroMQ 的模式","tags":"并发系统","loc":"http://holbrook.github.io/2013/07/03/zeromq_intro.html"},{"title":"lvs+nginx的负载均衡实验","text":"准备环境 2 LVS(cluster) + 2 NginX （图） 配置 LVS服务器配置 安装软件包 pulse: LVS守护进程 piranha: LVS的web管理工具，包括状态监控和配置 {% highlight bash %} yum install pulse piranha 打开IP转发功能（ip_forward） 在 /etc/sysctl.conf 中设置 net.ipv4.ip_forward = 1 /sbin/sysctl -w net.ipv4.ip_forward=1 或者 echo 1 > /proc/sys/net/ipv4/ip_forward 查看状态： /sbin/sysctl net.ipv4.ip_forward 或者 cat /proc/sys/net/ipv4/ip_forward 配置LVS 配置文件位于 /etc/sysconfig/ha/lvs.cf ，使用piranha可以以图形界面的方式进行配置。 {% highlight bash %} # 设置管理密码 piranha-passwd # 启动piranha服务 /etc/init.d/piranha-gui start {% endhighlight %} 接下来可以用浏览器访问: http://IP_OF_LVS:3636（记得配置LVS上的防火墙，否则只能本机访问）。 点击\"Login\"按钮，使用用户名 piranha 和刚才设置的密码登录，可以看到管理界面： 依次配置全局设置(GLOBAL SETTINGS), 备机设置(REDUNDANCY, 可选)，虚拟服务器(VIRTUAL SERVERS)，即可。 其中虚拟服务器可以配置基本信息(VIRTUAL SERVER)、真实服务器(REAL SERVER)和监控脚本(MONITORING SCRIPTS)。 启动服务 配置完成后，启动lvs服务( /etc/init.d/pulse start )，在监控界面(CONTROL/MONITORING)可以看到\"Daemon\"的状态为\"running\"。 如果要设置pulse为开机自动启动，可以使用命令： /sbin/chkconfig --level35 pulse on 。 RS（Real Server，真实服务器）配置 这里使用nginx作为Real Server，参考 这篇文章 进行最简单的配置，能够看到nginx默认的欢迎界面即可。 RS需要进行一系列的设置才能与LVS协同工作，参考如下脚本： {% highlight bash %} !/bin/bash VIP=VIP_OF_LVS /sbin/ifconfig lo:0 $VIP broadcast $VIP netmask 255.255.255.255 up /sbin/route add -host $VIP dev lo:0 echo \"1\" >/proc/sys/net/ipv4/conf/lo/arp_ignore echo \"2\" >/proc/sys/net/ipv4/conf/lo/arp_announce echo \"1\" >/proc/sys/net/ipv4/conf/all/arp_ignore echo \"2\" >/proc/sys/net/ipv4/conf/all/arp_announce sysctl -p /sbin/service iptables stop {% endhighlight %} 启动LVS服务 LVS和RS都配置好之后，可以启动LVS服务。前面提到，pulse是LVS的守护进程(Daemon)。使用如下的命令启动LVS： /etc/init.d/pulse start 命令行工具：ipvsadm ipvsadm 是LVS的命令行管理工具，可以用于更改运行时状态或更改配置文件。主要功能包括： {% highlight bash %} # 增加/编辑虚拟服务器（VS） ipvsadm -A|E -t|u|f virutal-service-address:port [-s scheduler] [-p [timeout]] [-M netmask] # 删除虚拟服务器 ipvsadm -D -t|u|f virtual-service-address # 清除内核虚拟服务器表中的所有记录。 ipvsadm -C # 放弃内存中的修改，读取配置文件 ipvsadm -R # 将内存中的修改保存为配置文件 ipvsadm -S [-n] # 增加/编辑真实服务器（RS） ipvsadm -a|e -t|u|f service-address:port -r real-server-address:port # 删除真实服务器 ipvsadm -d -t|u|f service-address -r server-address # 显示虚拟服务器表 ipvsadm -L|l [options] # 虚拟服务表计数器清零（清空当前的连接数量等） ipvsadm -Z [-t|u|f service-address] # 设置连接超时值 ipvsadm –set tcp tcpfin udp # 启动守护进程, 可以是master或backup方式 ipvsadm –start-daemon state [--mcast-interface interface] # 停止守护进程 ipvsadm –stop-daemon # 查看帮助 ipvsadm -h {% endhighlight %} 功能验证 检查LVS启动过程： tail -f /var/log/messages ，可以看到虚拟服务启动、连接到各个真实服务器等记录。 将两台真实服务器的nginx欢迎界面（index.html）修改成不同的内容，重复刷新对虚拟服务器的访问，能看到内容变化 使用命令 ipvsadm 检查分流状况 关闭一台nginx, /var/log/messages 中会记录服务器连接失败，此时通过 ipvsadm 检查会发现所有的流量被分流到另一个nginx上面 重新启动刚才关闭的nginx, /var/log/messages 中会记录服务器连接成功，此时通过 ipvsadm 检查会发现恢复了负载分担 lvs+keepalived的故障切换测试（未测试） 性能测试 使用Apache Bench进行简单的性能测试，得出如下结论： 单个nginx的最佳并发：1900，最大并发：2900；使用LVS+2台nginx的最佳并发：3000，最大并发：5900。 说明通过LVS做负载均衡能提高并发能力，但不是线性增加，会有一定的损失。具体数据需要进一步测试。 经过LVS访问nginx比直接访问nginx会增加50毫秒左右的响应时间。 官方的测试数字是：VS/NAT方式达到1112并发，VS/DR或VS/TUN方式可以达到25,000并发。 F5的并发处理能力超过10万，可以保持的连接数能达到几百万。","tags":"软件开发","loc":"http://holbrook.github.io/2013/07/01/lvs_nginx_practice.html"},{"title":"Salt state 配置结构","text":"配置的目标是通过master管理多个mision的状态，最终配置的实现是使用文件夹和文件。而Salt state的设计就是在二者之间建立逻辑关系。 Salt的state配置比较复杂，官方文档也比较零散。初学者不易掌握。但是如果把Salt的state配置看做是编写代码，就很容易掌握其脉络。 下图是Salt state配置结构的逻辑图： 配置的目标是通过master管理多个mision的状态，最终配置的实现是使用文件夹和文件。而Salt state的设计就是在二者之间建立逻辑关系。 StateTree 和 Environment 每个master上面都会建立一棵state树，将各个state的配置分级管理。 这棵树的第一层就是环境（environment)的划分。salt将环境分为base环境和自定义环境。base环境是必须存在的，其他的环境根据自己的需要进行定义。典型的可以划分开发环境(dev), 用户参与测试环境（uat)，生成环境(prod), 备份环境（backup)等等。 Salt约定base环境必须存在，是其他环境的基础，base环境中定义的state可以在各个自定义环境中使用。 显然，每个环境至少需要一个文件夹来保持多个state配置。事实上，Salt允许一个环境使用多个文件夹。 Salt环境与目录的对应关系在salt master的配置文件 /etc/salt/master 的 file_roots 变量中定义。 /etc/salt/master 文件也是使用YAML格式。 一个典型的配置如下： {% highlight yaml %} file_roots: base: - /srv/salt/ dev: - /srv/salt/dev/services - /srv/salt/dev/states prod: - /srv/salt/prod/services - /srv/salt/prod/states state定义 Salt state即可以使用单个的sls文件(single state)，也可以使用一个文件夹并在其中保持多个sls及其他配置文件（multi-state)。 state之间还可以使用require, include, extend等关系进行关联。 minion 与 state之间的映射 一个salt master可以管理多个minion, 也可以定义很多个state。需要在minion和state之间建立一种多对多的映射关系。 Salt在一个 top.sls 文件中定义这种映射关系。比如： {% highlight yaml %} base: ' ': - servers dev: ' nodb*': - mongodb 小结 按环境的不同划分state的存放目录；定义state文件/文件夹并在state之间使用关系实现复用；建立minion和state之间的多对多映射关系。 掌握了这三点，就掌握了Salt state配置的脉络。 实际上，Salt中 Pillar的配置 也使用了类似的结构。","tags":"软件开发","loc":"http://holbrook.github.io/2013/07/01/salt_state_config_structure.html"},{"title":"Salt state实例解析","text":"在Salt的 官方教程 中，以apache和sshd的state配置作为例子。掌握这两个例子，就能够触类旁通，处理日常工作中大部分的配置管理问题。 本文对这两个例子进行详细的分析和注释。 目录结构 文档 中的例子包含了多个文件。这些文件之间互相引用和关联。目录结构及文件清单如下： apache/init.sls apache/httpd.conf ssh/init.sls ssh/server.sls ssh/banner ssh/ssh_config ssh/sshd_config ssh/custom-server.sls 两个配置分别放在了 apache 和 ssh 文件夹。一个Salt状态可以使用单个的SLS文件，或者使用一个文件夹。后者更加灵活方便。 apache/init.sls {% highlight yaml %} apache: pkg: - installed service: - running - watch: - pkg: apache - file: /etc/httpd/conf/httpd.conf - user: apache user.present: - uid: 87 - gid: 87 - home: /var/www/html - shell: /bin/nologin - require: - group: apache group.present: - gid: 87 - require: - pkg: apache /etc/httpd/conf/httpd.conf: file.managed: - source: salt://apache/httpd.conf - user: root - group: root - mode: 644 - template: jinja - context: custom_var: \"override\" - defaults: custom_var: \"default value\" other_var: 123 {% endhighlight %} 说明： sls文件使用 YAML 格式定义，最外面的层级定义配置项。 一个sls文件中可以有多个配置项，配置项的ID可以起任意的名字。本例中包含ID为 apache 和 /etc/httpd/conf/httpd.conf 两个配置项。 配置项内是一系列的状态声明。所有的状态项来自Salt状态模块。即可以使用 Salt内置的状态模块 ，也可以 编写自定义的状态模块 状态声明内部指定状态函数的调用。状态函数是每个Salt状态模块中定义的函数。 apache配置项 pkg模块 ，使用操作系统的包管理器(如yum, apt-get)安装软件包 salt.states.pkg.installed函数 , 验证软件包是否安装以及是否为指定的版本 service模块 管理服务/守护进程(daemon)的启动或停止 salt.states.service.running函数 检查服务是否已经启动 service模块 定义了 salt.states.service.mod_watch 函数，可以使用 watch 要素 监控其他的模块是否满足。这里监控以下情况： apache 软件包(pkg) 是否已安装 /etc/httpd/conf/httpd.conf 文件(file) 是否存在 apache 用户(user) 是否存在 user.present 是简写形式，直接调用 user 模块的 present 函数检查是否存在如下属性的 apache 用户： uid=87 gid=87 home目录为 /var/www/html 登录脚本为 /bin/nologin 检查依赖项： apache 用户组 group.present 是简写形式，直接调用 group 模块的 present 函数检查是否存在如下属性的 apache 用户组： gid=87 检查依赖项： apache 软件包 /etc/httpd/conf/httpd.conf 配置项 file.managed 是简写形式，直接调用 file模块 的 managed方法 根据需要从master获取文件并可能会通过模板系统(templating system)进行渲染。文件要满足如下要求： 使用master上面的apache/httpd.conf文件 user=root group=root mode=644 使用 jinja 模板渲染 上下文变量： custom_var=\"override\" 默认值: custom_var=\"default value\" other_var=123 ssh/init.sls {% highlight yaml %} openssh-client: pkg.installed /etc/ssh/ssh_config: file.managed: - user: root - group: root - mode: 644 - source: salt://ssh/ssh_config - require: - pkg: openssh-client {% endhighlight %} 说明： ssh/server.sls {% highlight yaml %} include: - ssh openssh-server: pkg.installed sshd: service.running: - require: - pkg: openssh-client - pkg: openssh-server - file: /etc/ssh/banner - file: /etc/ssh/sshd_config /etc/ssh/sshd_config: file.managed: - user: root - group: root - mode: 644 - source: salt://ssh/sshd_config - require: - pkg: openssh-server /etc/ssh/banner: file: - managed - user: root - group: root - mode: 644 - source: salt://ssh/banner - require: - pkg: openssh-server {% endhighlight %} 说明： include语句将别的state添加到当前文件中，使得state可以跨文件引用。 使用include相当于把被引用的内容文件添加到自身，可以require、watch或extend被引用的SLS中定义的内容。 这里引用了 ssh state。 openssh-server 配置项 sshd /etc/ssh/sshd_config 配置项 /etc/ssh/banner 配置项 ssh/custom-server.sls {% highlight yaml %} include: - ssh.server extend: /etc/ssh/banner: file: - source: salt://ssh/custom-banner 说明： 引用 ssh state的server配置项 extend 可以复用已有的state，在原来的基础上进行扩展，增加新的配置或修改已有的配置。 将 /etc/ssh/banner 配置项的文件修改为 salt://ssh/custom-banner","tags":"软件开发","loc":"http://holbrook.github.io/2013/06/30/salt_sls_sample.html"},{"title":"salt的主要功能及使用","text":"掌握了这些内容，可以使用Salt极大提高运维的效率（事实上，Salt对于开发阶段也能提供很大的帮助，开发和运维的界限正在逐渐模糊）。 Salt的介绍 中提到了Salt支持变更操作、配置管理、状态监控所需的一些功能，如下图： 本文详细介绍如何使用这些功能。 如果想对Salt的功能和使用有一个初步的了解，最好参考官方文档： Salt Stack Walkthrough 。 批量操作(targeting) 再回顾一下 前文中的例子 : {% highlight bash %} # 测试连通性 salt '*' test.ping # 查询主机运行了多长时间 sudo salt '*' cmd.run \"uptime\" # 批量重启服务 salt '*' cmd.run \"service httpd restart\" # 让多台机器一起，使用Apache Bench进行压力测试 salt '*' cmd.run \"ab -n 10 -c 2 http://www.google.com/\" {% endhighlight %} 上面的例子都是对多个节点进行批量操作：使用通配符\"'*'\"对所有注册的节点进行操作。Salt支持多种方式对节点id(minion id)进行匹配。包括： 默认： 通配符(globbing) E： 正则表达式(Regular Expression) L：列表 N: 分组(group) C：复合匹配 先看一下通配符、正则表达式和列表的例子： {% highlight bash %} # 通配符是最常用的匹配方式。Salt使用 linux风格的通配符 salt ' ' test.ping salt ' .example.net' test.ping salt ' .example. ' test.ping salt 'web?.example.net' test.ping salt 'web[1-5]' test.ping salt 'web-[x-z]' test.ping # 正则表达式可以适应更复杂的情况。使用 python的re模块 进行匹配 salt -E 'web1-(prod|devel)' test.ping # 最直接的方式是自己指定多个minion，即列表 salt -L 'web1,web2,web3' test.ping {% endhighlight %} 复合匹配(Compound matchers) 有点复杂，后续会在其他文章中专门介绍。 分组匹配见本文的下一节。 节点分组（nodegroups） 好吧，批量操作确实很爽。但是每次都输入匹配规则有点麻烦，对于复杂的匹配规则更是如此。 salt的 [nodegroups功能]((http://docs.saltstack.com/topics/targeting/nodegroups.html)可以将常用的匹配规则保存下来（称之为minion的分组）。批量操作是，只需要使用L标记指定要操作的group名字即可。 groups定义在master的配置文件 /etc/salt/master 中。 group 的定义可以使用各种匹配规则，比如： {% highlight bash %} group1: 'L@foo.domain.com, bar.domain.com,baz.domain.com or bl*.domain.com' group2: 'G@os:Debian and foo.domain.com' {% endhighlight %} 同样的，使用复合匹配(Compound matchers)定义group的内容不在本文范围之内。 命令编排（execution） Salt生来就有命令编排的功能。据说，Salt最先实现的是远程执行技术，然后才添加的配置管理功能。Salt使用ZeroMQ来处理命令执行的请求和响应消息，安装配置简单，并且性能非常高。 Salt即可以批量执行命令，也可以单机执行。通常单机执行用于测试： 单机（立即）执行。 使用 salt-call 命令单机执行操作 批量(立即)执行。最常用的操作。使用salt命令，对匹配的minion节点执行操作 Salt可以执行的命令也可以分为两种： 系统命令，使用 cmd.run 执行 Salt模块，将常用的命令/批处理封装到内置的Salt模块(module)，使用 模块名.功能名 的方式执行。 比如： {% highlight bash %} # 执行系统命令 salt '*' cmd.run 'hostname' # 执行Salt模块 salt '*' disk.usage {% endhighlight %} 使用Salt模块的好处是能够做到一致。比如同样是查看磁盘使用情况， salt '*' cmd.run \"df -h\" 只能用于 NIX节点，而 salt '*' disk.usage 对 NIX和Windows都适用，并且采用相同结构返回数据，便于批量处理。 Salt已经内置了 大量的模块 ，这些模块涵盖了日常管理任务的主要任务，包括： 通用的管理任务，比如apt, at, cp, cron, disk, extfs, file, grains, hosts, iptables, mount, network, pam, parted, pkg, ps, selinux, shadow, ssh, test等 针对特定软件的任务，比如apache, cassandra, djangomod, git, mongodb, mysql, nginx, nova, postgres, solr, sqlite3, 和tomcat 而且，自己开发Salt模块也非常简单，很容易将实际管理操作中的一些经验通过自定义的模块固化下来，并方便分享。 在开发和调试模块的时候，可以使用 test=True 参数进行模拟执行(Dry run)。比如： salt 'minion1.example.com' state.highstate -v test=True 节点信息(grains) grains 是Salt内置的一个非常有用的模块。在用salt进行管理客户端的时候或者写state的时候都可以引用grains的变量。 grains的基本使用举例如下： {% highlight bash %} # 查看grains分类 salt '*' grains.ls # 查看grains所有信息 salt '*' grains.items # 查看grains某个信息 salt '*' grains.item osrelease {% endhighlight %} 配置管理（state) 配置管理是Salt中非常重要的内容之一。Salt通过内置的state模块支持配置管理所需的功能。关于这部分内容，官方文档有很详细的描述，可以参考 part 1 ， part 2 和 part 3 。 Salt中可以定义节点的目标状态，称之为state。state对应配置管理中的配置，可以对其进行标识、变更控制、变更识别、状态报告、跟踪和归档以及审计等一些的管理行为。 状态描述 Salt使用SLS文件（SaLt State file）描述状态。SLS使用 YAML 格式进行数据序列化，因此简单明了，可读性也很高。 基本描述(yaml) 下边是一个简单的SLS文件例子: {% highlight yaml %} apache: pkg: - installed service: - running - require: - pkg: apache {% endhighlight %} 该文件描述一个ID为 apache 的配置状态： 软件包（pkg)已经安装 服务应该处于运行中 服务的运行依赖于 apache 软件包的安装 state文件中的所有YAML变量名来自Salt的state模块。 Salt内置了大量的state模块，比如cron, cmd, file, group, host, mount, pkg, service, ssh_auth，user等。 详细清单参考 这里 。 还可以开发自己的state模块。 扩展描述(jinja) state可以使用 jinja 模板引擎进行扩展，其语法可以参考 这里 。 下面是一个更复杂的例子： {% highlight html+jinja %} vim: pkg: { % if grains['os_family'] == 'RedHat' % } - name: vim-enhanced { % elif grains['os'] == 'Debian' % } - name: vim-nox { % elif grains['os'] == 'Ubuntu' % } - name: vim-nox { % endif % } - installed {% endhighlight %} 该state增加了判断逻辑：如果是redhard系列的就安装 vim-enhanced，如果系统是Debian或者Ubuntu就安装vim-nox。 逻辑关系 state之间可以有 逻辑关系 。常见的关系举例如下： require：依赖某个state，在运行此state前，先运行依赖的state，依赖可以有多个 {% highlight yaml %} httpd: pkg: - installed file.managed: - name: /etc/httpd/conf/httpd.conf - source: salt://httpd/httpd.conf - require: - pkg: httpd watch：在某个state变化时运行此模块 {% highlight yaml %} redis: pkg: - latest file.managed: - source: salt://redis/redis.conf - name: /etc/redis.conf - require: - pkg: redis service.running: - enable: True - watch: - file: /etc/redis.conf - pkg: redis watch除具备require功能外，还增了关注状态的功能 order：优先级比require和watch低，有order指定的state比没有order指定的优先级高 {% highlight yaml %} vim: pkg.installed: - order: 1 想让某个state最后一个运行，可以用last 保存状态 状态描述文件(SLS)要保存在master节点中，并通过指令分发到minion节点。 路径设置 Salt master的配置文件( /etc/salt/master )中可以通过 file_roots 参数指定状态文件的保存路径。可以为不同的环境（如开发环境、UAT环境、生产环境、灾备环境等）分别指定路径，如下所示： {% highlight yaml %} file_roots: base: - /srv/salt/ dev: - /srv/salt/dev/services - /srv/salt/dev/states prod: - /srv/salt/prod/services - /srv/salt/prod/states {% endhighlight %} 其中,base环境是必须的。 入口文件 file_roots 中必须指定\"base\"环境的路径，因为该路径中存在Salt state的 入口文件: top.sls 。 Top文件建立配置环境、节点和状态配置之间的映射关系。比如一个简单的top.sls文件： {% highlight yaml %} base: ' ': - servers dev: ' nodb*': - mongodb {% endhighlight %} 该文件指定了： - 所有节点使用base环境的servers配置 - nodb 节点使用dev环境的mongodb配置 结合第一部分的file_roots配置，该top配置意味存在以下的配置文件： /srv/salt/servers.sls /srv/salt/dev/mongodb.sls 注：这里也可以使用文件夹 /srv/salt/servers/ 和 /srv/salt/dev/mongodb/ ，在文件夹中放置一组状态文件和配置文件，便于建立复杂的状态配置。 top.sls中的可配置内容非常丰富，具体内容可以参考 官方文档 。 状态生效（State Enforcement） master上对状态进行定义，最终这些状态要传递到minion节点上。在本节的例子中，如果定义好了状态文件 /srv/salt/dev/mongodb.sls ： {% highlight yaml %} mongodb: pkg: - installed {% endhighlight %} 可以使用命令 salt \"minion1\" state.highstate -v 使得所有针对\"minion1\"的state生效； 在执行状态之前先进行测试是个好主意，需要指定参数 test=True 。比如， salt \"minion1\" state.highstate -v test=True 。 关于state模块的更多用法，可以参考 state模块说明 ，或 官方文档 。 更多 Salt的state模块的功能不仅如此，还可以使用模板和变量，以及定义状态的定时自动生效。 小结 本文介绍Salt的主要功能和基本使用，包括minion节点的管理，批量操作，以及非常重要的配置管理。 掌握了这些内容，可以使用Salt极大提高运维的效率（事实上，Salt对于开发阶段也能提供很大的帮助，开发和运维的界限正在逐渐模糊）。 后续会介绍一些使用案例以及Salt的高级功能。","tags":"软件开发","loc":"http://holbrook.github.io/2013/06/25/salt_usage.html"},{"title":"用salt管理成千上万的服务器","text":"引言：一个\"非专职运维人员\"的烦恼 加入到某证券公司的IT部门，尽管所在的部门挂了一个\"研发部\"的名字，但是我发现有大概40%的时间是在做运维工作。 这来自两种情况： 自主开发的应用，需要持续的改进，不断的更新、发布、部署、调整配置，这不是运维部门喜欢的状态。 软件商提供的\"产品\"无法满足运维部门的要求：无法通过简单的 Q&A 文档保证系统的正常运行，经常需要有一定技术能力的人员解决系统运行过程中各种稀奇古怪的问题。 这种情况下只能自己做一个\"非专职运维人员\"，需要频繁的登录各种服务器，执行一些命令来查看状态或者更改配置（包括配置文件的变更和软件包的安装部署）。很多操作都是不断的重复，日复一日，让人厌烦。 \"重复的工作应该交给程序去做\"，所以我自己写过一些脚本。为了避免将脚本上传到几十台服务器并且不时进行更改，我使用 Fabric 来进行服务器的批量操作。 尽管避免了\"批量的人工操作\"，但我还是在进行\"人工的批量操作\"。远远没有实现自动管理。将有限的生命解放出来，投入到更有意义的编码工作是一个奔四程序员应有的追求，所以我又睁大红肿的眼睛，迷茫的搜索这个世界。 我发现了 Puppet ， Chef 和 CFEngine ，但是并不满意。直到我发现了 Salt ,我的眼前一亮：这正是我所需要的东西。 如果说Salt有什么独特之处打动了我，那就是： 简单：可能是源于python的简约精神，Salt的安装配置和使用简单到了令人发指的地步。任何稍有经验的linux使用者可以在10分钟之内搭建一个测试环境并跑通一个例子（相比之下，puppet可能需要30--60分钟）。 高性能：Salt使用大名鼎鼎的 ZeroMQ 作为通讯协议，性能极高。可以在数秒钟之内完成数据的传递 可伸缩：基于 ZeroMQ 通信，具备很强的扩展性；可以进行分级管理，能够管理分布在广域网的上万台服务器。 尽管 twitter 、 豆瓣 、 oracle 、等著名网站的运维团队都在使用puppet，但是我相信，他们切换到salt只是一个时间问题。毕竟不是所有的人都喜欢操纵傀儡(puppet)，但是谁又能离开盐(salt)呢？ 关于Salt和Puppet的对比，可以参考 这里 ，或者看看 中文版 。 Salt快速入门 Salt的体系结构中将节点区分为: master, minion, syndic。 master: 老大，管理端 minion: 马仔，被管理端 syndic: 头目，对于老大来说是马仔，对于马仔来说是老大 在入门阶段，先不考虑syndic。 安装配置 如果将操作系统区分为： *NIX Linux Solaris HP Unix FreeBSD OS X windows 理论上来说，Salt可以安装在任何*NIX系统上，包括master和minion。除了 源代码 之外， 还可以通过Salt提供的 安装脚本 ，或者 PyPI 进行安装。 对于Linux，尤其是企业环境中常用的RHEL,CentOS,Ubuntu，可以通过包管理器非常容易的安装master 和/或 minion。 比如: yum(需要先配置 EPEL ), apt(需要增加 http://debian.madduck.net/repo/ 库)，yaourt，ports。 Mac OS X 先使用HomeBrew解决依赖包： brew install swig zmq ，然后用PyPI安装： pip install salt 。 对于windows，只能安装minion（windows只适合做马仔）。从 官方网站 下载合适的安装包。安装过程中可以指定master地址和本机名称。 安装后需要自己启动Salt服务。配置文件在C:\\salt\\conf\\minion。 具体的各操作系统下的安装可以参考 官方文档 。这里为了简单，只考虑常用的RHEL/CentOS 和 windows。 在下面的例子中，使用一台RHEL/CentOS作为master， 另外一台RHEL/CentOS和一台windows 2003 Server作为 minion。 安装管理端(master) {% highlight bash %} # 安装EPEL,注意选择合适的版本 rpm -ivh http://mirrors.sohu.com/fedora-epel/6/x86_64/epel-release-6-8.noarch.rpm yum update # 安装master yum install salt-master # 修改配置 vim /etc/salt/master # 最基本的设定服务端监听的IP(比如使用VIP做master的高可用时)： # interface: 服务端监听IP # 其他配置参考 官方文档 # 启动服务(以下命令等效) salt-master -d /etc/init.d/salt-master start service salt-master start {% endhighlight %} 安装被管理端(minion) {% highlight bash %} # 安装EPEL,注意选择合适的版本 rpm -ivh http://mirrors.sohu.com/fedora-epel/6/x86_64/epel-release-6-8.noarch.rpm yum update # 安装minion yum install salt-minion # 修改配置 vim /etc/salt/minion # 最基本的设定是指定master地址，以及本机标识符： # master: master的主机名或IP地址 # id: 本机标识符 # 其他配置参考 官方文档 # 启动服务(以下命令等效) salt-minion -d /etc/init.d/salt-minion start service salt-minion start {% endhighlight %} 接受minion的托管请求 minion向master投诚后，还需要master接受才行。这个过程叫做\"授信\"。 Salt底层使用公钥-私钥证书来保证通信信道的安全。具体的机制可以参考ZeroMQ的相关内容。Salt已经屏蔽了底层的细节，只需要使用封装好的命令： {% highlight bash %} # 在master上运行 # 查看所有minion salt-key -L Accepted Keys: windows bond_app_server_main mac_os_vm salt-master Unaccepted Keys: minion1 minion2 Rejected Keys: #其中Unaccepted Keys是未许可的minion。可以使用下面的命令通过认证： salt-key -a minion1 {% endhighlight %} 测试 安装配置好之后，首先要测试一下联通性： salt '*' test.ping 。salt会列出每个认证过的minion的联通状态(true 或 false)。 再举一些例子： {% highlight bash %} # 查询主机运行了多长时间 sudo salt '*' cmd.run \"uptime\" # 批量重启服务 salt '*' cmd.run \"service httpd restart\" # 让多台机器一起，使用Apache Bench进行压力测试 salt '*' cmd.run \"ab -n 10 -c 2 http://www.google.com/\" {% endhighlight %} 注意，默认情况下master和minion之间使用以下端口进行通信： 4505(publish_port): salt的消息发布系统 4506(ret_port):salt客户端与服务端通信的端口 网络的设置需要保证这些端口可以访问。 Salt的强大功能 上面的例子都是用Salt进行批量操作。但是Salt的功能不仅如此。 认真分析一下我的\"非专职运维工作\"的内容，发现可以分为以下三个方面： 变更操作：根据需要对节点中某个资源的某种状态进行调整，并检验变更的结果 配置管理：让上述行为变得\"可管理\"，支持\"有关人士\"对上述行为的标记、控制、识别、报告、跟踪和归档甚至审批和审计 状态监控：随时掌握状态，发现异常。尽量在系统用户发现问题之前解决麻烦 Salt对上述三个方面提供了完美的支持，事实上，Salt提供的功能比我需要的还要多。下图是Salt的主要功能： 具体的功能使用在 这篇文章 中详细说明。 Salt的网络资源 网站 salt官方网站 ， 中国SaltStack用户组(CSSUG)网站 Into The Salt Mine,关于Salt的各种安装、配置、使用的博客 代码 saltstack将代码托管在github上 ,包括： salt主工程 salt-bootstrap，一个快速安装Salt的脚本 salt states参考配置 ，大量用于监控目标主机状态的配置文件，可以直接使用 Salt Cloud ,使得Salt支持各种云服务(Amazon EC2, HP Cloud, OpenStack,Parallels等)的扩展 salty-vagrant , 用Salt管理 Vagrant虚拟环境 的扩展 salt-api ，基于Salt进行二次开发的包 salt-ui , 一个图形界面 pepper , Stand-alone CLI tools that mimic Salt's CLI tools but proxy Salt commands through salt-api salt-contrib , Salt Module Contributions sublime-text , Salt-related syntax highlighting and snippets for Sublime Text formulae , salt-vim , Vim files for editing Salt files salt-ci , Salt-CI — Salt Continuous Integration salt-genesis , salt-qa , saltstack_org , salt-windows-install , 中国SaltStack用户组在github上托管的代码 ，包括： salt的一个分支 , 其目标是实现中心库和配置管理功能。 salt的web管理界面 ，基于Django。","tags":"软件开发","loc":"http://holbrook.github.io/2013/06/24/salt_intro.html"},{"title":"《统计学》读书笔记(4/17:机会的度量：概率和分布)","text":"@ 豆瓣 概率：0--1之间的一个数目，表示事情发生的可能性/经常性。 得到概率的几种途径 利用等可能事件 在机会均等的情况下，概率 = 要计算概率的情况的组合数 / 全部可能情况的组合数 根据长期相对频率 如果出现的机会不等，而且未知，可以用观测数据估计概率， 此时 概率 = 观测到的发生次数k / 重复实验的次数n 只适用于可以重复实验的情况 主观概率 不可计算、不可实验的、主要取决于主观因素的一次性事件，其发生的概率称为主观概率。 概率的运算 事件相当于集合 概率的运算可以从集合运算的角度考虑 互补事件的概率 互补事件/互余事件/对立事件：相当于补集的概念。互补事件的概率之和为1 优势/赔率：两个互补事件概率的比值 概率的加法 两个不可能发生的事件，发生其中之一的概率，等于两个事件概率之和，相当于并集的概念 概率的乘法 两个事件同时发生的概率，等于两个事件概率之积，相当于交集的概念 仅当两个事件独立时才成立。如果不独立，需要引入条件概率 概率的分布 概率-变量值 的函数称为概率分布。可以用图或公式表示。 概率分布与总体/样本空间相关 离散随机变量的分布 对于变量的每一个离散的值，对应着一个概率。全部概率的和为1 这样的关系称为该离散随机变量的概率分布 二项分布 最简单的离散分布，变量只能有两个值（如硬币的正反面），两个事件互补 TODO: 更详细的说明 多项分布 二项分布的扩展 泊松(Poisson)分布 衡量某种事件在一定期间内出现的次数的概率 超几何分布 研究有限总体的不放回抽样（检查样品后不放回，避免重复检查） 比如抽取样品进行质检 TODO: 公式和理解 连续随机变量的分布 与离散变量的分布相对 表现为概率密度函数。所有区间概率的积分为1 正态分布/高斯分布 一个对称的钟形曲线，最高点对应均值 TODO: 更多的变量和参数 x&#94;2-分布/卡方分布 n个独立标准正态变量的平方和，称为有n个自由度的x&#94;2-分布 t-分布/学生分布 正态分布的变换 TODO：图形 F-分布 两个独立x&#94;2-分布变量的比，称为F-分布变量 F-分布有两个自由度 TODO: 图形 均匀分布/矩形分布 最简单的连续型分布，取值范围是一个区间。形状是一个矩形 累积分布函数 为了便于计算某个区间的概率，对概率函数进行积分后得到的函数 抽样分布、中心极限定理 抽样分布：样本的统计量（均值、中位数、标准差等）随着样本的不同也是随机的，其分布称为抽样分布 抽样分布的特征可以帮助判断抽样是否合理 用小概率事件进行判断 如果对某种（统计）结论进行验证，可以抽取一定的样本进行检验，并得出一个概率。 如果该结果与事先的结论不符，可以根据事先结论计算得到实验结果的概率。 如果得到实验结果的概率非常低，可以认为结论不正确。","tags":"数据科学","loc":"http://holbrook.github.io/2013/06/07/statistics_intro_4.html"},{"title":"《统计学》读书笔记(3/17:数据的描述)","text":"第3章 数据的描述 2013-05-31: 1st 数据难以一目了然，但数据的特征容易掌握（如：定性or定量，变量的个数，收集目的等） 借助图表和一些运算有利于掌握更多关于数据的特征 数据的特征反映了总体的特征 数据特征的图形表示 定量变量的图形表示 直方图 表达数据分布的疏密。纵坐标可以是数量或百分比 如：人数-年龄，人数-财富值。 盒形图 指标(最大值,上四分位数,中位数,下四分位数,最小值)-> 条件，表达指标的多个特征在某种条件下的分布形态 茎叶图 既表达形状，又包含数据 散点图 用于比较成对的数值。散点图通常用于比较跨类别的聚合数据 定性变量（属性变量，分类变量）的图形表示 饼图 条形图 数据的概括 用汇总/概括统计量来描述定量变量 统计量：summary statistic 样本的随机性决定了统计量的随机性 样本统计量 vs 总体统计量 可以用样本统计量估计总体统计量 可以用样本统计量来检验对总体的假设 概括数据通常使用以下统计量 数据的位置 均值容易受单个样本偏差 or 少数极端值的影响，但位置不会 中位数比均值稳健(robust) 中位数，上下四分位数， alpha= k百分位数(k-pecentile)：有k% 的观测值小于alpha, alpha称为alpha分位数(quantile) 众数(mode)：样本中出现最多的数目。 使用得较少 数据的尺度 描述数据的分布是否均匀 尺度统计量描述数据集中与分散的程度或变化（散度统计量） 数据越分散，尺度统计量的值越大 极差(range), 最大、最小值之差 如，盒形图中盒子的高度(有时为宽度)表示四分位间距(interquantile range) 标准差，方差 标准差是方差的平方根 单峰值数据的分布(1delta=68%, 2delta=95%)，多峰值数据的分布。。。 同一总体，多个不同样本的均值的标准差称为标准误差(standand error) 数据的标准得分 如，两个水平接近的班级，两个老师进行评分。由于评分标准不同，两个班成绩的均值和标准差都不一样。 如何放在一起评价？ 方法：数据标准化——可以理解为对盒形图的缩放和位移 标准得分是比较常用的一种标准化方法： 标准得分z = (得分-样本均值)/样本标准差","tags":"数据科学","loc":"http://holbrook.github.io/2013/05/31/statistics_intro_3.html"},{"title":"Jekyll建站过程","text":"早在2012年8月，就通过 这篇文章 知道了Jekyll, 但是一直没有去尝试。 直到最近静下心来，才发现使用Jekyll 搭建博客非常简单。当然，上手简单，想用好并不容易。 本文记录在使用Jekyll搭建博客过程中的一些过程和经验，并持续完善和改进。 本文分成3个部分： 基础篇：最简单、最快速的使用Jekyll 进阶篇：一些个性化定制的选项 推广篇：博客推广的一些手段和方法 基础篇 关于Jekyll 已经有太多的文章介绍了 Jekyll (/'dʒiːk əl/)。 简单的说，Jekyll是用ruby语言实现的一个静态网站生成器，可以将 Markdown (或者 Textile )编辑的文档生成html。 当然也可以用来生成博客。 我使用Markdown标记语言，其语法可以参考 这里 。 Jekyll支持 Liquid 模板语言，写文档时的感觉很像是在写Django模板。Jekyll定义了一些 内置的变量 ，包括全局变量、页面变量等。 在文档中可以设置页面变量的值 。 与RoR类似，Jekyll也可以通过插件来增加额外的功能。 关于github Pages github 是程序员的facebook。 github Pages 是github提供的静态网页托管。可以为用户或者项目创建站点。 有意思的是，github Pages对于上传的静态文件会通过Jekyll进行处理后再发布出来。 于是，一些\"不务正业\"的程序员就开始使用github Pages建立博客，现在这股风潮已经愈演愈烈，一些程序员聚集的博客站点可能要小心应对了。 使用github Pages写博客的好处 为什么说\"一些程序员聚集的博客站点可能要小心应对了\"呢？ 因为github Pages简直是为程序员量身定制的博客系统。 （当然，估计也只有程序员会愿意折腾这些事情）。 对我来说，使用github Pages写博客的好处主要体现在以下方面： 1. 自由，随意定制 2. 方便，在github上托管 3. 可控，有版本管理 4. 直接，只需提交，不需要先导出再提交，让人愿意持续更新文章 5. 高效，使用markdown语言能提高写作的效率（但是个人觉得不如org-mode) 6. 免费，无限流量，无限空间 关于Jekyll Bootstrap jekyll-bootstrap 是用Jekyll建立博客的一套模板，提供了主题（themes)、评论、。。等功能， 对于Jekyll的初学者能提供很大的帮助，其网站上号称\"基于GitHub Pages建博客的最快方式\"，可以\"用3分钟就建立一个博客\"。 3分钟建立博客 让我们看看上述工具的组合如何用3分钟建立博客。假设你已经有git的基础，在github上托管过项目。并且使用的不是windows。 # 检查ruby版本 ruby -v #更换更快的gem源，可选 gem sources --remove http://rubygems.org/ gem sources -a http://ruby.taobao.org/ gem sources -l #如果不是1.9.3+，需要升级到1.9.3 bash < <(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer ) source ~/.bashrc rvm install 1.9.3 # 安装jekyll, 并使用rdiscount作为markdown解析器 sudo gem install jekyll gem install rdiscount # 使用Jekyll-Bootstrap，其实就是一个复制的过程。下面的USERNAME代表你在github上的用户名 git clone https://github.com/plusjade/jekyll-bootstrap.git USERNAME.github.com # 使用GitHub Pages的账户主页建立博客，必须使用如下形式的项目名称并使用主分支 # 如果使用项目主页，必须使用项目的gh-pages分支 cd USERNAME.github.com git remote set-url origin git@github.com:USERNAME/USERNAME.github.com.git git push origin master 好了，等上几分钟，你的主页就发布在了https://USERNAME.github.com。 其他操作 jekyll命令 安装jekyll会产生一个命令行工具：jekyll，提供以下功能： build Build your site doctor Search site and print specific deprecation warnings help Display global or [ command ] help documentation . import Import your old blog to Jekyll new Creates a new Jekyll site scaffold in PATH serve Serve your site locally Rakefile Jekyll-Bootstrap提供了一个Rakefile（ruby的makefile），包含一些博客相关的任务（task），包括： $ rake -T rake page # Create a new page. rake post # Begin a new post in ./_posts rake preview # Launch preview environment rake theme:install # Install theme rake theme:package # Package theme rake theme:switch # Switch between Jekyll-bootstrap themes. 进阶篇 放弃Jekyll bootstrap Jekyll bootstrap确实能带来一些变量，但是和RoR一样，充满了各种puzzle。 更加让中国人不爽的是，作者将其缩写定义为\"JB\"。 经过初步的尝试后，我决定放弃JB，也不想尝试 Octopress 。我的选择是用原生的Jekyll来构建博客，让一切都在掌控之中。 Jekyll的目录结构 使用Jekyll创建一个干净的站点： $ jekyll new clearly $ tree clearly/ clearly/ ├── _config.yml ├── _layouts │ ├── default.html │ └── post.html ├── _posts │ └── 2013-05-29-welcome-to-jekyll.markdown ├── css │ ├── main.css │ └── syntax.css └── index.html 其中，博客文章放在_posts目录中，可以使用子目录。 博客文章必须使用 YEAR-MONTH-DAY-title.MARKUP 的形式命名，比如： 2011-12-31-new-years-eve-is-awesome.md _layouts目录存放页面模板，其他还可以使用html、css、image等静态资源。 Jekyll会把任何不以下划线开头的文件和目录都复制/生成到网站（在本地是生成到_site/目录)。 设计模板 jekyll把_layouts目录中的文档看做是模板，如果某个文档中的头部变量声明中指定了layout： --- layout: post ... --- 则Jekyll在生成页面时会使用该模板进行渲染，用文档的内容替换模板中的{{ content }}部分。 模板本身也是文档，所以一个模板也可以用layout变量指定使用一个模板作为布局，这就是模板的继承。 此外，在设计模板时，利用好Liquid语言的include语法能够带来很大的变量。被包含的页面部件需要放在_includes文件夹中。 因为Jekyll生成的是静态站点，可能会需要大量的js以增加动态特性，在设计模板时要遵循 Unobtrusive JavaScript原则 。 灵活的导航 使用静态的导航菜单会带来两个问题： 文档过长 \"当前项\"的高亮不好处理 可以在_config.yml中设置一个导航菜单的变量： {% highlight yaml %} menuitems: - name: 首页 url: /index.html - name: 分类 url: /categories.html - name: 标签 url: /tags.html - name: 归档 url: /archive.html - name: 读书 url: /reading.html - name: 工作 url: /working.html - name: 关于 url: /about.html 然后在模板的导航部分可以这样写： <ul class= \"nav\" > {/% for item in site.menuitems %/} {/% if item.url == page.url %/} <li class= \"active\" > {/% else %/} <li> {/% endif %/} <a href= \" {{ item.url }} \" > {{ item.name }} </a> </li> {/% endfor %/} </ul> 分类、标签、归档和RSS 这些都是博客站点必须有的元素。分类、标签和归档可以安装不同的方式检索博客文章；RSS可以订阅博客。 用Jekyll的变量和模板很容易实现这些元素。 注意：不管文件的扩展名是md、html还是xml、txt，只要文件的头部包含变量声明，Jekyll的模板引擎就会对其进行处理。 其中md和html文件都会处理为html，其他类型会保持扩展名。 但如果不是写文档，最好不要使用md，否则会按照markdown语法进行渲染，带来一些意想不到的麻烦。 具体的例子可以参考JB中的代码。 你可能需要对每个分类、每个标签建立单独的索引页面，这个活手工做比较麻烦，可以使用Jekyll插件或者自己写脚本生成文件， 但这不符合\"KISS\"原则，这里不进行探讨。 对于标签云(tag cloud)，在不使用插件的情况下，可以使用js实现，参考如下代码： {% highlight html %} {/% for tag in site.tags %/} {/{ tag[0] }/} {/% endfor %/} <script type= \"text/javascript\" > $(function() { var minFont = 15.0, maxFont = 40.0, diffFont = maxFont - minFont, size = 0; {/% assign max = 1.0 %/} {/% for tag in site.tags %/} {/% if tag[1].size > max %/} {/% assign max = tag[1].size %/} {/% endif %/} {/% endfor %/} {/% for tag in site.tags %/} size = (Math.log( {{ tag [ 1 ] .size }} ) / Math.log( {{ max }} )) * diffFont + minFont; $(\"# {{ forloop .index }} \").css(\"font-size\", size + \"px\"); {/% endfor %/} }); </script> {% endhighlight %} 关于分类和标签的设计，可以参考 这篇文章 分页 TODO: ajax分页 TODO: 浮动标题 on paginator 语法高亮 对于程序员，博客中难免会包含一些代码。实现代码高亮可以有几种方法： 利用外部资源，比如 GitHub Gist 简单，但是需要使用外部链接或通过js嵌入到页面，不利于文档和代码的统一维护 使用js在前端渲染，比如 google-code-prettify 简单高效，对语言的支持不够多 使用Jekyll插件，比如调用 pygments 推荐方式。支持 100多种语言 。 ~~~本站采取js的方式。只需要在post的模板中进行配置，就可以为所有博文的代码进行渲染~~~ ~~~Jekyll在编译markdown时，会将符合\"代码格式\"的内容放到一个< pre>< code> code>< /pre>标签中。~~~ ~~~而prettify提供的js会对html中的所有< pre>< /pre>或< code> code>区块进行处理，甚至会自动判断使用的语言。~~~ ~~~在post模板的合适位置中增加以下内容：~~~ {% highlight html %} $(document).ready(function(){ prettyPrint(); }); ~~~如果要更改配色方案，只需要修改css文件。~~~ 本站采用pygments的方式： 安装pygments {% highlight bash %} pip install pygments {% endhighlight %} 在_config.yml中设置 {% highlight yaml %} pygments: true {% endhighlight %} 在代码的前后增加过滤器： {% highlight ruby linenos %} {/% highlight ruby linenos %/} def foo puts 'foo' end {% endhighlight %} 更改样式 从 这里 获取css样例，并自行更改。 文档目录(TODO) 如果写比较长的文章，提供一个类似于developerworks上的文档目录进行导航可以方便阅读。 使用公式 MathJax is an open source JavaScript display engine for mathematics that works in all modern browsers. 使用maruku来解析markdown文件，可以把LaTeX解析成图片， 优点是网页加载速度快。但是在windows下安装复杂，且需要安装有LaTeX Mathjax http://www.mathjax.org/ ，缺点是动态加载，速度慢。 参考：http://chen.yanping.me/cn/blog/2012/03/10/octopress-with-latex/ 处理图片 设置一个IMAGE_ROOT变量，可以可以在post中设置，也可以在post的模板中通过指定的规则capture（或者assign）。 则引可以使用{{page.IMAGE_ROOT}}/xxx.png的形式插入图片，便于以后的调整和管理。 {{page.url}} page_url 处理表格(TODO) 博客搬家（TODO） 用Jekyll写博客的，通常不会是新博主，会存在博客搬家的需求。 Jekyll提供了一个import的子命令(需要插件jekyll-import），可以将旧的博客导入到Jekyll。 exitwp 是一个用python开发的工具，号称是将wordpress的博客导出并转换成markdown，但实际上 任何能导出rss/atom的博客都可以用这个工具进行转换。 git clone https://github.com/thomasf/exitwp sudo pip install --upgrade -r pip_requirements.txt cd exitwp/wordpress-xml/ wget http://your/atom/file/xml cd .. python exitwp.py 推广篇 使用域名 Github Pages会为站点分配类似\"USERNAME.github.com\"的二级域名。你也可以使用自己的域名。 申请域名 免费的域名(.tk)可以在 DotTK 申请。 .tk是南太平洋岛国托克劳的国家域名，支持域名转发（可隐藏原URL）、电邮转发、A记录解析、CNAME别名记录、MX邮件记录、设置DNS服务器等服务。 收费的域名到处有，是否使用国内的域名商随你。 域名解析服务 一般来说域名提供商会提供简单的解析服务，也支持将解析服务指向到其他的提供者。 国外的如 Godaddy ，可能被墙。 国内的如 DNSPod ，有免费版。 配置 在jekyll站点中增加CNAME文件，记录使用的域名 如果使用顶级域名，在域名解析服务提供商那里将A记录指向 204.232.175.78 如果使用二级域名，在域名解析服务提供商那里增加CNAME记录，指向 204.232.175.78 社会化网络 Jekyll生成的是静态网站，诸如评论、推荐、关注之类的功能就无法实现了。 不过好在现在有很多社会化网络应用，通过混搭(marshup) 可以把各种各样第三方的功能部件（widgets）加到你的博客中。 与博客相关的Widget主要有几类： 社会化评论 专门提供评论功能的网站，可以为博客增加评论功能。也可能附带着关注、相关文章、推荐等功能。 国外的有 disqus ，国内的有 友言 ， 多说 社会化推荐 自动推荐跨站的相关文章。包括自动推相关文章。 国内的有 友荐 ， 无觅 。 Jekyll本身也可以实现站内文章推荐的功能。 社会化分享 将自己喜欢的网址分享给别人，通常附带推荐功能。 国内的有 加网 ， 百度分享 等。其中加网提供了划词分享功能。 社交网站 可以发布简短的动态。比如Twitter, Facebook, Google Plus, 新浪微博等网站。与博客的联动可以是自己发布博客动态， 也可以是由别人推荐（这种方式即为社会化推荐）。 如果是自己发布动态，需要让别人能够方便的\"关注/Follow\"你，最好提供\"一键关注的按钮\"，或者提供连接能够让别人在这些网上方便的找到你。 社会化登录 没懂，感觉也就是OpenID或OAuth的集合。暂时不予考虑。 由于存在着伟大的墙，我只好尽量选择国内的社会化网络资源。对于更喜欢的国外的资源，尽量考虑如何不拖慢墙内用户的访问速度。 我对社会化网络资源的利用方式如下： 评论功能 只选一个，我选择了 友言 。 推荐功能 可以有多个，那么先加上友荐和无觅，Jekyll自带的相关文章功能也在测试中。 分享功能 只选一个，还是选择 百度分享 吧，与 百度统计 可以勾搭在一起，而且据说有利于百度的SEO。 流量分析和统计 第三方的流量分析和统计工具可以说是最古老的marshup，尽管没有社会化网络的功能。 可以选择的有国外的 Google Analysis 、 SiteMeter 和国内的 百度统计 、 量子恒道统计 等。 出于种种无奈，还是选择了百度。","tags":"极限写作","loc":"http://holbrook.github.io/2013/05/27/2013-05-27-jekyll_mysite.html"},{"title":"用nginX+keepalived实现高可用的负载均衡","text":"前面的 《统一web访问层方案》 中就目的、目标和整体方案进行了讨论，本文讨论具体的实施。简单来说就是在两台服务器上分别部署NginX，并通过keepalived实现高可用。 1 规划和准备 需要统一访问的应用系统： 应用系统 域名/虚拟目录 应用服务器及URL svn dev.mycompany.com/svn http://50.1.1.21/svn svn web管理 dev.mycompany.com/submin http://50.1.1.21/submin 网站 www.mycompany.com http://50.1.1.10; http://50.1.1.11; http://50.1.1.12 OA oa.mycompany.com http://50.1.1.13:8080; http://50.1.1.14:8080 web访问服务器 用两台接入服务器50.1.1.3/4分别作为主、备(MASTER、BACKUP)服务器，使用RHEL5.6x64，配置了yum 私服。 两台接入服务器公用一个虚拟IP（VIP）：50.1.1.2 2 安装 两台接入服务器分别安装NginX和keepalived: #准备依赖包： yum -y install gcc pcre-devel zlib-devel openssl-devel #下载 wget http://nginx.org/download/nginx-1.2.4.tar.gz wget http://www.keepalived.org/software/keepalived-1.2.7.tar.gz #安装NginX tar zxvf nginx-1.2.4.tar.gz cd nginx-1.2.4 ./configure make && make install #安装keepalived tar zxvf keepalived-1.2.7.tar.gz cd keepalived-1.2.7 ./configure make make install cp /usr/local/etc/rc.d/init.d/keepalived /etc/rc.d/init.d/ cp /usr/local/etc/sysconfig/keepalived /etc/sysconfig/ mkdir /etc/keepalived cp /usr/local/etc/keepalived/keepalived.conf /etc/keepalived/ cp /usr/local/sbin/keepalived /usr/sbin/ #加入启动 echo \"/usr/local/nginx/sbin/nginx\" >> /etc/rc.local echo \"/etc/init.d/keepalived start\" >> /etc/rc.local 3 配置 3.1 配置NginX 两台接入服务器的NginX的配置完全一样,主要是配置/usr/local/nginx/conf/nginx.conf的http。其中多域名指向是通过虚拟主机（配置http下面的server）实现；同一域名的不同虚拟目录通过每个server下面的不同location实现；到后端的服务器在http下面配置upstream,然后在server或location中通过proxypass引用。要实现前面规划的接入方式，http的配置如下： {% highlight c %} http { include mime.types; default_type application/octet-stream; sendfile on ; upstream dev .hysec.com { server 50 . 1 . 1 . 21 : 80 ; } upstream www .hysec.com { ip_hash ; server 50 . 1 . 1 . 10 : 80 ; server 50 . 1 . 1 . 11 : 80 ; server 50 . 1 . 1 . 12 : 80 ; } upstream oa .hysec.com { ip_hash ; server 50 . 1 . 1 . 13 : 8080 ; server 50 . 1 . 1 . 14 : 8080 ; server { listen 80 ; server_name dev . hysec . com ; location / svn { proxy_pass http :// dev . hysec . com ; } location / submin { proxy_pass http :// dev . hysec . com ; } } server { listen 80 ; server_name www . hysec . com ; location / { proxy_pass http :// www . hysec . com ; } server { listen 80 ; server_name oa . hysec . com ; location / { proxy_pass http :// oa . hysec . com ; } } {% endhighlight %} 验证方法： 首先用IP访问前表中各个应用服务器的url，再用域名和路径访问前表中各个应用系统的域名/虚拟路径 3.2 配置keepalived 按照上面的安装方法，keepalived的配置文件在/etc/keepalived/keepalived.conf。主、从服务器的配置相关联但有所不同。如下： Master配置 {% highlight c %} ! Configuration File for keepalived global_defs { notification_email { wanghaikuo@hysec.com wanghaikuo@gmail.com } notification_email_from wanghaikuo@hysec.com smtp_server smtp.hysec.com smtp_connect_timeout 30 router_id nginx_master } vrrp_instance VI_1 { state MASTER interface eth0 virtual_router_id 51 priority 101 advert_int 1 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 50.1.1.2 } } {% endhighlight %} Backup配置 {% highlight c %} ! Configuration File for keepalived global_defs { notification_email { wanghaikuo@hysec.com wanghaikuo@gmail.com } notification_email_from wanghaikuo@hysec.com smtp_server smtp.hysec.com smtp_connect_timeout 30 router_id nginx_backup } vrrp_instance VI_1 { state BACKUP interface eth0 virtual_router_id 51 priority 99 advert_int 1 authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 50.1.1.2 } } {% endhighlight %} 验证： 先后在主、从服务器上启动keepalived: /etc/init.d/keepalived start 在主服务器上查看是否已经绑定了虚拟IP： ip addr 停止主服务器上的keepalived: /etc/init.d/keepalived stop 然后在从服务器上查看是否已经绑定了虚拟IP 启动主服务器上的keepalived，看看主服务器能否重新接管虚拟IP 3.3 让keepalived监控NginX的状态 经过前面的配置，如果主服务器的keepalived停止服务，从服务器会自动接管VIP对外服务；一旦主服务器的keepalived恢复，会重新接管VIP。 但这并不是我们需要的，我们需要的是当NginX停止服务的时候能够自动切换。 keepalived支持配置监控脚本，我们可以通过脚本监控NginX的状态，如果状态不正常则进行一系列的操作，最终仍不能恢复NginX则杀掉keepalived，使得从服务器能够接管服务。 如何监控NginX的状态 最简单的做法是监控NginX进程，更靠谱的做法是检查NginX端口，最靠谱的做法是检查多个url能否获取到页面。 如何尝试恢复服务 如果发现NginX不正常，重启之。等待3秒再次校验，仍然失败则不再尝试。 根据上述策略很容易写出监控脚本。这里使用nmap检查nginx端口来判断nginx的状态，记得要首先安装nmap。监控脚本如下: {% highlight bash %} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 #!/bin/sh # check nginx server status NGINX = /usr/local/nginx/sbin/nginx PORT = 80 nmap localhost -p $PORT | grep \" $PORT /tcp open\" #echo $? if [ $? -ne 0 ] ; then $NGINX -s stop $NGINX sleep 3 nmap localhost -p $PORT | grep \" $PORT /tcp open\" [ $? -ne 0 ] && /etc/init.d/keepalived stop fi {% endhighlight %} 不要忘了设置脚本的执行权限，否则不起作用。 假设上述脚本放在/opt/chk_nginx.sh，则keepalived.conf中增加如下配置： vrrp_script chk_http_port { script \"/opt/chk_nginx.sh\" interval 2 weight 2 } track_script { chk_http_port } {% endhighlight %} 更进一步，为了避免启动keepalived之前没有启动nginx , 可以在/etc/init.d/keepalived的start中首先启动nginx: start() { /usr/local/nginx/sbin/nginx sleep 3 echo -n $\"Starting $prog : \" daemon keepalived ${ KEEPALIVED_OPTIONS } RETVAL=$? echo [ $RETVAL -eq 0 ] && touch /var/lock/subsys/ $prog } {% endhighlight %} 4 还可以做什么 对于简单重复性劳动，人总是容易犯错，这种事情最好交给机器去做。 比如，在这个案例中，作为统一接入服务器，可能经常要修改nginx的配置、nginx下面的html文件等。而且，一定要保证集群中的每台服务器的配置相同。 最好的做法是由配置管理服务器来管理，如果没有，也可以使用简单的linux文件同步来解决。 5 支持https 需要安装openSSL： yum install openssl-devel 在nginx/conf下生成秘钥： {% highlight bash %} #生成RSA密钥 openssl dsaparam -rand -genkey -out myRSA.key 1024 #生成CA密钥：(要输入一个自己记得的密码) openssl gendsa -des3 -out cert.key myRSA.key #用这个CA密钥来创建证书，需要上一步创建的密码 openssl req -new -x509 -days 365 -key cert.key -out cert.pem #把证书设置为root专用 chmod 700 cert.* #生成免密码文件 openssl rsa -in cert.key -out cert.key.unsecure {% endhighlight %} 如果要启用SSL，首先在安装nginx是要增加配置参数：--with-http_ssl_module ， 然后在nginx中进行如下配置： {% highlight c %} # 这里是SSL的相关配置 server { listen 443; server_name www.example.com; # 你自己的域名 root /home/www; ssl on; ssl_certificate cert.perm; #使用.unsecure文件可以在nginx启动时不输入密码 ssl_certificate_key cert.key.unsecure; location / { #... } } 公共证书的申请过程： 生成RSA(私钥)文件： openssl genrsa -des3 -out myRSA.key 2048 生成csr文件： openssl req -new -key myRSA.key -out my.csr 将csr提交给证书机构，比如GlobalSign。 证书机构会返回私有证书(crt)和中级证书（crt） 到机构网站下载根证书（root_CA.cer), 将根证书拼接到私有证书之后 在nginx中配置证书： {% highlight c %} ssl_certificate /etc/ssl/my.crt; ssl_certificate_key /etc/ssl/myRSA.key; ssl_client_certificate /etc/ssl/root_CA.cer; {% endhighlight %} 6 支持webservice 通过chunkin-nginx-module模块支持webservice。 否则会报错：411：http 头中缺少 Conten-Length 参数 步骤： {% highlight bash %} git clone https://github.com/agentzh/chunkin-nginx-module.git #重新编译nginx cd PATH/TO/NGINX/SOURCE ./configure xxx --add-module=/PATH/TO/chunkin-nginx-module make && make install {% endhighlight %} 在nginx的server{}节点中增加配置： chunkin on; error_page 411 = @my_411_error; location @my_411_error { chunkin_resume; } {% endhighlight %} 7 状态监控 编译时需要增加 --with-http_stub_status_module 参数。 查看编译参数：使用命令 /usr/local/nginx/sbin/nginx -V 安装好之后增加配置： location /nginx_status { stub_status on; access_log off; # deny all; allow all; } {% endhighlight %} 重新加载配置后，会看到一些文本： Active connections: 1 （对后端发起的活动连接数） server accepts handled requests 5 5 5 （处理连接个数，成功握手次数，处理请求数） Reading: 0 Writing: 1 Waiting: 0 （读取客户端header数，返回客户端header数，等待数即active-reading-writing）","tags":"软件开发","loc":"http://holbrook.github.io/2013/05/27/nginx_keepalived.html"},{"title":"重拾vim","text":"以前在 博客园 时，用 emacs org-mode 写博客，并且写了一系列 《emacs 学习笔记》 。 emacs 和 org-mode 的强大毋庸置疑，但是经过1年多的使用，还是有些不适应： 小手指很受伤。 过于依赖配置。 由于我的工作要经常登录到linux服务器进行操作，这就带来了一个问题： 服务器上的emacs在不配置的情况下几乎无法使用，但是在服务器上使用vim，又不符合手指中记忆的快捷键。 emacs有点重，比如不得不使用的ecb,cedet,jdee等等，都是大块头。 我还没有做好准备去掌握Erlang语言。但是对于vim，我可以使用我喜欢的python去写插件。 经过艰难的取舍，还是决定在个人工作领域也回到vim。保护手指，保护大脑。 插件管理器(Vundle) 重新关注vim后，首先发现了一系列插件管理器。主要有： Vundle vim-addon-manager pathogen.vim vvundle vvimana 经过简单的比较，我选择了Vundle。这里不想对上述插件管理器做一个完整的对比，只是简单说一个我看中的Vundle的特点： 只需要维护需要的插件列表就可以统一安装，同样，复制环境时也只需要复制一个文件(.vimrc) 支持git更新 支持插件搜索功能 自动管理插件依赖关系 安装Vundle 安装Vundle只需要一条命令： $ git clone https://github.com/gmarik/vundle.git ~/.vim/bundle/vundle 如果你使用git管理vim配置，还可以使用git submodule： git submodule add https://github.com/gmarik/vundle.git vim/bundle/vundle 会在.gitmodule中增加如下配置： [submodule \"vim/bundle/vundle\"] path = vim/bundle/vundle url = https://github.com/gmarik/vundle.git 之后运行git命令： git submodule init git submodule update 即可。 配置插件 在.vimrc中配置需要的插件，作者给出了一个例子： set nocompatible \" be iMproved filetype off \" required! set rtp+=~/.vim/bundle/vundle/ call vundle#rc() \" let Vundle manage Vundle \" required! Bundle 'gmarik/vundle' \" My Bundles here: \" \" original repos on github Bundle 'tpope/vim-fugitive' Bundle 'Lokaltog/vim-easymotion' Bundle 'rstacruz/sparkup', {'rtp': 'vim/'} Bundle 'tpope/vim-rails.git' \" vim-scripts repos Bundle 'L9' Bundle 'FuzzyFinder' \" non github repos Bundle 'git://git.wincent.com/command-t.git' \" ... 注意： 对于重名的Vim插件，需要在插件后面加上作者的姓氏， 比如 Bundle 'Javascript-Indentation' 对于插件名称中包含空格和斜杠的情况， 需要将空格和斜杠替换为 - 安装插件 只需要在启动vim后，运行命令： :BundleInstall Vbundle就会自动安装或更新前面配置好的插件 其他操作 使用帮助： :h vundle 查看插件清单： :BundleList 搜索插件： :BundleSearch markdown 清理不用的插件： :BundleClean #或者 :BundleClean markdown 必备插件（TODO） 下面是我使用的一些vim插件，直接在.vimrc中配置。可以在 github 查看。 编辑器增强 NERDTree （Bundle 'The-NERD-tree'）可以在窗口左侧打开文件浏览器 Bundle 'vim-orgmode' Bundle 'winmanager' Bundle 'SuperTab' 语法高亮 Markdown（Bundle 'Markdown'） markdown文件的语法高亮 vim基本操作 以前整理过一个 vim 常用命令备忘 , 如下： vim_cheet_sheet.xlsx 别人的一个更详细的版本： vi-vim-cheat-sheet-list 如果已经有一定的基础，还可以使用vim cheat sheet。下面的图分别可以用于打印版或者桌面背景。","tags":"极限写作","loc":"http://holbrook.github.io/2013/05/23/vim_addon_manager.html"},{"title":"《统计学》读书笔记(2/17:数据的收集)","text":"第2章 数据的收集 2013-05-19: 1st 获取数据 一手数据vs二手数据——自己调研的or别人公布的 观测数据 vs 试验数据——是否可控 个体、总体和样本 单个对象：个体element, individual, unit 所有要研究的个体的集合：总体（有限总体）population 被研究的个体的集合：该总体的一个样本sample 抽样方法： 简单随机抽样：每个个体有同等机会被选到样本——随机样本random sample 样本量sample size 随机样本的产生：使用随机数（random number) 方便样本：比如。。。 收集数据时的误差 样本的特征（比如男女比例）不一定和总体完全一样，这叫抽样误差（sampling error) 调查问卷不一定被回答，这叫未响应误差（nonresponse error) 回答不一定真实，这叫响应误差（response error) 抽样误差不可避免 未响应误差和响应误差应该尽量避免 抽样调查和一些常用的方法 抽样调查的设计目的是确保样本对总体的代表性，以保证后续推断的可靠性 抽样方法可以分为概率抽样方法和非概率抽样方法 概率抽样假定每个个体出现在样本中的概率是已知的，从而能够对数据进行合理的统计推断； 非概率抽样方法比较省时省力，但是推断时要慎重：依赖于抽样方案的设计和实施， 这种推断无法根据漂亮的统计理论来进行，也很难客观建立抽样误差的范围。 简单随机样本（全部随机抽样）很难实施，通常会采用局部随机抽样。下面是一些抽样方法： 概率抽样方法 系统抽样： 根据样本量确定距离n； 为每个单元编号； 随机选取一个开始点； 安装n等距抽样。 如果编号是随机的，则等价于简单随机抽样。 分层抽样 对样本进行分类； 在各类中简单随机抽样； 对结果进行汇总。 可以按照比例，也可以不安装比例，也可以加权（加权系数的和为1） 整群抽样 把总体划分成若干群cluster, 群中的个体不相似； 随机抽取几个群； 单级整群抽样：调查抽取的整个群；两级整群抽样：对随机抽取的群再进行简单随机抽样 适用于各群差异不大的情况，主要用于区域抽样。 多级抽样 多层次分群，在最后一级进行调查 每级的抽样方法可能不同，整个抽样计划可能比较复杂 非概率抽样方法 目的抽样 主观选择对象，样本的多少依赖于预先就有的知识 方便抽样 随意选取（不具有随机性），用于初期的评估或探索性研究 判断抽样 主观评判选择样本，是方便抽样的延伸 定额抽样 非概率的分层抽样。先确定分类和比例，然后对各类进行方便抽样或判断抽样 雪球抽样 对于样本稀少的情况，依赖于一个目标推荐另一个目标，偏差较大 自我选择 让个体自愿参加调查 实际的抽样方法可能是各种抽样方法的组合。考虑精确度的同时，考虑方便性、可行性、经济性 计算机中常用的数据形式: 原始数据 汇总表格（不能还原成原始数据） 小结 数据总是从一个总体中抽取出来的，是总体的一个代表，称为样本 数据是否可控分为观测数据和试验数据 数据来源可以分为一手数据和二手数据 数据科恩能够有抽样误差（不可避免），对于响应/非响应误差要尽量避免 样本的抽取有多种方法 抽取样本、收集数据是为了从样本中得到总体的信息，关系到后续分析和推断的结果是否合理","tags":"数据科学","loc":"http://holbrook.github.io/2013/05/19/statistics_intro_2.html"},{"title":"《统计学》读书笔记(1/17:一些基本概念)","text":"@ 豆瓣 统计是什么 统计是人类思维的一个归纳过程： 从现实世界中收集数据 分析收集到的数据 从分析结果得出结论 关于统计的一个例子如下： 站在一个路口，看到每过去20辆小轿车时，也有100辆自行车通过，同时记录每辆车上的人数（收集） 平均每10个轿车载有12个人，每辆自行车上只有1人（分析） 所以，小汽车和自行车在这个路口的运载能力为24:100（结论） 统计学是什么 统计学（statistics），是用以收集数据，分析数据和由数据得出结论的一组概念、原则和方法。 主要内容包括： 如何有效的收集数据 如果数据和指标的关系缺乏模型，如何用统计方法建立模型 如何评价数据的有效性 如何得出结论 如何利用数据和模型进行预测 如何用图形化的方式表现统计结论 其中，统计模型是从数据产生的，会根据新的数据不断改进，最终会被新的模型（可能不是统计模型）所代替。 统计学的一些特点： 统计学的思维方式是归纳为主，而不是演绎为主 统计学是应用学科，是为具体目标服务的，不形成自己的数学体系 统计学可以应用到大量的学科 有些学科已经形成了与统计学结合的分支学科，如经济计量学(econometrics)，数据挖掘(Data Mining)等。 由于统计学的应用性和交叉性，统计学需要一些其他学科的基础，包括： 各种可能用到的数学 计算机 其他领域的知识 下面列举一些可以用统计学解决的问题： 当你买了一台电视时，被告知三年内可以免费保修。你想过厂家凭什么这样说吗？说多了，厂家会损失；说少了，会失去竞争，也是损失。到底这个保修期是怎样决定的呢？ 大学排名是一个非常敏感的问题。不同的机构得出不同的结果；各自都说自己是客观、公正和有道理的。到底如何理解这些不同的结果呢？ 任何公司都有一个信用问题。当然，在这些公司试图得到贷款时并没有不还贷的不良记录。如何根据它们的财务和商业资料来判断一个公司的信用等级呢？ 我国东部和西部的概念是一个比较笼统的概念。如何能够根据需要，选择一些指标来把各省，或各市县甚至村进行分类呢？ 疾病传播时，如何能够通过感染者入院前后的各种因素得到一个疾病传染方式的模型呢？ 如何通过大众调查来得到性别、年龄、职业、收入等各种因素与公众对某项事物（比如商品或政策）的态度的关系呢？ 一个从来没有研究过红楼梦的统计学家如何根据比较写作习惯得出红楼梦从哪一段开始就不是曹雪芹的手笔了呢？ 如何才能够客观地得到某个电视节目的收视率，以确定广告的价格是否合理呢？ 如何确定观众/听众是否忠实于某节目？ 如何对电视节目排名次？ 什么因素影响一个节目的收视率？ 如何按照各种不同环境估计某商店的顾客人数？ 如何按照各种指标评价雇员？ 如何把地区(市县镇等)按照各种指标分类？ 如何确定红楼梦第几回不是曹雪芹所写？ 如何确定一个产品的可靠性？ 如何进行偏差较少的民意调查？ 如何根据一些财务数据发现漏税的嫌疑单位? 随机性和规律性，概率和机会 自然科学的很多领域有确定性，但其他的领域存在着随机性（randomness），比如吸烟与寿命的关系。 随机性与很多不易说清的因素有关。 对于一些现象，虽然个体存在随机性，但是总体却可能存在规律性——统计规律。 这种总体性的规律体现为概率（probability)，描述某件事情发生的机会有多大。 有些概率是精确的，比如掷骰子时每个点数出现的概率都是1/6。 有些概率无法精确推断,比如你周末去公园的概率是8成。 从随机性的个体现象推导出规律性的统计结论，就是统计学存在的意义。 统计结果/统计结论是否有效？ 统计学可以从个体现象（数据）得到结论。但是结论是否有效？ 依靠统计学的部门很有可能闹笑话，比如xx局和xx局。那么，该如何评价统计的结果或者结论？ 这里面需要注意几点： 数据可以有误或作假 统计方法（有意或无意）使用不当可以误导。有低级误导和高级误导。 常识判断和直觉是重要的 下面是一些统计结论，可以思考一些如何理解这些结论的含义： \"明天降水概率为40％\" \"我冬天去新加坡度假的概率为10％\" \"该节目收视率是30%\" \"调查结果表明20%的观众喜欢某节目\" \"抽样调查结果的误差为±3%\" \"支持率的95％置信区间为(25%,30%)\" \"某学校排名第一\" \"某县是贫困县\" \"某国的综合竞争力排名第43位\" \"该国家属于发展中国家\" \"该药品疗效99%\" \"该国贫富差距大\" \"这个县收入比那个县高\" \"该结果统计显著\" \"消费价格指数为120%\" \"他的血压已经正常了\" 统计学描述问题的方法：常量，变量和数据 统计学将研究的对象分为总体，样本和个体。 总体，样本和个体都有其属性。 对于确定的属性，称为常量(constant)；对于不确定性的属性，称为变量(variable)。 比如： 一节火车车厢有多少坐位是一个常量；车厢中旅客的人数是一个变量 一个学校的在校男女生比例是一个常量；该校任意一群学生的男女生比例是一个变量 变量根据是否为数值类型可以区分为定量变量（数据变量，随机变量）和定性变量（属性变量，分类变量） 定量变量的值是数值类型，比如身高身高体重，购买某商品的人数等等。由于定量变量的值是随机的，所以又称为随机变量。 定性变量的值是非数值类型，比如性别，观点等。定性变量描述对象的属性，用于表达对象的类别，也叫做属性变量或分类变量。 为了便于用模型描述定性变量，通常将定性变量抽象为离散的值。类似于枚举类型。 数据：就是关于变量的每个实例的实际值/观测值。 通常能获得一部分数据，是对于真实情况的不完全的观测。 统计学的方法可以根据这些不完全的观测推断出全体的规律性。比如掷骰子的实验： 常量：骰子有6个面 分类变量：奇数，偶数 数据：掷1000次骰子的实际点数 分析：奇数次数493，偶数次数507 结论：？？？ 变量之间的关系 通常，单个的变量没有意义，人们更加关心变量之间的关系。比如，职业种类与收入是否有关系？政府投入与经济增长是否有关系？ 除了上述二元关系，还有复杂的多变量关系，如企业的固定资产、流动资产、预算分配、管理模式、生产率、债务和利润。 如同本文开始所说，有些关系可以明确确定，有些关系只能依靠统计学作出推断。 定量变量间的关系 比如，一组广告投入和销售额之间的数据，做成二维点图（散点图）： 通常对于变量之间的关系会研究以下问题： 这两个变量是否有关系？（相关性） 如果有，它们的关系是否显著？ 这些关系是什么关系，能否用数学模型来描述？ 这个关系是否带有普遍性？（是否只对此样本有效？——需要收集更多数据） 这个关系是不是因果关系？（需要排除其他因素的影响才能判断） 因果关系是对变量关系的深入分析 不是因果关系也可以用来作为推断的依据 比如，中西医对疾病的因果关系的理解不同 但是从统计结果上来看，中西医都具有疗效 按照变量类型的不同，变量之间的关系可以分为： 定量变量间的关系 定性变量间的关系 定性定量变量间的混合关系 常用的统计软件 统计学涉及到大量数据的计算，离不开统计软件的支持（在应用计算机之前，主要通过查表的方式得到计算结果）。常用的统计软件如下： R 这是一个免费的，由志愿者管理的软件。其编程语言与S-plus所基于的S语言一样，很方便。还有不断加入的各个方向统计学家编写的统计软件包。同时从网上可以不断更新和增加有关的软件包和程序。这是发展最快的软件，受到世界上统计师生的欢迎。是用户量增加最快的统计软件。对于一般非统计工作者来说，主要问题是它没有\"傻瓜化\"。 S-plus 这是统计学家喜爱的软件。不仅由于其功能齐全，而且由于其强大的编程功能，使得研究人员可以编制自己的程序来实现自己的理论和方法。它也在进行\"傻瓜化\"以争取顾客。但仍然以编程方便为顾客所青睐。 SPSS 这是一个很受欢迎的统计软件；它容易操作，输出漂亮，功能齐全，价格合理。对于非统计工作者是很好的选择。 Excel 严格说来并不是统计软件，但作为数据表格软件，必然有一定统计计算功能。而且凡是有Microsoft Office的计算机，基本上都装有Excel。但要注意，有时在装Office时没有装数据分析的功能，那就必须装了才行。当然，画图功能是都具备的。对于简单分析，Excel还算方便，但随着问题的深入，Excel就不那么\"傻瓜\"，需要使用函数，甚至根本没有相应的方法了。多数专门一些的统计推断问题还需要其他专门的统计软件来处理。 SAS 这是功能非常齐全的软件；尽管价格不菲，许多公司还是因为其功能众多和某些美国政府机构认可而使用。尽管现在已经尽量\"傻瓜化\"，仍然需要一定的训练才可以进入。对于基本统计课程则不那么方便。 Minitab 这个软件是很方便的功能强大而又齐全的软件，也已经\"傻瓜化\"，在我国用的不如SPSS与SAS那么普遍。 Statistica 也是功能强大而齐全的\"傻瓜化\"的软件，在我国用的也不如SAS与SPSS那么普遍。 Eviews 这是一个主要处理回归和时间序列的软件。 GAUSS 这是一个很好用的统计软件，许多搞经济的喜欢它。主要也是编程功能强大。目前在我国使用的人不多。 FORTRAN 这是应用于各个领域的历史很长的非常优秀的编程软件，功能强大，也有一定的统计软件包。计算速度比这里介绍的都快得多。但需要编程和编译。操作不那么容易。 MATLAB 这也是应用于各个领域的以编程为主的软件，在工程上应用广泛。编程类似于S和R。但是统计方法不多。","tags":"数据科学","loc":"http://holbrook.github.io/2013/05/12/statistics_intro_1.html"},{"title":"技术分析的理论体系","text":"价值投资和趋势投资 投资的终极目的就是获利；为了获利，就要找出价格变化的一些规律； 通过不同的手段发现价格规律，就形成了不同的投资策略。 策略的不同，体现了投资者看待市场角度的不同。 大体来说，证券市场的投资策略主要有两种： 价值投资。分析证券的内在价值，当证券的价格与内在价值发生偏离（高估或低估）时，就产生了投资机会。 趋势投资。预测价格的变化趋势，当证券的价格变化具有明显趋势时，就产生了投资机会。 一度以来，人们认为价值投资比较容易量化，操作稳健，是投资的正统，其他的都是旁门左道。 比如《有价证券分析》的作者本杰明·格雷厄姆就说过：\"投资是基于详尽的分析，本金的安全和满意回报有保证的操作。不符合这一标准的操作就是投机。\" 但个人认为，价值投资和趋势投资（或者说投资和投机）并没有本质的区别： 所谓的价值投资，也是对趋势的一种预测。价值投资认为从长期来看，股票价格的趋势是向\"内在价值\"回归。 价值投资也存在假设，价值投资的前提和假设是：股票价格围绕\"内在价值 \"的稳固基点上下波动。该假设并没有被明确的证明。 价值投资并不容易量化。尽管价值投资认为内在价值可以用一定的、量化的方法来测定，但是信息获取的范围、来源、准确性、时效不同，以及分析方法的不同，会导致完全不同的估值结果。 价值投资也不能保证本金的安全和满意的回报。 虽然价值投资和趋势投资并没有本质的不同，但是两种方法有各自适用的场合。 对于机构投资者等大资金的投资者，每次操作（买入或卖出）都会产生较大的成本，需要一段时间周期才能完成。这就决定了大资金投资者通常不会频繁操作，而且 需要\"先知先觉\"，在趋势明显确定之前就开始操作以保证能够在合适的时点完成操作，对于这种较长期的投资，更倾向于价值投资； 而对于散户，收集信息非常困难并明显滞后，但是资金量小\"船小好调头\"，通常采用短线操作，更青睐趋势投资。 当然，两种投资理念并不是冲突的，完全可以根据情况结合使用。 何为技术分析 无论是价值投资还是趋势投资，都需要通过某种手段进行分析，获取未来价格变化的趋势。 价值投资通过基本面分析预测未来某一时点/时段证券的内在价值（价格变化的趋势就是向内在价值靠近）；趋势投资通过技术分析预测今后较短一段时间内价格变化的趋势。 二者的本质区别在于着眼点的不同。基本面分析的目标是证券的内在属性，影响内在价值的因素五花八门，大到国际形势，小到公司管理细节。 技术分析的目标是市场行为，即当前情况下市场对证券价格会做出如何的反应。\"当前情况\"主要是当前（和历史）的成交价格及成交量，当然也可以包含很多五花八门的要素，比如黑子活动周期、月亮的阴晴圆缺等。 如果要给技术分析一个明确的定义，可以参考 维基百科的定义 ： 技术分析是指研究过去金融市场的资讯（主要是经由使用图表）来预测价格的趋势决定投资的策略。纯理论上，技术分析只考虑市场或金融工具真实的价格行为。 理论基础和假设 所有的技术分析都是建立在三大假设之上的。 市场行为包容消化一切（价格变化反映一切）。 价格以趋势方式演变。 历史会重演。 如果一定要为技术分析找到一个理论基础，大概可以算是凯恩斯的\"空中楼阁理论\"。其实这并不能算是一个理论，而仅仅是一个假设。 凯恩斯认为： 证券的内在价值理论上是存在的，但是很难准确的进行长期预期; 由于长期难以预测，所以应该关注短期。长期只不过是一连串短期的连接； 在短期来说，价格并不是由内在价值决定的，而是由投资者心理决定的，是空中楼阁； 获利需要顺势而为，在短期，就是要顺应投资者的心理和行为模式； 短期价格体现了投资者的平均预期； 一般人从心理上倾向于趋势会延续，除非预测到未来会变化的因素； 在短期，投资者不需要关心证券的内在价值，而只需要关心平均预期及其可能发生的变化； 凯恩斯的分析完全抛开了股票的内在价值，认为证券的价格在短期主要决定于投资者的心理预期，而不存在向内在价值靠拢的趋势。对于短期趋势的预测，就是对短期心理预期的预测。 技术分析理论派别 技术分析名为\"技术\"，但更像是\"艺术\"。技术分析没有严格的数学推理，更多的是依赖经验的总结。 证券市场众多的投资者根据自身的经验总结出了很多的\"规律\"。但是这些\"规律\"之间并不能互相映射。而且\"规律\"运用的程度和结果与使用者的经验有很大关系。 目前被广泛认可的理论派别包括： 道氏理论 、 波浪理论 和 江恩理论 。 各种规律都能或多或少在这些理论中找到影子。 技术分析的理论严格来说并不能算是\"理论\"，上述三个派别都提出了趋势可能存在的类型及其特征，但是无法给出这些趋势存在或特征的证明。 道氏理论要点 道氏理论是所有市场技术研究的鼻祖。其创造者指明了技术分析的真谛：不是预测股市，而是反映市场趋势；是根据价格模式的研究,推测未来价格行为的一种方法。 道氏理论在三个假设的基础上，提出了关于趋势的五个\"定理\"： 存在3个级别的趋势 短期（持续几天–几周），中期（持续几周–几月），长期（持续几月–几年），次级走势围绕上级走势折返。 存在一个市场的主要走势 主要走势是一种长期走势，代表市场的整体趋势，根据方向不同称为多头市场和空头市场（牛市和熊市） 主要的空头市场包含三个主要的阶段 试探前一多头高点失败后的下跌；下跌一定程度后的反弹和调整；调整后的持续下跌 主要的多头市场包含三个主要的阶段 前一空头下跌放缓；震荡上扬；持续走高 存在次级折返走势，要分析其与主要走势的区别与联系 波浪理论要点 波浪理论号称\"道氏理论告诉人们何谓大海，而波浪理论指导你如何在大海上冲浪\"。其含义是道氏理论是一种定性的分析，而波浪理论在道氏理论的基础上实现了一定程度的定量分析。 波浪理论在\"群体心理\"的假设上，提出价格的变化具有类似潮汐或波浪一样的形态。主要内容包括： 5升3降是基本的形态 各等级的波会互相叠加，但都各自符合基本形态 存在9个等级的划分 波浪的形态与时间无关，或者说，尽管波长可能不同，但波形一定符合基本形态 在特定的趋势阶段下，对应的波浪会有一些明显的特征。反过来说，把握了波浪的特征，可以判断正处于趋势的哪个阶段 波浪的某些特征可以向斐波那契数列、黄金分割率等数字上靠拢 江恩理论要点 江恩理论是一个\"神奇\"的理论，主要\"神奇\"在：江恩理论不仅引入了数学，还包含了天文、宗教等因素。江恩的一些作图方法看起来就像占星术或者周易。而且江恩理论对趋势的预测准确性非常高，甚至有人评价\"不可思议\"。 由于江恩理论的神奇性，短期无法给出该理论的一个简要说明，这些内容留待以后研究。 但江恩理论的重要特征是： 周期性和一些\"魔术数字\" 在预测趋势的同时，还提出了一整套的操作程序，对于错误的预测能够进行补救。如\"十二条买卖规则\"，\"二十一条买卖守则\"等 技术分析的应用方法 不管应用哪种技术分析理论，其应用方法是一样的： 根据基本指标技术出趋势性指标 这些指标都是对历史数据中交易行为的一种量化，有些指标是简单计算出来的，也有的指标需要经过统计分析后得出。 趋势性指标主要体现了量、价、时、空四大要素。 也有人将指标划分为趋势型指标、超买超卖型指标、人气和意愿指标、大势领先指标等类别。 对单个趋势性指标或多个指标的组合进行分析 可以直接观察数字，也可以做出图形(比如K线、切线等）观察形态，最终得出对趋势的判断。 根据预测到的趋势进行操作 这里需要注意的是： 由于趋势的预测不可能100%正确，所以要指定风险控制、资金管理等策略，简单的说就是先制定交易原则，以及预测失败的处理办法。 不同的趋势具有不同的敏感度，敏感度越高，其适用的时间范围就越小，风险也越大。对趋势级别的选择要和自己的操作级别相适应。 资料 本文只是对技术分析理论的大体框架进行了最粗略的概览，要想深入学习，还需要阅读大量的资料。目前找到的资料包括： 书籍 《股市晴雨表》 《道氏理论》 《专业投机原理》 《股市趋势技术分析》 《江恩测市法则》 《在华尔街45年》 网站 国际技术分析师联盟 市场技术分析师协会 美国专业技术分析师协会 加拿大技术分析师公会 MoneyDJ技术分析学院 图表人技术分析Facebook专页","tags":"投资分析","loc":"http://holbrook.github.io/2013/01/26/technical_analysis.html"},{"title":"你真的会数钱吗？","text":"一篇旧的博文，原文发表在 博客园 。 快年底了，假如你们公司的美国总部给每个人发了一笔201212.21美元的特别奖金，作为程序员的你， 该如何把这笔钱收入囊中？ 1.美元？美元！ 你可能觉得，这根本不是问题。在自己的账户中直接加上一笔\"转入\"就行了。但是首先就遇到了币种的问题。 一般来说，银行账户都是单币种的。你可能会说不对啊，我的一卡通就能存入不同的币种啊？但那是一个\"账号（Account Number）\"对应的多个\"账户(Account)\"。 通常财务记账的时候，一个\"账户(Account)\"都使用同一币种。 账户(Account)记录了资金的往来，包含很多条目(Entry)。账户会记录结余，结余等于所有条目中金额的总和。 我们不可能为每个币种设计一种条目，所以需要抽象出一个货币类——Money，适用于各种不同的币种： Money类至少要记录金额和币种: 对于金额，由于货币存在最小面额，所以金额的类型可以采用定点小数或者整型。考虑到会对金额进行一些运算，用整数处理应该更方便。如果用java语言实现，可以使用long类型。 对于币种，java提供了java.util.Currency类，专门用于表示货币，符合ISO 4217货币代码标准。Currency使用Singleton模式，需要用getInstance方法获得实例。 主要的方法包括： String getCurrencyCode() 获取货币的ISO 4217货币代码 int getDefaultFractionDigits() 获取与此货币一起使用的默认小数位数 static Currency getInstance(Locale locale) 返回给定语言环境的国家/地区的 Currency 实例 static Currency getInstance(String currencyCode) 返回给定货币代码的 Currency 实例。 String getSymbol() 获取默认语言环境的货币符号 String getSymbol(Locale locale) 获取指定语言环境的货币符号 String toString() 返回此货币的 ISO 4217 货币代码 通过Currency类的帮助，我们的Money类看起来大概是这个样子(为了方便，提供多种构造函数)： public class Money { private long amount; private Currency currency; public double getAmount() { return BigDecimal.valueOf(amount, currency.getDefaultFractionDigits()).doubleValue(); } public Currency getCurrency() { return currency; } public Money(double amount, Currency currency) { this.currency = currency; this.amount = Math.round(amount * centFactor()); } public Money(long amount, Currency currency) { this.currency = currency; this.amount = amount * centFactor(); } private static final int[] cents = new int[] { 1, 10, 100, 1000,10000 }; private int centFactor() { return cents[currency.getDefaultFractionDigits()]; } } 用Money类表示我们的$201212.21奖金，就是： Money myMoney = new Money(201212.21,Currency.getInstance(Locale.US)); 2.存入账户 终于解决了币种的问题，可以把钱存入账户了。存入的逻辑是：在条目中记录一笔账目，并计算账户的余额。 不同币种之间相加或相减是没有意义的，为了避免人为错误，在Money的代码中就要禁止这种操作。我们可以采用抛出异常的方式。 为了简单起见，这里不再定义一个单独的\"MoneyException\"，而是直接使用java.lang.Exception: public Money add(Money money) throws Exception{ if(!money.getCurrency().equals(this.currency)){ throw(new Exception(\"different currency can't be add\")); } BigDecimal value = this.getAmount().add(money.getAmount()); Money result = new Money(value.doubleValue(),this.getCurrency()); return result; } public Money minus(Money money) throws Exception{ if(!money.getCurrency().equals(this.currency)){ throw(new Exception(\"different currency can't be minus\")); } BigDecimal value =this.getAmount().add(money.getAmount().negate()); Money result = new Money(value.doubleValue(),this.getCurrency()); return result; } 3.收税 先不要高兴得太早，这笔钱属于\"一次性所得\"，需要交20%的个人所得税。税后所得应该是多少？ 你可能说：是80%。只要为Money加上一个multiply(double factor)方法就可以进行计算了。 但是牵扯到了舍入的问题。由于货币存在最小单位，在做乘/除法运算的时候就要考虑到舍入的问题了。最好是能够控制舍入的行为。假如税务部门对于 舍入的计算有明确规定，我们也可以做一个遵纪守法的好公民。 在java.math.BigDecimal中定义了7种舍入模式： ROUND_UP：等于远离0的数。 ROUND_DOWN：等于靠近0的数。 ROUND_CEILING：等于靠近正无穷的数。 ROUND_FLOOR：等于靠近负无穷的数。 ROUND_HALFUP：等于靠近的数，若舍入位为5，应用ROUNDUP。 ROUND_HALFDOWN：等于靠近的数，若舍入位为5，应用ROUNDDOWN。 ROUND_HALFEVEN：舍入位前一位为奇数，应用ROUNDHALFUP；舍入位前一位为偶数，应用ROUNDHALFDOWN。 我们可以借用这些模式作为参数： public static final int ROUND_UP = BigDecimal.ROUND_UP; public static final int ROUND_DOWN = BigDecimal.ROUND_DOWN; public static final int ROUND_CEILING = BigDecimal.ROUND_CEILING; public static final int ROUND_FLOOR = BigDecimal.ROUND_FLOOR; public static final int ROUND_HALF_UP = BigDecimal.ROUND_HALF_UP; public static final int ROUND_HALF_DOWN = BigDecimal.ROUND_HALF_DOWN; public static final int ROUND_HALF_EVEN = BigDecimal.ROUND_HALF_EVEN; public static final int ROUND_UNNECESSARY = BigDecimal.ROUND_UNNECESSARY; public Money multiply(double multiplicand, int roundingMode) { BigDecimal amount = this.getAmount().multiply(new BigDecimal(multiplicand)); amount = amount.divide(BigDecimal.ONE,roundingMode); return new Money(amount.doubleValue(),this.getCurrency()); } public Money divide(double divisor, int roundingMode) { BigDecimal amount = this.getAmount().divide(new BigDecimal(divisor), roundingMode); Money result = new Money(amount.doubleValue(), this.getCurrency()); return result; } 4.转成人民币 尽管各领域的国际化提了十几年，但是在国内想直接用美元消费还是有一定困难。所以你决定将这笔钱换成人民币。 对于账户来说，就是在美元账户和人民币账户分别做一笔转出和转入。 转入和转出的amount值是不同的，因为涉及到币种转换的问题。 显然，账户对象不应该知道如何进行汇率转换，责任又落在了Money类上。 最直观的做法是在Money类上增加一个convertTo(Currency currency)的方法。 但汇率实在是一个复杂的问题： 汇率是经常变化的； 汇率转换时的舍入处理会有相关的约定； 这些复杂的问题处理如果直接放在Money类上会显得十分笨重，单独设计一个MoneyConverter类会比较好： import java.util.Currency ; public interface MoneyConverter { Money convertTo ( Money money , Currency currency ) throws Exception ; } 我们实现一个最简单的转化器，使用固定的汇率值： import java.math.BigDecimal ; import java.util.Currency ; import java.util.Locale ; public class SimpleMoneyConverter implements MoneyConverter { private static final BigDecimal DOLLAR_TO_CNY = new BigDecimal ( 6.2365 ); private static final Currency DOLLAR = Currency . getInstance ( Locale . US ); private static final Currency CNY = Currency . getInstance ( Locale . CHINA ); @Override public Money convertTo ( Money money , Currency target ) throws Exception { if ( ! known ( money . getCurrency ()) || ! known ( target )){ throw ( new Exception ( \"unknown currency\" )); } BigDecimal factorSource = BigDecimal . ONE , factorTarget = BigDecimal . ONE ; if ( money . getCurrency () . equals ( DOLLAR )) factorSource = DOLLAR_TO_CNY ; if ( target . equals ( DOLLAR )) factorTarget = DOLLAR_TO_CNY ; BigDecimal value = money . getAmount () . multiply ( factorSource ) . divide ( factorTarget ); return new Money ( value . doubleValue (), target ); } private boolean known ( Currency currency ){ return ( currency . equals ( DOLLAR ) || currency . equals ( CNY ) ); } } 可以看到，即使是最简单的转换器，处理起来也比较麻烦。所以千万不要在Money类中做这件事情。 通过转换器可以很容易得到转成人民币后的值。 5.分钱 有好处不能独享。这笔钱你决定和老婆三七开。当然，你三！ 这又是一个新的舍入问题：即使你指定各自的舍入计算方法，也不能保证各部分舍入后的值加总后仍等于原值。 前面的\"可定制乘除法\"似乎不能很好的解决这个问题，所以我们需要一个新的方法： Money[] allocate(double[] ratioes) 传入分配比例的数组，返回分配结果的数组。 为了保证分配的公平，可以使用伪随机数来处理误差。 该方法的实现如下： public Money[] allocate(double[] ratioes) throws Exception{ if(ratioes.length==0){ throw (new Exception(\"there is no ratio\")); } double ratioTotal = 0; for(double ratio:ratioes){ ratioTotal += ratio; } if(0==ratioTotal){ throw(new Exception(\"total of ratioes is zero\")); } double total = this.getAmount().doubleValue(); double delta = total; Money[] results = new Money[ratioes.length]; for(int i=0;i<ratioes.length;i++){ double amount = total*ratioes[i]/ratioTotal; results[i] = new Money(amount,this.getCurrency()); delta -= results[i].getAmount().doubleValue(); } int i = (int)(Math.random() * ratioes.length); results[i] = results[i].minus(new Money(delta,this.getCurrency())); return results; } 6.记账 将一切重要的数据保存到数据库是很通常的做法。但是将Money保存到数据库的时候，你要小心了！ Money不能作为单独的实体。如果把Money当做实体来处理，就会产生一些问题： 会有很多实体关联到Money，比如本文中的Account，Entry等。 需要非常小心处理对Money对象的引用，避免多个实体引用到同一个Money对象。在第一点的前提下，这会变得很困难。 所以应该把Money嵌入到需要的实体中，而不是把Money作为单独的实体。这样，Money仅仅是实体对象（比如Entry）的一个属性，只不过其具有多个内置的属性值。 在JPA中，可以使用@Embeddable来标注Money类。 更复杂的情况是，由于一个Account中的所有Entry都应该具有相同的Currency，将Currency保存到Account中会更简洁，Entry中只记录ammount。 可以为Money的currency属性增加@Transient标注，在Entry类的getMoney中进行组装。 7.来点高级的 在DDD（领域驱动设计）中，Money是典型的值对象（Value Object）。值对象与实体的根本区别是：值对象不需要进行标识（ID）。 这会带来一些处理上的不同： 实体对象根据ID判断是否相等，值对象只根据内部属性值判断是否相等 值对象通常小而且简单，创建的代价较小 值对象只传递值，不传递对象引用，不用判断值对象是否指向同一个物理对象 通常将值对象设计为通过构造函数进行属性设置，一旦创建就无法改变其属性值 由于值对象根据内部属性值判等，我们要为Money类覆盖equals方法： public boolean equals(Object other) 8.其他未尽事宜 我们还可以为Money类增加互相比较的方法（略） 可以在构造函数中进行格式校验（略） 可以增加一些帮助显式的方法 使用currency的getSymbol(Locale locale)方法、和NumberFormat的format方法，比如： NumberFormat nf=NumberFormat.getCurrencyInstance(Locale.CHINA); String s=nf.format(73084.803984);// result：￥73,084.80 9.小结 本文探讨如何在应用中处理货币类型，包括币种转换、各种计算、如何持久化等内容。 货币类型是典型的值对象，本文也介绍了一点值对象的特点。更多的内容可以参考DDD。","tags":"软件开发","loc":"http://holbrook.github.io/2013/01/01/money.html"},{"title":"JPA概要","text":"1 JPA概述 JPA（Java Persistence API，Java持久化API），定义了对象-关系映射（ORM）以及实体对象持久化的标准接口。 JPA1.0是 JSR-220 （EJB3.0）规范的一部分，在JSR-220中规定实体对象（EntityBean）由JPA进行支持。 后来，JPA2.0迁移到 JSR-317 （Java Persistence 2.0），已经不局限于EJB3.0，而是作为POJO持久化的标准规范，可以脱离容器独立运行，开发和测试更加方便。 JPA在应用中的位置如下图所示： JPA维护一个Persistence Context（持久化上下文），在持久化上下文中维护实体的生命周期。主要包含三个方面的内容： ORM元数据。JPA支持annotion或xml两种形式描述对象-关系映射。 实体操作API。实现对实体对象的CRUD操作。 查询语言。约定了面向对象的查询语言JPQL（Java Persistence Query Language）。 JPA的主要API都定义在javax.persistence包中。 如果你熟悉Hibernate，可以很容易做出对应： org.hibernate javax.persistence 说明 cfg.Configuration Persistence 读取配置信息 SessionFactory EntityManagerFactory 用于创建会话/实体管理器的工厂类 Session EntityManager 提供实体操作API，管理事务，创建查询 Transaction EntityTransaction 管理事务 Query Query 执行查询 2 实体生命周期 实体生命周期是JPA中非常重要的概念，描述了实体对象从创建到受控、从删除到游离的状态变换。对实体的操作主要就是改变实体的状态。 JPA中实体的生命周期如下图： New，新创建的实体对象，没有主键(identity)值 Managed，对象处于Persistence Context(持久化上下文）中，被EntityManager管理 Detached，对象已经游离到Persistence Context之外，进入Application Domain Removed, 实体对象被删除 EntityManager提供一系列的方法管理实体对象的生命周期，包括： persist, 将新创建的或已删除的实体转变为Managed状态，数据存入数据库。 remove，删除受控实体 merge，将游离实体转变为Managed状态，数据存入数据库。 如果使用了事务管理，则事务的commit/rollback也会改变实体的状态。 3 实体关系映射（ORM） 3.1 基本映射 对象端 数据库端 annotion 可选annotion Class Table @Entity @Table(name=\"table_name\") property column – @Column(name = \"column_name\") property primary key @Id @GeneratedValue 详见ID生成策略 property NONE @Transient 3.2 ID生成策略 ID对应数据库表的主键，是保证唯一性的重要属性。JPA提供了以下几种ID生成策略： GeneratorType.AUTO ，由JPA自动生成 GenerationType.IDENTITY，使用数据库的自增长字段，需要数据库的支持（如SQL Server、MySQL、DB2、Derby等） GenerationType.SEQUENCE，使用数据库的序列号，需要数据库的支持（如Oracle） GenerationType.TABLE，使用指定的数据库表记录ID的增长 需要定义一个TableGenerator，在@GeneratedValue中引用。例如： @TableGenerator( name=\"myGenerator\", table=\"GENERATORTABLE\", pkColumnName = \"ENTITYNAME\", pkColumnValue=\"MyEntity\", valueColumnName = \"PKVALUE\", allocationSize=1 ) @GeneratedValue(strategy = GenerationType.TABLE,generator=\"myGenerator\") 3.3 关联关系 JPA定义了one-to-one、one-to-many、many-to-one、many-to-many 4种关系。 对于数据库来说，通常在一个表中记录对另一个表的外键关联；对应到实体对象，持有关联数据的一方称为owning-side，另一方称为inverse-side。 为了编程的方便，我们经常会希望在inverse-side也能引用到owning-side的对象，此时就构建了双向关联关系。 在双向关联中，需要在inverse-side定义mappedBy属性，以指明在owning-side是哪一个属性持有的关联数据。 对关联关系映射的要点如下： 关系类型 Owning-Side Inverse-Side one-to-one @OneToOne @OneToOne(mappedBy=\"othersideName\") one-to-many / many-to-one @ManyToOne @OneToMany(mappedBy=\"xxx\") many-to-many @ManyToMany @ManyToMany(mappedBy =\"xxx\") 其中 many-to-many关系的owning-side可以使用@JoinTable声明自定义关联表，比如Book和Author之间的关联表： @JoinTable(name = \"BOOKAUTHOR\", joinColumns = { @JoinColumn(name = \"BOOKID\", referencedColumnName = \"id\") }, inverseJoinColumns = { @JoinColumn(name = \"AUTHORID\", referencedColumnName = \"id\") }) 关联关系还可以定制延迟加载和级联操作的行为（owning-side和inverse-side可以分别设置）： 通过设置fetch=FetchType.LAZY 或 fetch=FetchType.EAGER来决定关联对象是延迟加载或立即加载。 通过设置cascade={options}可以设置级联操作的行为，其中options可以是以下组合： CascadeType.MERGE 级联更新 CascadeType.PERSIST 级联保存 CascadeType.REFRESH 级联刷新 CascadeType.REMOVE 级联删除 CascadeType.ALL 级联上述4种操作 3.4 继承关系 JPA通过在父类增加@Inheritance(strategy=InheritanceType.xxx)来声明继承关系。A支持3种继承策略： 单表继承（InheritanceType.SINGLETABLE），所有继承树上的类共用一张表，在父类指定（@DiscriminatorColumn）声明并在每个类指定@DiscriminatorValue来区分类型。 类表继承（InheritanceType.JOINED），父子类共同的部分公用一张表，其余部分保存到各自的表，通过join进行关联。 具体表继承（InheritanceType.TABLEPERCLASS)，每个具体类映射到自己的表。 其中1和2能够支持多态，但是1需要允许字段为NULL，2需要多个JOIN关系；3最适合关系数据库，对多态支持不好。具体应用时根据需要取舍。 3.5 值对象、关联表 在领域驱动设计(DDD)中，值对象不具有唯一标识，而是依附在实体上，只能通过实体获取。 通常，值对象的字段作为所嵌入的实体对象对应的表中的字段。如有必要，也可以通过 @SecondaryTable 和 @AttributeOverrides 注解将值对象的字段放到关联表中。 JPA使用 @Embeddable 标记一个类为值对象；在实体对象中使用 @Embedded 使用值对象作为属性。 比如： @Embeddable public class Address { private String street; private String city; private String state; @Column(name=\"ZIP_CODE\") private String zip; …… } @Entity @Table(name=\"EMP\") @SecondaryTable(name=\"EMP_ADDRESS\", pkJoinColumns=@PrimaryKeyJoinColumn(name=\"EMP_ID\")) public class Professor { @Id private int id; private String name; @Embedded @AttributeOverrides({ @AttributeOverride(name=\"street\", column=@Column(table=\"EMP_ADDRESS\")), @AttributeOverride(name=\"city\", column=@Column(name=\"CITY\", table=\"EMP_ADDRESS\")), @AttributeOverride(name=\"state\", column=@Column(name=\"STATE\", table=\"EMP_ADDRESS\")), @AttributeOverride(name=\"zip\", column=@Column(name=\"ZIP_CODE\", table=\"EMP_ADDRESS\")) }) private Address address; …… } 3.6 复合主键 JPA中，可以使用 @EmbeddedId 主键将一个值对象声明为复合主键。作为复合主键的值对象要实现 Serializable 接口， 并覆盖 equals 和 hashCode 方法： 比如： @Embeddable public class SectionPK implements Serializable{ @ManyToOne private Security target; private Interval interval; private Date datetime; @Override public int hashCode() { final int prime = 31; int result = 1; result = prime * result + ((target == null) ? 0 : target.hashCode()); result = prime * result + ((datetime == null) ? 0 : datetime.hashCode()); result = prime * result + ((interval == null) ? 0 : interval.hashCode()); return result; } @Override public boolean equals(Object obj) { if (this == obj) return true; if (obj == null) return false; if (getClass() != obj.getClass()) return false; SectionPK other = (SectionPK) obj; if(!isEqual(this.getDatetime(),other.getDatetime())) return false; if(!isEqual(this.getInterval(),other.getInterval())) return false; if(!isEqual(this.getTarget(),other.getTarget())) return false; return true; } private boolean isEqual(Object obj1,Object obj2){ if(obj1==null){ if(obj2!=null) return false; }else if(!obj1.equals(obj2)){ return false; } return true; } } @Entity public class Section { @EmbeddedId SectionPK key; …… } 3.7 集合映射 从JPA2.0开始，不仅支持实体集合的映射，还支持基本类型(如String,Integer等）集合以及值对象(Embeded)集合的映射。 JPA通过 @ElementCollection 注解集合映射，可以自动检测元素类型，也可以通过 targetClass 参数指定。 通过 @CollectionTable 注解可以指定集合表的详细信息。当然，也可以使用 @JoinTable 注解进行指定。 比如，基本类型集合的映射： //Set @ElementCollection @JoinTable(name = \"item\", joinColumns = { @JoinColumn(nullable = false, name = \"item_id\", referencedColumnName = \"id\") }) @Column(name = \"filename\", nullable = false) private Set<String> images = new HashSet<String>(); //List @ElementCollection(targetClass = java.lang.String.class) @JoinTable(name = \"item\", joinColumns = { @JoinColumn(nullable = false, name = \"item_id\") }) @IndexColumn(name = \"position\", base = 1) @Column(name = \"filename\", nullable = false) @OrderBy(clause=\"item_id desc\") private List<String> listImages = new ArrayList<String>(); //Map @ElementCollection @JoinTable(name=\"item\", joinColumns={ @JoinColumn(nullable=false, name=\"item_id\")}) @MapKeyColumn(name=\"map_key\") @Column(name=\"filename\", nullable=false) private Map<String, String> mapImages = new HashMap<String, String>(); 值对象集合映射： public enum FeatureType { AC, CRUISE, PWR, BLUETOOTH, TV, ... } @Embeddable public class ServiceVisit { …… } @Entity public class Vehicle { @Id int vin; @ElementCollection @CollectionTable(name=\"VEH_OPTNS\") @Column(name=\"FEAT\") Set<FeatureType> optionalFeatures; @ElementCollection @CollectionTable(name=\"VEH_SVC\") @OrderBy(\"serviceDate\") List<ServiceVisit> serviceHistory; 4 事件及监听 通过在实体的方法上标注@PrePersist，@PostPersist等声明即可在事件发生时触发这些方法。 5 Query Language 查询语言 JPA提供两种查询方式，一种是根据主键查询，使用EntityManager的find方法： T find(Class entityClass, Object primaryKey) 另一种就是使用JPQL查询语言。JPQL是完全面向对象的，具备继承、多态和关联等特性，和hibernate HQL很相似。 使用EntityManager的createQuery方法： Query createQuery(String qlString) 5.1 使用参数 可以在JPQL语句中使用参数。JPQL支持命名参数和位置参数两种参数，但是在一条JPQL语句中所有的参数只能使用同一种类型。 举例如下： 命令参数 Query query = em.createQuery(\"select p from Person p where p.personid=:Id\"); query.setParameter(\"Id\",new Integer(1)); 位置参数 Query query = em.createQuery(\"select p from Person p where p.personid=?1\"); query.setParameter(1,new Integer(1)); 5.2 命名查询 如果某个JPQL语句需要在多个地方使用，还可以使用 @NamedQuery 或者 @NamedQueries 在实体对象上预定义命名查询。 在需要调用的地方只要引用该查询的名字即可。 例如： @NamedQuery(name=\"getPerson\", query= \"FROM Person WHERE personid=?1\") @NamedQueries({ @NamedQuery(name=\"getPerson1\", query= \"FROM Person WHERE personid=?1\"), @NamedQuery(name=\"getPersonList\", query= \"FROM Person WHERE age>?1\") }) Query query = em.createNamedQuery(\"getPerson\"); 5.3 排序 JPQL也支持排序，类似于SQL中的语法。例如： Query query = em.createQuery(\"select p from Person p order by p.age, p.birthday desc\"); 5.4 聚合查询 JPQL支持AVG、SUM、COUNT、MAX、MIN五个聚合函数。例如： Query query = em.createQuery(\"select max(p.age) from Person p\"); Object result = query.getSingleResult(); String maxAge = result.toString(); 5.5 更新和删除 JPQL不仅用于查询，还可以用于批量更新和删除。如： Query query = em.createQuery(\"update Order as o set o.amount=o.amount+10\"); //update 的记录数 int result = query.executeUpdate(); Query query = em.createQuery(\"delete from OrderItem item where item.order in(from Order as o where o.amount<100)\"); query.executeUpdate(); query = em.createQuery(\"delete from Order as o where o.amount<100\"); query.executeUpdate();//delete的记录数 5.6 更多 与SQL类似，JPQL还涉及到更多的语法，可以参考 这里 。 6 事务管理 JPA支持本地事务管理（RESOURCELOCAL）和容器事务管理（JTA），容器事务管理只能用在EJB/Web容器环境中。 事务管理的类型可以在persistence.xml文件中的\"transaction-type\"元素配置。 JPA中通过EntityManager的getTransaction()方法获取事务的实例（EntityTransaction），之后可以调用事务的begin()、commit()、rollback()方法。","tags":"软件开发","loc":"http://holbrook.github.io/2012/12/30/JPA_intro.html"},{"title":"Java规则引擎规范：JSR94","text":"Java World似乎总会出现一些接口规范，这样做的好处是可以面向接口编程，可以在实现了该接口的产品/组件之间自由切换，避免被厂商绑架。 本文要介绍的 JSR94:Java Rule Engine API ， Java规则引擎API规范。 概述 JSR-94是JCP(Java Community Process)制定的关于Java规则引擎API的规范，包括接口定义和示例代码。于2004年8月发布。 JSR-94定义了javax.rules和javax.rules.admin,前者包含了Java规则引擎运行时（Rumtime)API及异常（Exception）定义，后者包含了规则管理相关的API和异常定义。 规则管理API 规则管理API在javax.rules.admin中定义,主要包括以下类/接口： Rule：规则实体 RuleExecutionSet：执行集，某个规则对应的动作 LocalRuleExecutionSetProvider：用于从本地创建执行集，如InputStream,Reader等 RuleExectuionSetProvider：用于从本地或远程创建执行集，如xml Element，Serializable等 RuleAdministrator：用于获取ExecutionSetProvider，并管理执行集的注册/注销 规则管理API实现的功能包括： 装载规则（Rule）和执行集（RuleExecutionSet) 执行集的注册/注销,只有注册的执行集对应的规则才能被客户访问 运行时API 运行时API在javax.rules中定义，主要包括以下类/接口： RuleServiceProviderManager: 通过URL注册/注销RuleServiceProvider RuleServiceProvider: 提供对RuleRuntime和RuleAdministrator的访问 RuleRuntime: 规则引擎运行时，可以创建规则会话 RuleSession: 规则会话，用于执行规则 RuleExecutionSetMetaData: 执行集元数据，包括name,url,description等。执行集元数据会被RuleSession使用 StatelessRuleSession: 无状态规则会话 StatefulRuleSession: 有状态规则会话 Handle和ObjectFilter: 有状态会话维护会话状态的帮助类 规则引擎运行时API实现的功能包括： 注册/注销规则引擎实例，只有注册的规则引擎实例才能被使用 从注册的规则引擎实例创建Runtime 从Runtime创建会话，包括有状态和无状态两种会话 通过会话执行规则 异常定义 除了前面提到的主要类/接口外，JSR94还规定了规则引擎运行时及管理的一些异常，如下： 代码示例 下面是使用Drools作为规则引擎实例的一个例子，规则文件使用了Drools的drl格式： JSR94Sample.java package com.sample ; import java.io.FileReader ; import java.util.ArrayList ; import java.util.HashMap ; import java.util.List ; import javax.rules.ConfigurationException ; import javax.rules.RuleRuntime ; import javax.rules.RuleServiceProvider ; import javax.rules.RuleServiceProviderManager ; import javax.rules.StatelessRuleSession ; import javax.rules.admin.LocalRuleExecutionSetProvider ; import javax.rules.admin.RuleAdministrator ; import javax.rules.admin.RuleExecutionSet ; import org.drools.jsr94.rules.RuleServiceProviderImpl ; public class JSR94Sample { private static RuleServiceProvider ruleProvider ; private static void initProvider (){ String uri = RuleServiceProviderImpl . RULE_SERVICE_PROVIDER ; Class providerClass = RuleServiceProviderImpl . class ; try { //注册ruleProvider RuleServiceProviderManager . registerRuleServiceProvider ( uri , providerClass ); //从RuleServiceProviderManager获取ruleProvider ruleProvider = RuleServiceProviderManager . getRuleServiceProvider ( uri ); } catch ( ConfigurationException e ){ e . printStackTrace (); } } private static void adminSample (){ try { //获取RuleAdministrator实例 RuleAdministrator admin = ruleProvider . getRuleAdministrator (); //获取RuleExectuionSetProvider HashMap properties = new HashMap (); properties . put ( \"name\" , \"My Rules\" ); properties . put ( \"description\" , \"A trivial rulebase\" ); LocalRuleExecutionSetProvider ruleExecutionSetProvider = admin . getLocalRuleExecutionSetProvider ( properties ); //创建RuleExecutionSet FileReader reader = new FileReader ( \"bin/sample.drl\" ); RuleExecutionSet reSet = ruleExecutionSetProvider . createRuleExecutionSet ( reader , properties ); //注册RuleExecutionSet admin . registerRuleExecutionSet ( \"mysample\" , reSet , properties ); } catch ( Exception e ){ e . printStackTrace (); } } private static void runtimeSampe (){ try { //获取RuleRuntime, 创建会话 RuleRuntime runtime = ruleProvider . getRuleRuntime (); StatelessRuleSession ruleSession = ( StatelessRuleSession ) runtime . createRuleSession ( \"mysample\" , null , RuleRuntime . STATELESS_SESSION_TYPE ); //初始化输入数据 Message message1 = new Message (); message1 . setMessage ( \"Hello World\" ); message1 . setStatus ( Message . HELLO ); Message message2 = new Message (); message2 . setMessage ( \"Goodbye World\" ); message2 . setStatus ( Message . GOODBYE ); List inputs = new ArrayList (); inputs . add ( message1 ); inputs . add ( message2 ); //执行规则 List < Message > results = ruleSession . executeRules ( inputs ); for ( int i = 0 ; i < results . size (); i ++){ Message msg = results . get ( i ); System . out . println ( msg . message ); } //释放会话资源 ruleSession . release (); } catch ( Exception e ){ e . printStackTrace (); } } public static void main ( String [] args ) { // TODO Auto-generated method stub initProvider (); adminSample (); runtimeSampe (); } public static class Message { public static final int HELLO = 0 ; public static final int GOODBYE = 1 ; private String message ; private int status ; public String getMessage () { return this . message ; } public void setMessage ( String message ) { this . message = message ; } public int getStatus () { return this . status ; } public void setStatus ( int status ) { this . status = status ; } } } 规则文件使用的就是 这里 的例子。 实现JSR94的产品 主要的一些实现了JSR94的规则引擎产品如下： Drools : 开源 DRL,xDRL,DSL,Decision Table ReteOO Eclipse,excel 文件系统 jar Mandarax : 开源 RuleML OpenRules : 开源 Decision Table Rete excel war JLisa : 开源 Blaze : 商业 SRL WebSphere ILOG JRules : 商业 JESS : 商业 小结 JSR94为规则引擎提供了公用标准API,为实现规则管理API和运行时API提供了指导规范, 目前已经获得很多开源/商业规则引擎产品的支持。 但是JSR94没有对 规则的描述语言 进行规范，导致各规则引擎产品大多采用自己私有的描述语言。","tags":"软件开发","loc":"http://holbrook.github.io/2012/12/07/jsr94.html"},{"title":"Drools规则描述语言快速手册","text":"在规则引擎中，通常会使用某种表述性的语言（而不是编程语言）来描述规则 。 所以规则描述语言也是规则引擎的一个重要组成部分。 目前在规则描述语言方面，并没有一个通用的标准获得规则引擎厂商的广泛支持，大部分规则描述语言都是厂商私有的。 大体来说，规则语言可以分为结构化的（Structured)和基于标记的（Markup，通常为xml）。 常见的规则描述语言包括： srl(Structured Rule Language) : Fair Isaac（以前是Blaze Software）定义的结构化规则描述语言 drl(Drools Rule Language) : Jboss（以前是drools.org)定义的结构化规则描述语言 RuleML(Rule Markup Language）: www.ruleml.org定义的xml规则描述语言 SRML(Simple Rule Markup Language): xml规则描述语言 BRML(Business Rules Markup Language):xml规则描述语言 SWRL（A Semantic Web Rule Language):www.daml.org定义的xml规则描述语言 不管是哪种规则描述语言，都需要描述一组条件以及在此条件下执行的操作（即规则）。 概览 下面是一个drl的例子： package com . sample import com.sample.DroolsTest.Message ; rule \"Hello World\" when m : Message ( status == Message . HELLO , myMessage : message ) then System . out . println ( myMessage ); m . setMessage ( \"Goodbye cruel world\" ); m . setStatus ( Message . GOODBYE ); update ( m ); end rule \"GoodBye\" when Message ( status == Message . GOODBYE , myMessage : message ) then System . out . println ( myMessage ); end 完整的drl文件会包含以下几个部分： package 声明 imports declares globals functions queries rules package和import声明 与Java语言类似，drl的头部需要有package和import的声明。 规则文件当中必须要有一个 package 声明,同时 package 声明必须要放在规则文件的第一行。 规则定义 drl中，一个规则的标准结构如下： rule \"name\" attributes when LHS then RHS end 一个规则通常包括三个部分:属性部分(attribute)、条件 部分(LHS)和结果部分(RHS)。 条件部分(LHS) 在 LHS 当中,可以包含多个条件,如果 LHS 部分没空的话,那么引擎会自动添加一 个 eval(true)的条件。 多个条件之间之间用可以使用 and 或 or 来进行连接。默认是 and 关系。 每个条件的语法为： [绑定变量名:]Object([field 约束]) \"绑定变量名\"是可选的。绑定的变量可以在该LHS后续的条件中引用。 \"field 约束\"是指当前对象里相关字段的条件限制, 多个约束之间可以用\"&&\"(and)、\"||\"(or)和\",\"(and)来连接。 举例如下： when $ customer :Customer() then …… when $ customer :Customer(age>20,gender==􏰃male􏰃) Order(customer== $ customer ,price>1000) then …… when Customer(age>20 || (gender=='male' && city==‘sh')) then …… 约束中可以使用的比较操作符包括： >、>=、<、<=、= =、!=、contains、not contains、 memberof、not memberof、matches、not matches 举例如下： when $ order :Order (); $ customer :Customer ( age > 20 , orders contains $ order ); then …… when $ order :Order ( name memberOf orderNames ); # orderNames为数组或集合类型 then …… when $ customer :Customer ( name matches \"李.*\" ); # 正则表达式匹配 then …… 结果部分(RHS) RHS 部分定义了当LHS满足是要进行的操作。 RHS中可以编写代码，可以使用 LHS 部分当中定义的绑定变量名以及drl头部定义的全局变量。 在 RHS 当中虽然可以直接编写 Java 代码,但不建议在代码当中有条件判断,如果需要条件判断,那么请重新考虑将其放在 LHS 当中,否则就违背了使用规则的初衷。 使用宏函数 RHS中可以使用宏函数对工作空间(Working Memory)进行操作。当调用宏函数后，所有未设置\"no-loop\"属性的规则都会被重新匹配，符合条件的重新触发。 宏函数包括： insert：将一个 Fact 对象插入到当前的 Working Memory update：对当前 Working Memory 中的 Fact 进行更新 retract ：从 Working Memory 中删除某个 Fact 对象 这些宏函数都是StatefulSession中定义的方法。 举例如下： when …… then Customer cus = new Customer (); cus .setName ( \"张三\" ); insert ( cus ); when $ customer :Customer ( name == \"张三\" , age < 10 ); then $ customer .setAge ($ customer .getAge ()+ 1 ); update ($ customer ); when $ customer :Customer ( name == \"张三\" , age < 10 ); then Customer customer = new Customer (); customer .setName ( \"张三\" ); customer .setAge ($ customer .getAge ()+ 1 ); # 用新对象替换Working Memory中的旧对象 update ( drools .getWorkingMemory () .getFactHandleByIdentity ($ customer ), customer ); when $ customer :Customer ( name == \"张三\" ); then retract ($ customer ); modify代码块 modify代码块用于快速修改并更新(update)某个 Fact 对象的多个属性。语法及例子如下： modify ( fact-expression ) { < 修改 Fact 属性的表达式 > [ , < 修改 Fact 属性的表达式 >* ] } when $ customer :Customer ( name == \"张三\" , age == 20 ); then modify ($ customer ) { setId ( \"super man\" ) , setAge ( 30 ) } drools宏对象 通过使用 drools 宏对象可以实现在规则文件里直接访问 Working Memory, 从而获取对当前的 Working Memory 的更多控制。 drools 宏对象的常用方法包括： drools.getWorkingMemory()：获取当前的 WorkingMemory 对象 drools.halt()：在当前规则执行完成后,不再执行 其它未执行的规则。 drools.getRule()：得到当前的规则对象 drools.insert(new Object)：向当前的 WorkingMemory 当中插入 指定的对象,功能与宏函数 insert 相同。 drools.update(new Object)：更新当前的 WorkingMemory 中指定 的对象,功能与宏函数 update 相同。 drools.update(FactHandle Object)：更新当前的 WorkingMemory 中指定 的对象,功能与宏函数 update 相同。 drools.retract(new Object)：从当前的 WorkingMemory 中删除指 定的对象,功能与宏函数 retract 相 同。 例如： when eval(true); then Customer cus=new Customer(); cus.setName(\"张三\"); drools.insert(cus) kcontext宏对象 kcontext 也是 Drools 提供的一个宏对象,它的作用主要是用来得到当前的 KnowledgeRuntime 对象,KnowledgeRuntime 对象可以实现与引擎的各种交互。 规则属性 主要的规则属性如下： 13 个: auto-focus、、lock-on-active、no-loop、 ruleflow-group、、when。 salience 设置规则执行的优先级,数字越大越先执行，数字相同的使用随机顺序。默认值为0，可以设置为负数。 no-loop 默认为false。设置为true时，表示该规则只会被引擎检查一次。引擎内部对Fact更新时，忽略本规则的再次检查。 date-effective 设置规则的开始生效日期。默认接受\"dd-MMM-yyyy\"格式的字符串。可以用代码修改日期格式，如： System.setProperty(\"drools.dateformat\",\"yyyy-MM-dd\") 。 date-expires 设置规则的过期日期。格式与 date-effective 相同。 enabled 默认为true。设置规则是否可用。 dialect 设置规则中使用的编程语言。默认为java，还可以设置为mvel。通过drools.getRule().getDialect()可以获取该属性的设置。 duration 延迟指定的时间后，在 另一个线程中 触发规则。单位为毫秒。 activation-group 为规则划指定一个活动组（组名为字符串）。同一个活动组中的规则只执行一个，根据优先级(salience)来决定执行哪一个规则。 agenda-group 和 auto-focus 为规则指定一个议程(agenda)组。指定了议程组的规则只有在该议程组得到焦点时才被触发。但如果规则同时指定了auto-focus属性为true，则该规则自动得到焦点。 指定议程组焦点可以通过回话(session)： session.getAgenda().getAgendaGroup(\"GROUP_NAME\").setFocus(); session.fireAllRules(); 也可以实现org.drools.runtime.rule.AgendaFilter 接口： {% highlight java %} package test; import org.drools.runtime.rule.Activation; import org.drools.runtime.rule.AgendaFilter; public class TestAgendaFilter implements AgendaFilter { private String startName; public TestAgendaFilter(String startName){ this.startName=startName; } public boolean accept(Activation activation) { String ruleName=activation.getRule().getName(); if(ruleName.startsWith(this.startName)){ return true; }else{ return false; } } } {% endhighlight %} ruleflow-group 指定规则流组。 lock-on-active 当在规则上使用 ruleflow-group 属性或 agenda-group 属性的时候,将 lock-on-action 属性 的值设置为 true,可能避免因某些 Fact 对象被修改而使已经执行过的规则再次被激活执行。lock-on-active 是 no-loop 的增强版属性，在规则流中很有用。 举例如下： rule \"rule1\" salience 1 when …… 注释 Drools 当中注释的写法与编写 Java 类的注 释的写法完全相同,注释的写法分两种:单行注释与多行注释。 单行注释可以采用\"#\"或者\"//\"来进行标记， 多行注释以\"/ \"开始,以\" /\"结束。 例如： /* 规则rule1的注释 这是一个测试用规则 */ rule \"rule1\" when eval ( true ) #没有条件判断 then System . out . println ( \"rule1 execute\" ) ; // 仅仅是输出 end 类型声明 可以在规则文件中定义Fact类型，而不需要编写Java类。比如： declare Address city : String addressName : String end declare Person name:String birthday:Date address:Address //使用declare声明的对象作为address属性类型 order:Order //使用名为Order的JavaBean作为order属性类型 end 在KnowledgeBase中可以获取规则文件中定义的Fact类型，比如： //获取规则文件当中定义的Address对象并对其进行实例化 FactType addressType=knowledgeBase.getFactType(\"test\",\"Address\"); Object add=addressType.newInstance(); addressType.set(add, \"city\",\"Beijing\"); addressType.set(add, \"addressName\",\"Capital\"); 在声明中还可以定义元数据。可以为 Fact 对象、Fact对象的属性或者是规则来定义元数据,元数据定义采用的是\"@\"符号开头。 比如： declare User @createTime(2009-10-25) username : String @maxLenth(30) userid : String @key birthday : java.util.Date end 元数据的获取？(TODO) 全局变量（TODO） 函数和import function 函数的定义和使用 函数是定义在规则文件当中一代码块,作用是将在规则文件当中若干个规则都会用到的业务操作封装起来,实现业务代码的复用,减少规则编写的工作量。 函数的可见范围是函数所在的规则文件。 函数以function定义，可以是void，也可以有返回值。例如： package test import java.util.List ; import java.util.ArrayList ; /* 一个测试函数 用来向 Customer对象当中添加指定数量的Order对象的函数 */ function void setOrder ( Customer customer , int orderSize ) { List ls = new ArrayList (); for ( int i = 0 ; i < orderSize ; i ++ ){ Order order = new Order (); ls . add ( order ); } customer . setOrders ( ls ); } /* 测试规则 */ rule \"rule1\" when $ customer : Customer (); then setOrder ( $ customer , 5 ); System . out . println ( \"rule 1 customer has order size:\" + $ customer . getOrders () . size ()); end /* 测试规则 */ rule \"rule2\" when $ customer : Customer (); then setOrder ( $ customer , 10 ); System . out . println ( \"rule 2 customer has order size:\" + $ customer . getOrders () . size ()); end 引入静态方法 实际应用当中,可以考虑使用在 Java 类当中定义静态方法的办法来替代在规则文件当 中定义函数。 Drools 提供了一个特殊的 import 语句:import function,通过该 import 语句,可以实现将一个 Java 类中静态方法引入到一个规则文件当中,使得该文件当中的规 则可以像使用普通的 Drools 函数一样来使用 Java 类中某个静态方法。 比如： {% highlight java %} package test; public class RuleTools { public static void printInfo(String name){ System.out.println(\"your name is :\"+name); } } package test import function test.RuleTools.printInfo ; /* 测试规则 */ rule \"rule1\" when eval ( true ); then printInfo ( \"test import function\" ); end 查询定义 查询用于根据条件在当前的 WorkingMemory 当中查找 Fact。Drools 当中查询可分为两种:一种是不需要外部传入参数;一种是需要外部传入参 数。 如： query \"testQuery\" customer:Customer(age>30,orders.size >10) end query \"testQuery2\"(int $ age ,String $ gender ) customer:Customer(age> $ age ,gender== $ gender ) end 通过session可以在外部调用规则文件中的查询，比如： {% highlight java %} …… QueryResults queryResults=statefulSession.getQueryResults(\"testQuery\"); for(QueryResultsRow qr:queryResults){ Customer cus=(Customer)qr.get(\"customer\"); //打印查询结果 System.out.println(\"customer name :\"+cus.getName()); } QueryResults queryResults2=statefulSession.getQueryResults(\"testQuery2\", new Object[]{new Integer(20),\"F\"}); ……","tags":"软件开发","loc":"http://holbrook.github.io/2012/12/06/rule_language.html"},{"title":"规则引擎中常用的模式匹配算法","text":"前面 提到，规则引擎的核心是Pattern Matcher(模式匹配器)。不管是正向推理还是反向推理，首先要解决一个模式匹配的问题。 对于规则的模式匹配，可以定义为： 一个规则是一组模式的集合。如果事实/假设的状态符合该规则的所有模式，则称为该规则是可满足的。 模式匹配的任务就是将事实/假设的状态与规则库中的规则一一匹配，找到所有可满足的规则。 什么是模式匹配 对于模式匹配我们都应该不陌生，我们经常使用的正则表达式就是一种模式匹配。 正则表达式是一种\"模式（pattern）\" 编程语言提供的\"正则表达式引擎\"就是Pattern Matcher。比如python中的re模块 首先输入\"知识\"：re.compile(r'string') 然后就可以让其匹配（match）事实（字符串） 最后通过正则表达式引擎可以得到匹配后的结果 对于规则匹配，通常定义如下： 条件部分，也称为LHS(left-hand side) 事实部分，也称为RHS(right-hand side) 假设系统中有N条规则，平均每个规则的条件部分有P个模式，在某个时点有M个事实需要处理。则规则匹配要做的事情就是： 对每一个规则r，判断当前的事实o是否满足LHS(r)=True,如果满足，则将规则r的实例r(o)，即规则+满足该规则的事实，加到冲突集中等待处理。 通常采取如下过程： 从N条规则中取出一条r； 从M个事实中取出P个事实的一个组合c； 用c测试LHS(r)，如果LHS(r（c）)=True，将RHS(r（c）)加入队列中； 如果M个事实还存在其他的组合c，goto 3； 取出下一条规则r，goto 2； 实际的问题可能更复杂，在规则的执行过程中可能会改变RHS的数据，从而使得已经匹配的规则实例失效或者产生新的满足规则的匹配，形成一种\"动态\"的匹配链。 上面的处理由于涉及到组合，过程很复杂。有必要通过特定的算法优化匹配的效率。目前常见的模式匹配算法包括Rete、Treat、Leaps，HAL，Matchbox等。 Rete算法 Rete算法是目前使用最广泛的规则匹配算法，由Charles L. Forgy博士在1979年发明。Rete算法是一种快速的Forward-Chaining推理算法，其匹配速度与规则的数量无关。 Rete的高效率主要来自两个重要的假设： 时间冗余性 假设facts在推理过程中的变化是缓慢的, 即在每个执行周期中,只有少数的facts发生变化，因此影响到的规则也只占很小的比例。所以可以只考虑每个执行周期中已经匹配的facts. 结构相似性 假设许多规则常常包含类似的模式和模式组。 Rete算法的基本思想是保存过去匹配过程中留下的全部信息,以空间代价来换取执行效率 。对每一个模式 ,附加一个匹配元素表来记录WorkingMemory中所有能与之匹配的元素。当一个新元素加入到WorkingMemory时, 找出所有能与之匹配的模式, 并将该元素加入到匹配元素表中; 当一个无素从WorkingMemory中删除时,同样找出所有与该元素匹配的模式,并将元素从匹配元素表中删除。 Rete算法接受对工作存储器的修改操作描述 ,产生一个修改冲突集的动作 。 Rete算法的步骤如下： 将初始数据（fact）输入Working Memory。 使用Pattern Matcher比较规则（rule）和数据（fact）。 如果执行规则存在冲突（conflict），即同时激活了多个规则，将冲突的规则放入冲突集合。 解决冲突，将激活的规则按顺序放入Agenda。 使用规则引擎执行Agenda中的规则。重复步骤2至5，直到执行完毕所有Agenda中的规则。 Tread算法 在 Rete算法中 ,同一规则连接结点上的寄存器保留了大量的冗余结果。实际上, 寄存器中大部分信息已经体现在冲突集的规则实例中。因此 ,如果在部分匹配过程中直接使用冲突集来限制模式之间的变量约束,不仅可以减少寄存器的数量 ,而且能够加快匹配处理效率 。这一思想称为 冲突集支撑策略 。 考虑增删事实对匹配过程的影响，当向工作存储器增加一个事实时 ,冲突集中已有的规则实例仍然保留,只是将与该事实匹配的规则实例加入到冲突集中; 当从工作存储器删去一个事实时，不可能有新的规则实例产生, 只是将 包含该事实的规则实例从冲突集中删去。 基于冲突集支撑策略和上述观察, Treat算法放弃了Rete算法中利用寄存器保存模式之间变量约束中间结果的思想,对于每一个模式 ,除保留原有 a寄存器的外 ,增加两个新链来记录与该模式匹配的增删事实,一个叫做增链 (addlist),另一个叫做删链 (deletelist)。当修改描述的操作符为 \"+\"时,临时执行部分连接任务;当修改描述的操作符为 \"一\"时,直接删去冲突集中包含该事实的规则实例。 Treat算法的步骤如下： 行动 :根据点火规则的 RHS,生成修改描述表 CHANGES; 模式匹配:置每一模式的删链和增链为空,对 CHANGES的每一个修改描述 ,执行模式匹配。对于与修改描述中的事实匹配成功的模式,若修改描述的操作符为 \"+\", 将该事实加入这一模式的增链;若修改描述的操作符为 \"一\",将该事实加入这一模式的 删链。 删去事实的处理:对于任一模式链中的每一个事实,找到冲突集中所有包含该事实 的规则实例,并将这一规则实例从冲突集中删去。相应地修改该模式的 a寄存器 。 新增事实的处理:对 于 每 一 模 式 ,若 其 增 链 非 空 ,则 将 增 链 中 的 所 有 事 实 加 入 该 模 式的a寄存器 ,并对与新增事实相关的每一条规则临时执行部分匹配,寻找该规则新的实 例。具体做法为:首先将第一个模式增链中的事实集合与后一模式的 a寄存器进行连接 , 再将部分连接结果与第三个模式的a寄存器进行连接 ,一直到所有模式均连接完成为止。 其中 ,a寄存器 的内容包括新增 事实。若连接结果非空 ,则将找到 的规则 实例插入到冲突 集中。 Leaps 算法 前向推理引擎，包括LEAPS，都包括了匹配-选择-执行（match-select-action）循环。即，确定可以匹配的规则，选择某个匹配的元 组，此元组相应的规则动作被执行。重复这一过程，直到某一状态（如没有更多的规则动作）。RETE和TREAT匹配算法速度慢的原因是，它们把满足规则条 件的元组都实例化。Leaps算法的最大的改进就是使用一种\"lazy\"的方法来评估条件（conditions），即仅当必要时才进行元组的实例化。这 一改进极大的减少了前向推理引擎的时空复杂度，极大提高了规则执行速度。 Leaps算法将所有的 asserted 的 facts ，按照其被 asserted 在 Working Memory 中的顺序（ FIFO ），放在主堆栈中。它一个个的检查 facts ，通过迭代匹配 data type 的 facts 集合来找出每一个相关规则的匹配。当一个匹配的数据被发现时，系统记住此时的迭代位置以备待会的继续迭代，并且激发规则结果（ consequence ）。当结果（ consequence ）执行完成以后，系统就会继续处理处于主堆栈顶部的 fact 。如此反复。 Leaps算法的效率可以比Rete算法和Tread算法高几个数量级。 其他算法 对于HAL算法和Matchbox算法，使用的范围不是很广，这里不做过多的介绍。","tags":"软件开发","loc":"http://holbrook.github.io/2012/12/05/algorithm_of_pattern_match.html"},{"title":"CEP：鱼与熊掌可以兼得","text":"从事件驱动编程（Event-driven Programming)开始 如果你写过GUI程序，对事件处理一定不陌生。事实上，事件驱动编程已经成为一种设计模式。大多数的GUI库都会采用这一模式。 简单的说，事件驱动模式包括三个参与者：事件产生者，事件分发器和事件处理器。 事件产生者（Events Generator） 决定是否需要产生事件。比如，GUI上的每个组件都是一个事件产生者，可以根据用户操作产生鼠标事件或者键盘事件。 事件分发器（Events Dispatcher） 收集所有事件产生者发出的事件放入事件队列(Events Queue)， 并根据事件的类型将事件分发给已经注册的事件处理器。事件分发器通常由GUI框架实现。 事件处理器（Events Handler) 根据接收到的事件进行处理，需要GUI框架的使用者自行编写。 事件驱动编程的核心价值在于：程序的执行流程不是预先定义好的，而是由程序的使用者决定的。这将极大增强程序的交互性。 就好像DVD与RPG游戏的区别：前者的剧情是设定好的，你只能进行开始、暂停、快进、回退等有限的交互；后者可以决定主角的行为从而影响故事的结局。 事件驱动业务（Event-driven Business) 代码的世界不可能是现实世界的完整镜像，但一定是对现实世界的某种抽象，这种抽象能够简化代码世界中对问题的分析和处理。 同时，这种抽象还可以反向映射到现实世界，为我们解决现实问题提供思路。 现代企业生存的外部环境处于剧烈的变化之中，\"敏捷企业\"已经成为生存之道，而事件驱动业务是敏捷企业的一个基本要求。 事件驱动业务（Event-driven Business)，是在 连续 的业务过程中进行决策的一种业务管理方式，即根据不同时点上出现的一系列事件触发相关的任务，并调度可用的资源执行任务。 如果说事件驱动编程能够为软件带来更灵活的交互性和强大的功能，那么企业中的事件驱动业务能够大幅度提高业务的效率和灵活性。 事件驱动业务依托于比较成熟的信息化建设。各个业务应用系统在产生连续不断的数据流的同时，根据定义好的条件产生一些\"业务事件\"，按照策略对这些业务事件进行分析处理，触发新的业务事件或者业务流程，即实现了业务的事件驱动。 从上面的描述可以看出，事件驱动业务要求能够快速（毫秒级）、不间断的处理连续、海量的数据，具备灵活的规则或策略设置，从而具备迅速识别、捕获、响应实时业务数据的能力。 而传统的企业IT架构通常采用： 在业务应用系统中处理业务操作 遵循固定的业务流程（Business Process）处理跨系统事务，并且这些流程很少变化 基于数据仓库进行海量数据的存储及事后分析 这种IT架构远远达不到事件驱动业务的要求。 事件驱动业务能够应用的业务领域很多，凡是需要快速处理连续性数据、需要能够灵活制定策略的业务，都可以采用事件驱动的业务模式。如证券行业常见的风险分析预警（事前及事中风控）、投资决策（程序化交易）、经纪人绩效计算等。 业务事件处理的几个层次 其实在传统的IT架构中，我们已经实现了业务事件的处理。比如在传统的业务应用系统中，我们通常将业务数据存储在数据库中，通过应用系统的操作界面由人工发现和处理业务事件。 这样的处理方式存在两个不足，一是速度慢，二是对于复杂的情况只靠人脑难以处理。于是有了两个技术方向： 消息队列（MQ） 对于速度慢的解决办法是用机器代替人工，为了在多个系统之间传递消息，发展出了消息队列（MQ）的技术 商业智能（BI） 为了应对复杂性，通过数据仓库将数据整合到一起，并用专门的工具在数据模型的基础上进行分析 但是上述两个方向是正交的：MQ不适合处理复杂性，而BI主要适应于对结构化的历史数据的分析，无法处理\"现在\"的情况。 CEP：鱼与熊掌可以兼得 CEP（Complex Event Processing）的出现解决了上述两个方面的问题，在实时性和复杂性方面都得到了很好的解决。 处理数据流 不管是单独的应用系统，还是数据仓库，都是先将数据存储到数据库/数据仓库，然后再处理或查询。 而CEP与MQ类似的将数据看作是 数据流 。在连续数据的快速移动过程中进行分析处理。 这样的方式不需要很大的数据加载，完全可以在内存中进行，从而能够快速产生结果。 处理复杂性 业务事件可能很复杂，在各种不同的数据流中源源不断产生各种类型的事件。需要对这些业务事件进行复杂的计算，如过滤、关联、聚合等，同时还需要考虑这些也是事件出现的时间序列。 最终才能产生有意义的事件，或触发业务流程。同时，这些计算的规则可能还会经常变化。 这一类的问题通常通过基于规则的推理机（即规则引擎）来实现。 CEP的架构 综上所述，CEP在逻辑上应该包括： 事件发生器 通过应用系统、文件系统、数据库、互联网、人工、以及传感器产生事件 事件处理器 模式的匹配、验证和改进，路由，转换以及编排 事件消费者 与事件发生器类似，也可以是应用系统、文件系统、数据库、互联网、人工界面等 小结 CEP是一种比较新的企业架构(EA,Enterprise Architure)组件。CEP将数据看做一种数据流，基于规则引擎对业务过程中持续产生的各种事件进行复杂的处理，能够实现对连续数据的快速分析处理。可以应用在多种业务场景，如风险分析、程序化交易等。 如果说BI实现了商业智能，那么CEP则实现了\"持续智能（Continuous Intelligence）\"。","tags":"并发系统","loc":"http://holbrook.github.io/2012/11/06/cep_about.html"},{"title":"NoSQL数据库选型指引","text":"什么是NoSQL NoSQL可以有两种解释： No SQL：\"不使用SQL查询语言\"。强调其轻量的特点 Not Only SQL：\"不仅仅是查询\"。强调其高性能，分布式，大容量等传统关系数据库所不具备的特性 从设计原则上，NoSQL不再强调ACID（酸），而是强调BASE（碱）。 ACID是指： atomicity（原子性）：一个事务中的所有操作，要么全部完成，要么全部不完成。如果中途发生错误需要回滚（Rollback） consistency(一致性)：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。這表示寫入的資料必須完全符合所有的預設規則，這包含資料的精確度、串聯性以及後續数据库可以自發性地完成預定的工作。 isolation(隔離性)：当两个或者多个事务并发访问（此处访问指查询和修改的操作）数据库的同一数据时所表现出的相互关系。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable） durability(持久性)：在事务完成以后，该事务对数据库所作的更改便持久地保存在数据库之中，并且是完全的 BASE是指： Basically Available（基本可用） Soft-state（软状态/柔性事务） Eventually Consistent（最终一致性） NoSQL与关系数据库的原则不同：NoSQL牺牲高一致性，换取获得可用性或可靠性。软状态意味着状态是异步的，在某些时段状态是不一致的；但最终一致保证数据早晚会一致。 NoSQL选型要素 存储结构 由于NoSQL的目的和原则的不同，NoSQL中的数据不是按照表存储。根据NoSQL存储结构的不同，可以分为： 文档存储 图存储 key/value儲存 列存储 对象数据库 是否持久化 有的NoSQL是纯内存存储，不支持持久化 是否支持嵌入式 是否支持集群部署 操作接口的丰富程度 常见的NoSQL数据库 文档数据库 名称 持久化 部署方式 操作接口 备注 CouchDB 分布式 JavaScript MapReduce, RESTful JSON API HTTP访问，内置了Web管理控制台 JackRabbit Java Lotus Notes LotusScript, Java BaseX XQuery, Java MongoDB 服务，集群 PHP，Python，Perl，Ruby，JavaScript，C++等 JSON数据库，支持全文索引，自动分片，跨LAN或WAN扩展 图形数据库 名称 持久化 部署方式 操作接口 备注 Neo4j Java DEX Java , C# AllegroGraph SPARQL FlockDB Scala key/value数据库 名称 持久化 部署方式 操作接口 备注 BigTable memcached Redis Oracle Berkeley DB 列数据库 名称 持久化 部署方式 操作接口 备注 Cassandra HBase Hypertable 对象数据库 名称 持久化 部署方式 操作接口 备注 db4o iBoxDB JADE ZODB ObjectStore","tags":"软件开发","loc":"http://holbrook.github.io/2012/11/06/nosql_list.html"},{"title":"如何规划blog的分类和标签","text":"一篇旧的博文，原文发表在 博客园 。","tags":"极限写作","loc":"http://holbrook.github.io/2012/11/05/2012-11-05-blog_design_categories_and_tags.html"},{"title":"QQ 餐厅与系统性能模型(续)：如何评价系统的性能","text":"作为QQ餐厅的客人，对餐厅效率的评价就是供餐\"快\"或者\"慢\"。但是对于餐厅的经营者，这样简单的考虑问题显然是不够的。 在 《QQ餐厅与系统性能模型》 中提到了系统性能的很多指标，而客人感觉\"快\"或者\"慢\"仅仅对应其中的 响应时间 这一指标。 对于QQ餐厅的经营者，应该如何考虑呢？ 在《QQ餐厅与系统性能模型》 中已经描述了客人数量增加时餐厅中发生的一系列\"故事\"，让我们回顾一下： 资源利用率与负载 资源利用率随负载的增加而增加，最终达到100%。此时再增加负载，资源利用率也不会增加。当然，这是对单一资源来说，现实中总是有某种资源最先达到100%而其他的资源仍有空闲。 资源利用率达到100%时对应的并发用户数称为 最佳并发用户数 。 响应时间与负载 当并发用户数小于前面定义的\"最大并发用户数\"时，系统的响应时间是一个固定的值。如果继续增加系统的负载，用户等待时间就会增加从而延长响应时 间。假设用户有一个能容忍的最长等待时间，则负载增加到一定程度时系统对某些请求的响应时间就会超过用户的容忍度。在临界状态的负载称为 最大并发用户数 。 在最大并发用户数的情况下，系统的吞吐量应该达到最大值。超过最大并发用户数的负载会导致资源浪费在超时的请求上，从而使吞吐量下降。 （在系统负载略高于最大并发用户数时，可能吞吐量会有一定程度的增加，但此时的吞吐量已经没有意义。所以应该考量最大并发用户数下系统的吞吐量） 评价系统的性能 从系统建设者的角度来说，系统性能不仅仅是\"快\"或者\"慢\"，而是应该有一个全面的描述。比如对于\"QQ餐厅系统\"，至少要有如下的描述才能评价其性能： QQ餐厅的可用资源包括：2位厨师，6名服务员，30套座位 QQ餐厅最理想情况是同时接待25位客人，此时2名厨师工作量饱和，服务员空闲1人，座位空闲5套 在25人就餐的情况下，没小时可以卖出8道菜，客人评价就餐时间为10分钟，99%的客人可以在30分钟完成内用餐 假设 客人能容忍的最长用餐时间为60分钟，则QQ餐厅最多能容纳35人就餐 在35人就餐的情况下，每小时可以卖出10道菜，客人平均就餐时间为20分钟，99%的客人可以在50分钟内完成用餐 提高系统的性能 有了前面比较系统的性能描述，就很容易知道如何提高系统的性能。提高系统性能的目标有两个级别： 在现有的响应时间基础上，提高最佳并发用户数和最大并发用户数。 这两个指标的现实意义在于：最佳并发用户数要不小于系统的平均负载，最大并发用户数要不小于系统的峰值负载（通常应该达到峰值的1.5–2倍）。 实现这个级别的目标通常比较容易，主要是增加系统的可用资源。必要时还可以横向扩展（增加服务器数量）。比如对于前面的QQ餐厅性能情况，增加厨师数量就能够有效提高最佳并发数和最大并发数。 当然，如果能够说服用户增加所能容忍的等待时间，也可以提高最大并发数。 增加系统整体的响应速度 用户感受到的整体响应时间=请求传输时间+等待时间+处理时间+响应返回时间。针对这些不同的时间片段可以分别想办法提高速度。比如： 提高网络带宽可以减小请求传输时间和响应返回时间； 增加处理单元可以减小等待时间； 优化算法可以减小处理时间。 上面的几种办法实现起来难度都比较大，所以提高系统性能应该优先考虑第一个级别的办法。 最精简的性能测试的例子 使用Apache ab进行性能测试，访问NginX上面部署的静态页面。在不同并发下测试100万次请求，结果如下： 并发数 失败请求数 每秒完成请求 平均响应时间ms 99%请求响应时间ms 吞吐量(kb/s) 100 0 13005.97 7.689 10 24132.19 500 0 24132.19 36.193 232 25632.78 600 0 13948.85 43.014 296 25881.7 700 0 14317.11 48.893 232 25632.78 800 288 14264.21 56.084 2570 26461.06 1000 390 14752.1 67.787 3013 27363.46 在各轮测试中，Nginx均没有发生故障切换。 从测试数据中可以得出以下结论： 当前的性能瓶颈在于网络带宽 当前系统的最佳并发数为500，最大并发为700 在最佳并发下，系统每秒可以处理2.4万个请求，平均响应时间36ms，99%的请求在232ms内完成 在最大并发下，系统每秒可以处理1.4万个请求，平均响应时间48ms，99%的请求在232ms内完成 负载均衡器的性能指标 对于负载均衡器，需要的性能指标与具体的应用服务器不太一样。更关注如下指标： 每秒的会话处理数，要区分4层和7层 最多保持的连接数 吞吐量，要区分4层和7层 支持的虚拟服务器的个数 支持的后端真实服务器的个数","tags":"软件开发","loc":"http://holbrook.github.io/2012/10/29/performance_test.html"},{"title":"QQ餐厅与系统性能模型","text":"QQ餐厅\"系统\" QQ餐厅是一个系统。 其中包括各种资源： 厨师是 CPU 服务员是 内存 桌椅板凳是 磁盘IO 这个系统中只运行一个 应用 ，该应用只提供一个 服务 ：就餐服务。显然，系统的所有资源都会用于这个服务。 QQ餐厅当然会有很多客人，称之为 并发用户数 ，或者叫 负载 。 开始的时候客人不多，桌椅板凳或厨师、服务员都可能空闲，叫做 资源闲置 ，已经使用的资源比例叫做 资源利用率 。 随着资源和人的增加，资源利用率也会逐渐增长，并最终达到100%。此时餐厅已经\"全速运转\"，这是的并发用户数叫做 最佳并发数 ， 所谓\"最佳\"是指资源已经充分利用，并且每个请求没有额外的等待。 如果某些资源不足，就会发生该资源的利用率已经达到100%，但是其他资源仍有空闲的情况。此时该项资源成为 性能瓶颈 。为避免性能瓶颈，最理想的情况是使得所有资源的利用率同时达到100%，此时各种资源的比例叫做 最佳资源配比 。 QQ餐厅玩家很重要的一项任务就是在餐厅的不断扩建过程中，始终维持各资源的最佳配比。 当客人的数量超过\"最佳并发数\"时，就会产生额外的等待。也就是说， 等待时间 会随着并发用户数的增加而增长。而从客人的角度来说，等待时间+供餐所需的固有时间（服务员点菜、传菜、结账和厨师做菜等需要的，不可减少的时间）= 响应时间 ，所以等待时间的延长会导致响应时间的延长。而客人的耐心是有限的，如果响应时间过长，客人就会愤然离去，这叫做 响应超时 。 由于响应超时会导致客人的离去，我们应该区分满意离开的客人和因为超时而离开的客人。我们把餐厅在单位时间接待的客人叫做 吞吐量 ，并发用户数-吞吐量=超时的请求。不发生超时情况下的最大并发用户数成为 最大并发数 。 此时系统的吞吐量达到最大。 系统性能指标 在QQ餐厅中，涉及到了很多系统性能指标，让我们来回顾一下： 系统，应用，服务 资源： CPU、内存、磁盘IO等 负载，并发用户数 资源利用率、性能瓶颈、资源闲置 最佳并发数，最佳资源配比 等待时间、响应时间与响应超时 吞吐量、最大并发数 当然，由于QQ餐厅的模型比较简单，有一些性能指标没有体现出来： 用户响应时间和系统响应时间 前面的响应时间是从餐厅（系统）角度考虑的，如果从客人（用户）角度考虑，可能还需要加上从家到餐厅以及从餐厅返回到家的时间。 吞吐量的计量 前面把餐厅在单位时间接待的客人数量作为吞吐量，这是因为QQ餐厅进行了简化，假设每位顾客只点一种套餐（一道菜+一份饮料）并且只点一次。更复杂 的情况是根据粒度的不同，分别用每秒完成菜品的数量（流量）、完成点餐的数量（请求）、用餐次数（事务）作为吞吐量的计量，根据需要选择一个或者多个指 标。 小结 综上所述，QQ餐厅是一个系统，玩QQ餐厅就是考虑如何优化系统的性能。 而需要分析系统的哪些性能指标、如何分析决定能否对系统性能进行有效的优化。 这些内容可以继续围观 《QQ餐厅与系统性能模型(续)：如何评价系统的性能》 。","tags":"软件开发","loc":"http://holbrook.github.io/2012/10/23/whats_performance.html"},{"title":"开发和部署JBoss FUSE中的路由(Route)","text":"快速开始 因为 Fuse的核心组成部分是ServiceMix ，而ServiceMix的核心组成部分是Apache Camel，所以\"用Fuse开发路由\"也就是\"开发Camel路由\"。 Camel提供了大量的开发 工具 ，其中 camel-archetype-blueprint 是一个 maven archetype ， 可以基于 Blueprint ，以依赖注入的方式配置CamelContext。下面快速创建一个demo: mvn archetype:generate \\ -DarchetypeGroupId = org.apache.camel.archetypes \\ -DarchetypeArtifactId = camel-archetype-blueprint \\ -DarchetypeVersion = 2.12.2 \\ -DgroupId = thinkinside.demo.fuse \\ -DartifactId = route-demo \\ -Dversion = 1.0.0-SNAPSHOT 会创建如下结构的一个工程： 从 pom.xml 来看，这是一个 使用maven-bundle-plugin构建的OSGibundle工程 。 基于 Blueprint 装配Camel Context 工程的`META-INF/blueprint/blueprint.xml'文件是一个Blueprint配置文件： <?xml version=\"1.0\" encoding=\"UTF-8\"?> <blueprint xmlns= \"http://www.osgi.org/xmlns/blueprint/v1.0.0\" xmlns:xsi= \"http://www.w3.org/2001/XMLSchema-instance\" xmlns:camel= \"http://camel.apache.org/schema/blueprint\" xsi:schemaLocation= \" http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd\" > <bean id= \"helloBean\" class= \"thinkinside.demo.fuse.HelloBean\" > <property name= \"say\" value= \"Hi from Camel\" /> </bean> <camelContext id= \"blueprintContext\" trace= \"false\" xmlns= \"http://camel.apache.org/schema/blueprint\" > <route id= \"timerToLog\" > <from uri= \"timer:foo?period=5000\" /> <setBody> <method ref= \"helloBean\" method= \"hello\" /> </setBody> <log message= \"The message contains ${body}\" /> <to uri= \"mock:result\" /> </route> </camelContext> </blueprint> 该配置文件中，定义了一个id为 blueprintContext 的Camel Context。这个Context中定义了一个路由： 入口为一个Timer类型的Endpoint 使用预定义的bean为Message设置body 记录日志 出口为一个Mock类型的Endpoint 如果使用FuseIDE，可以看到图形化的配置界面： 部署到ServiceMix ================ 执行 mvn package 后，得到 route-demo-1.0.0-SNAPSHOT.jar ，这是一个OSGi bundle。可以将jar文件部署到 =\\$SERVICEMIX~HOME~/deploy/= 目录中。正常情况下，bundle的依赖关系被满足，该bundle会被自动启动。 从ServiceMix到Fuse 上述的过程也适用于JBoss Fuse。 但是Fuse对ServiceMix进行了再次封装，需要使用Fuse对应的版本。比如，=camel-archetype-blueprint= 的版本可能要使用 2.10.0.redhat-60024 这样的\"Fuse版本号\"，否则在部署到Fuse是可能会发生版本不匹配的问题。 Fuse提供了一个maven仓库，专门提供这种定制版本的组件，需要在maven中配置： <repository> <id> fusesource </id> <url> http://repo.fusesource.com/nexus/content/groups/public/ </url> <snapshots> <enabled> false </enabled> </snapshots> <releases> <enabled> true </enabled> </releases> </repository>","tags":"并发系统","loc":"http://holbrook.github.io/2012/04/14/fuse_develop_route.html"},{"title":"规则，推理机和规则引擎","text":"什么是规则 在现实生活中，规则无处不在。我们最长接触的是法律、法规和各种制度；对于企业级应用来说，第一步的业务调研中很重要的内容就是了解业务规则。在企业流程再造中，可能还会接触到流程规则。 在IT技术领域，很多地方也应用了规则，比如路由表，防火墙策略，乃至角色权限控制(RBAC)，或者Web框架中的URL匹配。 不管是哪种种规则，都规定了一组确定的条件和此条件所产生的结果。 举一个例子，是纷繁复杂的保险费率计算中的一条规则： IF 汽车是红色 车是运动型的 驾驶员是男性 驾驶员在16-25岁之间 THEN 保险费用增加20% 从这个例子可以看出： 每条规则都是一组条件决定的一系列结果 一条规则可能与其他规则共同决定最终结果。比如例子中的规则只产生了增量，还需要与确定基数的规则共同作用才能决定最终的费率 可能存在条件互相交叉的规则，此时有必要规定规则的优先级 推理机与规则引擎 规则作为一种知识，其典型运用就是通过实际情况，根据给定的一组规则，得出结论。这个结论可能是某种静态的结果，也可能是需要进行的一组操作。 这种规则的运用过程叫做推理。如果由程序来处理推理过程，那么这个程序就叫做推理机/推理引擎（Inference Engine）。推理机是专家系统（专家系统是人工智能的一个分支）的核心模块。 推理引擎根据知识表示的不同采取的控制策略也是不同的，常见的类型包括基于神经网络、基于案例和基于规则的推理机。其中，基于规则的推理机易于理解、易于获取、易于管理，被广泛采用。这种推理引擎被称为\"规则引擎\"。 在规则引擎中，将知识表达为规则（rules），要分析的情况定义为事实（facts）。二者在内存中的存储分别称为Production Memory和Working Memory，如下图： rules和facts是规则引擎接受的输入参数，而规则引擎本身包括两个组成部分：Pattern Matcher和Agenda。Pattern Matcher根据facts找到匹配的rules，Agenda管理PatternMatcher挑选出来的规则的执行次序。在外围，还会有一个执行引擎（Execution Engine）负责根据Agenda输出的rules执行具体的操作。 其中Pattern Matcher是规则引擎负责推理的核心。和人类的思维相对应，规则引擎中也存在两种推理方式：正向推理（Forward-Chaining）和反向推理（Backward-Chaining）。 正向推理也叫演绎法，由事实驱动，从 一个初始的事实出发，不断地应用规则得出结论。首先在候选队列中选择一条规则作为启用规则进行推理，记录其结论作为下一步推理时的证据。如此重复这个过程，直到再无可用规则可被选用或者求得了所要求的解为止。 反向推理也叫归纳法，由目标驱动，首先提出某个假设，然后寻找支持该假设的证据，若所需的证据都能找到，说明原假设是正确的；若无论如何都找不到所需要的证据，则说明原假设不成立，此时需要另做新的假设。 规则引擎的作用 规则引擎可以将规则的定义从代码中分离出来，将推理过程封装到规则引擎内部进行处理，这带来几个好处： 规则外部化，即有利于规则知识的复用，也可避免改变规则时带来的代码变更问题 由规则引擎使用某种算法进行推理过程，不需要编写复杂晦涩的逻辑判断代码 开发人员的不需要过多关注逻辑判断，可以专注于逻辑处理","tags":"软件开发","loc":"http://holbrook.github.io/2012/03/20/rule_engine_1.html"},{"title":"多线程的基本概念","text":"多线程编程必须理解的一些基本概念，适用于所有编程语言。内容： 并发式编程 多任务操作系统 多线程vs多进程 线程安全 线程的生命周期 线程的类型 并发式编程 不同的编程范式对软件有不同的视角。并发式编程将软件看做任务和资源的组合——任务之间竞争和共享资源，当资源满足时执行任务，否则等待资源。 并发式编程使得软件易于理解和重用，在某些场景能够极大提高性能。 多任务操作系统 要实现并发，首先需要操作系统的支持。现在的操作系统大部分都是多任务操作系统，可以\"同时\"执行多个任务。 多任务可以在进程或线程的层面执行。 进程是指一个内存中运行的应用程序，每个进程都有自己独立的一块内存空间。多任务操作系统可以\"并发\"执行这些进程。 线程是指进程中乱序、多次执行的代码块，多个线程可以\"同时\"运行，所以认为多个线程是\"并发\"的。多线程的目的是为了最大限度的利用CPU资源。比如一个JVM进程中，所有的程序代码都以线程的方式运行。 这里面的\"同时\"、\"并发\"只是一种宏观上的感受，实际上从微观层面看只是进程/线程的轮换执行，只不过切换的时间非常短，所以产生了\"并行\"的感觉。 多线程vs多进程 操作系统会为每个进程分配不同的内存块，而多个线程共享进程的内存块。这带来最直接的不同就是创建线程的开销远小于创建进程的开销。 同时，由于内存块不同，所以进程之间的通信相对困难。需要采用pipe/named pipe，signal, message queue, shared memory,socket等手段；而线程间的通信简单快速，就是共享进程内的全局变量。 但是，进程的调度由操作系统负责，线程的调度就需要我们自己来考虑，避免死锁，饥饿，活锁，资源枯竭等情况的发生，这会增加一定的复杂度。而且，由于线程之间共享内存，我们还需要考虑线程安全性的问题。 线程安全 因为线程间共享进程中的全局变量，所以当其他线程改变了共享的变量时，可能会对本线程产生影响。 所谓线程安全的约束是指一个函数被多个并发线程反复调用时，要一直产生正确的结果。要保证线程安全，主要是通过加锁的方式保证共享变量的正确访问。 比线程安全更严格的约束是\"可重入性\"，即函数在一个线程内执行的过程中被暂停，接下来又在另一个线程内被调用，之后在返回原线程继续执行。在整个过程中都能保证正确执行。保证可重入性，通常通过制作全局变量的本地拷贝来实现。 线程的生命周期 所谓的xx生命周期，其实就是某对象的包含产生和销毁的一张状态图。线程的生命周期如下图所示： 各状态的说明如下： New新建。新创建的线程经过初始化后，进入Runnable状态。 Runnable就绪。等待线程调度。调度后进入运行状态。 Running运行。 Blocked阻塞。暂停运行，解除阻塞后进入Runnable状态重新等待调度。 Dead消亡。线程方法执行完毕返回或者异常终止。 可能有3种情况从Running进入Blocked： 同步：线程中获取同步锁，但是资源已经被其他线程锁定时，进入Locked状态，直到该资源可获取（获取的顺序由Lock队列控制） 睡眠：线程运行sleep()或join()方法后，线程进入Sleeping状态。区别在于sleep等待固定的时间，而join是等待子线程执行完。当然join也可以指定一个\"超时时间\"。从语义上来说，如果两个线程a,b, 在a中调用b.join()，相当于合并(join)成一个线程。最常见的情况是在主线程中join所有的子线程。 等待：线程中执行wait()方法后，线程进入Waiting状态，等待其他线程的通知(notify）。 线程的类型 主线程：当一个程序启动时，就有一个进程被操作系统（OS）创建，与此同时一个线程也立刻运行，该线程通常叫做程序的主线程（Main Thread）。每个进程至少都有一个主线程，主线程通常最后关闭。 子线程：在程序中创建的其他线程，相对于主线程来说就是这个主线程的子线程。 守护线程：daemon thread，对线程的一种标识。守护线程为其他线程提供服务，如JVM的垃圾回收线程。当剩下的全是守护线程时，进程退出。 前台线程：相对于守护线程的其他线程称为前台线程。","tags":"并发系统","loc":"http://holbrook.github.io/2012/02/23/multi_thread.html"},{"title":"Python之禅(The Zen of Python)","text":"The Zen of Python by Tim Peters Beautiful is better than ugly. Explicit is better than implicit. Simple is better than complex. Complex is better than complicated. Flat is better than nested. Sparse is better than dense. Readability counts. Special cases aren't special enough to break the rules. Although practicality beats purity. Errors should never pass silently. Unless explicitly silenced. In the face of ambiguity, refuse the temptation to guess. There should be one-- and preferably only one --obvious way to do it. Although that way may not be obvious at first unless you're Dutch. Now is better than never. Although never is often better than right now. If the implementation is hard to explain, it's a bad idea. If the implementation is easy to explain, it may be a good idea. Namespaces are one honking great idea -- let's do more of those! Python之禅 赖勇浩 翻译 优美胜于丑陋（Python 以编写优美的代码为目标） 明了胜于晦涩（优美的代码应当是明了的，命名规范，风格相似） 简洁胜于复杂（优美的代码应当是简洁的，不要有复杂的内部实现） 复杂胜于凌乱（如果复杂不可避免，那代码间也不能有难懂的关系，要保持接口简洁） 扁平胜于嵌套（优美的代码应当是扁平的，不能有太多的嵌套） 间隔胜于紧凑（优美的代码有适当的间隔，不要奢望一行代码解决问题） 可读性很重要（优美的代码是可读的） 即便假借特例的实用性之名，也不可违背这些规则（这些规则至高无上） 不要包容所有错误，除非你确定需要这样做（精准地捕获异常，不写 except:pass 风格的代码） 当存在多种可能，不要尝试去猜测 而是尽量找一种，最好是唯一一种明显的解决方案（如果不确定，就用穷举法） 虽然这并不容易，因为你不是 Python 之父（这里的 Dutch 是指 Guido ） 做也许好过不做，但不假思索就动手还不如不做（动手之前要细思量） 如果你无法向人描述你的方案，那肯定不是一个好方案；反之亦然（方案测评标准） 命名空间是一种绝妙的理念，我们应当多加利用（倡导与号召）","tags":"软件开发","loc":"http://holbrook.github.io/2012/02/12/zen_of_python.html"},{"title":"数据科学的知识体系","text":"数据科学是利用计算机的运算能力对数据进行处理，从数据中提取信息，进而形成\"知识\"。 然而要实现这一点并不容易。Swami Chandrasekaran在他的 《Becoming a Data Scientist》 中，规划了\"数据科学家\"之路，让我们共勉。 先上图： 1.基本原理(Fundamentals) 矩阵和线性代数(Matrices & Linear Algebra) 数据存储和处理 哈希函数，二叉树，时间复杂度(Hash Functions,Binary Tree,O(n)) 关系代数和数据库基础(Relational Algebra,DB Basic) 内连接、外连接、交叉连接、θ连接(Inner、Outer、Cross、Theta Join) CAP定理（CAP Theorem） 列表数据(tabular data) 数据框和序列(DataFrames & Series) 分片(Sharding) 联机分析处理（OLAP, Online Analytical Processing） 多维数据模型(Multidimensional Data Model) ETL 报表，商业智能与分析(Reporting vs BI vs Analytics) JSON & XML NoSQL 正则表达式（Regex, Regular Expression） 业务背景知识(Vendor Landscape) 安装环境(Env Setup) 2.统计学(Statistics) 获取数据(Pick a Dataset) UCI Repo: UCI数据库。是加州大学欧文分校(University of CaliforniaIrvine) 提出的用于机器学习的数据库，有大量的数据集。 描述性统计Descriptive Statistics 均值，中位数，极差，标准差，方差(（mean, median, range, SD, Var） 探索性数据分析(Exploratory Data Analysis) 直方图(Histograms) 百分位数和极值(Percentiles & Outliers) 概率论(Probability Theory) 贝叶斯定理(Bayes Theorem) 随机变量(Random Variables) 累计分布函数（CDF, Cumulative Distribution Function) 连续分布(Continuos Distributions) 正态分布、泊松分布、高斯分布(Normal, Poisson, Gaussian) 偏度(Skewness) 方差分析(ANOVA) 概率密度函数(PDF,Prob Den Fn) 中心极限定理(Central Limit THeorem) 蒙特卡罗方法(Monte Carlo Method) 假设检验(Hypothesis Testing) P值(p-Value) 卡方检验(Chi2 Test) 估计(Estimation) 置信区间(CI,Confid Int) 极大似然估计(MLE) 核密度估计(Kernel Density Estimate) 回归(Regression) 协方差(Convariance) 相关性(Correlation) 皮尔逊相关系数(Pearson Coeff) 因果性(Causation) 最小二乘法(Least2 fit) 欧氏距离(Eculidean Distance) 3.编程(Programming) python基础(Python Basics) R Excel 数据结构 Swami Chandrasekaran 给出的是 R 中的数据结构，但可以映射到python中。 变量(Varibles) 向量(Vectors) 矩阵(Matrices) 数组(Arrays) 因子(Factors) 列表(Lists) 数据框(Data Frames) 4.机器学习(Machine Learning) 机器学习与数据挖掘的区别(What is ML?) 数值变量(Numerical Var) 分类变量(Categorical Var) 监督学习(Supervised Learning) 无监督学习(Unsupervied Learning) 概念、输入和特征(Concepts, Inputs & Attributes) 训练集和测试集(Traning & Test Data) 分类器(Classifier) 预测(Prediction) Lift曲线 过拟合(Overfitting) 偏差和方差(Bias & Variance) 树分类(Trees & Classification) 分类问题(Classification) 分类正确率(Classification Rate) 决策树(Decision Trees) 提升方法(Boosting) 朴素贝叶斯分类(Naive Bayes Classifiers) K近邻分类(K-Nearest Neighbour) 回归问题(Regression) 逻辑回归(Logistic Regression) 排序(Ranking) 线性回归(Linear Regression) 感知机(Perceptron) 聚类问题(Clustering) 层次聚类(Hierarchical Clustering) K聚类(K-means Clusterning) 神经网络(Neural Networks) 情感分析(Sentiment Analysis) 协同过滤(Collaborative Fitering) 标签(Tagging) 5.文本挖掘/自然语言处理(Text Mining / NLP) 语料库(Corpus) 命名实体识别(Named Entity Recognition) 文本分析(Text Analysis) UIMA 词-文档矩阵(Term Document Matrix) 词频和权重(Term Frequency & Weight) 支持向量机(Support Vector Machines) 关联规则(Association Rules) 购物篮分析(Market Basket Analysis) 特征提取(Feature Extraction) 工具箱 Mahout Weka NLTK 文本分类(Classify Text) 词汇映射(Vocabulary Mapping) 6.数据可视化 单变量、双变量和多变量可视化(Uni, Bi & Multivariate Viz) ggplot2(R中的一个可视化包，python中使用pyplotlib) 直方图和饼图（单变量）(Histogram & Pie(Uni)) 树图和矩形树图(Tree & Tree Map) 散点图（双变量）(Scatter Plot (Bi)) 折线图（双变量）(Line Charts (Bi)) 空间图(Spatial Charts) Survey Plot 时间轴(Timeline) 决策树(Decision Tree) D3.js(知名的数据可视化前端框架) IBM ManyEyes(IBM的一款在线可视化处理工具) Tableau(国外知名的商用BI) 7.大数据(Big Data) MapReduce框架(Map Reduce Fundamentals) Hadoop组件(Hadoop Components) HDFS(Hadoop分布式文件系统,Hadoop Distributed FilesSystem） 数据复制原理(Data Replication Principles) 名称和数据节点(Name & Data Nodes) 任务跟踪(Job & Task Tracker) Map/Reduce编程(M/R Programming) Sqoop工具: Loading Data in HDFS Flue, Scribe: 处理非结构化数据 利用Pig语言进行SQL操作(SQL with Pig) 利用Hive来实现数据仓库(DWH with Hive) Scribe, Chukwa For Weblog(日志收集器和数据收集器) 使用Mahout Zookeeper 和 Avro Storm: Hadoop Realtime Rhadoop, RHipe, SparkR ： 将R和hadoop结合起来的架构 rmr: RHadoop的一个包，和hadoop的MapReduce相关 NoSql数据库 Classandra MongoDB Neo4j 8.数据摄取(ingestion) 数据格式概要(Summary of Data Formats) 数据发现(Data Discovery) 数据来源与采集(Data Sources & Acquisition) 数据集成(Data Integration) 数据融合(Data Fusion) 转换和浓缩(Transformation & Enrichament) 数据调查(Data Survey) Google OpenRefine: Google发布的开源的数据处理软件 数据量级(How much Data) ETL 9.数据清洗(munging) 维度与数值归约(Dimensionality & Numerosity Reduction) 数据规范化(Normalization) 数据清洗(Data Scrubbing) 缺失值处理(Handling Missing Values) 无偏估计量(Unbiased Estimators) 分箱稀疏值(Binning Sparse Values) 特征提取／特征工程(Feature Extraction) 去噪(Denoising) 抽样(Sampling) 分层抽样(Stratified Sampling) 主成分分析(PCA,Principal Component Analysis) 10.工具集 微软的Excel及其自带的分析工具库(MS Excel / Analysis ToolPak) Java, Python R, R-Studio, Rattle（Rattle是基于R的数据挖掘工具，提供了GUI） Weka(基于JAVA环境下开源的机器学习以及数据挖掘软件) Knime(基于Eclipse环境的开源商业智能工具) RapidMiner(开源的数据挖掘软件,提供一些可扩展的数据分析挖掘算法的实现。) Hadoop发行版选择(Hadoop Dist of Choice) Spark, Storm: Hadoop相关的实时处理框架，是对Hadoop的补充和完善 Flume: 海量日志采集、聚合和传输的系统 Scribe: Facebook开源的日志收集系统，在Facebook内部已经得到的应用 Chukwa: 开源的用于监控大型分布式系统的数据收集系统 Nutch: 一个开源的Java搜索引擎 Talend： 一家专业的开源集成软件公司，提供各类数据工具 ScraperWiKi： 致力于数据科学领域维基百科网站，帮助个人和企业获得最专业的可视化数据，并支持对数据进行分析和管理 Webscraper： 网页爬虫 Flume: 海量日志采集、聚合和传输的系统 Sqoop: Haddop套件 tm: R语言的文本挖掘包 RWeka: R的weka算法包 NLTK: 自然语言工具包 RHIPE: R与Hadoop相关的开发环境 D3.js ggplot2 Shiny: 在线网页交互可视化工具, 可以将R语言作为半个BI用。 IBM Languageware: IBM的自然语言处理 Cassandra, MongoDB: 2种NoSql数据库 参考资料 知乎上面秦路的回答 Vamei对数据科学的理解","tags":"数据科学","loc":"http://holbrook.github.io/2017/02/05/index.html"},{"title":"《机器学习》","text":"《机器学习》 , 作者: (美)Tom Mitchell ，译者: 曾华军 / 张银奎 / 等 读书笔记目录。 机器学习关注的问题是:计算机程序如何随着经验积累自动提高性能。 本书展现机器学习中核心的算法和理论。书中的一些算法的实现和数据可以在互联网上 1 找到。 学习笔记目录 第1章 引言 第2章 概念学习和一般到特殊序 第3章 决策树学习 第4章 人工神经网络 第5章 评估假设 第6章 贝叶斯学习 第7章 计算学习理论 第8章 基于实例的学习 第9章 遗传算法 第10章 学习规则集合 第11章 分析学习 第12章 归纳和分析学习的结合 第13章 增强学习 相关资料 本书的网址：http://www.cs.cmu.edu/~tom/mlbook.html ↩","tags":"机器学习","loc":"http://holbrook.github.io/2017/03/04/index.html"}]}